(function(){function a(b,c,d){if(b===c)return 0!==b||1/b==1/c;if(null==b||null==c)return b===c;b._chain&&(b=b._wrapped);c._chain&&(c=c._wrapped);if(b.isEqual&&h.isFunction(b.isEqual))return b.isEqual(c);if(c.isEqual&&h.isFunction(c.isEqual))return c.isEqual(b);var e=l.call(b);if(e!=l.call(c))return!1;switch(e){case "[object String]":return b==String(c);case "[object Number]":return b!=+b?c!=+c:0==b?1/b==1/c:b==+c;case "[object Date]":case "[object Boolean]":return+b==+c;case "[object RegExp]":return b.source==
c.source&&b.global==c.global&&b.multiline==c.multiline&&b.ignoreCase==c.ignoreCase}if("object"!=typeof b||"object"!=typeof c)return!1;for(var f=d.length;f--;)if(d[f]==b)return!0;d.push(b);var f=0,t=!0;if("[object Array]"==e){if(f=b.length,t=f==c.length)for(;f--&&(t=f in b==f in c&&a(b[f],c[f],d)););}else{if("constructor"in b!="constructor"in c||b.constructor!=c.constructor)return!1;for(var g in b)if(h.has(b,g)&&(f++,!(t=h.has(c,g)&&a(b[g],c[g],d))))break;if(t){for(g in c)if(h.has(c,g)&&!f--)break;
t=!f}}d.pop();return t}var b=this,c=b._,d={},e=Array.prototype,f=Object.prototype,g=e.slice,k=e.unshift,l=f.toString,m=f.hasOwnProperty,q=e.forEach,r=e.map,n=e.reduce,p=e.reduceRight,C=e.filter,u=e.every,y=e.some,z=e.indexOf,B=e.lastIndexOf,f=Array.isArray,F=Object.keys,A=Function.prototype.bind,h=function(a){return new x(a)};"undefined"!==typeof exports?("undefined"!==typeof module&&module.exports&&(exports=module.exports=h),exports._=h):b._=h;h.VERSION="1.3.3";var s=h.each=h.forEach=function(a,
b,c){if(null!=a)if(q&&a.forEach===q)a.forEach(b,c);else if(a.length===+a.length)for(var e=0,f=a.length;e<f&&!(e in a&&b.call(c,a[e],e,a)===d);e++);else for(e in a)if(h.has(a,e)&&b.call(c,a[e],e,a)===d)break};h.map=h.collect=function(a,b,c){var d=[];if(null==a)return d;if(r&&a.map===r)return a.map(b,c);s(a,function(a,e,f){d[d.length]=b.call(c,a,e,f)});a.length===+a.length&&(d.length=a.length);return d};h.reduce=h.foldl=h.inject=function(a,b,c,d){var e=2<arguments.length;null==a&&(a=[]);if(n&&a.reduce===
n)return d&&(b=h.bind(b,d)),e?a.reduce(b,c):a.reduce(b);s(a,function(a,f,t){e?c=b.call(d,c,a,f,t):(c=a,e=!0)});if(!e)throw new TypeError("Reduce of empty array with no initial value");return c};h.reduceRight=h.foldr=function(a,b,c,d){var e=2<arguments.length;null==a&&(a=[]);if(p&&a.reduceRight===p)return d&&(b=h.bind(b,d)),e?a.reduceRight(b,c):a.reduceRight(b);var f=h.toArray(a).reverse();d&&!e&&(b=h.bind(b,d));return e?h.reduce(f,b,c,d):h.reduce(f,b)};h.find=h.detect=function(a,b,c){var d;D(a,function(a,
e,f){if(b.call(c,a,e,f))return d=a,!0});return d};h.filter=h.select=function(a,b,c){var d=[];if(null==a)return d;if(C&&a.filter===C)return a.filter(b,c);s(a,function(a,e,f){b.call(c,a,e,f)&&(d[d.length]=a)});return d};h.reject=function(a,b,c){var d=[];if(null==a)return d;s(a,function(a,e,f){b.call(c,a,e,f)||(d[d.length]=a)});return d};h.every=h.all=function(a,b,c){var e=!0;if(null==a)return e;if(u&&a.every===u)return a.every(b,c);s(a,function(a,f,t){if(!(e=e&&b.call(c,a,f,t)))return d});return!!e};
var D=h.some=h.any=function(a,b,c){b||(b=h.identity);var e=!1;if(null==a)return e;if(y&&a.some===y)return a.some(b,c);s(a,function(a,f,t){if(e||(e=b.call(c,a,f,t)))return d});return!!e};h.include=h.contains=function(a,b){var c=!1;return null==a?c:z&&a.indexOf===z?-1!=a.indexOf(b):c=D(a,function(a){return a===b})};h.invoke=function(a,b){var c=g.call(arguments,2);return h.map(a,function(a){return(h.isFunction(b)?b||a:a[b]).apply(a,c)})};h.pluck=function(a,b){return h.map(a,function(a){return a[b]})};
h.max=function(a,b,c){if(!b&&h.isArray(a)&&a[0]===+a[0])return Math.max.apply(Math,a);if(!b&&h.isEmpty(a))return-Infinity;var d={computed:-Infinity};s(a,function(a,e,f){e=b?b.call(c,a,e,f):a;e>=d.computed&&(d={value:a,computed:e})});return d.value};h.min=function(a,b,c){if(!b&&h.isArray(a)&&a[0]===+a[0])return Math.min.apply(Math,a);if(!b&&h.isEmpty(a))return Infinity;var d={computed:Infinity};s(a,function(a,e,f){e=b?b.call(c,a,e,f):a;e<d.computed&&(d={value:a,computed:e})});return d.value};h.shuffle=
function(a){var b=[],c;s(a,function(a,d,e){c=Math.floor(Math.random()*(d+1));b[d]=b[c];b[c]=a});return b};h.sortBy=function(a,b,c){var d=h.isFunction(b)?b:function(a){return a[b]};return h.pluck(h.map(a,function(a,b,e){return{value:a,criteria:d.call(c,a,b,e)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;return void 0===c?1:void 0===d?-1:c<d?-1:c>d?1:0}),"value")};h.groupBy=function(a,b){var c={},d=h.isFunction(b)?b:function(a){return a[b]};s(a,function(a,b){var e=d(a,b);(c[e]||(c[e]=[])).push(a)});
return c};h.sortedIndex=function(a,b,c){c||(c=h.identity);for(var d=0,e=a.length;d<e;){var f=d+e>>1;c(a[f])<c(b)?d=f+1:e=f}return d};h.toArray=function(a){return!a?[]:h.isArray(a)||h.isArguments(a)?g.call(a):a.toArray&&h.isFunction(a.toArray)?a.toArray():h.values(a)};h.size=function(a){return h.isArray(a)?a.length:h.keys(a).length};h.first=h.head=h.take=function(a,b,c){return null!=b&&!c?g.call(a,0,b):a[0]};h.initial=function(a,b,c){return g.call(a,0,a.length-(null==b||c?1:b))};h.last=function(a,
b,c){return null!=b&&!c?g.call(a,Math.max(a.length-b,0)):a[a.length-1]};h.rest=h.tail=function(a,b,c){return g.call(a,null==b||c?1:b)};h.compact=function(a){return h.filter(a,function(a){return!!a})};h.flatten=function(a,b){return h.reduce(a,function(a,c){if(h.isArray(c))return a.concat(b?c:h.flatten(c));a[a.length]=c;return a},[])};h.without=function(a){return h.difference(a,g.call(arguments,1))};h.uniq=h.unique=function(a,b,c){c=c?h.map(a,c):a;var d=[];3>a.length&&(b=!0);h.reduce(c,function(c,e,
f){if(b?h.last(c)!==e||!c.length:!h.include(c,e))c.push(e),d.push(a[f]);return c},[]);return d};h.union=function(){return h.uniq(h.flatten(arguments,!0))};h.intersection=h.intersect=function(a){var b=g.call(arguments,1);return h.filter(h.uniq(a),function(a){return h.every(b,function(b){return 0<=h.indexOf(b,a)})})};h.difference=function(a){var b=h.flatten(g.call(arguments,1),!0);return h.filter(a,function(a){return!h.include(b,a)})};h.zip=function(){for(var a=g.call(arguments),b=h.max(h.pluck(a,"length")),
c=Array(b),d=0;d<b;d++)c[d]=h.pluck(a,""+d);return c};h.indexOf=function(a,b,c){if(null==a)return-1;var d;if(c)return c=h.sortedIndex(a,b),a[c]===b?c:-1;if(z&&a.indexOf===z)return a.indexOf(b);c=0;for(d=a.length;c<d;c++)if(c in a&&a[c]===b)return c;return-1};h.lastIndexOf=function(a,b){if(null==a)return-1;if(B&&a.lastIndexOf===B)return a.lastIndexOf(b);for(var c=a.length;c--;)if(c in a&&a[c]===b)return c;return-1};h.range=function(a,b,c){1>=arguments.length&&(b=a||0,a=0);c=arguments[2]||1;for(var d=
Math.max(Math.ceil((b-a)/c),0),e=0,f=Array(d);e<d;)f[e++]=a,a+=c;return f};var v=function(){};h.bind=function(a,b){var c,d;if(a.bind===A&&A)return A.apply(a,g.call(arguments,1));if(!h.isFunction(a))throw new TypeError;d=g.call(arguments,2);return c=function(){if(!(this instanceof c))return a.apply(b,d.concat(g.call(arguments)));v.prototype=a.prototype;var e=new v,f=a.apply(e,d.concat(g.call(arguments)));return Object(f)===f?f:e}};h.bindAll=function(a){var b=g.call(arguments,1);0==b.length&&(b=h.functions(a));
s(b,function(b){a[b]=h.bind(a[b],a)});return a};h.memoize=function(a,b){var c={};b||(b=h.identity);return function(){var d=b.apply(this,arguments);return h.has(c,d)?c[d]:c[d]=a.apply(this,arguments)}};h.delay=function(a,b){var c=g.call(arguments,2);return setTimeout(function(){return a.apply(null,c)},b)};h.defer=function(a){return h.delay.apply(h,[a,1].concat(g.call(arguments,1)))};h.throttle=function(a,b){var c,d,e,f,t,g,w=h.debounce(function(){t=f=!1},b);return function(){c=this;d=arguments;e||
(e=setTimeout(function(){e=null;t&&a.apply(c,d);w()},b));f?t=!0:g=a.apply(c,d);w();f=!0;return g}};h.debounce=function(a,b,c){var d;return function(){var e=this,f=arguments;c&&!d&&a.apply(e,f);clearTimeout(d);d=setTimeout(function(){d=null;c||a.apply(e,f)},b)}};h.once=function(a){var b=!1,c;return function(){if(b)return c;b=!0;return c=a.apply(this,arguments)}};h.wrap=function(a,b){return function(){var c=[a].concat(g.call(arguments,0));return b.apply(this,c)}};h.compose=function(){var a=arguments;
return function(){for(var b=arguments,c=a.length-1;0<=c;c--)b=[a[c].apply(this,b)];return b[0]}};h.after=function(a,b){return 0>=a?b():function(){if(1>--a)return b.apply(this,arguments)}};h.keys=F||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[],c;for(c in a)h.has(a,c)&&(b[b.length]=c);return b};h.values=function(a){return h.map(a,h.identity)};h.functions=h.methods=function(a){var b=[],c;for(c in a)h.isFunction(a[c])&&b.push(c);return b.sort()};h.extend=function(a){s(g.call(arguments,
1),function(b){for(var c in b)a[c]=b[c]});return a};h.pick=function(a){var b={};s(h.flatten(g.call(arguments,1)),function(c){c in a&&(b[c]=a[c])});return b};h.defaults=function(a){s(g.call(arguments,1),function(b){for(var c in b)null==a[c]&&(a[c]=b[c])});return a};h.clone=function(a){return!h.isObject(a)?a:h.isArray(a)?a.slice():h.extend({},a)};h.tap=function(a,b){b(a);return a};h.isEqual=function(b,c){return a(b,c,[])};h.isEmpty=function(a){if(null==a)return!0;if(h.isArray(a)||h.isString(a))return 0===
a.length;for(var b in a)if(h.has(a,b))return!1;return!0};h.isElement=function(a){return!!(a&&1==a.nodeType)};h.isArray=f||function(a){return"[object Array]"==l.call(a)};h.isObject=function(a){return a===Object(a)};h.isArguments=function(a){return"[object Arguments]"==l.call(a)};h.isArguments(arguments)||(h.isArguments=function(a){return!(!a||!h.has(a,"callee"))});h.isFunction=function(a){return"[object Function]"==l.call(a)};h.isString=function(a){return"[object String]"==l.call(a)};h.isNumber=function(a){return"[object Number]"==
l.call(a)};h.isFinite=function(a){return h.isNumber(a)&&isFinite(a)};h.isNaN=function(a){return a!==a};h.isBoolean=function(a){return!0===a||!1===a||"[object Boolean]"==l.call(a)};h.isDate=function(a){return"[object Date]"==l.call(a)};h.isRegExp=function(a){return"[object RegExp]"==l.call(a)};h.isNull=function(a){return null===a};h.isUndefined=function(a){return void 0===a};h.has=function(a,b){return m.call(a,b)};h.noConflict=function(){b._=c;return this};h.identity=function(a){return a};h.times=
function(a,b,c){for(var d=0;d<a;d++)b.call(c,d)};h.escape=function(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")};h.result=function(a,b){if(null==a)return null;var c=a[b];return h.isFunction(c)?c.call(a):c};h.mixin=function(a){s(h.functions(a),function(b){J(b,h[b]=a[b])})};var E=0;h.uniqueId=function(a){var b=E++;return a?a+b:b};h.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,
escape:/<%-([\s\S]+?)%>/g};var t=/.^/,w={"\\":"\\","'":"'",r:"\r",n:"\n",t:"\t",u2028:"\u2028",u2029:"\u2029"},G;for(G in w)w[w[G]]=G;var K=/\\|'|\r|\n|\t|\u2028|\u2029/g,L=/\\(\\|'|r|n|t|u2028|u2029)/g,H=function(a){return a.replace(L,function(a,b){return w[b]})};h.template=function(a,b,c){c=h.defaults(c||{},h.templateSettings);a="__p+='"+a.replace(K,function(a){return"\\"+w[a]}).replace(c.escape||t,function(a,b){return"'+\n_.escape("+H(b)+")+\n'"}).replace(c.interpolate||t,function(a,b){return"'+\n("+
H(b)+")+\n'"}).replace(c.evaluate||t,function(a,b){return"';\n"+H(b)+"\n;__p+='"})+"';\n";c.variable||(a="with(obj||{}){\n"+a+"}\n");a="var __p='';var print=function(){__p+=Array.prototype.join.call(arguments, '')};\n"+a+"return __p;\n";var d=new Function(c.variable||"obj","_",a);if(b)return d(b,h);b=function(a){return d.call(this,a,h)};b.source="function("+(c.variable||"obj")+"){\n"+a+"}";return b};h.chain=function(a){return h(a).chain()};var x=function(a){this._wrapped=a};h.prototype=x.prototype;
var I=function(a,b){return b?h(a).chain():a},J=function(a,b){x.prototype[a]=function(){var a=g.call(arguments);k.call(a,this._wrapped);return I(b.apply(h,a),this._chain)}};h.mixin(h);s("pop push reverse shift sort splice unshift".split(" "),function(a){var b=e[a];x.prototype[a]=function(){var c=this._wrapped;b.apply(c,arguments);var d=c.length;("shift"==a||"splice"==a)&&0===d&&delete c[0];return I(c,this._chain)}});s(["concat","join","slice"],function(a){var b=e[a];x.prototype[a]=function(){return I(b.apply(this._wrapped,
arguments),this._chain)}});x.prototype.chain=function(){this._chain=!0;return this};x.prototype.value=function(){return this._wrapped}}).call(this);
(function(){var a=this,b=a.Backbone,c=Array.prototype.slice,d=Array.prototype.splice,e;e="undefined"!==typeof exports?exports:a.Backbone={};e.VERSION="0.9.2";var f=a._;!f&&"undefined"!==typeof require&&(f=require("underscore"));var g=a.jQuery||a.Zepto||a.ender;e.setDomLibrary=function(a){g=a};e.noConflict=function(){a.Backbone=b;return this};e.emulateHTTP=!1;e.emulateJSON=!1;var k=/\s+/,l=e.Events={on:function(a,b,c){var d,e,f,g,h;if(!b)return this;a=a.split(k);for(d=this._callbacks||(this._callbacks=
{});e=a.shift();)f=(h=d[e])?h.tail:{},f.next=g={},f.context=c,f.callback=b,d[e]={tail:g,next:h?h.next:f};return this},off:function(a,b,c){var d,e,g,h,l,m;if(e=this._callbacks){if(!a&&!b&&!c)return delete this._callbacks,this;for(a=a?a.split(k):f.keys(e);d=a.shift();)if(g=e[d],delete e[d],g&&(b||c))for(h=g.tail;(g=g.next)!==h;)if(l=g.callback,m=g.context,b&&l!==b||c&&m!==c)this.on(d,l,m);return this}},trigger:function(a){var b,d,e,f,g,h;if(!(e=this._callbacks))return this;g=e.all;a=a.split(k);for(h=
c.call(arguments,1);b=a.shift();){if(d=e[b])for(f=d.tail;(d=d.next)!==f;)d.callback.apply(d.context||this,h);if(d=g){f=d.tail;for(b=[b].concat(h);(d=d.next)!==f;)d.callback.apply(d.context||this,b)}}return this}};l.bind=l.on;l.unbind=l.off;var m=e.Model=function(a,b){var c;a||(a={});b&&b.parse&&(a=this.parse(a));if(c=v(this,"defaults"))a=f.extend({},c,a);b&&b.collection&&(this.collection=b.collection);this.attributes={};this._escapedAttributes={};this.cid=f.uniqueId("c");this.changed={};this._silent=
{};this._pending={};this.set(a,{silent:!0});this.changed={};this._silent={};this._pending={};this._previousAttributes=f.clone(this.attributes);this.initialize.apply(this,arguments)};f.extend(m.prototype,l,{changed:null,_silent:null,_pending:null,idAttribute:"id",initialize:function(){},toJSON:function(a){return f.clone(this.attributes)},get:function(a){return this.attributes[a]},escape:function(a){var b;if(b=this._escapedAttributes[a])return b;b=this.get(a);return this._escapedAttributes[a]=f.escape(null==
b?"":""+b)},has:function(a){return null!=this.get(a)},set:function(a,b,c){var d,e;f.isObject(a)||null==a?(d=a,c=b):(d={},d[a]=b);c||(c={});if(!d)return this;d instanceof m&&(d=d.attributes);if(c.unset)for(e in d)d[e]=void 0;if(!this._validate(d,c))return!1;this.idAttribute in d&&(this.id=d[this.idAttribute]);b=c.changes={};var g=this.attributes,h=this._escapedAttributes,k=this._previousAttributes||{};for(e in d){a=d[e];if(!f.isEqual(g[e],a)||c.unset&&f.has(g,e))delete h[e],(c.silent?this._silent:
b)[e]=!0;c.unset?delete g[e]:g[e]=a;!f.isEqual(k[e],a)||f.has(g,e)!=f.has(k,e)?(this.changed[e]=a,c.silent||(this._pending[e]=!0)):(delete this.changed[e],delete this._pending[e])}c.silent||this.change(c);return this},unset:function(a,b){(b||(b={})).unset=!0;return this.set(a,null,b)},clear:function(a){(a||(a={})).unset=!0;return this.set(f.clone(this.attributes),a)},fetch:function(a){a=a?f.clone(a):{};var b=this,c=a.success;a.success=function(d,e,f){if(!b.set(b.parse(d,f),a))return!1;c&&c(b,d)};
a.error=e.wrapError(a.error,b,a);return(this.sync||e.sync).call(this,"read",this,a)},save:function(a,b,c){var d,g;f.isObject(a)||null==a?(d=a,c=b):(d={},d[a]=b);c=c?f.clone(c):{};if(c.wait){if(!this._validate(d,c))return!1;g=f.clone(this.attributes)}a=f.extend({},c,{silent:!0});if(d&&!this.set(d,c.wait?a:c))return!1;var h=this,k=c.success;c.success=function(a,b,e){b=h.parse(a,e);c.wait&&(delete c.wait,b=f.extend(d||{},b));if(!h.set(b,c))return!1;k?k(h,a):h.trigger("sync",h,a,c)};c.error=e.wrapError(c.error,
h,c);b=this.isNew()?"create":"update";b=(this.sync||e.sync).call(this,b,this,c);c.wait&&this.set(g,a);return b},destroy:function(a){a=a?f.clone(a):{};var b=this,c=a.success,d=function(){b.trigger("destroy",b,b.collection,a)};if(this.isNew())return d(),!1;a.success=function(e){a.wait&&d();c?c(b,e):b.trigger("sync",b,e,a)};a.error=e.wrapError(a.error,b,a);var g=(this.sync||e.sync).call(this,"delete",this,a);a.wait||d();return g},url:function(){var a=v(this,"urlRoot")||v(this.collection,"url")||E();
return this.isNew()?a:a+("/"==a.charAt(a.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(a,b){return a},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return null==this.id},change:function(a){a||(a={});var b=this._changing;this._changing=!0;for(var c in this._silent)this._pending[c]=!0;var d=f.extend({},a.changes,this._silent);this._silent={};for(c in d)this.trigger("change:"+c,this,this.get(c),a);if(b)return this;for(;!f.isEmpty(this._pending);){this._pending=
{};this.trigger("change",this,a);for(c in this.changed)!this._pending[c]&&!this._silent[c]&&delete this.changed[c];this._previousAttributes=f.clone(this.attributes)}this._changing=!1;return this},hasChanged:function(a){return!arguments.length?!f.isEmpty(this.changed):f.has(this.changed,a)},changedAttributes:function(a){if(!a)return this.hasChanged()?f.clone(this.changed):!1;var b,c=!1,d=this._previousAttributes,e;for(e in a)if(!f.isEqual(d[e],b=a[e]))(c||(c={}))[e]=b;return c},previous:function(a){return!arguments.length||
!this._previousAttributes?null:this._previousAttributes[a]},previousAttributes:function(){return f.clone(this._previousAttributes)},isValid:function(){return!this.validate(this.attributes)},_validate:function(a,b){if(b.silent||!this.validate)return!0;a=f.extend({},this.attributes,a);var c=this.validate(a,b);if(!c)return!0;b&&b.error?b.error(this,c,b):this.trigger("error",this,c,b);return!1}});var q=e.Collection=function(a,b){b||(b={});b.model&&(this.model=b.model);b.comparator&&(this.comparator=b.comparator);
this._reset();this.initialize.apply(this,arguments);a&&this.reset(a,{silent:!0,parse:b.parse})};f.extend(q.prototype,l,{model:m,initialize:function(){},toJSON:function(a){return this.map(function(b){return b.toJSON(a)})},add:function(a,b){var c,e,g,h,k,l={},m={},n=[];b||(b={});a=f.isArray(a)?a.slice():[a];c=0;for(e=a.length;c<e;c++){if(!(g=a[c]=this._prepareModel(a[c],b)))throw Error("Can't add an invalid model to a collection");h=g.cid;k=g.id;l[h]||this._byCid[h]||null!=k&&(m[k]||this._byId[k])?
n.push(c):l[h]=m[k]=g}for(c=n.length;c--;)a.splice(n[c],1);c=0;for(e=a.length;c<e;c++)(g=a[c]).on("all",this._onModelEvent,this),this._byCid[g.cid]=g,null!=g.id&&(this._byId[g.id]=g);this.length+=e;d.apply(this.models,[null!=b.at?b.at:this.models.length,0].concat(a));this.comparator&&this.sort({silent:!0});if(b.silent)return this;c=0;for(e=this.models.length;c<e;c++)if(l[(g=this.models[c]).cid])b.index=c,g.trigger("add",g,this,b);return this},remove:function(a,b){var c,d,e,g;b||(b={});a=f.isArray(a)?
a.slice():[a];c=0;for(d=a.length;c<d;c++)if(g=this.getByCid(a[c])||this.get(a[c]))delete this._byId[g.id],delete this._byCid[g.cid],e=this.indexOf(g),this.models.splice(e,1),this.length--,b.silent||(b.index=e,g.trigger("remove",g,this,b)),this._removeReference(g);return this},push:function(a,b){a=this._prepareModel(a,b);this.add(a,b);return a},pop:function(a){var b=this.at(this.length-1);this.remove(b,a);return b},unshift:function(a,b){a=this._prepareModel(a,b);this.add(a,f.extend({at:0},b));return a},
shift:function(a){var b=this.at(0);this.remove(b,a);return b},get:function(a){return null==a?void 0:this._byId[null!=a.id?a.id:a]},getByCid:function(a){return a&&this._byCid[a.cid||a]},at:function(a){return this.models[a]},where:function(a){return f.isEmpty(a)?[]:this.filter(function(b){for(var c in a)if(a[c]!==b.get(c))return!1;return!0})},sort:function(a){a||(a={});if(!this.comparator)throw Error("Cannot sort a set without a comparator");var b=f.bind(this.comparator,this);1==this.comparator.length?
this.models=this.sortBy(b):this.models.sort(b);a.silent||this.trigger("reset",this,a);return this},pluck:function(a){return f.map(this.models,function(b){return b.get(a)})},reset:function(a,b){a||(a=[]);b||(b={});for(var c=0,d=this.models.length;c<d;c++)this._removeReference(this.models[c]);this._reset();this.add(a,f.extend({silent:!0},b));b.silent||this.trigger("reset",this,b);return this},fetch:function(a){a=a?f.clone(a):{};void 0===a.parse&&(a.parse=!0);var b=this,c=a.success;a.success=function(d,
e,f){b[a.add?"add":"reset"](b.parse(d,f),a);c&&c(b,d)};a.error=e.wrapError(a.error,b,a);return(this.sync||e.sync).call(this,"read",this,a)},create:function(a,b){var c=this;b=b?f.clone(b):{};a=this._prepareModel(a,b);if(!a)return!1;b.wait||c.add(a,b);var d=b.success;b.success=function(e,f,g){b.wait&&c.add(e,b);d?d(e,f):e.trigger("sync",a,f,b)};a.save(null,b);return a},parse:function(a,b){return a},chain:function(){return f(this.models).chain()},_reset:function(a){this.length=0;this.models=[];this._byId=
{};this._byCid={}},_prepareModel:function(a,b){b||(b={});a instanceof m?a.collection||(a.collection=this):(b.collection=this,a=new this.model(a,b),a._validate(a.attributes,b)||(a=!1));return a},_removeReference:function(a){this==a.collection&&delete a.collection;a.off("all",this._onModelEvent,this)},_onModelEvent:function(a,b,c,d){("add"==a||"remove"==a)&&c!=this||("destroy"==a&&this.remove(b,d),b&&a==="change:"+b.idAttribute&&(delete this._byId[b.previous(b.idAttribute)],this._byId[b.id]=b),this.trigger.apply(this,
arguments))}});f.each("forEach each map reduce reduceRight find detect filter select reject every all some any include contains invoke max min sortBy sortedIndex toArray size first initial rest last without indexOf shuffle lastIndexOf isEmpty groupBy".split(" "),function(a){q.prototype[a]=function(){return f[a].apply(f,[this.models].concat(f.toArray(arguments)))}});var r=e.Router=function(a){a||(a={});a.routes&&(this.routes=a.routes);this._bindRoutes();this.initialize.apply(this,arguments)},n=/:\w+/g,
p=/\*\w+/g,C=/[-[\]{}()+?.,\\^$|#\s]/g;f.extend(r.prototype,l,{initialize:function(){},route:function(a,b,c){e.history||(e.history=new u);f.isRegExp(a)||(a=this._routeToRegExp(a));c||(c=this[b]);e.history.route(a,f.bind(function(d){d=this._extractParameters(a,d);c&&c.apply(this,d);this.trigger.apply(this,["route:"+b].concat(d));e.history.trigger("route",this,b,d)},this));return this},navigate:function(a,b){e.history.navigate(a,b)},_bindRoutes:function(){if(this.routes){var a=[],b;for(b in this.routes)a.unshift([b,
this.routes[b]]);b=0;for(var c=a.length;b<c;b++)this.route(a[b][0],a[b][1],this[a[b][1]])}},_routeToRegExp:function(a){a=a.replace(C,"\\$&").replace(n,"([^/]+)").replace(p,"(.*?)");return RegExp("^"+a+"$")},_extractParameters:function(a,b){return a.exec(b).slice(1)}});var u=e.History=function(){this.handlers=[];f.bindAll(this,"checkUrl")},y=/^[#\/]/,z=/msie [\w.]+/;u.started=!1;f.extend(u.prototype,l,{interval:50,getHash:function(a){return(a=(a?a.location:window.location).href.match(/#(.*)$/))?a[1]:
""},getFragment:function(a,b){if(null==a)if(this._hasPushState||b){a=window.location.pathname;var c=window.location.search;c&&(a+=c)}else a=this.getHash();a.indexOf(this.options.root)||(a=a.substr(this.options.root.length));return a.replace(y,"")},start:function(a){if(u.started)throw Error("Backbone.history has already been started");u.started=!0;this.options=f.extend({},{root:"/"},this.options,a);this._wantsHashChange=!1!==this.options.hashChange;this._wantsPushState=!!this.options.pushState;this._hasPushState=
!(!this.options.pushState||!window.history||!window.history.pushState);a=this.getFragment();var b=document.documentMode;if(b=z.exec(navigator.userAgent.toLowerCase())&&(!b||7>=b))this.iframe=g('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(a);this._hasPushState?g(window).bind("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!b?g(window).bind("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,
this.interval));this.fragment=a;a=window.location;b=a.pathname==this.options.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!b)return this.fragment=this.getFragment(null,!0),window.location.replace(this.options.root+"#"+this.fragment),!0;this._wantsPushState&&(this._hasPushState&&b&&a.hash)&&(this.fragment=this.getHash().replace(y,""),window.history.replaceState({},document.title,a.protocol+"//"+a.host+this.options.root+this.fragment));if(!this.options.silent)return this.loadUrl()},
stop:function(){g(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl);clearInterval(this._checkUrlInterval);u.started=!1},route:function(a,b){this.handlers.unshift({route:a,callback:b})},checkUrl:function(a){a=this.getFragment();a==this.fragment&&this.iframe&&(a=this.getFragment(this.getHash(this.iframe)));if(a==this.fragment)return!1;this.iframe&&this.navigate(a);this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(a){var b=this.fragment=this.getFragment(a);return f.any(this.handlers,
function(a){if(a.route.test(b))return a.callback(b),!0})},navigate:function(a,b){if(!u.started)return!1;if(!b||!0===b)b={trigger:b};var c=(a||"").replace(y,"");this.fragment!=c&&(this._hasPushState?(0!=c.indexOf(this.options.root)&&(c=this.options.root+c),this.fragment=c,window.history[b.replace?"replaceState":"pushState"]({},document.title,c)):this._wantsHashChange?(this.fragment=c,this._updateHash(window.location,c,b.replace),this.iframe&&c!=this.getFragment(this.getHash(this.iframe))&&(b.replace||
this.iframe.document.open().close(),this._updateHash(this.iframe.location,c,b.replace))):window.location.assign(this.options.root+a),b.trigger&&this.loadUrl(a))},_updateHash:function(a,b,c){c?a.replace(a.toString().replace(/(javascript:|#).*$/,"")+"#"+b):a.hash=b}});var B=e.View=function(a){this.cid=f.uniqueId("view");this._configure(a||{});this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents()},F=/^(\S+)\s*(.*)$/,A="model collection el id attributes className tagName".split(" ");
f.extend(B.prototype,l,{tagName:"div",$:function(a){return this.$el.find(a)},initialize:function(){},render:function(){return this},remove:function(){this.$el.remove();return this},make:function(a,b,c){a=document.createElement(a);b&&g(a).attr(b);c&&g(a).html(c);return a},setElement:function(a,b){this.$el&&this.undelegateEvents();this.$el=a instanceof g?a:g(a);this.el=this.$el[0];!1!==b&&this.delegateEvents();return this},delegateEvents:function(a){if(a||(a=v(this,"events"))){this.undelegateEvents();
for(var b in a){var c=a[b];f.isFunction(c)||(c=this[a[b]]);if(!c)throw Error('Method "'+a[b]+'" does not exist');var d=b.match(F),e=d[1],d=d[2],c=f.bind(c,this),e=e+(".delegateEvents"+this.cid);""===d?this.$el.bind(e,c):this.$el.delegate(d,e,c)}}},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(a){this.options&&(a=f.extend({},this.options,a));for(var b=0,c=A.length;b<c;b++){var d=A[b];a[d]&&(this[d]=a[d])}this.options=a},_ensureElement:function(){if(this.el)this.setElement(this.el,
!1);else{var a=v(this,"attributes")||{};this.id&&(a.id=this.id);this.className&&(a["class"]=this.className);this.setElement(this.make(this.tagName,a),!1)}}});m.extend=q.extend=r.extend=B.extend=function(a,b){var c=D(this,a,b);c.extend=this.extend;return c};var h={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};e.sync=function(a,b,c){var d=h[a];c||(c={});var k={type:d,dataType:"json"};c.url||(k.url=v(b,"url")||E());if(!c.data&&b&&("create"==a||"update"==a))k.contentType="application/json",
k.data=JSON.stringify(b.toJSON());e.emulateJSON&&(k.contentType="application/x-www-form-urlencoded",k.data=k.data?{model:k.data}:{});if(e.emulateHTTP&&("PUT"===d||"DELETE"===d))e.emulateJSON&&(k.data._method=d),k.type="POST",k.beforeSend=function(a){a.setRequestHeader("X-HTTP-Method-Override",d)};"GET"!==k.type&&!e.emulateJSON&&(k.processData=!1);return g.ajax(f.extend(k,c))};e.wrapError=function(a,b,c){return function(d,e){e=d===b?e:d;a?a(b,e,c):b.trigger("error",b,e,c)}};var s=function(){},D=function(a,
b,c){var d;d=b&&b.hasOwnProperty("constructor")?b.constructor:function(){a.apply(this,arguments)};f.extend(d,a);s.prototype=a.prototype;d.prototype=new s;b&&f.extend(d.prototype,b);c&&f.extend(d,c);d.prototype.constructor=d;d.__super__=a.prototype;return d},v=function(a,b){return!a||!a[b]?null:f.isFunction(a[b])?a[b]():a[b]},E=function(){throw Error('A "url" property or function must be specified');}}).call(this);
var UndoManager=function(){function a(a){if(a){d=!0;if(void 0==a.f)throw Error("Undefined  function for command: "+a.m);a.f.apply(a.o,a.p);d=!1}}var b=[],c=-1,d=!1,e;return{register:function(a,g,k,l,m,q,r,n){d||(b.splice(c+1,b.length-c),b.push({undo:{o:a,f:g,p:k,m:l},redo:{o:m,f:q,p:r,m:n}}),c=b.length-1,e&&e())},setCallback:function(a){e=a},undo:function(){var d=b[c];d&&(a(d.undo),c-=1,e&&e())},redo:function(){var d=b[c+1];d&&(a(d.redo),c+=1,e&&e())},clear:function(){var a=b.length;b=[];c=-1;e&&
0<a&&e()},hasUndo:function(){return-1!==c},hasRedo:function(){return c<b.length-1},debugInfo:function(){return b}}},dbwm={Validation:function(a,b){this.value=b;this.name=void 0==a?"Value":a;this.valueNull=!0;void 0===b&&this.raise("is not defined");this.valueNull=null!=b?!1:!0;return this}};
dbwm.Validation.prototype={raise:function(a){throw Error(""+this.name+" "+a);},notNull:function(){!0==this.valueNull&&this.raise("is null.");return this},isFunction:function(){this.notNull();"function"!=typeof this.value&&this.raise("is not a function");return this}};dbwm.check=function(a,b){return new dbwm.Validation(b,a)};
var Model={init:function(){Backbone.sync=function(a,b,c){};Model.fuseBox.create({id:"ajax"});Model.fuseBox.create({id:"table_limit"})},makeSelectable:function(a){a.prototype.select=function(){this.set("selected",!0);this.trigger("selected",this)};a.prototype.isSelected=function(){void 0===this.get("selected")&&this.set("selected",!1);return this.get("selected")};a.prototype.deselect=function(){this.set("selected",!1);this.trigger("deselected",this)};a.prototype.attach=function(){!0!=this.get("attached")&&
(this.set("attached",!0),this.trigger("attached",this))};a.prototype.isAttached=function(){void 0===this.get("attached")&&this.set("attached",!1);return this.get("attached")};a.prototype.detach=function(){this.set("attached",!1);this.trigger("detached",this)}}};
Model.Selection=Backbone.Model.extend({initialize:function(a){this.set("selected_element",null);this.set("attached_elements",[])},getSelectedElement:function(){return this.get("selected_element")},getAttachedElements:function(){return this.get("attached_elements").slice(0)},selectElement:function(a){this.clearAll();this.set("selected_element",a);a.select();this.trigger("element_selected",a,this);this.set("attached_elements",[a]);a.attach();this.trigger("element_attached",a,this);this.triggerSelectionChanged()},
selectAndAttachElement:function(a){var b=this.get("selected_element");a!==b&&(null!==b&&(this.set("selected_element",null),b.deselect(),this.trigger("element_deselected",b,this)),this.set("selected_element",a),a.select(),this.trigger("element_selected",a,this),!1===a.isAttached()&&(b=this.get("attached_elements").slice(0),b.push(a),this.set("attached_elements",b),a.attach(),this.trigger("element_attached",a,this)))},attachElement:function(a){if(!1===a.isAttached()){var b=this.get("attached_elements").slice(0);
b.push(a);this.set("attached_elements",b);a.attach();this.trigger("element_attached",a,this);this.triggerSelectionChanged()}},deselectAndDetachElement:function(a){var b=this.get("selected_element"),c=this.get("attached_elements");null!==b&&b.get("id")===a.get("id")&&(this.set("selected_element",null),b.deselect(),this.trigger("element_deselected",b,this));for(b=0;b<c.length;b++){var d=c[b];if(d.get("id")===a.get("id")){c.splice(b,1);d.detach();this.trigger("element_detached",d,this);break}}this.triggerSelectionChanged()},
deselectCurrentElement:function(){var a=this.get("selected_element");null!==a&&(a.deselect(),this.set("selected_element",null),this.trigger("element_deselected",a,this),this.triggerSelectionChanged())},clearAll:function(){this.deselectCurrentElement();var a=this.get("attached_elements");if(0<a.length){this.set("attached_elements",[]);for(var b=0;b<a.length;b++)a[b].detach();this.trigger("elements_detached",a,this);this.triggerSelectionChanged()}},_doTriggerSelectionChanged:function(){Model.selection.trigger("selection-changed")},
triggerSelectionChanged:function(){Model.groupOperation.isInProgress()?Model.groupOperation.addOnRelease(Model.selection._doTriggerSelectionChanged):this._doTriggerSelectionChanged()}});
Model.DiagramMode=Backbone.Model.extend({SELECT_MODE:"select",SELECT_RECT_MODE:"select-rect",ADD_TABLE_MODE:"add-table",ADD_RELATIONSHIP_MODE:"add-relationship",ADD_NOTE_MODE:"add-note",ADD_VIEW_MODE:"add-view",ADD_AREA_MODE:"add-area",initialize:function(a){this.set("mode",this.SELECT_MODE)},mode:function(){return this.get("mode")},is:function(a){return a==this.mode()},setMode:function(a){this.set("mode",a)}});Model.diagramMode=new Model.DiagramMode;
Model.Fuse=Backbone.Model.extend({initialize:function(){this.set("ok",!0)},blow:function(){this.set("ok",!1)},ok:function(){return this.get("ok")},notOk:function(){return!1==this.get("ok")},fix:function(){this.set("ok",!0)}});Model.FuseBox=Backbone.Collection.extend({model:Model.Fuse});Model.fuseBox=new Model.FuseBox;Model.Counter=Backbone.Model.extend({initialize:function(a){}});Model.Counters=Backbone.Collection.extend({model:Model.Counter});Model.counters=new Model.Counters;
Model.nextId=function(a){var b=Model.counters.get(a);if(void 0==b||null==b)throw Error("No such counter: '"+a+"'.");a=b.get("value");a+=1;b.set("value",a);return b.get("prefix")+a};
Model.Column=Backbone.Model.extend({initialize:function(a){var b=this,c=new Model.Properties;void 0!=this.get("properties")&&(c=new Model.Properties(this.get("properties")));c.column=this;c.on("all",function(a){if("add"==a||"remove"==a||"reset"==a||"change"==a)b.trigger("change:properties",b,c),b.trigger("change",b)});this.set("properties",c)}});
Model.Columns=Backbone.Collection.extend({model:Model.Column,getOrder:function(){for(var a=[],b=this.length,c=0;c<b;c++){var d=this.at(c);a.push(d.get("id"))}return a},setOrder:function(a){for(var b={},c=this.length,d=0;d<c;d++){var e=this.pop({silent:!0});b[e.get("id")]=e}for(d=0;d<a.length;d++)e=b[a[d]],this.add(e,{silent:!0});this.trigger("change:order",this);this.owner.trigger("change:columns",this.owner,this);this.owner.trigger("change",this.owner)}});
Model.AlternateKey=Backbone.Model.extend({initialize:function(a){var b=this,c=new Model.Properties;void 0!=this.get("properties")&&(c=new Model.Properties(this.get("properties")));c.alternateKey=this;c.on("all",function(a){if("add"==a||"remove"==a||"reset"==a||"change"==a)b.trigger("change:properties",b,c),b.trigger("change",b)});this.set("properties",c)}});Model.AlternateKeys=Backbone.Collection.extend({model:Model.AlternateKey});
Model.Index=Backbone.Model.extend({initialize:function(a){var b=this,c=new Model.Properties;void 0!=this.get("properties")&&(c=new Model.Properties(this.get("properties")));c.alternateKey=this;c.on("all",function(a){if("add"==a||"remove"==a||"reset"==a||"change"==a)b.trigger("change:properties",b,c),b.trigger("change",b)});this.set("properties",c)}});Model.Indexes=Backbone.Collection.extend({model:Model.Index});
Model.TableCheck=Backbone.Model.extend({initialize:function(a){var b=this,c=new Model.Properties;void 0!=this.get("properties")&&(c=new Model.Properties(this.get("properties")));c.tableCheck=this;c.on("all",function(a){if("add"==a||"remove"==a||"reset"==a||"change"==a)b.trigger("change:properties",b,c),b.trigger("change",b)});this.set("properties",c)}});Model.TableChecks=Backbone.Collection.extend({model:Model.TableCheck});
Model.Table=Backbone.Model.extend({urlRoot:"/diagram-api/table",initialize:function(){this.set("inSearchResults",!1);this.set("selectedInSearchResults",!1);this.set("hasErrors",!1);this.set("hasWarnings",!1);this.set("hasHints",!1);var a=this,b=new Model.Columns;void 0!=this.get("columns")&&(b=new Model.Columns(this.get("columns")));b.owner=this;b.on("all",function(c){if("add"==c||"remove"==c||"reset"==c||"change"==c)a.trigger("change:columns",a,b),a.trigger("change",a)});this.set("columns",b);var c=
new Model.AlternateKeys;void 0!=this.get("alternateKeys")&&(c=new Model.AlternateKeys(this.get("alternateKeys")));c.owner=this;c.on("all",function(b){if("add"==b||"remove"==b||"reset"==b||"change"==b)a.trigger("change:alternateKeys",a,c),a.trigger("change",a)});this.set("alternateKeys",c);var d=new Model.Indexes;void 0!=this.get("indexes")&&(d=new Model.Indexes(this.get("indexes")));d.table=this;d.on("all",function(b){if("add"==b||"remove"==b||"reset"==b||"change"==b)a.trigger("change:indexes",a,
d),a.trigger("change",a)});this.set("indexes",d);var e=new Model.TableChecks;void 0!=this.get("tableChecks")&&(e=new Model.TableChecks(this.get("tableChecks")));e.table=this;e.on("all",function(b){if("add"==b||"remove"==b||"reset"==b||"change"==b)a.trigger("change:tableChecks",a,e),a.trigger("change",a)});this.set("tableChecks",e);var f=new Model.Properties;void 0!=this.get("properties")&&(f=new Model.Properties(this.get("properties")));f.table=this;f.on("all",function(b){if("add"==b||"remove"==b||
"reset"==b||"change"==b)a.trigger("change:properties",a,f),a.trigger("change",a)});this.set("properties",f)},setInSearchResults:function(){this.set("inSearchResults",!0);this.trigger("setInSearchResults",this);Model.tables.trigger("table_setInSearchResults",Model.tables,this)},unsetInSearchResults:function(){this.set("inSearchResults",!1);this.trigger("unsetInSearchResults",this);Model.tables.trigger("table_unsetInSearchResults",Model.tables,this)},createColumn:function(a,b){var c=Model.nextId("column"),
d=this.get("columns").size()+1;void 0==a&&(a="column_"+d);void 0==b&&(b=Model.databaseTypes.getDefaultType());c=new Model.Column({id:c,name:a,type:b,nullable:!1,pk:!1,description:"describe me please",default_value:"",check_expression:"",properties:[]});this.addColumn(c);return c},addColumn:function(a){var b=this.get("columns");b.add(a);this.trigger("change:columns",this,b)},getColumn:function(a){a=this.get("columns").where({name:a});return 0==a.length?null:a[0]},getPrimaryKeyColumns:function(){return this.get("columns").where({pk:!0})},
createAlternateKey:function(a){var b=Model.nextId("alternate_key"),c=this.get("alternateKeys").size()+1,d=this.get("name");void 0==a&&(a=d+"_ak_"+c);a=new Model.AlternateKey({id:b,name:a,description:"",columns:[],properties:[]});this.addAlternateKey(a);return a},addAlternateKey:function(a){var b=this.get("alternateKeys");b.add(a);this.trigger("change:alternateKeys",this,b)},createIndex:function(a){var b=Model.nextId("index"),c=this.get("indexes").size()+1;void 0==a&&(a="idx_"+c);a=new Model.Index({id:b,
name:a,description:"",columns:[],properties:[]});this.addIndex(a);return a},addIndex:function(a){var b=this.get("indexes");b.add(a);this.trigger("change:indexes",this,b)},createTableCheck:function(){var a=Model.nextId("table_check"),b="check_"+(this.get("tableChecks").size()+1),a=new Model.TableCheck({id:a,name:b,description:"",checkExpression:"",properties:[]});this.addTableCheck(a);return a},addTableCheck:function(a){var b=this.get("tableChecks");b.add(a);this.trigger("change:tableChecks",this,
b)},computeCenter:function(){return{x:this.get("x")+this.get("width")/2,y:this.get("y")+this.get("height")/2}},getContentOfColumnLines:function(){for(var a=[],b=this.get("columns"),c=Model.references.findFKReferences(this.get("id")),d=[],e=0;e<c.length;e++)for(var f=c[e].get("referenceColumns"),g=0;g<f.length;g++)d.push(f.at(g).get("fkColumnId"));for(e=0;e<b.size();e++){g=b.at(e);c=[];g.get("nullable")&&c.push("N");g.get("pk")&&c.push("PK");0<=d.indexOf(g.get("id"))&&c.push("FK");var c=c.join(" "),
f=g.get("type"),g=g.get("name"),k=[];k.push(g);k.push(f);k.push(c);a.push(k)}return a}});Model.Tables=Backbone.Collection.extend({model:Model.Table});Model.RCPType={};Model.RCPType.VERTICAL_2CP="Vertical_2CP";Model.RCPType.HORIZONTAL_2CP="Horizontal_2CP";Model.RCPType.VERTICAL_4CP="Vertical_4CP";Model.RCPType.HORIZONTAL_4CP="Horizontal_4CP";Model.RCPType.CROSS_3CP="Cross_3CP";Model.RCPType.SELF_4CP="Self_4CP";Model.RCPType.SELF_5CP="Self_5CP";Model.Point=Backbone.Model.extend({initialize:function(a){}});
Model.Points=Backbone.Collection.extend({model:Model.Point});Model.ReferenceColumn=Backbone.Model.extend({initialize:function(a){}});Model.ReferenceColumns=Backbone.Collection.extend({model:Model.ReferenceColumn});
Model.Reference=Backbone.Model.extend({initialize:function(){var a=this;new Model.Points;var b=new Model.ReferenceColumns;void 0!=this.get("referenceColumns")&&(b=new Model.ReferenceColumns(this.get("referenceColumns")));this.set("referenceColumns",b);this.set("inSearchResults",!1);this.set("selectedInSearchResults",!1);var c=new Model.Properties;void 0!=this.get("properties")&&(c=new Model.Properties(this.get("properties")));c.reference=this;c.on("all",function(b){if("add"==b||"remove"==b||"reset"==
b||"change"==b)a.trigger("change:properties",a,c),a.trigger("change",a)});this.set("properties",c);this.bindAllEvents()},triggerTables:function(a){var b=Model.tables.get(this.get("pkTableId")),c=Model.tables.get(this.get("fkTableId"));a=a?"reference_connected":"reference_disconnected";b.trigger(a,this);b.get("id")!=c.get("id")&&c.trigger(a,this)},bindAllEvents:function(){var a=this.get("referenceColumns"),b=Model.tables.get(this.get("pkTableId")),c=Model.tables.get(this.get("fkTableId")),d="Reference: "+
this.get("name");dbwm.check(b,d+" pkTable "+this.get("pkTableId")).notNull();dbwm.check(c,d+" fkTable "+this.get("fkTableId")).notNull();this.unbindAllEvents();this.bindChangeReferenceColumnsEvents(a)},unbindAllEvents:function(){var a=this.get("referenceColumns"),b=Model.tables.get(this.get("pkTableId")),c=Model.tables.get(this.get("fkTableId"));dbwm.check(b,"pkTable "+this.get("pkTableId")).notNull();dbwm.check(c,"fkTable "+this.get("fkTableId")).notNull();a.off(null,null,this)},bindChangeReferenceColumnsEvents:function(a){var b=
this;a.on("all",function(c){if("add"===c||"remove"===c||"reset"===c||"change"===c)b.trigger("change:referenceColumns",b,a),b.trigger("change",b)},b)},setInSearchResults:function(){this.set("inSearchResults",!0);this.trigger("setInSearchResults",this);Model.references.trigger("reference_setInSearchResults",Model.references,this)},unsetInSearchResults:function(){this.set("inSearchResults",!1);this.trigger("unsetInSearchResults",this);Model.references.trigger("reference_unsetInSearchResults",Model.references,
this)},swap:function(){for(var a=this.get("referenceColumns"),b=null,c=0;c<a.size();c++){var d=a.at(c),b=d.get("pkColumnId");d.set("pkColumnId",d.get("fkColumnId"));d.set("fkColumnId",b)}b=this.get("pkRole");this.set("pkRole",this.get("fkRole"));this.set("fkRole",b);b=this.get("pkTableId");this.set("pkTableId",this.get("fkTableId"));this.set("fkTableId",b);this.trigger("swap_reference")}});
Model.References=Backbone.Collection.extend({model:Model.Reference,url:"/diagram-api/reference",findFKReferences:function(a){return this.where({fkTableId:a})},triggerTables:function(){for(var a=0;a<this.size();a++)this.at(a).triggerTables(!0)}});
Model.Sequence=Backbone.Model.extend({initialize:function(a){this.set("inSearchResults",!1);this.set("selectedInSearchResults",!1);this.set("hasErrors",!1);this.set("hasWarnings",!1);this.set("hasHints",!1);var b=this,c=new Model.Properties;void 0!=this.get("properties")&&(c=new Model.Properties(this.get("properties")));c.owner=this;c.on("all",function(a){if("add"==a||"remove"==a||"reset"==a||"change"==a)b.trigger("change:properties",b,c),b.trigger("change",b)});this.set("properties",c)},setInSearchResults:function(){this.set("inSearchResults",
!0);this.trigger("setInSearchResults",this);Model.sequences.trigger("sequence_setInSearchResults",Model.sequences,this)},unsetInSearchResults:function(){this.set("inSearchResults",!1);this.trigger("unsetInSearchResults",this);Model.sequences.trigger("sequence_unsetInSearchResults",Model.sequences,this)}});Model.Sequences=Backbone.Collection.extend({model:Model.Sequence});Model.sequences=new Model.Sequences;
Model.Note=Backbone.Model.extend({initialize:function(a){this.set("inSearchResults",!1);this.set("selectedInSearchResults",!1);this.set("hasErrors",!1);this.set("hasWarnings",!1);this.set("hasHints",!1)},setInSearchResults:function(){this.set("inSearchResults",!0);this.trigger("setInSearchResults",this);Model.notes.trigger("note_setInSearchResults",Model.notes,this)},unsetInSearchResults:function(){this.set("inSearchResults",!1);this.trigger("unsetInSearchResults",this);Model.notes.trigger("note_unsetInSearchResults",
Model.notes,this)},moveTo:function(a,b,c){b=Model.Util.alignPoint({x:a,y:b});a=b.x;b=b.y;var d=a-this.get("x"),e=b-this.get("y");if(!this.has("oldx")||!this.has("oldy"))this.trigger("movestart",this,this.get("x"),this.get("y")),this.set("oldx",this.get("x")),this.set("oldy",this.get("y"));if(0!==d||0!==e)this.set("x",a),this.set("y",b),this.trigger("move",this,d,e);void 0!==c&&!0===c&&(this.trigger("moveend",this,this.get("oldx"),this.get("oldy"),this.get("x"),this.get("y")),this.unset("oldx"),this.unset("oldy"))},
resize:function(a,b){a=Math.floor(a);b=Math.floor(b);var c=this.get("width"),d=this.get("height"),e=a-this.get("width"),f=b-this.get("height");this.trigger("resizestart",this,this.get("width"),this.get("height"));this.set({width:a,height:b});this.trigger("resize",this,a,b,e,f);this.trigger("resizeend",this,c,d,this.get("width"),this.get("height"))},moveControlPointTo:function(a,b,c,d){var e=Model.Util.alignPoint({x:b,y:c});b=e.x;c=e.y;var e=this.get("width"),f=this.get("height");a===Diagram.NoteControlPointIndex.TOP_LEFT?
(e=this.get("width")+(this.get("x")-b),f=this.get("height")+(this.get("y")-c),this.moveTo(b,c,d)):a===Diagram.NoteControlPointIndex.TOP_RIGHT?(e=b-this.get("x"),f=this.get("height")+(this.get("y")-c),this.moveTo(this.get("x"),c,d)):a===Diagram.NoteControlPointIndex.BOTTOM_LEFT?(e=this.get("width")+(this.get("x")-b),f=c-this.get("y"),this.moveTo(b,this.get("y"),d)):a===Diagram.NoteControlPointIndex.BOTTOM_RIGHT&&(e=b-this.get("x"),f=c-this.get("y"));e=Math.floor(e);f=Math.floor(f);a=e-this.get("width");
b=f-this.get("height");if(!this.has("oldwidth")||!this.has("oldheight"))this.trigger("resizestart",this,this.get("width"),this.get("height")),this.set("oldwidth",this.get("width")),this.set("oldheight",this.get("height"));if(0!==a||0!==b)this.set("width",e),this.set("height",f),this.trigger("resize",this,e,f,a,b);void 0!==d&&!0===d&&(this.trigger("resizeend",this,this.get("oldwidth"),this.get("oldheight"),this.get("width"),this.get("height")),this.unset("oldwidth"),this.unset("oldheight"))},getPreviousCPPosition:function(a){var b,
c,d,e;b=this.has("oldx")?this.get("oldx"):this.get("x");c=this.has("oldy")?this.get("oldy"):this.get("y");d=this.has("oldwidth")?this.get("oldwidth"):this.get("width");e=this.has("oldheight")?this.get("oldheight"):this.get("height");if(a===Diagram.NoteControlPointIndex.TOP_LEFT)a=b;else if(a===Diagram.NoteControlPointIndex.TOP_RIGHT)a=b+d;else if(a===Diagram.NoteControlPointIndex.BOTTOM_LEFT)a=b,c+=e;else if(a===Diagram.NoteControlPointIndex.BOTTOM_RIGHT)a=b+d,c+=e;else throw"Unknown note index "+
a;return{x:a,y:c}},getMinWidth:function(){return 50},getMinHeight:function(){return 25},inArea:function(a){return this.get("x")<a.xmin||this.get("y")<a.ymin||this.get("x")+this.get("width")>a.xmax||this.get("y")+this.get("height")>a.ymax?!1:!0},computeCenter:function(){return{x:this.get("x")+this.get("width")/2,y:this.get("y")+this.get("height")/2}},getBoundaryRect:function(){return{xmin:this.get("x"),ymin:this.get("y"),xmax:this.get("x")+this.get("width"),ymax:this.get("y")+this.get("height")}}});
Model.Notes=Backbone.Collection.extend({model:Model.Note});Model.notes=new Model.Notes;Model.ViewColumn=Backbone.Model.extend({initialize:function(a){var b=this,c=new Model.Properties;void 0!=this.get("properties")&&(c=new Model.Properties(this.get("properties")));c.column=this;c.on("all",function(a){if("add"==a||"remove"==a||"reset"==a||"change"==a)b.trigger("change:properties",b,c),b.trigger("change",b)});this.set("properties",c)}});
Model.ViewColumns=Backbone.Collection.extend({model:Model.ViewColumn,getOrder:function(){for(var a=[],b=this.length,c=0;c<b;c++){var d=this.at(c);a.push(d.get("id"))}return a},setOrder:function(a){for(var b={},c=this.length,d=0;d<c;d++){var e=this.pop({silent:!0});b[e.get("id")]=e}for(d=0;d<a.length;d++)e=b[a[d]],this.add(e,{silent:!0});this.trigger("change:order",this);this.owner.trigger("change:columns",this.owner,this);this.owner.trigger("change",this.owner)}});
Model.View=Backbone.Model.extend({urlRoot:"/diagram-api/view",initialize:function(){this.set("inSearchResults",!1);this.set("selectedInSearchResults",!1);this.set("hasErrors",!1);this.set("hasWarnings",!1);this.set("hasHints",!1);var a=this,b=new Model.ViewColumns;void 0!=this.get("columns")&&(b=new Model.ViewColumns(this.get("columns")));b.owner=this;b.on("all",function(c){if("add"==c||"remove"==c||"reset"==c||"change"==c)a.trigger("change:columns",a,b),a.trigger("change",a)});this.set("columns",
b);var c=new Model.Properties;void 0!=this.get("properties")&&(c=new Model.Properties(this.get("properties")));c.view=this;c.on("all",function(b){if("add"==b||"remove"==b||"reset"==b||"change"==b)a.trigger("change:properties",a,c),a.trigger("change",a)});this.set("properties",c)},setInSearchResults:function(){this.set("inSearchResults",!0);this.trigger("setInSearchResults",this);Model.views.trigger("view_setInSearchResults",Model.views,this)},unsetInSearchResults:function(){this.set("inSearchResults",
!1);this.trigger("unsetInSearchResults",this);Model.views.trigger("view_unsetInSearchResults",Model.views,this)},createColumn:function(a,b){var c=Model.nextId("view_column"),d=this.get("columns").size()+1;void 0==a&&(a="column_"+d);void 0==b&&(b=Model.databaseTypes.getDefaultType());c=new Model.ViewColumn({id:c,name:a,type:b,description:"",properties:[]});this.addColumn(c);return c},addColumn:function(a){var b=this.get("columns");b.add(a);this.trigger("change:columns",this,b)},getColumn:function(a){a=
this.get("columns").where({name:a});return 0==a.length?null:a[0]},resetColumns:function(a){var b=this.get("columns");b.reset(a);this.trigger("change:columns",this,b)},resetDependencies:function(a){this.set("dependencies",a);this._updateMinHeight();this.trigger("change:dependencies",this,a)},getInsideMargin:function(){return 10},adjustPointToInsideMargin:function(a){var b=this.getBoundaryRect(),c=this.getInsideMargin();a={x:a.x,y:a.y};a.x<b.xmin+c&&(a.x=b.xmin+c);a.x>b.xmax-c&&(a.x=b.xmax-c);a.y<b.ymin+
c&&(a.y=b.ymin+c);a.y>b.ymax-c&&(a.y=b.ymax-c);return a},getContentOfColumnLines:function(){for(var a=[],b=this.get("columns"),c=0;c<b.size();c++){var d=b.at(c),e=[];e.push(d.get("name"));e.push(d.get("type"));a.push(e)}return a},checkDependencyCycle:function(){var a=[],b=[];for(b.push(this.get("id"));0<b.length;){var c=b.splice(0,1)[0];a.push(c);c=Model.views.where({id:c});if(1!=c.length)throw Error("View's dependency is non-existing view!");var c=c[0].get("dependencies"),d;for(d in c){var e=c[d];
if(e===a[0])throw Error("There's cycle of dependencies!");0>a.indexOf(e)&&b.push(e)}}}});Model.Views=Backbone.Collection.extend({model:Model.View});Model.views=new Model.Views;
Model.Area=Backbone.Model.extend({TOP_LEFT:1,TOP_RIGHT:2,BOTTOM_LEFT:3,BOTTOM_RIGHT:4,urlRoot:"/diagram-api/area",initialize:function(){},setInSearchResults:function(){this.set("inSearchResults",!0);this.trigger("setInSearchResults",this);Model.areas.trigger("area_setInSearchResults",Model.areas,this)},unsetInSearchResults:function(){this.set("inSearchResults",!1);this.trigger("unsetInSearchResults",this);Model.areas.trigger("area_unsetInSearchResults",Model.areas,this)},moveTo:function(a,b,c){b=
Model.Util.alignPoint({x:a,y:b});a=b.x;b=b.y;var d=a-this.get("x"),e=b-this.get("y");if(!this.has("oldx")||!this.has("oldy"))this.trigger("movestart",this,this.get("x"),this.get("y")),this.set("oldx",this.get("x")),this.set("oldy",this.get("y"));if(0!==d||0!==e)this.set("x",a),this.set("y",b),this.trigger("move",this,d,e);void 0!==c&&!0===c&&(this.trigger("moveend",this,this.get("oldx"),this.get("oldy"),this.get("x"),this.get("y")),this.unset("oldx"),this.unset("oldy"))},computeNameRelativePosition:function(){var a=
this.get("nameX"),b=this.get("nameY"),c=this.get("width")/2,d=this.get("height")/2;a>c?b>d?(c=this.BOTTOM_RIGHT,a=this.get("width")-a,b=this.get("height")-b):(c=this.TOP_RIGHT,a=this.get("width")-a,b=-b):b>d?(c=this.BOTTOM_LEFT,a=-a,b=this.get("height")-b):(c=this.TOP_LEFT,a=-a,b=-b);return{xDiff:a,yDiff:b,corner:c}},moveControlPointTo:function(a,b,c,d){var e=Model.Util.alignPoint({x:b,y:c});b=e.x;c=e.y;var e=this.get("width"),f=this.get("height");a===Diagram.AreaControlPointIndex.TOP_LEFT?(e=this.get("width")+
(this.get("x")-b),f=this.get("height")+(this.get("y")-c),this.moveTo(b,c,d)):a===Diagram.AreaControlPointIndex.TOP_RIGHT?(e=b-this.get("x"),f=this.get("height")+(this.get("y")-c),this.moveTo(this.get("x"),c,d)):a===Diagram.AreaControlPointIndex.BOTTOM_LEFT?(e=this.get("width")+(this.get("x")-b),f=c-this.get("y"),this.moveTo(b,this.get("y"),d)):a===Diagram.AreaControlPointIndex.BOTTOM_RIGHT&&(e=b-this.get("x"),f=c-this.get("y"));e=Math.floor(e);f=Math.floor(f);a=e-this.get("width");b=f-this.get("height");
if(!this.has("oldwidth")||!this.has("oldheight"))this.trigger("resizestart",this,this.get("width"),this.get("height")),this.set("oldwidth",this.get("width")),this.set("oldheight",this.get("height")),c=this.computeNameRelativePosition(),this.set("oldNameRelativePosition",c);if(0!==a||0!==b)this.set("width",e),this.set("height",f),c=this.get("oldNameRelativePosition"),c=this.getNewNamePos(c,e,f),this.set({nameX:c.nameX,nameY:c.nameY}),this.trigger("resize",this,e,f,a,b);void 0!==d&&!0===d&&(this.trigger("resizeend",
this,this.get("oldwidth"),this.get("oldheight"),this.get("width"),this.get("height")),this.unset("oldwidth"),this.unset("oldheight"),this.unset("oldNameRelativePosition"))},resize:function(a,b){a=Math.floor(a);b=Math.floor(b);var c=this.get("width"),d=this.get("height"),e=a-this.get("width"),f=b-this.get("height");this.trigger("resizestart",this,this.get("width"),this.get("height"));var g=computeNameRelativePosition();this.set({width:a,height:b});g=getNewNamePos(g,a,b);this.set({nameX:g.nameX,nameY:g.nameY});
this.trigger("resize",this,a,b,e,f);this.trigger("resizeend",this,c,d,this.get("width"),this.get("height"))},getNewNamePos:function(a,b,c){var d,e;a.corner===this.BOTTOM_RIGHT?(d=b-a.xDiff,e=c-a.yDiff):a.corner===this.TOP_RIGHT?(d=b-a.xDiff,e=-a.yDiff):a.corner===this.BOTTOM_LEFT?(d=-a.xDiff,e=c-a.yDiff):a.corner===this.TOP_LEFT&&(d=-a.xDiff,e=-a.yDiff);return{nameX:d,nameY:e}},getMinWidth:function(){return Model.Area.MIN_WIDTH},getMinHeight:function(){return Model.Area.MIN_HEIGHT},getPreviousCPPosition:function(a){var b,
c,d,e;b=this.has("oldx")?this.get("oldx"):this.get("x");c=this.has("oldy")?this.get("oldy"):this.get("y");d=this.has("oldwidth")?this.get("oldwidth"):this.get("width");e=this.has("oldheight")?this.get("oldheight"):this.get("height");if(a===Diagram.AreaControlPointIndex.TOP_LEFT)a=b;else if(a===Diagram.AreaControlPointIndex.TOP_RIGHT)a=b+d;else if(a===Diagram.AreaControlPointIndex.BOTTOM_LEFT)a=b,c+=e;else if(a===Diagram.AreaControlPointIndex.BOTTOM_RIGHT)a=b+d,c+=e;else throw"Unknown area index "+
a;return{x:a,y:c}},inArea:function(a){return this.get("x")<a.xmin||this.get("y")<a.ymin||this.get("x")+this.get("width")>a.xmax||this.get("y")+this.get("height")>a.ymax?!1:!0},computeCenter:function(){return{x:this.get("x")+this.get("width")/2,y:this.get("y")+this.get("height")/2}},moveAreaName:function(a,b){this.set("nameX",a);this.set("nameY",b);this.trigger("move:name",this,this.get("nameX"),this.get("nameY"))},moveToTop:function(){var a=this.get("zIndex"),b=Model.areas.getMaxZIndex();b!=a&&this.set("zIndex",
b+1);this.trigger("change:moveToTop",this)},moveToBottom:function(){var a=this.get("zIndex"),b=_.map(Model.areas.models,function(a){return a.get("zIndex")}),b=_.reduce(b,function(a,b){return Math.min(a,b)},a);b!=a&&this.set("zIndex",b-1);this.trigger("change:moveToBottom",this)},moveUp:function(){var a=this.get("zIndex"),b=_.reduce(Model.areas.models,function(b,c){var f=b.zIndex,g=c.get("zIndex");if(g>a){if(null==f||g<f)return{zIndex:g,ids:[c.get("id")]};if(g==f)return g=b.ids.push(c.get("id")),{zIndex:f,
ids:g}}return b},{zIndex:null,ids:[]}),c=b.zIndex,b=b.ids;if(null!=c){this.set("zIndex",c);for(c=0;c<b.length;c++)Model.areas.get(b[c]).set("zIndex",a);this.trigger("change:moveUp",this)}},moveDown:function(){var a=this.get("zIndex"),b=_.reduce(Model.areas.models,function(b,c){var f=b.zIndex,g=c.get("zIndex");if(g<a){if(null==f||g>f)return{zIndex:g,ids:[c.get("id")]};if(g==f)return g=b.ids.push(c.get("id")),{zIndex:f,ids:g}}return b},{zIndex:null,ids:[]}),c=b.zIndex,b=b.ids;if(null!=c){this.set("zIndex",
c);for(c=0;c<b.length;c++)Model.areas.get(b[c]).set("zIndex",a);this.trigger("change:moveDown",this)}},setZIndex:function(a){this.set("zIndex",a);this.trigger("change:setZIndex",this)},getArea:function(){var a=this.get("x"),b=a+this.get("width"),c=this.get("y"),d=c+this.get("height");return{xmin:a,ymin:c,xmax:b,ymax:d}},getBoundaryRect:function(){return{xmin:this.get("x"),ymin:this.get("y"),xmax:this.get("x")+this.get("width"),ymax:this.get("y")+this.get("height")}}});Model.Area.MIN_HEIGHT=50;
Model.Area.MIN_WIDTH=50;
Model.Areas=Backbone.Collection.extend({model:Model.Area,getMaxZIndex:function(){var a=_.map(this.models,function(a){return a.get("zIndex")});return 0===a.length?0:_.reduce(a,function(a,c){return Math.max(a,c)},0)},getNextZIndex:function(){return this.getMaxZIndex()+1},getTableDisplayAreas:function(a){a=Model.tableDisplays.where({modelId:a});for(var b=[],c=0;c<this.models.length;c++){for(var d=this.models[c],e=!1,f=0;f<a.length;f++)a[f].inArea(d.getArea())&&(e=!0);e&&b.push(d)}return b},getTableDisplaysOutsideAreas:function(a){a=
Model.tableDisplays.where({modelId:a});for(var b=[],c=0;c<a.length;c++){for(var d=a[c],e=!0,f=0;f<this.models.length;f++)d.inArea(this.models[f].getArea())&&(e=!1);e&&b.push(d)}return b},getReferenceDisplayAreas:function(a){a=Model.referenceDisplays.where({modelId:a});for(var b=[],c=0;c<this.models.length;c++){for(var d=this.models[c],e=!1,f=0;f<a.length;f++)a[f].inArea(d.getArea())&&(e=!0);e&&b.push(d)}return b},getReferenceDisplaysOutsideAreas:function(a){a=Model.referenceDisplays.where({modelId:a});
for(var b=[],c=0;c<a.length;c++){for(var d=a[c],e=!0,f=0;f<this.models.length;f++)d.inArea(this.models[f].getArea())&&(e=!1);e&&b.push(d)}return b},getViewDisplayAreas:function(a){a=Model.viewDisplays.where({modelId:a});for(var b=[],c=0;c<this.models.length;c++){for(var d=this.models[c],e=!1,f=0;f<a.length;f++)a[f].inArea(d.getArea())&&(e=!0);e&&b.push(d)}return b},getViewDisplaysOutsideAreas:function(a){a=Model.viewDisplays.where({modelId:a});for(var b=[],c=0;c<a.length;c++){for(var d=a[c],e=!0,
f=0;f<this.models.length;f++)d.inArea(this.models[f].getArea())&&(e=!1);e&&b.push(d)}return b}});Model.createReference=function(a,b){return Model.references.create({id:Model.nextId("reference"),name:b.get("name")+"_"+a.get("name"),description:"",pkTableId:a.get("id"),fkTableId:b.get("id"),pkRole:"",fkRole:"",referenceColumns:[],cardinality:"0..*",onUpdateAction:"None",onDeleteAction:"None",mandatory:!0,properties:[]})};Model.AvailableAdditionalProperty=Backbone.Model.extend({initialize:function(a){}});
Model.AvailableAdditionalProperties=Backbone.Collection.extend({model:Model.AvailableAdditionalProperty});Model.availableTableProperties=new Model.AvailableAdditionalProperties;Model.availableColumnProperties=new Model.AvailableAdditionalProperties;Model.availableAlternateKeyProperties=new Model.AvailableAdditionalProperties;Model.availableIndexProperties=new Model.AvailableAdditionalProperties;Model.availableTableCheckProperties=new Model.AvailableAdditionalProperties;
Model.availableSequenceProperties=new Model.AvailableAdditionalProperties;Model.availableReferenceProperties=new Model.AvailableAdditionalProperties;Model.availableViewProperties=new Model.AvailableAdditionalProperties;Model.availableViewColumnProperties=new Model.AvailableAdditionalProperties;Model.Property=Backbone.Model.extend({initialize:function(a){}});Model.Properties=Backbone.Collection.extend({model:Model.Property});Model.properties=new Model.Properties;Model.tables=new Model.Tables;
Model.references=new Model.References;Model.references.on("remove",function(a){a.unbindAllEvents()});Model.references.on("add",function(a){a.bindAllEvents()});Model.areas=new Model.Areas;
Model.DatabaseTypeParsed=function(a){this.original=a;var b=/^([a-zA-Z0-9 ]+)\(([0-9%]+)\)$/,b=b.exec(a);if(null!=b)return this.type=b[1].toLowerCase(),this.len=b[2],this.prec=null,this;b=/^([a-zA-Z0-9 ]+)\(([0-9%]+),([0-9%]+)\)$/;b=b.exec(a);if(null!=b)return this.type=b[1].toLowerCase(),this.len=b[2],this.prec=b[3],this;b=/^([a-zA-Z0-9 ]+)\(([0-9%]+)\)([a-zA-Z0-9 ]+)\(([0-9%]+)\)$/;b=b.exec(a);if(null!=b)return this.type=(b[1]+" "+b[3]).replace(/\s+/g," ").toLowerCase(),this.len=b[2],this.prec=b[4],
this;b=/^([a-zA-Z0-9 ]+)\(([0-9%]+)\)([a-zA-Z0-9 ]+)$/;b=b.exec(a);if(null!=b)return this.type=(b[1]+" "+b[3]).replace(/\s+/g," ").toLowerCase(),this.len=b[2],this.prec=null,this;this.type=a.toLowerCase();this.prec=this.len=null;return this};Model.DatabaseTypeParsed.prototype={render:function(){var a=this.type;null!=this.len&&(a=a+"("+this.len);null!=this.prec&&(a+=",",a+=this.prec);null!=this.len&&(a+=")");return a}};
Model.DatabaseType=Backbone.Model.extend({isSimilar:function(a){var b=this.get("parsed");return b.type!=a.type||null!=b.len&&null==a.len||null==b.len&&null!=a.len||null!=b.prec&&null==a.prec||null==b.prec&&null!=a.prec?!1:!0}});
Model.DatabaseTypes=Backbone.Collection.extend({model:Model.DatabaseType,initialize:function(a){var b=this;this.on("reset",function(){for(var a=0;a<b.size();a++)b.at(a).set("parsed",new Model.DatabaseTypeParsed(b.at(a).get("type")))})},isSupported:function(a){a=new Model.DatabaseTypeParsed(a);for(var b=0;b<this.size();b++)if(this.at(b).isSimilar(a))return!0;return!1},getDefaultType:function(){return Model.databaseTypes.where({isVisible:!0})[0].get("type")},getCanonicalType:function(a){for(var b=new Model.DatabaseTypeParsed(a),
c=0;c<Model.databaseTypes.models.length;c++){var d=Model.databaseTypes.models[c];if(d.isSimilar(b)){a=d.get("canonicalTypePattern");a=a.replace("%",b.len);a=a.replace("%",b.prec);break}}return a},getFkType:function(a){for(var b=new Model.DatabaseTypeParsed(a),c=0;c<Model.databaseTypes.models.length;c++){var d=Model.databaseTypes.models[c];if(d.isSimilar(b))if(b=d.get("fkType"),null==b)break;else return b}return a}});Model.databaseTypes=new Model.DatabaseTypes;Model.SupportedObjectType=Backbone.Model.extend({});
Model.SupportedObjectTypes=Backbone.Collection.extend({model:Model.SupportedObjectType,has:function(a){return void 0!=this.get(a)},maxNameLength:function(a){return this.has(a)?parseInt(this.get(a).get("nameLength"),10):null}});Model.supportedObjectTypes=new Model.SupportedObjectTypes;Model.DatabaseModel=Backbone.Model.extend({});Model.DatabaseModels=Backbone.Collection.extend({model:Model.DatabaseModel});Model.databaseModels=new Model.DatabaseModels;Model.ModelVersion=Backbone.Model.extend({});
Model.ModelVersions=Backbone.Collection.extend({model:Model.ModelVersion});Model.modelVersions=new Model.ModelVersions;Model.MetaInfo=Backbone.Model.extend({initialize:function(a){},isEditable:function(){return"edit"==this.get("mode")},isReadOnly:function(){return!this.isEditable()}});Model.metaInfo=new Model.MetaInfo;Model.DiagramProperties=Backbone.Model.extend({});Model.diagramProperties=new Model.DiagramProperties;
Model.ApplicationProperties=Backbone.Model.extend({initialize:function(a){a=sessionStorage.getItem("display-left-panel");a=void 0==a||null==a?!0:"true"==a;var b=sessionStorage.getItem("display-right-panel"),b=void 0==b||null==b?!0:"true"==b;this.on("change:display-left-panel",this.saveDisplayPanel);this.on("change:display-right-panel",this.saveDisplayPanel);this.set({"display-left-panel":a,"display-right-panel":b});this.set({saveStatus:"ok"});this.set({dirtyModel:!1});this.set({loadCounter:0});this.set({saveInProgress:!1});
this.set({saveStatus:"ok"})},saveDisplayPanel:function(){sessionStorage.setItem("display-right-panel",this.get("display-right-panel"));sessionStorage.setItem("display-left-panel",this.get("display-left-panel"))}});Model.applicationProperties=new Model.ApplicationProperties;
Model.ValidationProperties=Backbone.Model.extend({key:function(a,b,c){return a+"_"+b+"_"+c.replace(/[^a-zA-Z]/g,"_")},setEnabled:function(a,b,c,d){this.set(this.key(a,b,c),d)},isEnabled:function(a,b,c){a=this.get(this.key(a,b,c));return void 0==a||null==a?!0:a}});Model.validationProperties=new Model.ValidationProperties;
Model.GoTo=Backbone.Model.extend({goTo:function(a,b){var c="goto";this.trigger("goto",a);for(var d=a.split("/"),e=0;e<d.length;e+=2){var f=d[e+1],c=c+"_"+d[e];this.trigger(c,f)}this.trigger(c+"/"+b,d[d.length-1])}});Model.goTo=new Model.GoTo;
Model.getById=function(a){var b=a.substring(0,1),c=null;"t"==b?c=Model.tables.get(a):"r"==b?c=Model.references.get(a):"s"==b?c=Model.sequences.get(a):"v"==b?c=Model.views.get(a):"td"==b?c=Model.tableDisplays.get(a):"rd"==b?c=Model.referenceDisplays.get(a):"vd"==b?c=Model.viewDisplays.get(a):"n"==b&&(c=Model.notes.get(a));return c};
Model.toJSON=function(){for(var a={tables:[],references:[],sequences:[],notes:[],counters:[],views:[],areas:[],tableDisplays:[],viewDisplays:[],referenceDisplays:[]},b=0;b<Model.tables.size();b++)a.tables.push(Model.tables.at(b).toJSON());for(b=0;b<Model.references.size();b++)a.references.push(Model.references.at(b).toJSON());for(b=0;b<Model.sequences.size();b++)a.sequences.push(Model.sequences.at(b).toJSON());for(b=0;b<Model.notes.size();b++)a.notes.push(Model.notes.at(b).toJSON());for(b=0;b<Model.counters.size();b++)a.counters.push(Model.counters.at(b).toJSON());
for(b=0;b<Model.views.size();b++)a.views.push(Model.views.at(b).toJSON());for(b=0;b<Model.areas.size();b++)a.areas.push(Model.areas.at(b).toJSON());for(b=0;b<Model.tableDisplays.size();b++)a.tableDisplays.push(Model.tableDisplays.at(b).toJSON());for(b=0;b<Model.viewDisplays.size();b++)a.viewDisplays.push(Model.viewDisplays.at(b).toJSON());for(b=0;b<Model.referenceDisplays.size();b++)a.referenceDisplays.push(Model.referenceDisplays.at(b).toJSON());a.diagramProperties=Model.diagramProperties.toJSON();
a.validationProperties=Model.validationProperties.toJSON();void 0!=Model.properties.get("additionalSQLBeforeCreate")&&(a.additionalSQLBeforeCreate=Model.properties.get("additionalSQLBeforeCreate").get("value"));void 0!=Model.properties.get("additionalSQLAfterCreate")&&(a.additionalSQLAfterCreate=Model.properties.get("additionalSQLAfterCreate").get("value"));void 0!=Model.properties.get("additionalSQLBeforeDrop")&&(a.additionalSQLBeforeDrop=Model.properties.get("additionalSQLBeforeDrop").get("value"));
void 0!=Model.properties.get("additionalSQLAfterDrop")&&(a.additionalSQLAfterDrop=Model.properties.get("additionalSQLAfterDrop").get("value"));a.modelProperties=Model.properties.toJSON();return a};
Model.initialize=function(a){var b=0==Model.supportedObjectTypes.size();Model.properties.reset(a.modelProperties);Model.properties.add(new Model.Property({id:"additionalSQLBeforeCreate",value:a.additionalSQLBeforeCreate}));Model.properties.add(new Model.Property({id:"additionalSQLAfterCreate",value:a.additionalSQLAfterCreate}));Model.properties.add(new Model.Property({id:"additionalSQLBeforeDrop",value:a.additionalSQLBeforeDrop}));Model.properties.add(new Model.Property({id:"additionalSQLAfterDrop",
value:a.additionalSQLAfterDrop}));Model.tables.reset(a.tables);Model.tableDisplays.reset(a.tableDisplays);Model.references.reset(a.references);Model.referenceDisplays.reset(a.referenceDisplays);Model.references.triggerTables();Model.sequences.reset(a.sequences);Model.notes.reset(a.notes);Model.counters.reset(a.counters);Model.views.reset(a.views);Model.viewDisplays.reset(a.viewDisplays);Model.databaseTypes.reset(a.databaseTypes);if(!1==Model.metaInfo.isReadOnly()||b)console.log("setting diagram properties"),
Model.diagramProperties.set(a.diagramProperties);Model.areas.reset(a.areas);Model.availableTableProperties.reset(a.properties.table);Model.availableColumnProperties.reset(a.properties.column);Model.availableAlternateKeyProperties.reset(a.properties.alternate_key);Model.availableIndexProperties.reset(a.properties.index);Model.availableTableCheckProperties.reset(a.properties.table_check);Model.availableSequenceProperties.reset(a.properties.sequence);Model.availableReferenceProperties.reset(a.properties.reference);
Model.availableViewProperties.reset(a.properties.view);Model.availableViewColumnProperties.reset(a.properties.view_column);Model.supportedObjectTypes.reset(a.supportedObjectTypes);Model.validationProperties.set(a.validationProperties);Model.updateToSaveModel();Model.metaInfo.set("modelLoad",!0);Model.metaInfo.set(a.metaInfo)};Model.setup={loadModelVersions:!1,loadDatabaseModels:!1,startMetaInfoUpdater:!1,usePublicModelLink:!1,useAdminModelLink:!1,isSaveEnabled:!1};
Model.loadDatabaseModels=function(){!1!=Model.setup.loadDatabaseModels&&$.ajax({type:"GET",url:"/diagram-api/models",dataType:"json"}).done(function(a){Model.databaseModels.reset(a)})};Model.loadModelVersions=function(){if(!1!=Model.setup.loadModelVersions){var a="/diagram-api/version/"+Model.metaInfo.get("id");Model.setup.useAdminModelLink&&(a="/diagram-api/adminVersion/"+Model.metaInfo.get("id"));$.ajax({type:"GET",url:a,dataType:"json"}).done(function(a){Model.modelVersions.reset(a)})}};
Model.load=function(a,b){var c=Model.setup.useAdminModelLink?"/diagram-api/admin_model/"+a:Model.setup.usePublicModelLink?"/diagram-api/public_model/"+a:"/diagram-api/model/"+a;b&&(c=c+"/"+b);Model.metaInfo.trigger("before-load");var d=(new Date).getTime();$.ajax({type:"GET",url:c,dataType:"json"}).done(function(a){Model.metaInfo.trigger("during-load-after-request");Model.doWithTimeout(function(){Model.groupOperation.doWithLock(function(){Model.initialize(a);Model.loadModelVersions()});Model.metaInfo.trigger("during-load-after-model-init");
Model.doWithTimeout(function(){void 0!==app.getDiagram()&&app.getDiagram().redrawDiagram();var a=Model.applicationProperties.get("loadCounter"),a=a+1;Model.applicationProperties.set("loadCounter",a);Model.metaInfo.trigger("after-load");1==a&&Model.metaInfo.trigger("after-initial-load");a=((new Date).getTime()-d)/1E3;logger.info("Model LOAD time: "+a+" Model: "+Model.metaInfo.get("id"))})})});Model.loadDatabaseModels()};Model.doWithTimeout=function(a){setTimeout(a,50)};
Model.reload=function(){var a=Model.metaInfo.get("id"),b=Model.metaInfo.get("versionId");void 0!=a&&Model.load(a,b)};Model.reloadToLatestVersion=function(){var a=Model.metaInfo.get("id");void 0!=a&&Model.load(a)};
Model.loadMetaInfo=function(){var a=Model.metaInfo.get("id");if(void 0!=a){var b="/diagram-api/metaInfo/"+a;Model.setup.useAdminModelLink?b="/diagram-api/adminMetaInfo/"+a:Model.setup.usePublicModelLink&&(b="/diagram-api/publicMetaInfo/"+a);$.ajax({type:"GET",url:b,dataType:"json"}).done(function(a){Model.metaInfo.set("modelLoad",!1);Model.metaInfo.set(a.metaInfo)})}};Model.metaInfoUpdaterInterval=5E3;
Model.startMetaInfoUpdater=function(){!1!=Model.setup.startMetaInfoUpdater&&$(function(){function a(){Model.loadMetaInfo();setTimeout(a,Model.metaInfoUpdaterInterval)}a()})};Model.takeControl=function(){var a=Model.metaInfo.get("id");void 0!=a&&$.ajax({type:"GET",url:"/diagram-api/takeControl/"+a,dataType:"json"}).done(function(a){Model.metaInfo.set("modelLoad",!1);Model.metaInfo.set(a.metaInfo)})};
Model.releaseControl=function(){var a=Model.metaInfo.get("id");void 0!=a&&$.ajax({type:"GET",url:"/diagram-api/releaseControl/"+a,dataType:"json"}).done(function(a){Model.metaInfo.set("modelLoad",!1);Model.metaInfo.set(a.metaInfo)})};
Model.tagVersion=function(a,b,c){var d=Model.metaInfo.get("id");void 0!=d&&(a=JSON.stringify({modelId:d,versionId:Model.metaInfo.get("versionId"),tag:a}),$.ajax({type:"POST",url:"/diagram-api/tagVersion/"+d,dataType:"json",data:a,processData:!1,async:!0,contentType:"application/json",dataType:"json"}).done(function(a){!0==a.alreadyExists?c():b()}))};Model.toSaveModel=null;Model.dirty=!1;Model.autosaverInterval=1E4;
Model.internalSave=function(a,b){if("read_only_edit_no_longer"!=Model.metaInfo.get("mode")&&!0==Model.metaInfo.isReadOnly()||!1==Model.setup.isSaveEnabled||Model.fuseBox.get("ajax").notOk())return!1;if(null==Model.toSaveModel)return console.log("Model.toSaveModel is null."),!1;var c=Model.metaInfo.get("id");console.time("toJSON");var d=Model.toSaveModel;d.operation=b;d=JSON.stringify(d);Model.applicationProperties.set("saveInProgress",!0);Model.applicationProperties.trigger("before-save");var e=(new Date).getTime();
$.ajax({type:"POST",url:"/diagram-api/model/"+c,data:d,processData:!1,async:!a,contentType:"application/json",dataType:"json"}).done(function(a){Model.applicationProperties.set("saveStatus",a.status);a.versionId&&Model.metaInfo.set("versionId",a.versionId);"ok"==a.status&&Model.fuseBox.get("table_limit").fix();"table_limit_reached"==a.status&&Model.fuseBox.get("table_limit").blow();"not_editor"==a.status&&console.log("You're not an editor. Not saved.");Model.dirty=!1;Model.applicationProperties.set("dirtyModel",
!1);Model.applicationProperties.set("saveInProgress",!1);Model.applicationProperties.trigger("after-save");a=((new Date).getTime()-e)/1E3;logger.info("Model SAVE time: "+a+" Model: "+Model.metaInfo.get("id"));5<a&&logger.performanceWarning("Saving model took "+a+" seconds")});return!0};Model.save=function(a){Model.touch();Model.internalSave(!1,a)};Model.autosave=function(){Model.internalSave(!1)};Model.updateToSaveModel=function(){Model.toSaveModel=Model.toJSON()};
Model.touch=function(){Model.applicationProperties.set("dirtyModel",!0);Model.dirty=!0;Model.updateToSaveModel()};Model.startAutosaver=function(){var a=this;$(function(){function b(){Model.dirty&&a.autosave();setTimeout(b,Model.autosaverInterval)}b()})};Model.makeSelectable(Model.Table);Model.makeSelectable(Model.Reference);Model.makeSelectable(Model.Sequence);Model.makeSelectable(Model.Note);Model.makeSelectable(Model.View);Model.makeSelectable(Model.Area);Model.selection=new Model.Selection;
Model.clearSearchResults=function(){for(var a=0;a<Model.tables.size();a++)Model.tables.at(a).unsetInSearchResults();for(a=0;a<Model.tableDisplays.size();a++)Model.tableDisplays.at(a).unsetInSearchResults();for(a=0;a<Model.references.size();a++)Model.references.at(a).unsetInSearchResults();for(a=0;a<Model.referenceDisplays.size();a++)Model.referenceDisplays.at(a).unsetInSearchResults();for(a=0;a<Model.sequences.size();a++)Model.sequences.at(a).unsetInSearchResults();for(a=0;a<Model.notes.size();a++)Model.notes.at(a).unsetInSearchResults();
for(a=0;a<Model.views.size();a++)Model.views.at(a).unsetInSearchResults();for(a=0;a<Model.viewDisplays.size();a++)Model.viewDisplays.at(a).unsetInSearchResults();for(a=0;a<Model.areas.size();a++)Model.areas.at(a).unsetInSearchResults()};Model.tableInSearchResults=function(a){a.setInSearchResults()};Model.referenceInSearchResults=function(a){a.setInSearchResults()};Model.sequenceInSearchResults=function(a){a.setInSearchResults()};Model.noteInSearchResults=function(a){a.setInSearchResults()};
Model.viewInSearchResults=function(a){a.setInSearchResults()};Model.areaInSearchResults=function(a){a.setInSearchResults()};
Model.GroupOperation=Backbone.Model.extend({releaseQueue:[],initialize:function(){this._isLockedFlag=!1;this.releaseQueue=[]},_isLocked:function(){return this._isLockedFlag},_lock:function(){this._isLockedFlag=!0},_release:function(){this._isLockedFlag=!1;_.each(this.releaseQueue,function(a){a()});this.releaseQueue=[]},doWithLock:function(a){if(this.isInProgress())a();else{this._lock();try{a()}finally{this._release()}}},isInProgress:function(){return this._isLocked()},addOnRelease:function(a){-1==
_.indexOf(this.releaseQueue,a)&&this.releaseQueue.push(a)}});Model.groupOperation=new Model.GroupOperation;Model.Util={alignPoint:function(a){return{x:Math.floor(a.x)+0.5,y:Math.floor(a.y)+0.5}}};Model.Problem=Backbone.Model.extend({});Model.Problems=Backbone.Collection.extend({model:Model.Problem});
Model.ProblemReport=Backbone.Model.extend({initialize:function(a){a=new Model.Problems;void 0!=this.get("errors")&&(a=new Model.Problems(this.get("errors")));this.set("errors",a);a=new Model.Problems;void 0!=this.get("warnings")&&(a=new Model.Problems(this.get("warnings")));this.set("warnings",a);a=new Model.Problems;void 0!=this.get("hints")&&(a=new Model.Problems(this.get("hints")));this.set("hints",a)}});Model.ProblemReports=Backbone.Collection.extend({model:Model.ProblemReport});
Model.problemReports=new Model.ProblemReports;Model.Validation={};
Model.Validation.Validator={dirty:!1,lastTouch:0,asyncInterval:1E3,asyncSafePeriod:2E3,touch:function(){this.dirty=!0;this.lastTouch=(new Date).getTime();Model.Validation.triggerWorker()},startAsyncValidator:function(){var a=this;$(function(){function b(){var c=(new Date).getTime();a.lastTouch+a.asyncSafePeriod<c&&a.dirty&&(a.dirty=!1,a.validateModel());setTimeout(b,a.asyncInterval)}b()})},validateModel:function(){Model.Validation.Cache={};this.validateTables(Model.tables);this.validateReferences(Model.references);
this.validateSequences(Model.sequences);this.validateViews(Model.views);Model.problemReports.trigger("after_validation")},validateTables:function(a){a.trigger("before_validation");for(var b=0;b<a.size();b++)this.validateTable(a.at(b));a.trigger("after_validation")},validateTable:function(a){var b="table/"+a.get("id"),c={errors:new Model.Problems,warnings:new Model.Problems,hints:new Model.Problems};this.validate(b,[a],"table",c);for(var d=a.get("columns"),b=0;b<d.size();b++){var e=d.at(b),f="table/"+
a.get("id")+"/column/"+e.get("id");this.validate(f,[a,e],"table_column",c)}d=a.get("indexes");for(b=0;b<d.size();b++)e=d.at(b),f="table/"+a.get("id")+"/index/"+e.get("id"),this.validate(f,[a,e],"table_index",c);d=a.get("alternateKeys");for(b=0;b<d.size();b++)e=d.at(b),f="table/"+a.get("id")+"/alternate_key/"+e.get("id"),this.validate(f,[a,e],"table_alternate_key",c);d=a.get("tableChecks");for(b=0;b<d.size();b++)e=d.at(b),f="table/"+a.get("id")+"/table_check/"+e.get("id"),this.validate(f,[a,e],"table_checks",
c);b=Model.problemReports.get(a.get("id"));0==c.errors.size()&&0==c.warnings.size()&&0==c.hints.size()?void 0!=b&&Model.problemReports.remove(b):void 0==b?(b=new Model.ProblemReport,b.set("errors",c.errors,{silent:!0}),b.set("warnings",c.warnings,{silent:!0}),b.set("hints",c.hints,{silent:!0}),b.set("id",a.get("id"),{silent:!0}),b.set("name","Table: "+a.get("name"),{silent:!0}),Model.problemReports.add(b)):(b.set("errors",c.errors,{silent:!0}),b.set("warnings",c.warnings,{silent:!0}),b.set("hints",
c.hints,{silent:!0}),b.set("name","Table: "+a.get("name"),{silent:!0}),b.trigger("change",Model.problemReports,b))},validateSequences:function(a){a.trigger("before_validation");for(var b=0;b<a.size();b++)this.validateSequence(a.at(b));a.trigger("after_validation")},validateSequence:function(a){var b="sequence/"+a.get("id"),c={errors:new Model.Problems,warnings:new Model.Problems,hints:new Model.Problems};this.validate(b,[a],"sequence",c);b=Model.problemReports.get(a.get("id"));0==c.errors.size()&&
0==c.warnings.size()&&0==c.hints.size()?void 0!=b&&Model.problemReports.remove(b):void 0==b?(b=new Model.ProblemReport,b.set("errors",c.errors,{silent:!0}),b.set("warnings",c.warnings,{silent:!0}),b.set("hints",c.hints,{silent:!0}),b.set("id",a.get("id"),{silent:!0}),b.set("name","Sequence: "+a.get("name"),{silent:!0}),Model.problemReports.add(b)):(b.set("errors",c.errors,{silent:!0}),b.set("warnings",c.warnings,{silent:!0}),b.set("hints",c.hints,{silent:!0}),b.set("name","Sequence: "+a.get("name"),
{silent:!0}),b.trigger("change",Model.problemReports,b))},validateReferences:function(a){a.trigger("before_validation");for(var b=0;b<a.size();b++)this.validateReference(a.at(b));a.trigger("after_validation")},validateReference:function(a){var b="reference/"+a.get("id"),c={errors:new Model.Problems,warnings:new Model.Problems,hints:new Model.Problems};this.validate(b,[a],"reference",c);b=Model.problemReports.get(a.get("id"));0==c.errors.size()&&0==c.warnings.size()&&0==c.hints.size()?void 0!=b&&Model.problemReports.remove(b):
void 0==b?(b=new Model.ProblemReport,b.set("errors",c.errors,{silent:!0}),b.set("warnings",c.warnings,{silent:!0}),b.set("hints",c.hints,{silent:!0}),b.set("id",a.get("id"),{silent:!0}),b.set("name","Reference: "+a.get("name"),{silent:!0}),Model.problemReports.add(b)):(b.set("errors",c.errors,{silent:!0}),b.set("warnings",c.warnings,{silent:!0}),b.set("hints",c.hints,{silent:!0}),b.set("name","Reference: "+a.get("name"),{silent:!0}),b.trigger("change",Model.problemReports,b))},validateViews:function(a){a.trigger("before_validation");
for(var b=0;b<a.size();b++)this.validateView(a.at(b));a.trigger("after_validation")},validateView:function(a){var b="view/"+a.get("id"),c={errors:new Model.Problems,warnings:new Model.Problems,hints:new Model.Problems};this.validate(b,[a],"view",c);for(var b=a.get("columns"),d=0;d<b.size();d++){var e=b.at(d),f="view/"+a.get("id")+"/column/"+e.get("id");this.validate(f,[a,e],"view_column",c)}b=Model.problemReports.get(a.get("id"));0==c.errors.size()&&0==c.warnings.size()&&0==c.hints.size()?void 0!=
b&&Model.problemReports.remove(b):void 0==b?(b=new Model.ProblemReport,b.set("errors",c.errors,{silent:!0}),b.set("warnings",c.warnings,{silent:!0}),b.set("hints",c.hints,{silent:!0}),b.set("id",a.get("id"),{silent:!0}),b.set("name","View: "+a.get("name"),{silent:!0}),Model.problemReports.add(b)):(b.set("errors",c.errors,{silent:!0}),b.set("warnings",c.warnings,{silent:!0}),b.set("hints",c.hints,{silent:!0}),b.set("name","View: "+a.get("name"),{silent:!0}),b.trigger("change",Model.problemReports,
b))},validate:function(a,b,c,d){this._validate(a,b,c,"errors",d.errors);this._validate(a,b,c,"warnings",d.warnings);this._validate(a,b,c,"hints",d.hints)},_validate:function(a,b,c,d,e){var f=Model.Validation.Rules[c];if(void 0==f)throw Error("No such rules: "+c);f=f[d];if(void 0==f)throw Error("No such rules level: "+c);for(var g in f)if("function"==typeof f[g]&&!1!=Model.validationProperties.isEnabled(c,d,g)){var k=f[g].apply(f,b);null!=k&&(k=new Model.Problem(k),k.set("id",a+":"+g.replace(" ","_")),
void 0==k.get("description")&&k.set("description",k.get("message")),void 0==k.get("name")&&k.set("name"," "),void 0==k.get("property")&&k.set("property","property"),e.add(k))}}};Model.Validation.Rules={};Model.Validation.Cache={};
Model.Validation.bindEvents=function(){var a=function(a,b){var e=a.get("id"),e=Model.getById(e);null==e?Model.problemReports.remove(a):(0<a.get("errors").size()?e.set("hasErrors",!0):e.set("hasErrors",!1),0<a.get("warnings").size()?e.set("hasWarnings",!0):e.set("hasWarnings",!1),0<a.get("hints").size()?e.set("hasHints",!0):e.set("hasHints",!1))};Model.problemReports.on("add",function(b,d){a(b)});Model.problemReports.on("change",function(b,d){a(b)});Model.problemReports.on("remove",function(a,b){var e=
Model.getById(a.get("id"));null!=e&&(e.set("hasErrors",!1),e.set("hasWarnings",!1),e.set("hasHints",!1))});var b=function(a){for(var b=0;b<a.size();b++)a.at(b).set({hasErrors:!1,hasWarnings:!1,hasHints:!1})};Model.problemReports.on("reset",function(c){b(Model.tables);b(Model.references);b(Model.sequences);b(Model.views);for(c=0;c<Model.problemReports.size();c++){var d=Model.problemReports.at(c);a(d)}});Model.metaInfo.on("change:modelLoad",function(a,b){!0==b&&Model.Validation.triggerWorker()})};
Model.Validation.init=function(){Model.Validation.bindEvents()};
Model.Validation.startWorker=function(){this.worker=new Worker("/js/modeler/worker.js");this.worker.addEventListener("message",function(a){a=JSON.parse(a.data);void 0!=a.problems&&(Model.tables.trigger("before_validation"),Model.references.trigger("before_validation"),Model.sequences.trigger("before_validation"),Model.views.trigger("before_validation"),Model.problemReports.reset(a.problems),Model.tables.trigger("after_validation"),Model.references.trigger("after_validation"),Model.sequences.trigger("after_validation"),
Model.views.trigger("after_validation"),Model.problemReports.trigger("after_validation"));if(void 0!=a.debug){for(var b=["WORKER>"],c=0;c<a.debug.length;c++)b.push(a.debug[c]);console.log.apply(console,b)}},!1)};
Model.Validation.triggerWorker=function(){if(null==Model.toSaveModel)return console.log("no model to pass, ehh"),null;Model.tables.trigger("before_validation");Model.references.trigger("before_validation");Model.sequences.trigger("before_validation");Model.views.trigger("before_validation");Model.problemReports.trigger("before_validation");this.worker.postMessage(["validate",JSON.stringify(Model.toSaveModel),JSON.stringify(Model.validationProperties.toJSON()),JSON.stringify(Model.databaseTypes.toJSON()),
JSON.stringify(Model.supportedObjectTypes.toJSON())])};Model.Validation.loadPlugin=function(a){this.worker.postMessage(["importScript",a])};
Model.Validation.Rules.table={errors:{"Empty name":function(a){return""==a.get("name")?{property:"name",message:"Table name can't be empty."}:null},"Unique Name":function(a){var b=Model.tables.where({name:a.get("name")}),c=function(a){a=a.get("properties").get("Schema");return void 0!=a?a.get("value"):""},d=c(a);if(1<b.length)for(var e=0;e<b.length;e++){var f=b[e];if(f.get("id")!=a.get("id")&&d==c(f))return{property:"name",message:"Table name is not unique."}}return null},"No columns":function(a){return 0<
a.get("columns").size()?null:{message:"Table must have at least one column."}}},warnings:{"Generated name":function(a){a=a.get("name");return!1==/Table_[0-9]+/.test(a)?null:{property:"name",message:"You should change default table name."}},"Name length":function(a){a=a.get("name");var b=Model.supportedObjectTypes.maxNameLength("table");return null==b?null:a.length>b?{property:"name",message:"Table name is too long. Name can't exceed "+b+" characters."}:null},"If has PK column(s)":function(a){a=a.get("columns");
return 0==a.size()?null:0==a.where({pk:!0}).length?{message:"Table should have primary key."}:null}},hints:{"Alone table":function(a){a.get("id");return 1==Model.tables.size()?{message:"This table is alone. Add more tables."}:null}}};
Model.Validation.Rules.table_column={errors:{"Name can't be empty":function(a,b){return""==b.get("name")?{name:"<EMPTY>",message:"Column name can't be empty.",property:"name"}:null},"Empty type":function(a,b){return""==b.get("type")?{name:b.get("name"),message:"Column type can't be empty.",property:"type"}:null},"Unique name":function(a,b){return 1<a.get("columns").where({name:b.get("name")}).length?{name:b.get("name"),message:"Column name is not unique.",property:"name"}:null},"PK column must be not null":function(a,
b){return b.get("pk")&&b.get("nullable")?{name:b.get("name"),message:"Primary key column can't be null.",property:"nullable"}:null},"Percent placeholder in type":function(a,b){if(-1!=b.get("type").indexOf("%"))return{name:b.get("name"),message:"Type contains percent symbol.",property:"type"}}},warnings:{"Generated column name":function(a,b){var c=b.get("name");return!1==/column_[0-9]+/.test(c)?null:{name:c,message:"You should change default column name.",property:"name"}},"Name length":function(a,
b){var c=b.get("name"),d=Model.supportedObjectTypes.maxNameLength("column");return null==d?null:c.length>d?{name:c,message:"Column name is too long. Name can't exceed "+d+" characters.",property:"name"}:null},"Supported database type":function(a,b){var c=b.get("type");return!1==Model.databaseTypes.isSupported(c)?{name:b.get("name"),message:"Type is not supported by chosen database engine. ",property:"type"}:null}},hints:{}};
Model.Validation.Rules.table_index={errors:{"Name can't be empty":function(a,b){return""==b.get("name")?{name:"<EMPTY>",message:"Index name can't be empty.",property:"name"}:null},"Unique name":function(a,b){return 1<a.get("indexes").where({name:b.get("name")}).length?{name:b.get("name"),message:"Index must have unique name.",property:"name"}:null},"At least one column":function(a,b){return 0==b.get("columns").length?{name:b.get("name"),message:"Index must have at least one column.",property:"columns"}:
null}},warnings:{"Name length":function(a,b){var c=b.get("name"),d=Model.supportedObjectTypes.maxNameLength("index");return null==d?null:c.length>d?{name:c,message:"Index name is too long. Name can't exceed "+d+" characters.",property:"name"}:null}},hints:{}};
Model.Validation.Rules.table_alternate_key={errors:{"Name can't be empty":function(a,b){return""==b.get("name")?{name:"<EMPTY>",message:"Alternate key name can't be empty.",property:"name"}:null},"Unique name":function(a,b){void 0==Model.Validation.Cache.alternativeKeyNames&&(Model.Validation.Cache.alternativeKeyNames=_.flatten(Model.tables.map(function(a){return a.get("alternateKeys").map(function(a){return a.get("name")})})));var c=b.get("name");return 1<_.filter(Model.Validation.Cache.alternativeKeyNames,
function(a){return a==c}).length?{name:b.get("name"),message:"Alternate key must have unique name.",property:"name"}:null},"Check if has at least one column":function(a,b){return 0==b.get("columns").length?{name:b.get("name"),message:"Alternate key must have at least one column.",property:"columns"}:null}},warnings:{"Name length":function(a,b){var c=b.get("name"),d=Model.supportedObjectTypes.maxNameLength("alternate_key");return null==d?null:c.length>d?{name:c,message:"Alternate Key name is too long. Name can't exceed "+
d+" characters.",property:"name"}:null}},hints:{}};Model.Validation.Rules.table_checks={errors:{"Check expression can't be empty":function(a,b){return""==b.get("checkExpression")?{name:b.get("name"),message:"Check expression cannot be null",property:"checkExpression"}:null}},warnings:{},hints:{}};
Model.Validation.Rules.reference={_isReferenceColumnsMatchKey:function(a,b){var c=[],d=_.map(a.get("columns").where({pk:!0}),function(a){return a.get("id")});c.push(d);for(d=0;d<a.get("alternateKeys").size();++d){var e=a.get("alternateKeys").at(d);c.push(e.get("columns"))}e=!1;for(d=0;d<c.length;++d){var f=c[d];if(f.length==b.size()){for(var g=!0,k=0;k<b.size();k++){var l=b.at(k).get("pkColumnId");if(f[k]!==l){g=!1;break}}if(g){e=!0;break}}}return e},errors:{"Name cannot be empty":function(a){return""==
a.get("name")?{property:"name",message:"Reference name can't be empty."}:null},"Unique name":function(a){return 1<Model.references.where({name:a.get("name"),pkTableId:a.get("pkTableId")}).length?{property:"name",message:"Reference name must be unique."}:null},"Check PK/FK keys":function(a){var b=Model.tables.get(a.get("pkTableId")),c=Model.tables.get(a.get("fkTableId")),d=a.get("referenceColumns");if(0==d.length)return{property:"columns",message:"Please add columns that join primary and foreign tables."};
if(!Model.Validation.Rules.reference._isReferenceColumnsMatchKey(b,d))return{property:"columns",message:"Foreign key must reference columns that are either a primary key or an alternate key in the primary table"};for(var e=a.get("mandatory"),f=0;f<d.size();f++){var g=d.at(f),k=g.get("pkColumnId"),g=g.get("fkColumnId");if(void 0==k||void 0==g||null==k||null==g)return{name:a.get("name"),property:"columns",message:"Reference must have defined all pairs of columns."};var l=b.get("columns").get(k),k=c.get("columns").get(g);
if(void 0===l||void 0===k)return{name:a.get("name"),property:"columns",message:"Reference must have defined all pairs of columns."};var g=l.escape("name")+"&rarr;"+k.escape("name"),m=l.get("type"),l=k.get("type"),m=Model.databaseTypes.getCanonicalType(m),l=Model.databaseTypes.getCanonicalType(l);if(m!=l)return{name:g,property:"columns",message:"Column types are different in primary and foreign table."};if(e&&!0==k.get("nullable"))return{name:g,property:"columns",message:"Reference is marked as mandatory but foreign key column is nullable."}}return null}},
warnings:{"Unique name":function(a){var b=Model.references.where({name:a.get("name")});a=a.get("pkTableId");if(1<b.length)for(var c=0;c<b.length;c++)if(a!=b[c].get("pkTableId"))return{property:"name",message:"Reference name should be unique across model."};return null},"Name length":function(a){a=a.get("name");var b=Model.supportedObjectTypes.maxNameLength("reference");return null==b?null:a.length>b?{property:"name",message:"Reference name is too long. Name can't exceed "+b+" characters."}:null},
"Check if self reference is not mandatory":function(a){return a.get("pkTableId")==a.get("fkTableId")&&a.get("mandatory")?{name:a.get("name"),property:"mandatory",message:"Reference cannot be marked as 'mandatory' when connects the same table."}:null}},hints:{}};
Model.Validation.Rules.sequence={errors:{"Name can't be empty":function(a){return""==a.get("name")?{property:"name",message:"Sequence name can't be empty."}:null},"Unique name":function(a){return 1<Model.sequences.where({name:a.get("name")}).length?{property:"name",message:"Sequence name is not unique."}:null}},warnings:{"Lenght name":function(a){a=a.get("name");var b=Model.supportedObjectTypes.maxNameLength("sequence");return null==b?null:a.length>b?{property:"name",message:"Sequence name is too long. Name can't exceed "+
b+" characters."}:null}},hints:{}};
Model.Validation.Rules.view={errors:{"Empty name":function(a){return""==a.get("name")?{property:"name",message:"View name can't be empty."}:null},"Unique Name":function(a){return 1<Model.views.where({name:a.get("name")}).length?{property:"name",message:"View name is not unique."}:null},"No columns":function(a){return 0<a.get("columns").size()?null:{message:"View must have at least one column."}},"Cyclic dependencies":function(a){try{a.checkDependencyCycle()}catch(b){return{message:"There's a cycle of views' dependencies"}}return null},"Empty SQL query":function(a){return""===
a.get("sqlQuery").replace(/^\s+|\s+$/g,"")?{message:"View's SQL query cannot be empty"}:null}},warnings:{"Generated name":function(a){return-1==a.get("name").indexOf("View_")?null:{property:"name",message:"You should change default view name."}},"Name length":function(a){a=a.get("name");var b=Model.supportedObjectTypes.maxNameLength("view");return null==b?null:a.length>b?{property:"name",message:"View name is too long. Name can't exceed "+b+" characters."}:null}},hints:{}};
Model.Validation.Rules.view_column={errors:{"Name can't be empty":function(a,b){return""==b.get("name")?{name:"<EMPTY>",message:"Column name can't be empty.",property:"name"}:null},"Empty type":function(a,b){return""==b.get("type")?{name:b.get("name"),message:"Column type can't be empty.",property:"type"}:null},"Unique name":function(a,b){return 1<a.get("columns").where({name:b.get("name")}).length?{name:b.get("name"),message:"Column name is not unique.",property:"name"}:null},"Percent placeholder in type":function(a,
b){if(-1!=b.get("type").indexOf("%"))return{name:b.get("name"),message:"Type contains percent symbol.",property:"type"}}},warnings:{"Generated column name":function(a,b){var c=b.get("name");return-1==c.indexOf("column_")?null:{name:c,message:"You should change default column name.",property:"name"}},"Name length":function(a,b){var c=b.get("name"),d=Model.supportedObjectTypes.maxNameLength("column");return null==d?null:c.length>d?{name:c,message:"Column name is too long. Name can't exceed "+d+" characters.",
property:"name"}:null},"Supported database type":function(a,b){var c=b.get("type");return!1==Model.databaseTypes.isSupported(c)?{name:b.get("name"),message:"Type is not supported by chosen database engine. ",property:"type"}:null}},hints:{}};
var Display={init:function(){Backbone.sync=function(a,b,c){}},makeSelectable:function(a){a.prototype.select=function(){this.set("selected",!0);this.trigger("selected",this)};a.prototype.isSelected=function(){void 0===this.get("selected")&&this.set("selected",!1);return this.get("selected")};a.prototype.deselect=function(){this.set("selected",!1);this.trigger("deselected",this)};a.prototype.attach=function(){!0!=this.get("attached")&&(this.set("attached",!0),this.trigger("attached",this))};a.prototype.isAttached=
function(){void 0===this.get("attached")&&this.set("attached",!1);return this.get("attached")};a.prototype.detach=function(){this.set("attached",!1);this.trigger("detached",this)}}};
Display.Selection=Backbone.Model.extend({initialize:function(a){this.set("selected_element",null);this.set("attached_elements",[])},getSelectedElement:function(){return this.get("selected_element")},getAttachedElements:function(){return this.get("attached_elements").slice(0)},selectElement:function(a){this.clearAll();this.set("selected_element",a);a.select();this.trigger("element_selected",a,this);this.set("attached_elements",[a]);a.attach();this.trigger("element_attached",a,this);a=this.getModel(a);
Model.selection.selectElement(a);this.triggerSelectionChanged()},selectAndAttachElement:function(a){var b=this.get("selected_element");a!==b&&(null!==b&&(this.set("selected_element",null),b.deselect(),this.trigger("element_deselected",b,this)),this.set("selected_element",a),a.select(),this.trigger("element_selected",a,this),!1===a.isAttached()&&(b=this.get("attached_elements").slice(0),b.push(a),this.set("attached_elements",b),a.attach(),this.trigger("element_attached",a,this)),a=this.getModel(a),
Model.selection.selectAndAttachElement(a),this.triggerSelectionChanged())},attachElement:function(a){if(!1===a.isAttached()){var b=this.get("attached_elements").slice(0);b.push(a);this.set("attached_elements",b);a.attach();this.trigger("element_attached",a,this)}a=this.getModel(a);Model.selection.attachElement(a);this.triggerSelectionChanged()},deselectAndDetachElement:function(a){var b=this.get("selected_element"),c=this.get("attached_elements");null!==b&&b.get("id")===a.get("id")&&(this.set("selected_element",
null),b.deselect(),this.trigger("element_deselected",b,this));for(b=0;b<c.length;b++){var d=c[b];if(d.get("id")===a.get("id")){c.splice(b,1);d.detach();this.trigger("element_detached",d,this);break}}a=this.getModel(a);Model.selection.deselectAndDetachElement(a);this.triggerSelectionChanged()},deselectCurrentElement:function(){var a=this.get("selected_element");null!==a&&(a.deselect(),this.set("selected_element",null),this.trigger("element_deselected",a,this),a=this.getModel(a),Model.selection.deselectCurrentElement(a),
this.triggerSelectionChanged())},getModel:function(a){return a instanceof Model.TableDisplay?(a=a.get("modelId"),Model.tables.get(a)):a instanceof Model.ReferenceDisplay?(a=a.get("modelId"),Model.references.get(a)):a instanceof Model.ViewDisplay?(a=a.get("modelId"),Model.views.get(a)):a},clearAll:function(){this.deselectCurrentElement();var a=this.get("attached_elements");if(0<a.length){this.set("attached_elements",[]);for(var b=0;b<a.length;b++)a[b].detach();this.trigger("elements_detached",a,this)}Model.selection.clearAll();
this.triggerSelectionChanged()},selectDisplay:function(a,b){this.clearAll();var c=b.getArea(),c=this.getAreaCenter(c),d=1E9;if(a instanceof Model.Table){for(var e=Model.tableDisplays.where({modelId:a.get("id")}),f=null,g=0;g<e.length;g++){var k=e[g],l=k.computeCenter(),l=this.distance(l,c);l<d&&(d=l,f=k)}this.selectElement(f);return f}if(a instanceof Model.Reference){e=Model.referenceDisplays.where({modelId:a.get("id")});f=null;for(g=0;g<e.length;g++)k=e[g],l=k.computeCenter(),l=this.distance(l,c),
l<d&&(d=l,f=k);this.selectElement(f);return f}if(a instanceof Model.View){e=Model.viewDisplays.where({modelId:a.get("id")});f=null;for(g=0;g<e.length;g++)k=e[g],l=k.computeCenter(),l=this.distance(l,c),l<d&&(d=l,f=k);this.selectElement(f);return f}},getAreaCenter:function(a){return{x:(a.xmin+a.xmax)/2,y:(a.ymin+a.ymax)/2}},distance:function(a,b){var c=a.x-b.x,d=a.y-b.y;return c*c+d*d},_doTriggerSelectionChanged:function(){Display.selection.trigger("selection-changed")},triggerSelectionChanged:function(){Model.groupOperation.isInProgress()?
Model.groupOperation.addOnRelease(Display.selection._doTriggerSelectionChanged):this._doTriggerSelectionChanged()}});
Model.TableDisplay=Backbone.Model.extend({initialize:function(a){},getBoundaryRect:function(){return{xmin:this.get("x"),ymin:this.get("y"),xmax:this.get("x")+this.get("width"),ymax:this.get("y")+this.get("height")}},moveControlPointTo:function(a,b,c,d){var e=Model.Util.alignPoint({x:b,y:c});b=e.x;c=e.y;var e=this.get("width"),f=this.get("height");a===Diagram.TableControlPointIndex.TOP_LEFT?(e=this.get("width")+(this.get("x")-b),f=this.get("height")+(this.get("y")-c),this.moveTo(b,c,d)):a===Diagram.TableControlPointIndex.TOP_RIGHT?
(e=b-this.get("x"),f=this.get("height")+(this.get("y")-c),this.moveTo(this.get("x"),c,d)):a===Diagram.TableControlPointIndex.BOTTOM_LEFT?(e=this.get("width")+(this.get("x")-b),f=c-this.get("y"),this.moveTo(b,this.get("y"),d)):a===Diagram.TableControlPointIndex.BOTTOM_RIGHT&&(e=b-this.get("x"),f=c-this.get("y"));e=Math.floor(e);f=Math.floor(f);a=e-this.get("width");b=f-this.get("height");if(!this.has("oldwidth")||!this.has("oldheight"))this.trigger("resizestart",this,this.get("width"),this.get("height")),
this.set("oldwidth",this.get("width")),this.set("oldheight",this.get("height"));if(0!==a||0!==b)this.set("width",e),this.set("height",f),this.trigger("resize",this,e,f,a,b);void 0!==d&&!0===d&&(this.trigger("resizeend",this,this.get("oldwidth"),this.get("oldheight"),this.get("width"),this.get("height")),this.unset("oldwidth"),this.unset("oldheight"))},moveTo:function(a,b,c){b=Model.Util.alignPoint({x:a,y:b});a=b.x;b=b.y;var d=a-this.get("x"),e=b-this.get("y");if(!this.has("oldx")||!this.has("oldy"))this.trigger("movestart",
this,this.get("x"),this.get("y")),this.set("oldx",this.get("x")),this.set("oldy",this.get("y"));if(0!==d||0!==e)this.set("x",a),this.set("y",b),this.trigger("move",this,d,e);void 0!==c&&!0===c&&(this.trigger("moveend",this,this.get("oldx"),this.get("oldy"),this.get("x"),this.get("y")),this.unset("oldx"),this.unset("oldy"))},resize:function(a,b){a=Math.floor(a);b=Math.floor(b);var c=this.get("width"),d=this.get("height"),e=a-this.get("width"),f=b-this.get("height");this.trigger("resizestart",this,
this.get("width"),this.get("height"));this.set({width:a,height:b});this.trigger("resize",this,a,b,e,f);this.trigger("resizeend",this,c,d,this.get("width"),this.get("height"))},getPreviousCPPosition:function(a){var b,c,d,e;b=this.has("oldx")?this.get("oldx"):this.get("x");c=this.has("oldy")?this.get("oldy"):this.get("y");d=this.has("oldwidth")?this.get("oldwidth"):this.get("width");e=this.has("oldheight")?this.get("oldheight"):this.get("height");if(a===Diagram.TableControlPointIndex.TOP_LEFT)a=b;else if(a===
Diagram.TableControlPointIndex.TOP_RIGHT)a=b+d;else if(a===Diagram.TableControlPointIndex.BOTTOM_LEFT)a=b,c+=e;else if(a===Diagram.TableControlPointIndex.BOTTOM_RIGHT)a=b+d,c+=e;else throw"Unknown table index "+a;return{x:a,y:c}},getMinWidth:function(){return 105},getMinHeight:function(){return 42},adjustPointToInsideMargin:function(a){var b=this.getBoundaryRect(),c=this.getInsideMargin();a={x:a.x,y:a.y};a.x<b.xmin+c&&(a.x=b.xmin+c);a.x>b.xmax-c&&(a.x=b.xmax-c);a.y<b.ymin+c&&(a.y=b.ymin+c);a.y>b.ymax-
c&&(a.y=b.ymax-c);return a},getInsideMargin:function(){return 10},inArea:function(a){return this.get("x")<a.xmin||this.get("y")<a.ymin||this.get("x")+this.get("width")>a.xmax||this.get("y")+this.get("height")>a.ymax?!1:!0},getTitleText:function(){var a=Model.tables.get(this.get("modelId")),a=null==a?"":a.get("name");if(!1==this.isGhost())return a;for(var b=this.getAreaLabel(this),c=Model.tableDisplays.where({modelId:this.get("modelId")}),d=[],e=0;e<c.length;e++){var f=c[e],g=this.getAreaLabel(f);
b==g&&d.push(f)}_.sortBy(d,function(a){return a.get("id")});var k=this;if(0==_.filter(d,function(a){return a.get("id")!=k.get("id")}).length)return a+b;c=_.indexOf(d,this)+1;0==c&&(c=d.length+1);return a+b+":"+c},isGhost:function(){var a=this,b=Model.tableDisplays.where({modelId:this.get("modelId")});return 0!=_.filter(b,function(b){return b.get("id")!=a.get("id")}).length},getAreaLabel:function(a){for(var b=[],c=Model.areas.models,d=0;d<c.length;d++){var e=c[d];a.inArea(e.getArea())&&b.push(e.get("name").trim())}_.sortBy(b,
function(a){return a});return _.reduce(b,function(a,b){return void 0==b||null==b||""==b?a:a+":"+b.trim()},"")},computeCenter:function(){return{x:this.get("x")+this.get("width")/2,y:this.get("y")+this.get("height")/2}},setInSearchResults:function(){this.set("inSearchResults",!0);this.trigger("setInSearchResults",this);Model.tableDisplays.trigger("tableDisplay_setInSearchResults",Model.tables,this)},unsetInSearchResults:function(){this.set("inSearchResults",!1);this.trigger("unsetInSearchResults",this);
Model.tableDisplays.trigger("tableDisplay_unsetInSearchResults",Model.tables,this)}});Model.TableDisplays=Backbone.Collection.extend({model:Model.TableDisplay,findTableDisplayInArea:function(a,b){for(var c=this.where({modelId:a}),d=Model.areas.get(b).getArea(),e=0;e<c.length;e++){var f=c[e];if(f.inArea(d))return f}return null}});Model.tableDisplays=new Model.TableDisplays;Display.makeSelectable(Model.TableDisplay);
Model.ViewDisplay=Backbone.Model.extend({initialize:function(a){this._updateMinHeight()},getBoundaryRect:function(){return{xmin:this.get("x"),ymin:this.get("y"),xmax:this.get("x")+this.get("width"),ymax:this.get("y")+this.get("height")}},getMinWidth:function(){return 105},_updateMinHeight:function(){var a=62+13*Model.views.get(this.get("modelId")).get("dependencies").length;this.set("minHeight",a)},getMinHeight:function(){return this.get("minHeight")},moveTo:function(a,b,c){b=Model.Util.alignPoint({x:a,
y:b});a=b.x;b=b.y;var d=a-this.get("x"),e=b-this.get("y");if(!this.has("oldx")||!this.has("oldy"))this.trigger("movestart",this,this.get("x"),this.get("y")),this.set("oldx",this.get("x")),this.set("oldy",this.get("y"));if(0!==d||0!==e)this.set("x",a),this.set("y",b),this.trigger("move",this,d,e);void 0!==c&&!0===c&&(this.trigger("moveend",this,this.get("oldx"),this.get("oldy"),this.get("x"),this.get("y")),this.unset("oldx"),this.unset("oldy"))},moveControlPointTo:function(a,b,c,d){var e=Model.Util.alignPoint({x:b,
y:c});b=e.x;c=e.y;var e=this.get("width"),f=this.get("height");a===Diagram.ViewControlPointIndex.TOP_LEFT?(e=this.get("width")+(this.get("x")-b),f=this.get("height")+(this.get("y")-c),this.moveTo(b,c,d)):a===Diagram.ViewControlPointIndex.TOP_RIGHT?(e=b-this.get("x"),f=this.get("height")+(this.get("y")-c),this.moveTo(this.get("x"),c,d)):a===Diagram.ViewControlPointIndex.BOTTOM_LEFT?(e=this.get("width")+(this.get("x")-b),f=c-this.get("y"),this.moveTo(b,this.get("y"),d)):a===Diagram.ViewControlPointIndex.BOTTOM_RIGHT&&
(e=b-this.get("x"),f=c-this.get("y"));e=Math.floor(e);f=Math.floor(f);a=e-this.get("width");b=f-this.get("height");if(!this.has("oldwidth")||!this.has("oldheight"))this.trigger("resizestart",this,this.get("width"),this.get("height")),this.set("oldwidth",this.get("width")),this.set("oldheight",this.get("height"));if(0!==a||0!==b)this.set("width",e),this.set("height",f),this.trigger("resize",this,e,f,a,b);void 0!==d&&!0===d&&(this.trigger("resizeend",this,this.get("oldwidth"),this.get("oldheight"),
this.get("width"),this.get("height")),this.unset("oldwidth"),this.unset("oldheight"))},getPreviousCPPosition:function(a){var b,c,d,e;b=this.has("oldx")?this.get("oldx"):this.get("x");c=this.has("oldy")?this.get("oldy"):this.get("y");d=this.has("oldwidth")?this.get("oldwidth"):this.get("width");e=this.has("oldheight")?this.get("oldheight"):this.get("height");if(a===Diagram.ViewControlPointIndex.TOP_LEFT)a=b;else if(a===Diagram.ViewControlPointIndex.TOP_RIGHT)a=b+d;else if(a===Diagram.ViewControlPointIndex.BOTTOM_LEFT)a=
b,c+=e;else if(a===Diagram.ViewControlPointIndex.BOTTOM_RIGHT)a=b+d,c+=e;else throw"Unknown view index "+a;return{x:a,y:c}},resize:function(a,b){a=Math.floor(a);b=Math.floor(b);var c=this.get("width"),d=this.get("height"),e=a-this.get("width"),f=b-this.get("height");this.trigger("resizestart",this,this.get("width"),this.get("height"));this.set({width:a,height:b});this.trigger("resize",this,a,b,e,f);this.trigger("resizeend",this,c,d,this.get("width"),this.get("height"))},computeCenter:function(){return{x:this.get("x")+
this.get("width")/2,y:this.get("y")+this.get("height")/2}},getTitleText:function(){var a=Model.views.get(this.get("modelId")),b="";null!=a&&(b=a.get("name"));if(!1==this.isGhost())return b;for(var a=this.getAreaLabel(this),c=Model.viewDisplays.where({modelId:this.get("modelId")}),d=[],e=0;e<c.length;e++){var f=c[e],g=this.getAreaLabel(f);a==g&&d.push(f)}_.sortBy(d,function(a){return a.get("id")});var k=this;if(0==_.filter(d,function(a){return a.get("id")!=k.get("id")}).length)return b+a;c=_.indexOf(d,
this)+1;0==c&&(c=d.length+1);return b+a+":"+c},isGhost:function(){var a=this,b=Model.viewDisplays.where({modelId:this.get("modelId")});return 0!=_.filter(b,function(b){return b.get("id")!=a.get("id")}).length},getAreaLabel:function(a){for(var b=[],c=Model.areas.models,d=0;d<c.length;d++){var e=c[d];a.inArea(e.getArea())&&b.push(e.get("name").trim())}_.sortBy(b,function(a){return a});return _.reduce(b,function(a,b){return void 0==b||null==b||""==b?a:a+":"+b.trim()},"")},inArea:function(a){return this.get("x")<
a.xmin||this.get("y")<a.ymin||this.get("x")+this.get("width")>a.xmax||this.get("y")+this.get("height")>a.ymax?!1:!0},setInSearchResults:function(){this.set("inSearchResults",!0);this.trigger("setInSearchResults",this);Model.viewDisplays.trigger("viewDisplay_setInSearchResults",Model.tables,this)},unsetInSearchResults:function(){this.set("inSearchResults",!1);this.trigger("unsetInSearchResults",this);Model.viewDisplays.trigger("viewDisplay_unsetInSearchResults",Model.tables,this)}});
Model.ViewDisplays=Backbone.Collection.extend({model:Model.ViewDisplay,findViewDisplayInArea:function(a,b){for(var c=this.where({modelId:a}),d=Model.areas.get(b).getArea(),e=0;e<c.length;e++){var f=c[e];if(f.inArea(d))return f}return null}});Model.viewDisplays=new Model.ViewDisplays;Display.makeSelectable(Model.ViewDisplay);Model.DisplayPoint=Backbone.Model.extend({initialize:function(a){}});Model.DisplayPoints=Backbone.Collection.extend({model:Model.Point});
Model.ReferenceDisplay=Backbone.Model.extend({initialize:function(a){a=new Model.DisplayPoints;void 0!=this.get("controlPoints")&&(a=new Model.DisplayPoints(this.get("controlPoints")));this.set("controlPoints",a);this.bindAllEvents()},bindAllEvents:function(){var a=this.get("controlPoints"),b=Model.tableDisplays.get(this.get("pkTableDisplayId")),c=Model.tableDisplays.get(this.get("fkTableDisplayId")),d=this;this.get("name");this.unbindAllEvents();var d=this,e=Model.references.get(this.get("modelId"));
if(null!=e)e.on("swap_reference",function(){d.swap()},d);b.on("movestart",function(a,b,c,e,m){d.set("oldControlPoints",Model.ReferenceDisplay.getCPsAsArray(d.get("controlPoints")));d.set("oldControlPointsType",d.get("controlPointsType"))},d);b.on("move",function(a,b,c){a=d.recalculateRCPsAfterTableMove(d,a,b,c);d.get("controlPoints").reset(a.controlPoints);d.set("controlPointsType",a.controlPointsType)},d);b.on("moveend",function(a,b,c,e,m){d.unset("oldControlPoints");d.unset("oldControlPointsType")},
d);b.on("resizestart",function(a,b,c){d.set("oldControlPoints",Model.ReferenceDisplay.getCPsAsArray(d.get("controlPoints")));d.set("oldControlPointsType",d.get("controlPointsType"))},d);b.on("resize",function(a,b,c,e,m){a=d.recalculateRCPsAfterTableResize(d,a,b,c,e,m);d.get("controlPoints").reset(a.controlPoints);d.set("controlPointsType",a.controlPointsType)},d);b.on("resizeend",function(a,b,c,e,m){d.unset("oldControlPoints");d.unset("oldControlPointsType")},d);b.get("id")!==c.get("id")&&(c.on("movestart",
function(a,b,c,e,m){d.set("oldControlPoints",Model.ReferenceDisplay.getCPsAsArray(d.get("controlPoints")));d.set("oldControlPointsType",d.get("controlPointsType"))},d),c.on("move",function(a,b,c){a=d.recalculateRCPsAfterTableMove(d,a,b,c);d.get("controlPoints").reset(a.controlPoints);d.set("controlPointsType",a.controlPointsType)},d),c.on("moveend",function(a,b,c,e,m){d.unset("oldControlPoints");d.unset("oldControlPointsType")},d),c.on("resizestart",function(a,b,c){d.set("oldControlPoints",Model.ReferenceDisplay.getCPsAsArray(d.get("controlPoints")));
d.set("oldControlPointsType",d.get("controlPointsType"))},d),c.on("resize",function(a,b,c,e,m){a=d.recalculateRCPsAfterTableResize(d,a,b,c,e,m);d.get("controlPoints").reset(a.controlPoints);d.set("controlPointsType",a.controlPointsType)},d),c.on("resizeend",function(a,b,c,e,m){d.unset("oldControlPoints");d.unset("oldControlPointsType")},d));this.bindChangeControlPointsEvents(a)},recalculateRCPsAfterTableMove:function(a,b,c,d){var e=Model.tableDisplays.get(a.get("pkTableDisplayId")),f=Model.tableDisplays.get(a.get("fkTableDisplayId")),
g=[],k=a.get("oldControlPointsType"),l=a.get("controlPointsType"),m=a.get("controlPoints"),q=m.at(0),r=m.at(m.length-1),n,p;b.get("id")===e.get("id")?(n={x:q.get("x")+c,y:q.get("y")+d},p={x:r.get("x"),y:r.get("y")}):(n={x:q.get("x"),y:q.get("y")},p={x:r.get("x")+c,y:r.get("y")+d});if(k===Model.RCPType.VERTICAL_2CP)return b.get("id")===e.get("id")?Model.ReferenceDisplay.calculateRCPs_Vertical_2CP(e,f,n,p,!1,!0):Model.ReferenceDisplay.calculateRCPs_Vertical_2CP(e,f,n,p,!0,!1);if(k===Model.RCPType.HORIZONTAL_2CP)return b.get("id")===
e.get("id")?Model.ReferenceDisplay.calculateRCPs_Horizontal_2CP(e,f,n,p,!1,!0):Model.ReferenceDisplay.calculateRCPs_Horizontal_2CP(e,f,n,p,!0,!1);if(k===Model.RCPType.CROSS_3CP)c=m.at(1),b.get("id")===e.get("id")?c.get("x")===r.get("x")?g[1]={x:p.x,y:n.y}:g[1]={x:n.x,y:p.y}:c.get("x")===q.get("x")?g[1]={x:n.x,y:p.y}:g[1]={x:p.x,y:n.y},g[0]={x:n.x,y:n.y},g[2]={x:p.x,y:p.y};else if(k===Model.RCPType.HORIZONTAL_4CP)b.get("id")===e.get("id")?(g=Model.ReferenceDisplay.getCPsAsArray(a.get("controlPoints")),
g[0]={x:n.x,y:n.y},g[1]={x:g[1].x,y:n.y}):(g=Model.ReferenceDisplay.getCPsAsArray(a.get("controlPoints")),g[2]={x:g[2].x,y:p.y},g[3]={x:p.x,y:p.y});else if(k===Model.RCPType.VERTICAL_4CP)b.get("id")===e.get("id")?(g=Model.ReferenceDisplay.getCPsAsArray(a.get("controlPoints")),g[0]={x:n.x,y:n.y},g[1]={x:n.x,y:g[1].y}):(g=Model.ReferenceDisplay.getCPsAsArray(a.get("controlPoints")),g[2]={x:p.x,y:g[2].y},g[3]={x:p.x,y:p.y});else if(k===Model.RCPType.SELF_4CP||k===Model.RCPType.SELF_5CP)for(b=0;b<m.length;b++)e=
m.at(b),g[b]={x:e.get("x")+c,y:e.get("y")+d};return Model.ReferenceDisplay.alignControlPoints({controlPoints:g,controlPointsType:l})},unbindAllEvents:function(){var a=this.get("controlPoints"),b=Model.tableDisplays.get(this.get("pkTableDisplayId")),c=Model.tableDisplays.get(this.get("fkTableDisplayId"));a.off(null,null,this);b.off(null,null,this);b.get("id")!==c.get("id")&&c.off(null,null,this);a=Model.references.get(this.get("modelId"));null!=a&&a.off(null,null,this)},bindChangeControlPointsEvents:function(a){var b=
this;a.on("all",function(c){if("add"===c||"remove"===c||"reset"===c||"change"===c)b.trigger("change:controlPoints",b,a),b.trigger("change",b)},b)},moveControlPointTo:function(a,b,c,d){var e=Model.tableDisplays.get(this.get("pkTableDisplayId")),f=Model.tableDisplays.get(this.get("fkTableDisplayId")),g=this.get("controlPointsType"),k=this.get("controlPoints");b=Math.floor(b)+0.5;c=Math.floor(c)+0.5;if(!this.has("oldcpx")||!this.has("oldcpy"))this.trigger("movecpstart",this,a,k.at(a).get("x"),k.at(a).get("y")),
this.set("oldcpx",k.at(a).get("x")),this.set("oldcpy",k.at(a).get("y"));if(g===Model.RCPType.HORIZONTAL_2CP)k.at(0).set("y",c),k.at(1).set("y",c),0===a?k.at(0).set("x",b):k.at(1).set("x",b);else if(g===Model.RCPType.VERTICAL_2CP)k.at(0).set("x",b),k.at(1).set("x",b),0===a?k.at(0).set("y",c):k.at(1).set("y",c);else if(g===Model.RCPType.CROSS_3CP)if(0===a||2===a){var g=k.at(a),l=k.at(1);g.get("x")===l.get("x")&&g.get("y")===l.get("y")||(g.get("x")===l.get("x")?l.set("x",b):l.set("y",c));b===l.get("x")&&
c===l.get("y")||(g.set("x",b),g.set("y",c))}else{if(1===a){var l=k.at(1),m=k.at(0),g=k.at(2),q=(m.get("x")-b)*(g.get("y")-c)-(m.get("y")-c)*(g.get("x")-b),r;r=m.get("x")!==g.get("x")?(g.get("y")-m.get("y"))/(g.get("x")-m.get("x")):100;m.get("x")===l.get("x")?(b<e.get("x")+10&&(b=e.get("x")+10),b>e.get("x")+e.get("width")-10&&(b=e.get("x")+e.get("width")-10),m.set("x",b)):(c<e.get("y")+10&&(c=e.get("y")+10),c>e.get("y")+e.get("height")-10&&(c=e.get("y")+e.get("height")-10),m.set("y",c));g.get("x")===
l.get("x")?(b<f.get("x")+10&&(b=f.get("x")+10),b>f.get("x")+f.get("width")-10&&(b=f.get("x")+f.get("width")-10),g.set("x",b)):(c<f.get("y")+10&&(c=f.get("y")+10),c>f.get("y")+f.get("height")-10&&(c=f.get("y")+f.get("height")-10),g.set("y",c));0<q*r?(l.set("x",m.get("x")),l.set("y",g.get("y"))):(l.set("x",g.get("x")),l.set("y",m.get("y")))}}else g===Model.RCPType.HORIZONTAL_4CP?0===a?(k.at(0).set("x",b),k.at(0).set("y",c),k.at(1).set("y",c)):1===a?(k.at(0).set("y",c),k.at(1).set("x",b),k.at(1).set("y",
c),k.at(2).set("x",b)):2===a?(k.at(1).set("x",b),k.at(2).set("x",b),k.at(2).set("y",c),k.at(3).set("y",c)):3===a&&(k.at(2).set("y",c),k.at(3).set("x",b),k.at(3).set("y",c)):g===Model.RCPType.VERTICAL_4CP?0===a?(k.at(0).set("x",b),k.at(0).set("y",c),k.at(1).set("x",b)):1===a?(k.at(0).set("x",b),k.at(1).set("x",b),k.at(1).set("y",c),k.at(2).set("y",c)):2===a?(k.at(1).set("y",c),k.at(2).set("x",b),k.at(2).set("y",c),k.at(3).set("x",b)):3===a&&(k.at(2).set("x",b),k.at(3).set("x",b),k.at(3).set("y",c)):
g===Model.RCPType.SELF_4CP?0===a?(m=k.at(0),e=k.at(1),e.get("x")===m.get("x")?e.set("x",b):e.set("y",c),m.set("x",b),m.set("y",c)):1===a?(m=k.at(0),e=k.at(1),g=k.at(2),m.get("x")===e.get("x")?m.set("x",b):m.set("y",c),g.get("x")===e.get("x")?g.set("x",b):g.set("y",c),e.set("x",b),e.set("y",c)):2===a?(e=k.at(1),g=k.at(2),f=k.at(3),e.get("x")===g.get("x")?e.set("x",b):e.set("y",c),f.get("x")===g.get("x")?f.set("x",b):f.set("y",c),g.set("x",b),g.set("y",c)):3===a&&(g=k.at(2),f=k.at(3),g.get("x")===f.get("x")?
g.set("x",b):g.set("y",c),f.set("x",b),f.set("y",c)):g===Model.RCPType.SELF_5CP&&(0===a?(m=k.at(0),e=k.at(1),e.get("x")===m.get("x")?e.set("x",b):e.set("y",c),m.set("x",b),m.set("y",c)):1===a?(m=k.at(0),e=k.at(1),g=k.at(2),m.get("x")===e.get("x")?m.set("x",b):m.set("y",c),g.get("x")===e.get("x")?g.set("x",b):g.set("y",c),e.set("x",b),e.set("y",c)):2===a?(e=k.at(1),g=k.at(2),f=k.at(3),e.get("x")===g.get("x")?e.set("x",b):e.set("y",c),f.get("x")===g.get("x")?f.set("x",b):f.set("y",c),g.set("x",b),g.set("y",
c)):3===a?(g=k.at(2),f=k.at(3),e=k.at(4),g.get("x")===f.get("x")?g.set("x",b):g.set("y",c),e.get("x")===f.get("x")?e.set("x",b):e.set("y",c),f.set("x",b),f.set("y",c)):4===a&&(f=k.at(3),e=k.at(4),f.get("x")===e.get("x")?f.set("x",b):f.set("y",c),e.set("x",b),e.set("y",c)));this.trigger("movecp",this,a);void 0!==d&&!0===d&&(this.trigger("movecpend",this,this.get("oldcpx"),this.get("oldcpy"),k.at(a).get("x"),k.at(a).get("y")),this.unset("oldcpx"),this.unset("oldcpy"))},recalculateRCPsAfterTableResize:function(a,
b,c,d,e,f){var g=Model.tableDisplays.get(a.get("pkTableDisplayId")),k=Model.tableDisplays.get(a.get("fkTableDisplayId"));c=[];var l=a.get("oldControlPointsType");d=a.get("controlPointsType");var m=a.get("controlPoints"),q=m.at(0),r=m.at(m.length-1);e={x:q.get("x"),y:q.get("y")};f={x:r.get("x"),y:r.get("y")};if(b.get("id")===g.get("id")){var n=q.get("x"),p=q.get("y");n>g.get("x")+g.get("width")-10&&(n=g.get("x")+g.get("width")-10);p>g.get("y")+g.get("height")-10&&(p=g.get("y")+g.get("height")-10);
e={x:n,y:p}}b.get("id")===k.get("id")&&(n=r.get("x"),p=r.get("y"),n>k.get("x")+k.get("width")-10&&(n=k.get("x")+k.get("width")-10),p>k.get("y")+k.get("height")-10&&(p=k.get("y")+k.get("height")-10),f={x:n,y:p});if(l===Model.RCPType.VERTICAL_2CP)return b.get("id")===g.get("id")?Model.ReferenceDisplay.calculateRCPs_Vertical_2CP(g,k,e,f,!1,!0):Model.ReferenceDisplay.calculateRCPs_Vertical_2CP(g,k,e,f,!0,!1);if(l===Model.RCPType.HORIZONTAL_2CP)return b.get("id")===g.get("id")?Model.ReferenceDisplay.calculateRCPs_Horizontal_2CP(g,
k,e,f,!1,!0):Model.ReferenceDisplay.calculateRCPs_Horizontal_2CP(g,k,e,f,!0,!1);l===Model.RCPType.CROSS_3CP?(a=m.at(1),b.get("id")===g.get("id")?a.get("x")===r.get("x")?c[1]={x:f.x,y:e.y}:c[1]={x:e.x,y:f.y}:a.get("x")===q.get("x")?c[1]={x:e.x,y:f.y}:c[1]={x:f.x,y:e.y},c[0]={x:e.x,y:e.y},c[2]={x:f.x,y:f.y}):l===Model.RCPType.HORIZONTAL_4CP?b.get("id")===g.get("id")?(c=Model.ReferenceDisplay.getCPsAsArray(a.get("controlPoints")),c[0]={x:e.x,y:e.y},c[1]={x:c[1].x,y:e.y}):(c=Model.ReferenceDisplay.getCPsAsArray(a.get("controlPoints")),
c[2]={x:c[2].x,y:f.y},c[3]={x:f.x,y:f.y}):l===Model.RCPType.VERTICAL_4CP?b.get("id")===g.get("id")?(c=Model.ReferenceDisplay.getCPsAsArray(a.get("controlPoints")),c[0]={x:e.x,y:e.y},c[1]={x:e.x,y:c[1].y}):(c=Model.ReferenceDisplay.getCPsAsArray(a.get("controlPoints")),c[2]={x:f.x,y:c[2].y},c[3]={x:f.x,y:f.y}):l===Model.RCPType.SELF_4CP?(c=Model.ReferenceDisplay.getCPsAsArray(a.get("controlPoints")),b=c[0],a=c[1],q=c[2],g=c[3],a.x===b.x?a.x=e.x:a.y=e.y,q.x===g.x?q.x=f.x:q.y=f.y,b.x=e.x,b.y=e.y,g.x=
f.x,g.y=f.y):l===Model.RCPType.SELF_5CP&&(c=Model.ReferenceDisplay.getCPsAsArray(a.get("controlPoints")),b=c[0],a=c[1],g=c[3],q=c[4],a.x===b.x?a.x=e.x:a.y=e.y,g.x===q.x?g.x=f.x:g.y=f.y,b.x=e.x,b.y=e.y,q.x=f.x,q.y=f.y);return Model.ReferenceDisplay.alignControlPoints({controlPoints:c,controlPointsType:d})},move:function(a,b,c){var d,e,f=this.get("controlPoints"),g=f.at(0);if(!this.has("oldx")||!this.has("oldy"))this.trigger("movestart",this,g.get("x"),g.get("y")),this.set("oldx",g.get("x")),this.set("oldy",
g.get("y"));d=g.get("x")-this.get("oldx");e=g.get("y")-this.get("oldy");for(var k=0;k<f.size();k++){var l=f.at(k);l.set("x",Math.floor(l.get("x")-d+a)+0.5);l.set("y",Math.floor(l.get("y")-e+b)+0.5)}this.trigger("move",this);void 0!==c&&!0===c&&(this.trigger("moveend",this,this.get("oldx"),this.get("oldy"),g.get("x"),g.get("y")),this.unset("oldx"),this.unset("oldy"))},computeCenter:function(){for(var a=Number.MAX_VALUE,b=-Number.MAX_VALUE,c=Number.MAX_VALUE,d=-Number.MAX_VALUE,e=0;e<this.get("controlPoints").size();e++){var f=
this.get("controlPoints").at(e),g=f.get("x"),f=f.get("y");g>b&&(b=g);g<a&&(a=g);f>d&&(d=f);f<c&&(c=f)}return{x:(b-a)/2+a,y:(d-c)/2+c}},moveLinePartTo:function(a,b,c,d,e){var f=this.get("controlPoints"),g=f.at(a);b=f.at(b);f=this.get("controlPointsType");c=Math.floor(c)+0.5;d=Math.floor(d)+0.5;if(!this.has("oldlinex")||!this.has("oldliney"))this.trigger("movelinestart",this,g.get("x"),g.get("y")),this.set("oldlinex",g.get("x")),this.set("oldliney",g.get("y"));f===Model.RCPType.HORIZONTAL_2CP?(g.set("y",
d),b.set("y",d)):f===Model.RCPType.VERTICAL_2CP?(g.set("x",c),b.set("x",c)):f===Model.RCPType.CROSS_3CP?g.get("x")===b.get("x")?(g.set("x",c),b.set("x",c)):(g.set("y",d),b.set("y",d)):f===Model.RCPType.HORIZONTAL_4CP?1===a?(g.set("x",c),b.set("x",c)):(g.set("y",d),b.set("y",d)):f===Model.RCPType.VERTICAL_4CP?1===a?(g.set("y",d),b.set("y",d)):(g.set("x",c),b.set("x",c)):f===Model.RCPType.SELF_4CP?g.get("x")===b.get("x")?(g.set("x",c),b.set("x",c)):(g.set("y",d),b.set("y",d)):f===Model.RCPType.SELF_5CP&&
(g.get("x")===b.get("x")?(g.set("x",c),b.set("x",c)):(g.set("y",d),b.set("y",d)));this.trigger("moveline",this);void 0!==e&&!0===e&&(this.trigger("movelineend",this,this.get("oldlinex"),this.get("oldliney"),g.get("x"),g.get("y")),this.unset("oldlinex"),this.unset("oldliney"))},getPreviousLinePosition:function(){return{x:this.get("oldlinex"),y:this.get("oldliney")}},getPreviousCPPosition:function(){return{x:this.get("oldcpx"),y:this.get("oldcpy")}},getBoundaryRect:function(){for(var a=Number.MAX_VALUE,
b=-Number.MAX_VALUE,c=Number.MAX_VALUE,d=-Number.MAX_VALUE,e=0;e<this.get("controlPoints").size();e++){var f=this.get("controlPoints").at(e),g=f.get("x"),f=f.get("y");g>b&&(b=g);g<a&&(a=g);f>d&&(d=f);f<c&&(c=f)}return{xmin:a,ymin:c,xmax:b,ymax:d}},inArea:function(a){for(var b=this.get("controlPoints"),c=0;c<b.size();c++){var d=b.at(c);if(d.get("x")<a.xmin||d.get("x")>a.xmax||d.get("y")<a.ymin||d.get("y")>a.ymax)return!1}return!0},setInSearchResults:function(){this.set("inSearchResults",!0);this.trigger("setInSearchResults",
this);Model.referenceDisplays.trigger("referenceDisplay_setInSearchResults",Model.referenceDisplays,this)},unsetInSearchResults:function(){this.set("inSearchResults",!1);this.trigger("unsetInSearchResults",this);Model.referenceDisplays.trigger("referenceDisplay_unsetInSearchResults",Model.referenceDisplays,this)},swap:function(){var a=this.get("pkTableDisplayId");this.set("pkTableDisplayId",this.get("fkTableDisplayId"));this.set("fkTableDisplayId",a);a=Model.ReferenceDisplay.getCPsAsArray(this.get("controlPoints"));
this.get("controlPoints").reset(a.reverse())}});Model.ReferenceDisplay.calculateRCPs_Horizontal_2CP=function(a,b,c,d,e,f){var g=[],k=Model.RCPType.HORIZONTAL_2CP;if(!1===f&&c.y>b.get("y")&&c.y<b.get("y")+b.get("height"))g[0]={x:c.x,y:c.y},g[1]={x:d.x,y:c.y};else if(!1===e&&d.y>a.get("y")&&d.y<a.get("y")+a.get("height"))g[0]={x:c.x,y:d.y},g[1]={x:d.x,y:d.y};else return Model.ReferenceDisplay.calculateRCPs_Horizontal_4CP(a,b,c,d);return Model.ReferenceDisplay.alignControlPoints({controlPoints:g,controlPointsType:k})};
Model.ReferenceDisplay.calculateRCPs_Horizontal_4CP=function(a,b,c,d){a=[];b=Model.RCPType.HORIZONTAL_4CP;var e=(c.x+d.x)/2;a[0]={x:c.x,y:c.y};a[1]={x:e,y:c.y};a[2]={x:e,y:d.y};a[3]={x:d.x,y:d.y};return Model.ReferenceDisplay.alignControlPoints({controlPoints:a,controlPointsType:b})};
Model.ReferenceDisplay.calculateRCPs_Cross_3CP=function(a,b,c,d){a=[];b=Model.RCPType.CROSS_3CP;var e;e=c.x!==d.x?Math.abs((d.y-c.y)/(d.x-c.x)):100;a[0]={x:c.x,y:c.y};a[1]=1>e?{x:d.x,y:c.y}:{x:c.x,y:d.y};a[2]={x:d.x,y:d.y};return Model.ReferenceDisplay.alignControlPoints({controlPoints:a,controlPointsType:b})};
Model.ReferenceDisplay.calculateRCPs_Vertical_2CP=function(a,b,c,d,e,f){var g=[],k=Model.RCPType.VERTICAL_2CP;if(!1===f&&c.x>b.get("x")&&c.x<b.get("x")+b.get("width"))g[0]={x:c.x,y:c.y},g[1]={x:c.x,y:d.y};else if(!1===e&&d.x>a.get("x")&&d.x<a.get("x")+a.get("width"))g[0]={x:d.x,y:c.y},g[1]={x:d.x,y:d.y};else return Model.ReferenceDisplay.calculateRCPs_Vertical_4CP(a,b,c,d);return Model.ReferenceDisplay.alignControlPoints({controlPoints:g,controlPointsType:k})};
Model.ReferenceDisplay.calculateRCPs_Vertical_4CP=function(a,b,c,d){a=[];b=Model.RCPType.VERTICAL_4CP;var e=(c.y+d.y)/2;a[0]={x:c.x,y:c.y};a[1]={x:c.x,y:e};a[2]={x:d.x,y:e};a[3]={x:d.x,y:d.y};return Model.ReferenceDisplay.alignControlPoints({controlPoints:a,controlPointsType:b})};
Model.ReferenceDisplay.calculateRCPs_Self=function(a,b,c){var d=[],e=Model.RCPType.SELF_5CP,f;f=b.y>a.get("y")+a.get("height")/2?a.get("y")+a.get("height")+30:a.get("y")-30;a=b.x>a.get("x")+a.get("width")/2?a.get("x")+a.get("width")+30:a.get("x")-30;d[0]={x:b.x,y:b.y};d[1]={x:b.x,y:f};d[2]={x:a,y:f};d[3]={x:a,y:c.y};d[4]={x:c.x,y:c.y};return Model.ReferenceDisplay.alignControlPoints({controlPoints:d,controlPointsType:e})};
Model.ReferenceDisplay.calculateRCPs=function(a,b,c,d){if(a.get("id")===b.get("id"))return Model.ReferenceDisplay.calculateRCPs_Self(a,c,d);if(c.x===d.x)return Model.ReferenceDisplay.calculateRCPs_Vertical_2CP(a,b,c,d,!1,!1);var e=Math.abs((d.y-c.y)/(d.x-c.x));return 0.2>e?Model.ReferenceDisplay.calculateRCPs_Horizontal_2CP(a,b,c,d,!1,!1):0.4>e?Model.ReferenceDisplay.calculateRCPs_Horizontal_4CP(a,b,c,d):2.5>e?Model.ReferenceDisplay.calculateRCPs_Cross_3CP(a,b,c,d):5>e?Model.ReferenceDisplay.calculateRCPs_Vertical_4CP(a,
b,c,d):Model.ReferenceDisplay.calculateRCPs_Vertical_2CP(a,b,c,d,!1,!1)};Model.ReferenceDisplay.alignControlPoints=function(a){for(var b=a.controlPoints,c=[],d=0;d<b.length;++d){var e=b[d];c.push({x:Math.floor(e.x)+0.5,y:Math.floor(e.y)+0.5})}return{controlPoints:c,controlPointsType:a.controlPointsType}};Model.ReferenceDisplay.getCPsAsArray=function(a){for(var b=[],c=0;c<a.length;c++){var d=a.at(c);b[c]={x:d.get("x"),y:d.get("y")}}return b};
Model.ReferenceDisplays=Backbone.Collection.extend({model:Model.ReferenceDisplay,findReferenceDisplayInArea:function(a,b){for(var c=this.where({modelId:a}),d=Model.areas.get(b).getArea(),e=0;e<c.length;e++){var f=c[e];if(f.inArea(d))return f}return null}});Model.referenceDisplays=new Model.ReferenceDisplays;Model.referenceDisplays.on("remove",function(a){a.unbindAllEvents()});Model.referenceDisplays.on("add",function(a){a.bindAllEvents()});Display.makeSelectable(Model.ReferenceDisplay);
Display.initialize=function(a){Model.tableDisplays.reset(a.tableDisplays);Model.referenceDisplays.reset(a.referenceDisplays)};Display.createReferenceDisplay=function(a,b,c,d,e){c=Model.ReferenceDisplay.calculateRCPs(a,b,c,d);return Model.referenceDisplays.create({id:Model.nextId("referenceDisplay"),modelId:e,pkTableDisplayId:a.get("id"),fkTableDisplayId:b.get("id"),color:"#000000",controlPoints:c.controlPoints,controlPointsType:c.controlPointsType})};Display.selection=new Display.Selection;
