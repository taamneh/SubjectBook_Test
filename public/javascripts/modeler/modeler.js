var Logger=function(){this.startAutoFlush();this.loggerStartedAt=(new Date).getTime()};
Logger.prototype={flushInterval:1E4,url:"/diagram-api/logger",queue:[],flush:function(){if(0!=this.queue.length){var a=this.queue;this.queue=[];a=JSON.stringify(a);$.ajax({type:"POST",url:"/diagram-api/logger",dataType:"json",data:a,processData:!1,async:!0,contentType:"application/json",dataType:"json"}).done(function(a){})}},now:function(){return(new Date).getTime()},warn:function(a){this.queue.push({level:"WARN",message:a})},info:function(a){this.queue.push({level:"INFO",message:a})},error:function(a){this.queue.push({level:"ERROR",
message:a})},secondsSinceStart:function(){return(this.now()-this.loggerStartedAt)/1E3},performanceWarning:function(a){a="Performance warning: "+a+(". Seconds since start: "+this.secondsSinceStart()+"  ");window&&(window.performance&&window.performance.memory)&&(a+="Memory info: "+JSON.stringify(window.performance.memory));this.warn(a)},startAutoFlush:function(){var a=this;$(function(){function b(){a.flush();setTimeout(b,a.flushInterval)}b()})}};
var logger=new Logger,Model={init:function(){Backbone.sync=function(a,b,c){};Model.fuseBox.create({id:"ajax"});Model.fuseBox.create({id:"table_limit"})},makeSelectable:function(a){a.prototype.select=function(){this.set("selected",!0);this.trigger("selected",this)};a.prototype.isSelected=function(){void 0===this.get("selected")&&this.set("selected",!1);return this.get("selected")};a.prototype.deselect=function(){this.set("selected",!1);this.trigger("deselected",this)};a.prototype.attach=function(){!0!=
this.get("attached")&&(this.set("attached",!0),this.trigger("attached",this))};a.prototype.isAttached=function(){void 0===this.get("attached")&&this.set("attached",!1);return this.get("attached")};a.prototype.detach=function(){this.set("attached",!1);this.trigger("detached",this)}}};
Model.Selection=Backbone.Model.extend({initialize:function(a){this.set("selected_element",null);this.set("attached_elements",[])},getSelectedElement:function(){return this.get("selected_element")},getAttachedElements:function(){return this.get("attached_elements").slice(0)},selectElement:function(a){this.clearAll();this.set("selected_element",a);a.select();this.trigger("element_selected",a,this);this.set("attached_elements",[a]);a.attach();this.trigger("element_attached",a,this);this.triggerSelectionChanged()},
selectAndAttachElement:function(a){var b=this.get("selected_element");a!==b&&(null!==b&&(this.set("selected_element",null),b.deselect(),this.trigger("element_deselected",b,this)),this.set("selected_element",a),a.select(),this.trigger("element_selected",a,this),!1===a.isAttached()&&(b=this.get("attached_elements").slice(0),b.push(a),this.set("attached_elements",b),a.attach(),this.trigger("element_attached",a,this)))},attachElement:function(a){if(!1===a.isAttached()){var b=this.get("attached_elements").slice(0);
b.push(a);this.set("attached_elements",b);a.attach();this.trigger("element_attached",a,this);this.triggerSelectionChanged()}},deselectAndDetachElement:function(a){var b=this.get("selected_element"),c=this.get("attached_elements");null!==b&&b.get("id")===a.get("id")&&(this.set("selected_element",null),b.deselect(),this.trigger("element_deselected",b,this));for(b=0;b<c.length;b++){var d=c[b];if(d.get("id")===a.get("id")){c.splice(b,1);d.detach();this.trigger("element_detached",d,this);break}}this.triggerSelectionChanged()},
deselectCurrentElement:function(){var a=this.get("selected_element");null!==a&&(a.deselect(),this.set("selected_element",null),this.trigger("element_deselected",a,this),this.triggerSelectionChanged())},clearAll:function(){this.deselectCurrentElement();var a=this.get("attached_elements");if(0<a.length){this.set("attached_elements",[]);for(var b=0;b<a.length;b++)a[b].detach();this.trigger("elements_detached",a,this);this.triggerSelectionChanged()}},_doTriggerSelectionChanged:function(){Model.selection.trigger("selection-changed")},
triggerSelectionChanged:function(){Model.groupOperation.isInProgress()?Model.groupOperation.addOnRelease(Model.selection._doTriggerSelectionChanged):this._doTriggerSelectionChanged()}});
Model.DiagramMode=Backbone.Model.extend({SELECT_MODE:"select",SELECT_RECT_MODE:"select-rect",ADD_TABLE_MODE:"add-table",ADD_RELATIONSHIP_MODE:"add-relationship",ADD_NOTE_MODE:"add-note",ADD_VIEW_MODE:"add-view",ADD_AREA_MODE:"add-area",initialize:function(a){this.set("mode",this.SELECT_MODE)},mode:function(){return this.get("mode")},is:function(a){return a==this.mode()},setMode:function(a){this.set("mode",a)}});Model.diagramMode=new Model.DiagramMode;
Model.Fuse=Backbone.Model.extend({initialize:function(){this.set("ok",!0)},blow:function(){this.set("ok",!1)},ok:function(){return this.get("ok")},notOk:function(){return!1==this.get("ok")},fix:function(){this.set("ok",!0)}});Model.FuseBox=Backbone.Collection.extend({model:Model.Fuse});Model.fuseBox=new Model.FuseBox;Model.Counter=Backbone.Model.extend({initialize:function(a){}});Model.Counters=Backbone.Collection.extend({model:Model.Counter});Model.counters=new Model.Counters;
Model.nextId=function(a){var b=Model.counters.get(a);if(void 0==b||null==b)throw Error("No such counter: '"+a+"'.");a=b.get("value");a+=1;b.set("value",a);return b.get("prefix")+a};
Model.Column=Backbone.Model.extend({initialize:function(a){var b=this,c=new Model.Properties;void 0!=this.get("properties")&&(c=new Model.Properties(this.get("properties")));c.column=this;c.on("all",function(a){if("add"==a||"remove"==a||"reset"==a||"change"==a)b.trigger("change:properties",b,c),b.trigger("change",b)});this.set("properties",c)}});
Model.Columns=Backbone.Collection.extend({model:Model.Column,getOrder:function(){for(var a=[],b=this.length,c=0;c<b;c++){var d=this.at(c);a.push(d.get("id"))}return a},setOrder:function(a){for(var b={},c=this.length,d=0;d<c;d++){var e=this.pop({silent:!0});b[e.get("id")]=e}for(d=0;d<a.length;d++)e=b[a[d]],this.add(e,{silent:!0});this.trigger("change:order",this);this.owner.trigger("change:columns",this.owner,this);this.owner.trigger("change",this.owner)}});
Model.AlternateKey=Backbone.Model.extend({initialize:function(a){var b=this,c=new Model.Properties;void 0!=this.get("properties")&&(c=new Model.Properties(this.get("properties")));c.alternateKey=this;c.on("all",function(a){if("add"==a||"remove"==a||"reset"==a||"change"==a)b.trigger("change:properties",b,c),b.trigger("change",b)});this.set("properties",c)}});Model.AlternateKeys=Backbone.Collection.extend({model:Model.AlternateKey});
Model.Index=Backbone.Model.extend({initialize:function(a){var b=this,c=new Model.Properties;void 0!=this.get("properties")&&(c=new Model.Properties(this.get("properties")));c.alternateKey=this;c.on("all",function(a){if("add"==a||"remove"==a||"reset"==a||"change"==a)b.trigger("change:properties",b,c),b.trigger("change",b)});this.set("properties",c)}});Model.Indexes=Backbone.Collection.extend({model:Model.Index});
Model.TableCheck=Backbone.Model.extend({initialize:function(a){var b=this,c=new Model.Properties;void 0!=this.get("properties")&&(c=new Model.Properties(this.get("properties")));c.tableCheck=this;c.on("all",function(a){if("add"==a||"remove"==a||"reset"==a||"change"==a)b.trigger("change:properties",b,c),b.trigger("change",b)});this.set("properties",c)}});Model.TableChecks=Backbone.Collection.extend({model:Model.TableCheck});
Model.Table=Backbone.Model.extend({urlRoot:"/diagram-api/table",initialize:function(){this.set("inSearchResults",!1);this.set("selectedInSearchResults",!1);this.set("hasErrors",!1);this.set("hasWarnings",!1);this.set("hasHints",!1);var a=this,b=new Model.Columns;void 0!=this.get("columns")&&(b=new Model.Columns(this.get("columns")));b.owner=this;b.on("all",function(c){if("add"==c||"remove"==c||"reset"==c||"change"==c)a.trigger("change:columns",a,b),a.trigger("change",a)});this.set("columns",b);var c=
new Model.AlternateKeys;void 0!=this.get("alternateKeys")&&(c=new Model.AlternateKeys(this.get("alternateKeys")));c.owner=this;c.on("all",function(b){if("add"==b||"remove"==b||"reset"==b||"change"==b)a.trigger("change:alternateKeys",a,c),a.trigger("change",a)});this.set("alternateKeys",c);var d=new Model.Indexes;void 0!=this.get("indexes")&&(d=new Model.Indexes(this.get("indexes")));d.table=this;d.on("all",function(b){if("add"==b||"remove"==b||"reset"==b||"change"==b)a.trigger("change:indexes",a,
d),a.trigger("change",a)});this.set("indexes",d);var e=new Model.TableChecks;void 0!=this.get("tableChecks")&&(e=new Model.TableChecks(this.get("tableChecks")));e.table=this;e.on("all",function(b){if("add"==b||"remove"==b||"reset"==b||"change"==b)a.trigger("change:tableChecks",a,e),a.trigger("change",a)});this.set("tableChecks",e);var f=new Model.Properties;void 0!=this.get("properties")&&(f=new Model.Properties(this.get("properties")));f.table=this;f.on("all",function(b){if("add"==b||"remove"==b||
"reset"==b||"change"==b)a.trigger("change:properties",a,f),a.trigger("change",a)});this.set("properties",f)},setInSearchResults:function(){this.set("inSearchResults",!0);this.trigger("setInSearchResults",this);Model.tables.trigger("table_setInSearchResults",Model.tables,this)},unsetInSearchResults:function(){this.set("inSearchResults",!1);this.trigger("unsetInSearchResults",this);Model.tables.trigger("table_unsetInSearchResults",Model.tables,this)},createColumn:function(a,b){var c=Model.nextId("column"),
d=this.get("columns").size()+1;void 0==a&&(a="column_"+d);void 0==b&&(b=Model.databaseTypes.getDefaultType());c=new Model.Column({id:c,name:a,type:b,nullable:!1,pk:!1,description:"describe me please",default_value:"",check_expression:"",properties:[]});this.addColumn(c);return c},addColumn:function(a){var b=this.get("columns");b.add(a);this.trigger("change:columns",this,b)},getColumn:function(a){a=this.get("columns").where({name:a});return 0==a.length?null:a[0]},getPrimaryKeyColumns:function(){return this.get("columns").where({pk:!0})},
createAlternateKey:function(a){var b=Model.nextId("alternate_key"),c=this.get("alternateKeys").size()+1,d=this.get("name");void 0==a&&(a=d+"_ak_"+c);a=new Model.AlternateKey({id:b,name:a,description:"",columns:[],properties:[]});this.addAlternateKey(a);return a},addAlternateKey:function(a){var b=this.get("alternateKeys");b.add(a);this.trigger("change:alternateKeys",this,b)},createIndex:function(a){var b=Model.nextId("index"),c=this.get("indexes").size()+1;void 0==a&&(a="idx_"+c);a=new Model.Index({id:b,
name:a,description:"",columns:[],properties:[]});this.addIndex(a);return a},addIndex:function(a){var b=this.get("indexes");b.add(a);this.trigger("change:indexes",this,b)},createTableCheck:function(){var a=Model.nextId("table_check"),b="check_"+(this.get("tableChecks").size()+1),a=new Model.TableCheck({id:a,name:b,description:"",checkExpression:"",properties:[]});this.addTableCheck(a);return a},addTableCheck:function(a){var b=this.get("tableChecks");b.add(a);this.trigger("change:tableChecks",this,
b)},computeCenter:function(){return{x:this.get("x")+this.get("width")/2,y:this.get("y")+this.get("height")/2}},getContentOfColumnLines:function(){for(var a=[],b=this.get("columns"),c=Model.references.findFKReferences(this.get("id")),d=[],e=0;e<c.length;e++)for(var f=c[e].get("referenceColumns"),g=0;g<f.length;g++)d.push(f.at(g).get("fkColumnId"));for(e=0;e<b.size();e++){g=b.at(e);c=[];g.get("nullable")&&c.push("N");g.get("pk")&&c.push("PK");0<=d.indexOf(g.get("id"))&&c.push("FK");var c=c.join(" "),
f=g.get("type"),g=g.get("name"),h=[];h.push(g);h.push(f);h.push(c);a.push(h)}return a}});Model.Tables=Backbone.Collection.extend({model:Model.Table});Model.RCPType={};Model.RCPType.VERTICAL_2CP="Vertical_2CP";Model.RCPType.HORIZONTAL_2CP="Horizontal_2CP";Model.RCPType.VERTICAL_4CP="Vertical_4CP";Model.RCPType.HORIZONTAL_4CP="Horizontal_4CP";Model.RCPType.CROSS_3CP="Cross_3CP";Model.RCPType.SELF_4CP="Self_4CP";Model.RCPType.SELF_5CP="Self_5CP";Model.Point=Backbone.Model.extend({initialize:function(a){}});
Model.Points=Backbone.Collection.extend({model:Model.Point});Model.ReferenceColumn=Backbone.Model.extend({initialize:function(a){}});Model.ReferenceColumns=Backbone.Collection.extend({model:Model.ReferenceColumn});
Model.Reference=Backbone.Model.extend({initialize:function(){var a=this;new Model.Points;var b=new Model.ReferenceColumns;void 0!=this.get("referenceColumns")&&(b=new Model.ReferenceColumns(this.get("referenceColumns")));this.set("referenceColumns",b);this.set("inSearchResults",!1);this.set("selectedInSearchResults",!1);var c=new Model.Properties;void 0!=this.get("properties")&&(c=new Model.Properties(this.get("properties")));c.reference=this;c.on("all",function(b){if("add"==b||"remove"==b||"reset"==
b||"change"==b)a.trigger("change:properties",a,c),a.trigger("change",a)});this.set("properties",c);this.bindAllEvents()},triggerTables:function(a){var b=Model.tables.get(this.get("pkTableId")),c=Model.tables.get(this.get("fkTableId"));a=a?"reference_connected":"reference_disconnected";b.trigger(a,this);b.get("id")!=c.get("id")&&c.trigger(a,this)},bindAllEvents:function(){var a=this.get("referenceColumns"),b=Model.tables.get(this.get("pkTableId")),c=Model.tables.get(this.get("fkTableId")),d="Reference: "+
this.get("name");dbwm.check(b,d+" pkTable "+this.get("pkTableId")).notNull();dbwm.check(c,d+" fkTable "+this.get("fkTableId")).notNull();this.unbindAllEvents();this.bindChangeReferenceColumnsEvents(a)},unbindAllEvents:function(){var a=this.get("referenceColumns"),b=Model.tables.get(this.get("pkTableId")),c=Model.tables.get(this.get("fkTableId"));dbwm.check(b,"pkTable "+this.get("pkTableId")).notNull();dbwm.check(c,"fkTable "+this.get("fkTableId")).notNull();a.off(null,null,this)},bindChangeReferenceColumnsEvents:function(a){var b=
this;a.on("all",function(c){if("add"===c||"remove"===c||"reset"===c||"change"===c)b.trigger("change:referenceColumns",b,a),b.trigger("change",b)},b)},setInSearchResults:function(){this.set("inSearchResults",!0);this.trigger("setInSearchResults",this);Model.references.trigger("reference_setInSearchResults",Model.references,this)},unsetInSearchResults:function(){this.set("inSearchResults",!1);this.trigger("unsetInSearchResults",this);Model.references.trigger("reference_unsetInSearchResults",Model.references,
this)},swap:function(){for(var a=this.get("referenceColumns"),b=null,c=0;c<a.size();c++){var d=a.at(c),b=d.get("pkColumnId");d.set("pkColumnId",d.get("fkColumnId"));d.set("fkColumnId",b)}b=this.get("pkRole");this.set("pkRole",this.get("fkRole"));this.set("fkRole",b);b=this.get("pkTableId");this.set("pkTableId",this.get("fkTableId"));this.set("fkTableId",b);this.trigger("swap_reference")}});
Model.References=Backbone.Collection.extend({model:Model.Reference,url:"/diagram-api/reference",findFKReferences:function(a){return this.where({fkTableId:a})},triggerTables:function(){for(var a=0;a<this.size();a++)this.at(a).triggerTables(!0)}});
Model.Sequence=Backbone.Model.extend({initialize:function(a){this.set("inSearchResults",!1);this.set("selectedInSearchResults",!1);this.set("hasErrors",!1);this.set("hasWarnings",!1);this.set("hasHints",!1);var b=this,c=new Model.Properties;void 0!=this.get("properties")&&(c=new Model.Properties(this.get("properties")));c.owner=this;c.on("all",function(a){if("add"==a||"remove"==a||"reset"==a||"change"==a)b.trigger("change:properties",b,c),b.trigger("change",b)});this.set("properties",c)},setInSearchResults:function(){this.set("inSearchResults",
!0);this.trigger("setInSearchResults",this);Model.sequences.trigger("sequence_setInSearchResults",Model.sequences,this)},unsetInSearchResults:function(){this.set("inSearchResults",!1);this.trigger("unsetInSearchResults",this);Model.sequences.trigger("sequence_unsetInSearchResults",Model.sequences,this)}});Model.Sequences=Backbone.Collection.extend({model:Model.Sequence});Model.sequences=new Model.Sequences;
Model.Note=Backbone.Model.extend({initialize:function(a){this.set("inSearchResults",!1);this.set("selectedInSearchResults",!1);this.set("hasErrors",!1);this.set("hasWarnings",!1);this.set("hasHints",!1)},setInSearchResults:function(){this.set("inSearchResults",!0);this.trigger("setInSearchResults",this);Model.notes.trigger("note_setInSearchResults",Model.notes,this)},unsetInSearchResults:function(){this.set("inSearchResults",!1);this.trigger("unsetInSearchResults",this);Model.notes.trigger("note_unsetInSearchResults",
Model.notes,this)},moveTo:function(a,b,c){b=Model.Util.alignPoint({x:a,y:b});a=b.x;b=b.y;var d=a-this.get("x"),e=b-this.get("y");if(!this.has("oldx")||!this.has("oldy"))this.trigger("movestart",this,this.get("x"),this.get("y")),this.set("oldx",this.get("x")),this.set("oldy",this.get("y"));if(0!==d||0!==e)this.set("x",a),this.set("y",b),this.trigger("move",this,d,e);void 0!==c&&!0===c&&(this.trigger("moveend",this,this.get("oldx"),this.get("oldy"),this.get("x"),this.get("y")),this.unset("oldx"),this.unset("oldy"))},
resize:function(a,b){a=Math.floor(a);b=Math.floor(b);var c=this.get("width"),d=this.get("height"),e=a-this.get("width"),f=b-this.get("height");this.trigger("resizestart",this,this.get("width"),this.get("height"));this.set({width:a,height:b});this.trigger("resize",this,a,b,e,f);this.trigger("resizeend",this,c,d,this.get("width"),this.get("height"))},moveControlPointTo:function(a,b,c,d){var e=Model.Util.alignPoint({x:b,y:c});b=e.x;c=e.y;var e=this.get("width"),f=this.get("height");a===Diagram.NoteControlPointIndex.TOP_LEFT?
(e=this.get("width")+(this.get("x")-b),f=this.get("height")+(this.get("y")-c),this.moveTo(b,c,d)):a===Diagram.NoteControlPointIndex.TOP_RIGHT?(e=b-this.get("x"),f=this.get("height")+(this.get("y")-c),this.moveTo(this.get("x"),c,d)):a===Diagram.NoteControlPointIndex.BOTTOM_LEFT?(e=this.get("width")+(this.get("x")-b),f=c-this.get("y"),this.moveTo(b,this.get("y"),d)):a===Diagram.NoteControlPointIndex.BOTTOM_RIGHT&&(e=b-this.get("x"),f=c-this.get("y"));e=Math.floor(e);f=Math.floor(f);a=e-this.get("width");
b=f-this.get("height");if(!this.has("oldwidth")||!this.has("oldheight"))this.trigger("resizestart",this,this.get("width"),this.get("height")),this.set("oldwidth",this.get("width")),this.set("oldheight",this.get("height"));if(0!==a||0!==b)this.set("width",e),this.set("height",f),this.trigger("resize",this,e,f,a,b);void 0!==d&&!0===d&&(this.trigger("resizeend",this,this.get("oldwidth"),this.get("oldheight"),this.get("width"),this.get("height")),this.unset("oldwidth"),this.unset("oldheight"))},getPreviousCPPosition:function(a){var b,
c,d,e;b=this.has("oldx")?this.get("oldx"):this.get("x");c=this.has("oldy")?this.get("oldy"):this.get("y");d=this.has("oldwidth")?this.get("oldwidth"):this.get("width");e=this.has("oldheight")?this.get("oldheight"):this.get("height");if(a===Diagram.NoteControlPointIndex.TOP_LEFT)a=b;else if(a===Diagram.NoteControlPointIndex.TOP_RIGHT)a=b+d;else if(a===Diagram.NoteControlPointIndex.BOTTOM_LEFT)a=b,c+=e;else if(a===Diagram.NoteControlPointIndex.BOTTOM_RIGHT)a=b+d,c+=e;else throw"Unknown note index "+
a;return{x:a,y:c}},getMinWidth:function(){return 50},getMinHeight:function(){return 25},inArea:function(a){return this.get("x")<a.xmin||this.get("y")<a.ymin||this.get("x")+this.get("width")>a.xmax||this.get("y")+this.get("height")>a.ymax?!1:!0},computeCenter:function(){return{x:this.get("x")+this.get("width")/2,y:this.get("y")+this.get("height")/2}},getBoundaryRect:function(){return{xmin:this.get("x"),ymin:this.get("y"),xmax:this.get("x")+this.get("width"),ymax:this.get("y")+this.get("height")}}});
Model.Notes=Backbone.Collection.extend({model:Model.Note});Model.notes=new Model.Notes;Model.ViewColumn=Backbone.Model.extend({initialize:function(a){var b=this,c=new Model.Properties;void 0!=this.get("properties")&&(c=new Model.Properties(this.get("properties")));c.column=this;c.on("all",function(a){if("add"==a||"remove"==a||"reset"==a||"change"==a)b.trigger("change:properties",b,c),b.trigger("change",b)});this.set("properties",c)}});
Model.ViewColumns=Backbone.Collection.extend({model:Model.ViewColumn,getOrder:function(){for(var a=[],b=this.length,c=0;c<b;c++){var d=this.at(c);a.push(d.get("id"))}return a},setOrder:function(a){for(var b={},c=this.length,d=0;d<c;d++){var e=this.pop({silent:!0});b[e.get("id")]=e}for(d=0;d<a.length;d++)e=b[a[d]],this.add(e,{silent:!0});this.trigger("change:order",this);this.owner.trigger("change:columns",this.owner,this);this.owner.trigger("change",this.owner)}});
Model.View=Backbone.Model.extend({urlRoot:"/diagram-api/view",initialize:function(){this.set("inSearchResults",!1);this.set("selectedInSearchResults",!1);this.set("hasErrors",!1);this.set("hasWarnings",!1);this.set("hasHints",!1);var a=this,b=new Model.ViewColumns;void 0!=this.get("columns")&&(b=new Model.ViewColumns(this.get("columns")));b.owner=this;b.on("all",function(c){if("add"==c||"remove"==c||"reset"==c||"change"==c)a.trigger("change:columns",a,b),a.trigger("change",a)});this.set("columns",
b);var c=new Model.Properties;void 0!=this.get("properties")&&(c=new Model.Properties(this.get("properties")));c.view=this;c.on("all",function(b){if("add"==b||"remove"==b||"reset"==b||"change"==b)a.trigger("change:properties",a,c),a.trigger("change",a)});this.set("properties",c)},setInSearchResults:function(){this.set("inSearchResults",!0);this.trigger("setInSearchResults",this);Model.views.trigger("view_setInSearchResults",Model.views,this)},unsetInSearchResults:function(){this.set("inSearchResults",
!1);this.trigger("unsetInSearchResults",this);Model.views.trigger("view_unsetInSearchResults",Model.views,this)},createColumn:function(a,b){var c=Model.nextId("view_column"),d=this.get("columns").size()+1;void 0==a&&(a="column_"+d);void 0==b&&(b=Model.databaseTypes.getDefaultType());c=new Model.ViewColumn({id:c,name:a,type:b,description:"",properties:[]});this.addColumn(c);return c},addColumn:function(a){var b=this.get("columns");b.add(a);this.trigger("change:columns",this,b)},getColumn:function(a){a=
this.get("columns").where({name:a});return 0==a.length?null:a[0]},resetColumns:function(a){var b=this.get("columns");b.reset(a);this.trigger("change:columns",this,b)},resetDependencies:function(a){this.set("dependencies",a);this._updateMinHeight();this.trigger("change:dependencies",this,a)},getInsideMargin:function(){return 10},adjustPointToInsideMargin:function(a){var b=this.getBoundaryRect(),c=this.getInsideMargin();a={x:a.x,y:a.y};a.x<b.xmin+c&&(a.x=b.xmin+c);a.x>b.xmax-c&&(a.x=b.xmax-c);a.y<b.ymin+
c&&(a.y=b.ymin+c);a.y>b.ymax-c&&(a.y=b.ymax-c);return a},getContentOfColumnLines:function(){for(var a=[],b=this.get("columns"),c=0;c<b.size();c++){var d=b.at(c),e=[];e.push(d.get("name"));e.push(d.get("type"));a.push(e)}return a},checkDependencyCycle:function(){var a=[],b=[];for(b.push(this.get("id"));0<b.length;){var c=b.splice(0,1)[0];a.push(c);c=Model.views.where({id:c});if(1!=c.length)throw Error("View's dependency is non-existing view!");var c=c[0].get("dependencies"),d;for(d in c){var e=c[d];
if(e===a[0])throw Error("There's cycle of dependencies!");0>a.indexOf(e)&&b.push(e)}}}});Model.Views=Backbone.Collection.extend({model:Model.View});Model.views=new Model.Views;
Model.Area=Backbone.Model.extend({TOP_LEFT:1,TOP_RIGHT:2,BOTTOM_LEFT:3,BOTTOM_RIGHT:4,urlRoot:"/diagram-api/area",initialize:function(){},setInSearchResults:function(){this.set("inSearchResults",!0);this.trigger("setInSearchResults",this);Model.areas.trigger("area_setInSearchResults",Model.areas,this)},unsetInSearchResults:function(){this.set("inSearchResults",!1);this.trigger("unsetInSearchResults",this);Model.areas.trigger("area_unsetInSearchResults",Model.areas,this)},moveTo:function(a,b,c){b=
Model.Util.alignPoint({x:a,y:b});a=b.x;b=b.y;var d=a-this.get("x"),e=b-this.get("y");if(!this.has("oldx")||!this.has("oldy"))this.trigger("movestart",this,this.get("x"),this.get("y")),this.set("oldx",this.get("x")),this.set("oldy",this.get("y"));if(0!==d||0!==e)this.set("x",a),this.set("y",b),this.trigger("move",this,d,e);void 0!==c&&!0===c&&(this.trigger("moveend",this,this.get("oldx"),this.get("oldy"),this.get("x"),this.get("y")),this.unset("oldx"),this.unset("oldy"))},computeNameRelativePosition:function(){var a=
this.get("nameX"),b=this.get("nameY"),c=this.get("width")/2,d=this.get("height")/2;a>c?b>d?(c=this.BOTTOM_RIGHT,a=this.get("width")-a,b=this.get("height")-b):(c=this.TOP_RIGHT,a=this.get("width")-a,b=-b):b>d?(c=this.BOTTOM_LEFT,a=-a,b=this.get("height")-b):(c=this.TOP_LEFT,a=-a,b=-b);return{xDiff:a,yDiff:b,corner:c}},moveControlPointTo:function(a,b,c,d){var e=Model.Util.alignPoint({x:b,y:c});b=e.x;c=e.y;var e=this.get("width"),f=this.get("height");a===Diagram.AreaControlPointIndex.TOP_LEFT?(e=this.get("width")+
(this.get("x")-b),f=this.get("height")+(this.get("y")-c),this.moveTo(b,c,d)):a===Diagram.AreaControlPointIndex.TOP_RIGHT?(e=b-this.get("x"),f=this.get("height")+(this.get("y")-c),this.moveTo(this.get("x"),c,d)):a===Diagram.AreaControlPointIndex.BOTTOM_LEFT?(e=this.get("width")+(this.get("x")-b),f=c-this.get("y"),this.moveTo(b,this.get("y"),d)):a===Diagram.AreaControlPointIndex.BOTTOM_RIGHT&&(e=b-this.get("x"),f=c-this.get("y"));e=Math.floor(e);f=Math.floor(f);a=e-this.get("width");b=f-this.get("height");
if(!this.has("oldwidth")||!this.has("oldheight"))this.trigger("resizestart",this,this.get("width"),this.get("height")),this.set("oldwidth",this.get("width")),this.set("oldheight",this.get("height")),c=this.computeNameRelativePosition(),this.set("oldNameRelativePosition",c);if(0!==a||0!==b)this.set("width",e),this.set("height",f),c=this.get("oldNameRelativePosition"),c=this.getNewNamePos(c,e,f),this.set({nameX:c.nameX,nameY:c.nameY}),this.trigger("resize",this,e,f,a,b);void 0!==d&&!0===d&&(this.trigger("resizeend",
this,this.get("oldwidth"),this.get("oldheight"),this.get("width"),this.get("height")),this.unset("oldwidth"),this.unset("oldheight"),this.unset("oldNameRelativePosition"))},resize:function(a,b){a=Math.floor(a);b=Math.floor(b);var c=this.get("width"),d=this.get("height"),e=a-this.get("width"),f=b-this.get("height");this.trigger("resizestart",this,this.get("width"),this.get("height"));var g=computeNameRelativePosition();this.set({width:a,height:b});g=getNewNamePos(g,a,b);this.set({nameX:g.nameX,nameY:g.nameY});
this.trigger("resize",this,a,b,e,f);this.trigger("resizeend",this,c,d,this.get("width"),this.get("height"))},getNewNamePos:function(a,b,c){var d,e;a.corner===this.BOTTOM_RIGHT?(d=b-a.xDiff,e=c-a.yDiff):a.corner===this.TOP_RIGHT?(d=b-a.xDiff,e=-a.yDiff):a.corner===this.BOTTOM_LEFT?(d=-a.xDiff,e=c-a.yDiff):a.corner===this.TOP_LEFT&&(d=-a.xDiff,e=-a.yDiff);return{nameX:d,nameY:e}},getMinWidth:function(){return Model.Area.MIN_WIDTH},getMinHeight:function(){return Model.Area.MIN_HEIGHT},getPreviousCPPosition:function(a){var b,
c,d,e;b=this.has("oldx")?this.get("oldx"):this.get("x");c=this.has("oldy")?this.get("oldy"):this.get("y");d=this.has("oldwidth")?this.get("oldwidth"):this.get("width");e=this.has("oldheight")?this.get("oldheight"):this.get("height");if(a===Diagram.AreaControlPointIndex.TOP_LEFT)a=b;else if(a===Diagram.AreaControlPointIndex.TOP_RIGHT)a=b+d;else if(a===Diagram.AreaControlPointIndex.BOTTOM_LEFT)a=b,c+=e;else if(a===Diagram.AreaControlPointIndex.BOTTOM_RIGHT)a=b+d,c+=e;else throw"Unknown area index "+
a;return{x:a,y:c}},inArea:function(a){return this.get("x")<a.xmin||this.get("y")<a.ymin||this.get("x")+this.get("width")>a.xmax||this.get("y")+this.get("height")>a.ymax?!1:!0},computeCenter:function(){return{x:this.get("x")+this.get("width")/2,y:this.get("y")+this.get("height")/2}},moveAreaName:function(a,b){this.set("nameX",a);this.set("nameY",b);this.trigger("move:name",this,this.get("nameX"),this.get("nameY"))},moveToTop:function(){var a=this.get("zIndex"),b=Model.areas.getMaxZIndex();b!=a&&this.set("zIndex",
b+1);this.trigger("change:moveToTop",this)},moveToBottom:function(){var a=this.get("zIndex"),b=_.map(Model.areas.models,function(a){return a.get("zIndex")}),b=_.reduce(b,function(a,b){return Math.min(a,b)},a);b!=a&&this.set("zIndex",b-1);this.trigger("change:moveToBottom",this)},moveUp:function(){var a=this.get("zIndex"),b=_.reduce(Model.areas.models,function(b,c){var f=b.zIndex,g=c.get("zIndex");if(g>a){if(null==f||g<f)return{zIndex:g,ids:[c.get("id")]};if(g==f)return g=b.ids.push(c.get("id")),{zIndex:f,
ids:g}}return b},{zIndex:null,ids:[]}),c=b.zIndex,b=b.ids;if(null!=c){this.set("zIndex",c);for(c=0;c<b.length;c++)Model.areas.get(b[c]).set("zIndex",a);this.trigger("change:moveUp",this)}},moveDown:function(){var a=this.get("zIndex"),b=_.reduce(Model.areas.models,function(b,c){var f=b.zIndex,g=c.get("zIndex");if(g<a){if(null==f||g>f)return{zIndex:g,ids:[c.get("id")]};if(g==f)return g=b.ids.push(c.get("id")),{zIndex:f,ids:g}}return b},{zIndex:null,ids:[]}),c=b.zIndex,b=b.ids;if(null!=c){this.set("zIndex",
c);for(c=0;c<b.length;c++)Model.areas.get(b[c]).set("zIndex",a);this.trigger("change:moveDown",this)}},setZIndex:function(a){this.set("zIndex",a);this.trigger("change:setZIndex",this)},getArea:function(){var a=this.get("x"),b=a+this.get("width"),c=this.get("y"),d=c+this.get("height");return{xmin:a,ymin:c,xmax:b,ymax:d}},getBoundaryRect:function(){return{xmin:this.get("x"),ymin:this.get("y"),xmax:this.get("x")+this.get("width"),ymax:this.get("y")+this.get("height")}}});Model.Area.MIN_HEIGHT=50;
Model.Area.MIN_WIDTH=50;
Model.Areas=Backbone.Collection.extend({model:Model.Area,getMaxZIndex:function(){var a=_.map(this.models,function(a){return a.get("zIndex")});return 0===a.length?0:_.reduce(a,function(a,c){return Math.max(a,c)},0)},getNextZIndex:function(){return this.getMaxZIndex()+1},getTableDisplayAreas:function(a){a=Model.tableDisplays.where({modelId:a});for(var b=[],c=0;c<this.models.length;c++){for(var d=this.models[c],e=!1,f=0;f<a.length;f++)a[f].inArea(d.getArea())&&(e=!0);e&&b.push(d)}return b},getTableDisplaysOutsideAreas:function(a){a=
Model.tableDisplays.where({modelId:a});for(var b=[],c=0;c<a.length;c++){for(var d=a[c],e=!0,f=0;f<this.models.length;f++)d.inArea(this.models[f].getArea())&&(e=!1);e&&b.push(d)}return b},getReferenceDisplayAreas:function(a){a=Model.referenceDisplays.where({modelId:a});for(var b=[],c=0;c<this.models.length;c++){for(var d=this.models[c],e=!1,f=0;f<a.length;f++)a[f].inArea(d.getArea())&&(e=!0);e&&b.push(d)}return b},getReferenceDisplaysOutsideAreas:function(a){a=Model.referenceDisplays.where({modelId:a});
for(var b=[],c=0;c<a.length;c++){for(var d=a[c],e=!0,f=0;f<this.models.length;f++)d.inArea(this.models[f].getArea())&&(e=!1);e&&b.push(d)}return b},getViewDisplayAreas:function(a){a=Model.viewDisplays.where({modelId:a});for(var b=[],c=0;c<this.models.length;c++){for(var d=this.models[c],e=!1,f=0;f<a.length;f++)a[f].inArea(d.getArea())&&(e=!0);e&&b.push(d)}return b},getViewDisplaysOutsideAreas:function(a){a=Model.viewDisplays.where({modelId:a});for(var b=[],c=0;c<a.length;c++){for(var d=a[c],e=!0,
f=0;f<this.models.length;f++)d.inArea(this.models[f].getArea())&&(e=!1);e&&b.push(d)}return b}});Model.createReference=function(a,b){return Model.references.create({id:Model.nextId("reference"),name:b.get("name")+"_"+a.get("name"),description:"",pkTableId:a.get("id"),fkTableId:b.get("id"),pkRole:"",fkRole:"",referenceColumns:[],cardinality:"0..*",onUpdateAction:"None",onDeleteAction:"None",mandatory:!0,properties:[]})};Model.AvailableAdditionalProperty=Backbone.Model.extend({initialize:function(a){}});
Model.AvailableAdditionalProperties=Backbone.Collection.extend({model:Model.AvailableAdditionalProperty});Model.availableTableProperties=new Model.AvailableAdditionalProperties;Model.availableColumnProperties=new Model.AvailableAdditionalProperties;Model.availableAlternateKeyProperties=new Model.AvailableAdditionalProperties;Model.availableIndexProperties=new Model.AvailableAdditionalProperties;Model.availableTableCheckProperties=new Model.AvailableAdditionalProperties;
Model.availableSequenceProperties=new Model.AvailableAdditionalProperties;Model.availableReferenceProperties=new Model.AvailableAdditionalProperties;Model.availableViewProperties=new Model.AvailableAdditionalProperties;Model.availableViewColumnProperties=new Model.AvailableAdditionalProperties;Model.Property=Backbone.Model.extend({initialize:function(a){}});Model.Properties=Backbone.Collection.extend({model:Model.Property});Model.properties=new Model.Properties;Model.tables=new Model.Tables;
Model.references=new Model.References;Model.references.on("remove",function(a){a.unbindAllEvents()});Model.references.on("add",function(a){a.bindAllEvents()});Model.areas=new Model.Areas;
Model.DatabaseTypeParsed=function(a){this.original=a;var b=/^([a-zA-Z0-9 ]+)\(([0-9%]+)\)$/,b=b.exec(a);if(null!=b)return this.type=b[1].toLowerCase(),this.len=b[2],this.prec=null,this;b=/^([a-zA-Z0-9 ]+)\(([0-9%]+),([0-9%]+)\)$/;b=b.exec(a);if(null!=b)return this.type=b[1].toLowerCase(),this.len=b[2],this.prec=b[3],this;b=/^([a-zA-Z0-9 ]+)\(([0-9%]+)\)([a-zA-Z0-9 ]+)\(([0-9%]+)\)$/;b=b.exec(a);if(null!=b)return this.type=(b[1]+" "+b[3]).replace(/\s+/g," ").toLowerCase(),this.len=b[2],this.prec=b[4],
this;b=/^([a-zA-Z0-9 ]+)\(([0-9%]+)\)([a-zA-Z0-9 ]+)$/;b=b.exec(a);if(null!=b)return this.type=(b[1]+" "+b[3]).replace(/\s+/g," ").toLowerCase(),this.len=b[2],this.prec=null,this;this.type=a.toLowerCase();this.prec=this.len=null;return this};Model.DatabaseTypeParsed.prototype={render:function(){var a=this.type;null!=this.len&&(a=a+"("+this.len);null!=this.prec&&(a+=",",a+=this.prec);null!=this.len&&(a+=")");return a}};
Model.DatabaseType=Backbone.Model.extend({isSimilar:function(a){var b=this.get("parsed");return b.type!=a.type||null!=b.len&&null==a.len||null==b.len&&null!=a.len||null!=b.prec&&null==a.prec||null==b.prec&&null!=a.prec?!1:!0}});
Model.DatabaseTypes=Backbone.Collection.extend({model:Model.DatabaseType,initialize:function(a){var b=this;this.on("reset",function(){for(var a=0;a<b.size();a++)b.at(a).set("parsed",new Model.DatabaseTypeParsed(b.at(a).get("type")))})},isSupported:function(a){a=new Model.DatabaseTypeParsed(a);for(var b=0;b<this.size();b++)if(this.at(b).isSimilar(a))return!0;return!1},getDefaultType:function(){return Model.databaseTypes.where({isVisible:!0})[0].get("type")},getCanonicalType:function(a){for(var b=new Model.DatabaseTypeParsed(a),
c=0;c<Model.databaseTypes.models.length;c++){var d=Model.databaseTypes.models[c];if(d.isSimilar(b)){a=d.get("canonicalTypePattern");a=a.replace("%",b.len);a=a.replace("%",b.prec);break}}return a},getFkType:function(a){for(var b=new Model.DatabaseTypeParsed(a),c=0;c<Model.databaseTypes.models.length;c++){var d=Model.databaseTypes.models[c];if(d.isSimilar(b))if(b=d.get("fkType"),null==b)break;else return b}return a}});Model.databaseTypes=new Model.DatabaseTypes;Model.SupportedObjectType=Backbone.Model.extend({});
Model.SupportedObjectTypes=Backbone.Collection.extend({model:Model.SupportedObjectType,has:function(a){return void 0!=this.get(a)},maxNameLength:function(a){return this.has(a)?parseInt(this.get(a).get("nameLength"),10):null}});Model.supportedObjectTypes=new Model.SupportedObjectTypes;Model.DatabaseModel=Backbone.Model.extend({});Model.DatabaseModels=Backbone.Collection.extend({model:Model.DatabaseModel});Model.databaseModels=new Model.DatabaseModels;Model.ModelVersion=Backbone.Model.extend({});
Model.ModelVersions=Backbone.Collection.extend({model:Model.ModelVersion});Model.modelVersions=new Model.ModelVersions;Model.MetaInfo=Backbone.Model.extend({initialize:function(a){},isEditable:function(){return"edit"==this.get("mode")},isReadOnly:function(){return!this.isEditable()}});Model.metaInfo=new Model.MetaInfo;Model.DiagramProperties=Backbone.Model.extend({});Model.diagramProperties=new Model.DiagramProperties;
Model.ApplicationProperties=Backbone.Model.extend({initialize:function(a){a=sessionStorage.getItem("display-left-panel");a=void 0==a||null==a?!0:"true"==a;var b=sessionStorage.getItem("display-right-panel"),b=void 0==b||null==b?!0:"true"==b;this.on("change:display-left-panel",this.saveDisplayPanel);this.on("change:display-right-panel",this.saveDisplayPanel);this.set({"display-left-panel":a,"display-right-panel":b});this.set({saveStatus:"ok"});this.set({dirtyModel:!1});this.set({loadCounter:0});this.set({saveInProgress:!1});
this.set({saveStatus:"ok"})},saveDisplayPanel:function(){sessionStorage.setItem("display-right-panel",this.get("display-right-panel"));sessionStorage.setItem("display-left-panel",this.get("display-left-panel"))}});Model.applicationProperties=new Model.ApplicationProperties;
Model.ValidationProperties=Backbone.Model.extend({key:function(a,b,c){return a+"_"+b+"_"+c.replace(/[^a-zA-Z]/g,"_")},setEnabled:function(a,b,c,d){this.set(this.key(a,b,c),d)},isEnabled:function(a,b,c){a=this.get(this.key(a,b,c));return void 0==a||null==a?!0:a}});Model.validationProperties=new Model.ValidationProperties;
Model.GoTo=Backbone.Model.extend({goTo:function(a,b){var c="goto";this.trigger("goto",a);for(var d=a.split("/"),e=0;e<d.length;e+=2){var f=d[e+1],c=c+"_"+d[e];this.trigger(c,f)}this.trigger(c+"/"+b,d[d.length-1])}});Model.goTo=new Model.GoTo;
Model.getById=function(a){var b=a.substring(0,1),c=null;"t"==b?c=Model.tables.get(a):"r"==b?c=Model.references.get(a):"s"==b?c=Model.sequences.get(a):"v"==b?c=Model.views.get(a):"td"==b?c=Model.tableDisplays.get(a):"rd"==b?c=Model.referenceDisplays.get(a):"vd"==b?c=Model.viewDisplays.get(a):"n"==b&&(c=Model.notes.get(a));return c};
Model.toJSON=function(){for(var a={tables:[],references:[],sequences:[],notes:[],counters:[],views:[],areas:[],tableDisplays:[],viewDisplays:[],referenceDisplays:[]},b=0;b<Model.tables.size();b++)a.tables.push(Model.tables.at(b).toJSON());for(b=0;b<Model.references.size();b++)a.references.push(Model.references.at(b).toJSON());for(b=0;b<Model.sequences.size();b++)a.sequences.push(Model.sequences.at(b).toJSON());for(b=0;b<Model.notes.size();b++)a.notes.push(Model.notes.at(b).toJSON());for(b=0;b<Model.counters.size();b++)a.counters.push(Model.counters.at(b).toJSON());
for(b=0;b<Model.views.size();b++)a.views.push(Model.views.at(b).toJSON());for(b=0;b<Model.areas.size();b++)a.areas.push(Model.areas.at(b).toJSON());for(b=0;b<Model.tableDisplays.size();b++)a.tableDisplays.push(Model.tableDisplays.at(b).toJSON());for(b=0;b<Model.viewDisplays.size();b++)a.viewDisplays.push(Model.viewDisplays.at(b).toJSON());for(b=0;b<Model.referenceDisplays.size();b++)a.referenceDisplays.push(Model.referenceDisplays.at(b).toJSON());a.diagramProperties=Model.diagramProperties.toJSON();
a.validationProperties=Model.validationProperties.toJSON();void 0!=Model.properties.get("additionalSQLBeforeCreate")&&(a.additionalSQLBeforeCreate=Model.properties.get("additionalSQLBeforeCreate").get("value"));void 0!=Model.properties.get("additionalSQLAfterCreate")&&(a.additionalSQLAfterCreate=Model.properties.get("additionalSQLAfterCreate").get("value"));void 0!=Model.properties.get("additionalSQLBeforeDrop")&&(a.additionalSQLBeforeDrop=Model.properties.get("additionalSQLBeforeDrop").get("value"));
void 0!=Model.properties.get("additionalSQLAfterDrop")&&(a.additionalSQLAfterDrop=Model.properties.get("additionalSQLAfterDrop").get("value"));a.modelProperties=Model.properties.toJSON();return a};
Model.initialize=function(a){var b=0==Model.supportedObjectTypes.size();Model.properties.reset(a.modelProperties);Model.properties.add(new Model.Property({id:"additionalSQLBeforeCreate",value:a.additionalSQLBeforeCreate}));Model.properties.add(new Model.Property({id:"additionalSQLAfterCreate",value:a.additionalSQLAfterCreate}));Model.properties.add(new Model.Property({id:"additionalSQLBeforeDrop",value:a.additionalSQLBeforeDrop}));Model.properties.add(new Model.Property({id:"additionalSQLAfterDrop",
value:a.additionalSQLAfterDrop}));Model.tables.reset(a.tables);Model.tableDisplays.reset(a.tableDisplays);Model.references.reset(a.references);Model.referenceDisplays.reset(a.referenceDisplays);Model.references.triggerTables();Model.sequences.reset(a.sequences);Model.notes.reset(a.notes);Model.counters.reset(a.counters);Model.views.reset(a.views);Model.viewDisplays.reset(a.viewDisplays);Model.databaseTypes.reset(a.databaseTypes);if(!1==Model.metaInfo.isReadOnly()||b)console.log("setting diagram properties"),
Model.diagramProperties.set(a.diagramProperties);Model.areas.reset(a.areas);Model.availableTableProperties.reset(a.properties.table);Model.availableColumnProperties.reset(a.properties.column);Model.availableAlternateKeyProperties.reset(a.properties.alternate_key);Model.availableIndexProperties.reset(a.properties.index);Model.availableTableCheckProperties.reset(a.properties.table_check);Model.availableSequenceProperties.reset(a.properties.sequence);Model.availableReferenceProperties.reset(a.properties.reference);
Model.availableViewProperties.reset(a.properties.view);Model.availableViewColumnProperties.reset(a.properties.view_column);Model.supportedObjectTypes.reset(a.supportedObjectTypes);Model.validationProperties.set(a.validationProperties);Model.updateToSaveModel();Model.metaInfo.set("modelLoad",!0);Model.metaInfo.set(a.metaInfo)};Model.setup={loadModelVersions:!1,loadDatabaseModels:!1,startMetaInfoUpdater:!1,usePublicModelLink:!1,useAdminModelLink:!1,isSaveEnabled:!1};
Model.loadDatabaseModels=function(){!1!=Model.setup.loadDatabaseModels&&$.ajax({type:"GET",url:"/diagram-api/models",dataType:"json"}).done(function(a){Model.databaseModels.reset(a)})};Model.loadModelVersions=function(){if(!1!=Model.setup.loadModelVersions){var a="/diagram-api/version/"+Model.metaInfo.get("id");Model.setup.useAdminModelLink&&(a="/diagram-api/adminVersion/"+Model.metaInfo.get("id"));$.ajax({type:"GET",url:a,dataType:"json"}).done(function(a){Model.modelVersions.reset(a)})}};
Model.load=function(a,b){var c=Model.setup.useAdminModelLink?"/diagram-api/admin_model/"+a:Model.setup.usePublicModelLink?"/diagram-api/public_model/"+a:"/diagram-api/model/"+a;b&&(c=c+"/"+b);Model.metaInfo.trigger("before-load");var d=(new Date).getTime();$.ajax({type:"GET",url:c,dataType:"json"}).done(function(a){Model.metaInfo.trigger("during-load-after-request");Model.doWithTimeout(function(){Model.groupOperation.doWithLock(function(){Model.initialize(a);Model.loadModelVersions()});Model.metaInfo.trigger("during-load-after-model-init");
Model.doWithTimeout(function(){void 0!==app.getDiagram()&&app.getDiagram().redrawDiagram();var a=Model.applicationProperties.get("loadCounter"),a=a+1;Model.applicationProperties.set("loadCounter",a);Model.metaInfo.trigger("after-load");1==a&&Model.metaInfo.trigger("after-initial-load");a=((new Date).getTime()-d)/1E3;logger.info("Model LOAD time: "+a+" Model: "+Model.metaInfo.get("id"))})})});Model.loadDatabaseModels()};Model.doWithTimeout=function(a){setTimeout(a,50)};
Model.reload=function(){var a=Model.metaInfo.get("id"),b=Model.metaInfo.get("versionId");void 0!=a&&Model.load(a,b)};Model.reloadToLatestVersion=function(){var a=Model.metaInfo.get("id");void 0!=a&&Model.load(a)};
Model.loadMetaInfo=function(){var a=Model.metaInfo.get("id");if(void 0!=a){var b="/diagram-api/metaInfo/"+a;Model.setup.useAdminModelLink?b="/diagram-api/adminMetaInfo/"+a:Model.setup.usePublicModelLink&&(b="/diagram-api/publicMetaInfo/"+a);$.ajax({type:"GET",url:b,dataType:"json"}).done(function(a){Model.metaInfo.set("modelLoad",!1);Model.metaInfo.set(a.metaInfo)})}};Model.metaInfoUpdaterInterval=5E3;
Model.startMetaInfoUpdater=function(){!1!=Model.setup.startMetaInfoUpdater&&$(function(){function a(){Model.loadMetaInfo();setTimeout(a,Model.metaInfoUpdaterInterval)}a()})};Model.takeControl=function(){var a=Model.metaInfo.get("id");void 0!=a&&$.ajax({type:"GET",url:"/diagram-api/takeControl/"+a,dataType:"json"}).done(function(a){Model.metaInfo.set("modelLoad",!1);Model.metaInfo.set(a.metaInfo)})};
Model.releaseControl=function(){var a=Model.metaInfo.get("id");void 0!=a&&$.ajax({type:"GET",url:"/diagram-api/releaseControl/"+a,dataType:"json"}).done(function(a){Model.metaInfo.set("modelLoad",!1);Model.metaInfo.set(a.metaInfo)})};
Model.tagVersion=function(a,b,c){var d=Model.metaInfo.get("id");void 0!=d&&(a=JSON.stringify({modelId:d,versionId:Model.metaInfo.get("versionId"),tag:a}),$.ajax({type:"POST",url:"/diagram-api/tagVersion/"+d,dataType:"json",data:a,processData:!1,async:!0,contentType:"application/json",dataType:"json"}).done(function(a){!0==a.alreadyExists?c():b()}))};Model.toSaveModel=null;Model.dirty=!1;Model.autosaverInterval=1E4;
Model.internalSave=function(a,b){if("read_only_edit_no_longer"!=Model.metaInfo.get("mode")&&!0==Model.metaInfo.isReadOnly()||!1==Model.setup.isSaveEnabled||Model.fuseBox.get("ajax").notOk())return!1;if(null==Model.toSaveModel)return console.log("Model.toSaveModel is null."),!1;var c=Model.metaInfo.get("id");console.time("toJSON");var d=Model.toSaveModel;d.operation=b;d=JSON.stringify(d);Model.applicationProperties.set("saveInProgress",!0);Model.applicationProperties.trigger("before-save");var e=(new Date).getTime();
$.ajax({type:"POST",url:"/diagram-api/model/"+c,data:d,processData:!1,async:!a,contentType:"application/json",dataType:"json"}).done(function(a){Model.applicationProperties.set("saveStatus",a.status);a.versionId&&Model.metaInfo.set("versionId",a.versionId);"ok"==a.status&&Model.fuseBox.get("table_limit").fix();"table_limit_reached"==a.status&&Model.fuseBox.get("table_limit").blow();"not_editor"==a.status&&console.log("You're not an editor. Not saved.");Model.dirty=!1;Model.applicationProperties.set("dirtyModel",
!1);Model.applicationProperties.set("saveInProgress",!1);Model.applicationProperties.trigger("after-save");a=((new Date).getTime()-e)/1E3;logger.info("Model SAVE time: "+a+" Model: "+Model.metaInfo.get("id"));5<a&&logger.performanceWarning("Saving model took "+a+" seconds")});return!0};Model.save=function(a){Model.touch();Model.internalSave(!1,a)};Model.autosave=function(){Model.internalSave(!1)};Model.updateToSaveModel=function(){Model.toSaveModel=Model.toJSON()};
Model.touch=function(){Model.applicationProperties.set("dirtyModel",!0);Model.dirty=!0;Model.updateToSaveModel()};Model.startAutosaver=function(){var a=this;$(function(){function b(){Model.dirty&&a.autosave();setTimeout(b,Model.autosaverInterval)}b()})};Model.makeSelectable(Model.Table);Model.makeSelectable(Model.Reference);Model.makeSelectable(Model.Sequence);Model.makeSelectable(Model.Note);Model.makeSelectable(Model.View);Model.makeSelectable(Model.Area);Model.selection=new Model.Selection;
Model.clearSearchResults=function(){for(var a=0;a<Model.tables.size();a++)Model.tables.at(a).unsetInSearchResults();for(a=0;a<Model.tableDisplays.size();a++)Model.tableDisplays.at(a).unsetInSearchResults();for(a=0;a<Model.references.size();a++)Model.references.at(a).unsetInSearchResults();for(a=0;a<Model.referenceDisplays.size();a++)Model.referenceDisplays.at(a).unsetInSearchResults();for(a=0;a<Model.sequences.size();a++)Model.sequences.at(a).unsetInSearchResults();for(a=0;a<Model.notes.size();a++)Model.notes.at(a).unsetInSearchResults();
for(a=0;a<Model.views.size();a++)Model.views.at(a).unsetInSearchResults();for(a=0;a<Model.viewDisplays.size();a++)Model.viewDisplays.at(a).unsetInSearchResults();for(a=0;a<Model.areas.size();a++)Model.areas.at(a).unsetInSearchResults()};Model.tableInSearchResults=function(a){a.setInSearchResults()};Model.referenceInSearchResults=function(a){a.setInSearchResults()};Model.sequenceInSearchResults=function(a){a.setInSearchResults()};Model.noteInSearchResults=function(a){a.setInSearchResults()};
Model.viewInSearchResults=function(a){a.setInSearchResults()};Model.areaInSearchResults=function(a){a.setInSearchResults()};
Model.GroupOperation=Backbone.Model.extend({releaseQueue:[],initialize:function(){this._isLockedFlag=!1;this.releaseQueue=[]},_isLocked:function(){return this._isLockedFlag},_lock:function(){this._isLockedFlag=!0},_release:function(){this._isLockedFlag=!1;_.each(this.releaseQueue,function(a){a()});this.releaseQueue=[]},doWithLock:function(a){if(this.isInProgress())a();else{this._lock();try{a()}finally{this._release()}}},isInProgress:function(){return this._isLocked()},addOnRelease:function(a){-1==
_.indexOf(this.releaseQueue,a)&&this.releaseQueue.push(a)}});Model.groupOperation=new Model.GroupOperation;Model.Util={alignPoint:function(a){return{x:Math.floor(a.x)+0.5,y:Math.floor(a.y)+0.5}}};Model.Problem=Backbone.Model.extend({});Model.Problems=Backbone.Collection.extend({model:Model.Problem});
Model.ProblemReport=Backbone.Model.extend({initialize:function(a){a=new Model.Problems;void 0!=this.get("errors")&&(a=new Model.Problems(this.get("errors")));this.set("errors",a);a=new Model.Problems;void 0!=this.get("warnings")&&(a=new Model.Problems(this.get("warnings")));this.set("warnings",a);a=new Model.Problems;void 0!=this.get("hints")&&(a=new Model.Problems(this.get("hints")));this.set("hints",a)}});Model.ProblemReports=Backbone.Collection.extend({model:Model.ProblemReport});
Model.problemReports=new Model.ProblemReports;Model.Validation={};
Model.Validation.Validator={dirty:!1,lastTouch:0,asyncInterval:1E3,asyncSafePeriod:2E3,touch:function(){this.dirty=!0;this.lastTouch=(new Date).getTime();Model.Validation.triggerWorker()},startAsyncValidator:function(){var a=this;$(function(){function b(){var c=(new Date).getTime();a.lastTouch+a.asyncSafePeriod<c&&a.dirty&&(a.dirty=!1,a.validateModel());setTimeout(b,a.asyncInterval)}b()})},validateModel:function(){Model.Validation.Cache={};this.validateTables(Model.tables);this.validateReferences(Model.references);
this.validateSequences(Model.sequences);this.validateViews(Model.views);Model.problemReports.trigger("after_validation")},validateTables:function(a){a.trigger("before_validation");for(var b=0;b<a.size();b++)this.validateTable(a.at(b));a.trigger("after_validation")},validateTable:function(a){var b="table/"+a.get("id"),c={errors:new Model.Problems,warnings:new Model.Problems,hints:new Model.Problems};this.validate(b,[a],"table",c);for(var d=a.get("columns"),b=0;b<d.size();b++){var e=d.at(b),f="table/"+
a.get("id")+"/column/"+e.get("id");this.validate(f,[a,e],"table_column",c)}d=a.get("indexes");for(b=0;b<d.size();b++)e=d.at(b),f="table/"+a.get("id")+"/index/"+e.get("id"),this.validate(f,[a,e],"table_index",c);d=a.get("alternateKeys");for(b=0;b<d.size();b++)e=d.at(b),f="table/"+a.get("id")+"/alternate_key/"+e.get("id"),this.validate(f,[a,e],"table_alternate_key",c);d=a.get("tableChecks");for(b=0;b<d.size();b++)e=d.at(b),f="table/"+a.get("id")+"/table_check/"+e.get("id"),this.validate(f,[a,e],"table_checks",
c);b=Model.problemReports.get(a.get("id"));0==c.errors.size()&&0==c.warnings.size()&&0==c.hints.size()?void 0!=b&&Model.problemReports.remove(b):void 0==b?(b=new Model.ProblemReport,b.set("errors",c.errors,{silent:!0}),b.set("warnings",c.warnings,{silent:!0}),b.set("hints",c.hints,{silent:!0}),b.set("id",a.get("id"),{silent:!0}),b.set("name","Table: "+a.get("name"),{silent:!0}),Model.problemReports.add(b)):(b.set("errors",c.errors,{silent:!0}),b.set("warnings",c.warnings,{silent:!0}),b.set("hints",
c.hints,{silent:!0}),b.set("name","Table: "+a.get("name"),{silent:!0}),b.trigger("change",Model.problemReports,b))},validateSequences:function(a){a.trigger("before_validation");for(var b=0;b<a.size();b++)this.validateSequence(a.at(b));a.trigger("after_validation")},validateSequence:function(a){var b="sequence/"+a.get("id"),c={errors:new Model.Problems,warnings:new Model.Problems,hints:new Model.Problems};this.validate(b,[a],"sequence",c);b=Model.problemReports.get(a.get("id"));0==c.errors.size()&&
0==c.warnings.size()&&0==c.hints.size()?void 0!=b&&Model.problemReports.remove(b):void 0==b?(b=new Model.ProblemReport,b.set("errors",c.errors,{silent:!0}),b.set("warnings",c.warnings,{silent:!0}),b.set("hints",c.hints,{silent:!0}),b.set("id",a.get("id"),{silent:!0}),b.set("name","Sequence: "+a.get("name"),{silent:!0}),Model.problemReports.add(b)):(b.set("errors",c.errors,{silent:!0}),b.set("warnings",c.warnings,{silent:!0}),b.set("hints",c.hints,{silent:!0}),b.set("name","Sequence: "+a.get("name"),
{silent:!0}),b.trigger("change",Model.problemReports,b))},validateReferences:function(a){a.trigger("before_validation");for(var b=0;b<a.size();b++)this.validateReference(a.at(b));a.trigger("after_validation")},validateReference:function(a){var b="reference/"+a.get("id"),c={errors:new Model.Problems,warnings:new Model.Problems,hints:new Model.Problems};this.validate(b,[a],"reference",c);b=Model.problemReports.get(a.get("id"));0==c.errors.size()&&0==c.warnings.size()&&0==c.hints.size()?void 0!=b&&Model.problemReports.remove(b):
void 0==b?(b=new Model.ProblemReport,b.set("errors",c.errors,{silent:!0}),b.set("warnings",c.warnings,{silent:!0}),b.set("hints",c.hints,{silent:!0}),b.set("id",a.get("id"),{silent:!0}),b.set("name","Reference: "+a.get("name"),{silent:!0}),Model.problemReports.add(b)):(b.set("errors",c.errors,{silent:!0}),b.set("warnings",c.warnings,{silent:!0}),b.set("hints",c.hints,{silent:!0}),b.set("name","Reference: "+a.get("name"),{silent:!0}),b.trigger("change",Model.problemReports,b))},validateViews:function(a){a.trigger("before_validation");
for(var b=0;b<a.size();b++)this.validateView(a.at(b));a.trigger("after_validation")},validateView:function(a){var b="view/"+a.get("id"),c={errors:new Model.Problems,warnings:new Model.Problems,hints:new Model.Problems};this.validate(b,[a],"view",c);for(var b=a.get("columns"),d=0;d<b.size();d++){var e=b.at(d),f="view/"+a.get("id")+"/column/"+e.get("id");this.validate(f,[a,e],"view_column",c)}b=Model.problemReports.get(a.get("id"));0==c.errors.size()&&0==c.warnings.size()&&0==c.hints.size()?void 0!=
b&&Model.problemReports.remove(b):void 0==b?(b=new Model.ProblemReport,b.set("errors",c.errors,{silent:!0}),b.set("warnings",c.warnings,{silent:!0}),b.set("hints",c.hints,{silent:!0}),b.set("id",a.get("id"),{silent:!0}),b.set("name","View: "+a.get("name"),{silent:!0}),Model.problemReports.add(b)):(b.set("errors",c.errors,{silent:!0}),b.set("warnings",c.warnings,{silent:!0}),b.set("hints",c.hints,{silent:!0}),b.set("name","View: "+a.get("name"),{silent:!0}),b.trigger("change",Model.problemReports,
b))},validate:function(a,b,c,d){this._validate(a,b,c,"errors",d.errors);this._validate(a,b,c,"warnings",d.warnings);this._validate(a,b,c,"hints",d.hints)},_validate:function(a,b,c,d,e){var f=Model.Validation.Rules[c];if(void 0==f)throw Error("No such rules: "+c);f=f[d];if(void 0==f)throw Error("No such rules level: "+c);for(var g in f)if("function"==typeof f[g]&&!1!=Model.validationProperties.isEnabled(c,d,g)){var h=f[g].apply(f,b);null!=h&&(h=new Model.Problem(h),h.set("id",a+":"+g.replace(" ","_")),
void 0==h.get("description")&&h.set("description",h.get("message")),void 0==h.get("name")&&h.set("name"," "),void 0==h.get("property")&&h.set("property","property"),e.add(h))}}};Model.Validation.Rules={};Model.Validation.Cache={};
Model.Validation.bindEvents=function(){var a=function(a,b){var e=a.get("id"),e=Model.getById(e);null==e?Model.problemReports.remove(a):(0<a.get("errors").size()?e.set("hasErrors",!0):e.set("hasErrors",!1),0<a.get("warnings").size()?e.set("hasWarnings",!0):e.set("hasWarnings",!1),0<a.get("hints").size()?e.set("hasHints",!0):e.set("hasHints",!1))};Model.problemReports.on("add",function(b,d){a(b)});Model.problemReports.on("change",function(b,d){a(b)});Model.problemReports.on("remove",function(a,b){var e=
Model.getById(a.get("id"));null!=e&&(e.set("hasErrors",!1),e.set("hasWarnings",!1),e.set("hasHints",!1))});var b=function(a){for(var b=0;b<a.size();b++)a.at(b).set({hasErrors:!1,hasWarnings:!1,hasHints:!1})};Model.problemReports.on("reset",function(c){b(Model.tables);b(Model.references);b(Model.sequences);b(Model.views);for(c=0;c<Model.problemReports.size();c++){var d=Model.problemReports.at(c);a(d)}});Model.metaInfo.on("change:modelLoad",function(a,b){!0==b&&Model.Validation.triggerWorker()})};
Model.Validation.init=function(){Model.Validation.bindEvents()};
Model.Validation.startWorker=function(){this.worker=new Worker("/assets/js/modeler/worker.js");this.worker.addEventListener("message",function(a){a=JSON.parse(a.data);void 0!=a.problems&&(Model.tables.trigger("before_validation"),Model.references.trigger("before_validation"),Model.sequences.trigger("before_validation"),Model.views.trigger("before_validation"),Model.problemReports.reset(a.problems),Model.tables.trigger("after_validation"),Model.references.trigger("after_validation"),Model.sequences.trigger("after_validation"),
Model.views.trigger("after_validation"),Model.problemReports.trigger("after_validation"));if(void 0!=a.debug){for(var b=["WORKER>"],c=0;c<a.debug.length;c++)b.push(a.debug[c]);console.log.apply(console,b)}},!1)};
Model.Validation.triggerWorker=function(){if(null==Model.toSaveModel)return console.log("no model to pass, ehh"),null;Model.tables.trigger("before_validation");Model.references.trigger("before_validation");Model.sequences.trigger("before_validation");Model.views.trigger("before_validation");Model.problemReports.trigger("before_validation");this.worker.postMessage(["validate",JSON.stringify(Model.toSaveModel),JSON.stringify(Model.validationProperties.toJSON()),JSON.stringify(Model.databaseTypes.toJSON()),
JSON.stringify(Model.supportedObjectTypes.toJSON())])};Model.Validation.loadPlugin=function(a){this.worker.postMessage(["importScript",a])};
Model.Validation.Rules.table={errors:{"Empty name":function(a){return""==a.get("name")?{property:"name",message:"Table name can't be empty."}:null},"Unique Name":function(a){var b=Model.tables.where({name:a.get("name")}),c=function(a){a=a.get("properties").get("Schema");return void 0!=a?a.get("value"):""},d=c(a);if(1<b.length)for(var e=0;e<b.length;e++){var f=b[e];if(f.get("id")!=a.get("id")&&d==c(f))return{property:"name",message:"Table name is not unique."}}return null},"No columns":function(a){return 0<
a.get("columns").size()?null:{message:"Table must have at least one column."}}},warnings:{"Generated name":function(a){a=a.get("name");return!1==/Table_[0-9]+/.test(a)?null:{property:"name",message:"You should change default table name."}},"Name length":function(a){a=a.get("name");var b=Model.supportedObjectTypes.maxNameLength("table");return null==b?null:a.length>b?{property:"name",message:"Table name is too long. Name can't exceed "+b+" characters."}:null},"If has PK column(s)":function(a){a=a.get("columns");
return 0==a.size()?null:0==a.where({pk:!0}).length?{message:"Table should have primary key."}:null}},hints:{"Alone table":function(a){a.get("id");return 1==Model.tables.size()?{message:"This table is alone. Add more tables."}:null}}};
Model.Validation.Rules.table_column={errors:{"Name can't be empty":function(a,b){return""==b.get("name")?{name:"<EMPTY>",message:"Column name can't be empty.",property:"name"}:null},"Empty type":function(a,b){return""==b.get("type")?{name:b.get("name"),message:"Column type can't be empty.",property:"type"}:null},"Unique name":function(a,b){return 1<a.get("columns").where({name:b.get("name")}).length?{name:b.get("name"),message:"Column name is not unique.",property:"name"}:null},"PK column must be not null":function(a,
b){return b.get("pk")&&b.get("nullable")?{name:b.get("name"),message:"Primary key column can't be null.",property:"nullable"}:null},"Percent placeholder in type":function(a,b){if(-1!=b.get("type").indexOf("%"))return{name:b.get("name"),message:"Type contains percent symbol.",property:"type"}}},warnings:{"Generated column name":function(a,b){var c=b.get("name");return!1==/column_[0-9]+/.test(c)?null:{name:c,message:"You should change default column name.",property:"name"}},"Name length":function(a,
b){var c=b.get("name"),d=Model.supportedObjectTypes.maxNameLength("column");return null==d?null:c.length>d?{name:c,message:"Column name is too long. Name can't exceed "+d+" characters.",property:"name"}:null},"Supported database type":function(a,b){var c=b.get("type");return!1==Model.databaseTypes.isSupported(c)?{name:b.get("name"),message:"Type is not supported by chosen database engine. ",property:"type"}:null}},hints:{}};
Model.Validation.Rules.table_index={errors:{"Name can't be empty":function(a,b){return""==b.get("name")?{name:"<EMPTY>",message:"Index name can't be empty.",property:"name"}:null},"Unique name":function(a,b){return 1<a.get("indexes").where({name:b.get("name")}).length?{name:b.get("name"),message:"Index must have unique name.",property:"name"}:null},"At least one column":function(a,b){return 0==b.get("columns").length?{name:b.get("name"),message:"Index must have at least one column.",property:"columns"}:
null}},warnings:{"Name length":function(a,b){var c=b.get("name"),d=Model.supportedObjectTypes.maxNameLength("index");return null==d?null:c.length>d?{name:c,message:"Index name is too long. Name can't exceed "+d+" characters.",property:"name"}:null}},hints:{}};
Model.Validation.Rules.table_alternate_key={errors:{"Name can't be empty":function(a,b){return""==b.get("name")?{name:"<EMPTY>",message:"Alternate key name can't be empty.",property:"name"}:null},"Unique name":function(a,b){void 0==Model.Validation.Cache.alternativeKeyNames&&(Model.Validation.Cache.alternativeKeyNames=_.flatten(Model.tables.map(function(a){return a.get("alternateKeys").map(function(a){return a.get("name")})})));var c=b.get("name");return 1<_.filter(Model.Validation.Cache.alternativeKeyNames,
function(a){return a==c}).length?{name:b.get("name"),message:"Alternate key must have unique name.",property:"name"}:null},"Check if has at least one column":function(a,b){return 0==b.get("columns").length?{name:b.get("name"),message:"Alternate key must have at least one column.",property:"columns"}:null}},warnings:{"Name length":function(a,b){var c=b.get("name"),d=Model.supportedObjectTypes.maxNameLength("alternate_key");return null==d?null:c.length>d?{name:c,message:"Alternate Key name is too long. Name can't exceed "+
d+" characters.",property:"name"}:null}},hints:{}};Model.Validation.Rules.table_checks={errors:{"Check expression can't be empty":function(a,b){return""==b.get("checkExpression")?{name:b.get("name"),message:"Check expression cannot be null",property:"checkExpression"}:null}},warnings:{},hints:{}};
Model.Validation.Rules.reference={_isReferenceColumnsMatchKey:function(a,b){var c=[],d=_.map(a.get("columns").where({pk:!0}),function(a){return a.get("id")});c.push(d);for(d=0;d<a.get("alternateKeys").size();++d){var e=a.get("alternateKeys").at(d);c.push(e.get("columns"))}e=!1;for(d=0;d<c.length;++d){var f=c[d];if(f.length==b.size()){for(var g=!0,h=0;h<b.size();h++){var k=b.at(h).get("pkColumnId");if(f[h]!==k){g=!1;break}}if(g){e=!0;break}}}return e},errors:{"Name cannot be empty":function(a){return""==
a.get("name")?{property:"name",message:"Reference name can't be empty."}:null},"Unique name":function(a){return 1<Model.references.where({name:a.get("name"),pkTableId:a.get("pkTableId")}).length?{property:"name",message:"Reference name must be unique."}:null},"Check PK/FK keys":function(a){var b=Model.tables.get(a.get("pkTableId")),c=Model.tables.get(a.get("fkTableId")),d=a.get("referenceColumns");if(0==d.length)return{property:"columns",message:"Please add columns that join primary and foreign tables."};
if(!Model.Validation.Rules.reference._isReferenceColumnsMatchKey(b,d))return{property:"columns",message:"Foreign key must reference columns that are either a primary key or an alternate key in the primary table"};for(var e=a.get("mandatory"),f=0;f<d.size();f++){var g=d.at(f),h=g.get("pkColumnId"),g=g.get("fkColumnId");if(void 0==h||void 0==g||null==h||null==g)return{name:a.get("name"),property:"columns",message:"Reference must have defined all pairs of columns."};var k=b.get("columns").get(h),h=c.get("columns").get(g);
if(void 0===k||void 0===h)return{name:a.get("name"),property:"columns",message:"Reference must have defined all pairs of columns."};var g=k.escape("name")+"&rarr;"+h.escape("name"),m=k.get("type"),k=h.get("type"),m=Model.databaseTypes.getCanonicalType(m),k=Model.databaseTypes.getCanonicalType(k);if(m!=k)return{name:g,property:"columns",message:"Column types are different in primary and foreign table."};if(e&&!0==h.get("nullable"))return{name:g,property:"columns",message:"Reference is marked as mandatory but foreign key column is nullable."}}return null}},
warnings:{"Unique name":function(a){var b=Model.references.where({name:a.get("name")});a=a.get("pkTableId");if(1<b.length)for(var c=0;c<b.length;c++)if(a!=b[c].get("pkTableId"))return{property:"name",message:"Reference name should be unique across model."};return null},"Name length":function(a){a=a.get("name");var b=Model.supportedObjectTypes.maxNameLength("reference");return null==b?null:a.length>b?{property:"name",message:"Reference name is too long. Name can't exceed "+b+" characters."}:null},
"Check if self reference is not mandatory":function(a){return a.get("pkTableId")==a.get("fkTableId")&&a.get("mandatory")?{name:a.get("name"),property:"mandatory",message:"Reference cannot be marked as 'mandatory' when connects the same table."}:null}},hints:{}};
Model.Validation.Rules.sequence={errors:{"Name can't be empty":function(a){return""==a.get("name")?{property:"name",message:"Sequence name can't be empty."}:null},"Unique name":function(a){return 1<Model.sequences.where({name:a.get("name")}).length?{property:"name",message:"Sequence name is not unique."}:null}},warnings:{"Lenght name":function(a){a=a.get("name");var b=Model.supportedObjectTypes.maxNameLength("sequence");return null==b?null:a.length>b?{property:"name",message:"Sequence name is too long. Name can't exceed "+
b+" characters."}:null}},hints:{}};
Model.Validation.Rules.view={errors:{"Empty name":function(a){return""==a.get("name")?{property:"name",message:"View name can't be empty."}:null},"Unique Name":function(a){return 1<Model.views.where({name:a.get("name")}).length?{property:"name",message:"View name is not unique."}:null},"No columns":function(a){return 0<a.get("columns").size()?null:{message:"View must have at least one column."}},"Cyclic dependencies":function(a){try{a.checkDependencyCycle()}catch(b){return{message:"There's a cycle of views' dependencies"}}return null},"Empty SQL query":function(a){return""===
a.get("sqlQuery").replace(/^\s+|\s+$/g,"")?{message:"View's SQL query cannot be empty"}:null}},warnings:{"Generated name":function(a){return-1==a.get("name").indexOf("View_")?null:{property:"name",message:"You should change default view name."}},"Name length":function(a){a=a.get("name");var b=Model.supportedObjectTypes.maxNameLength("view");return null==b?null:a.length>b?{property:"name",message:"View name is too long. Name can't exceed "+b+" characters."}:null}},hints:{}};
Model.Validation.Rules.view_column={errors:{"Name can't be empty":function(a,b){return""==b.get("name")?{name:"<EMPTY>",message:"Column name can't be empty.",property:"name"}:null},"Empty type":function(a,b){return""==b.get("type")?{name:b.get("name"),message:"Column type can't be empty.",property:"type"}:null},"Unique name":function(a,b){return 1<a.get("columns").where({name:b.get("name")}).length?{name:b.get("name"),message:"Column name is not unique.",property:"name"}:null},"Percent placeholder in type":function(a,
b){if(-1!=b.get("type").indexOf("%"))return{name:b.get("name"),message:"Type contains percent symbol.",property:"type"}}},warnings:{"Generated column name":function(a,b){var c=b.get("name");return-1==c.indexOf("column_")?null:{name:c,message:"You should change default column name.",property:"name"}},"Name length":function(a,b){var c=b.get("name"),d=Model.supportedObjectTypes.maxNameLength("column");return null==d?null:c.length>d?{name:c,message:"Column name is too long. Name can't exceed "+d+" characters.",
property:"name"}:null},"Supported database type":function(a,b){var c=b.get("type");return!1==Model.databaseTypes.isSupported(c)?{name:b.get("name"),message:"Type is not supported by chosen database engine. ",property:"type"}:null}},hints:{}};
var Commands={undoManager:null,groupUndoManager:null,groupUndoManagers:[],init:function(){this.undoManager=new UndoManager;var a=this;Commands.undoManager.setCallback(function(b){Model.applicationProperties.set("hasUndo",a.undoManager.hasUndo());Model.applicationProperties.set("hasRedo",a.undoManager.hasRedo())})},denied:function(){return!1==app.isEditable()},register:function(a,b,c,d,e,f){var g=this.undoManager;null!=this.groupUndoManager&&(g=this.groupUndoManager);if(void 0==a)throw Error("Undefined UNDO function. Operation: "+
c);if(void 0==d)throw Error("Undefined REDO function: Operation: "+f);g.register(this,a,b,c,this,d,e,f)},beginGroupCommands:function(){null!=this.groupUndoManager&&this.groupUndoManagers.push(this.groupUndoManager);this.groupUndoManager=new UndoManager},endGroupCommands:function(){if(null==this.groupUndoManager)throw Error("Registering group of commands is not in progress.");var a=this.groupUndoManager;this.groupUndoManager=this.groupUndoManagers.pop()||null;this.register(this.undoAll,[a],"Undo group of commands",
this.redoAll,[a],"Redo group of commands");this.afterChangeHook()},redoAll:function(a){Model.groupOperation.doWithLock(function(){for(;a.hasRedo();)a.redo()});this.afterChangeHook();this.refreshDiagram();this.notifySelectionChanged()},undoAll:function(a){Model.groupOperation.doWithLock(function(){for(;a.hasUndo();)a.undo()});this.afterChangeHook();this.refreshDiagram();this.notifySelectionChanged()},undo:function(){if(!this.denied()){if(null!=this.groupUndoManager)throw Error("Registering group of commands is in progress. Undo in not allowed here");
this.undoManager.undo();this.refreshDiagram();this.notifySelectionChanged()}},redo:function(){if(!this.denied()){if(null!=this.groupUndoManager)throw Error("Registering group of commands is in progress. Redo in not allowed here.");this.undoManager.redo();this.refreshDiagram();this.notifySelectionChanged()}},afterChangeHook:function(){null==this.groupUndoManager&&(Model.groupOperation.isInProgress()?(Model.groupOperation.addOnRelease(Model.touch),Model.groupOperation.addOnRelease(Model.Validation.Validator.touch)):
(Model.touch(),Model.Validation.Validator.touch()))},_redraw:function(){app.getDiagram().redrawDiagram()},refreshDiagram:function(){Model.groupOperation.isInProgress()?Model.groupOperation.addOnRelease(Commands._redraw):Commands._redraw()},_notifySelectionChanged:function(){Display.selection.triggerSelectionChanged();Model.selection.triggerSelectionChanged()},notifySelectionChanged:function(){Model.groupOperation.isInProgress()?Model.groupOperation.addOnRelease(Commands._notifySelectionChanged):Commands._notifySelectionChanged()},
changeTableName:function(a,b){if(!this.denied()){var c=Model.tables.get(a),d=c.get("name");c.set("name",b);this.register(this.changeTableName,[a,d],"Rename table",this.changeTableName,[a,b],"Rename table");this.afterChangeHook();this.refreshDiagram()}},changeTable:function(a,b,c){if(!this.denied()){var d=Model.tables.get(a),e=d.get(b);d.set(b,c);this.register(this.changeTable,[a,b,e],"Rename table",this.changeTable,[a,b,c],"Rename table");this.afterChangeHook();this.refreshDiagram()}},changeTableDisplay:function(a,
b,c){if(!this.denied()){var d=Model.tableDisplays.get(a),e=d.get(b);d.set(b,c);this.register(this.changeTableDisplay,[a,b,e],"Rename table",this.changeTableDisplay,[a,b,c],"Rename table");this.afterChangeHook();this.refreshDiagram()}},changeTableDescription:function(a,b){if(!this.denied()){var c=Model.tables.get(a),d=c.get("description");c.set("description",b);this.register(this.changeTableDescription,[a,d],"Change table description",this.changeTableDescription,[a,b],"Change table description");this.afterChangeHook()}},
_addTableOnly:function(a){Model.tables.add(a);this.afterChangeHook()},_addTableDisplayOnly:function(a){Model.tableDisplays.add(a);this.afterChangeHook()},deleteTable:function(a){if(!this.denied()){var b=Model.tables.get(a);if(void 0!=b){Commands.beginGroupCommands();for(var c=Model.references,d=[],e=0;e<c.size();e++){var f=c.at(e);(f.get("pkTableId")===a||f.get("fkTableId")===a)&&d.push(f)}for(e=0;e<d.length;e++)Commands.deleteReference(d[e].get("id"));d=Model.tableDisplays.where({modelId:b.get("id")});
for(e=0;e<d.length;e++)Commands.deleteTableDisplayOnly(d[e]);Commands.deleteTableOnly(b);Commands.endGroupCommands();this.refreshDiagram();this.notifySelectionChanged();this.afterChangeHook()}}},deleteTableDisplay:function(a){if(!this.denied()){Commands.beginGroupCommands();for(var b=Model.tableDisplays.get(a),c=Model.referenceDisplays,d=[],e=0;e<c.size();e++){var f=c.at(e);(f.get("pkTableDisplayId")===a||f.get("fkTableDisplayId")===a)&&d.push(f)}for(e=0;e<d.length;e++)f=d[e].get("id"),Commands.deleteReferenceDisplay(f);
Commands.deleteTableDisplayOnly(b);d=Model.tables.get(b.get("modelId"));a=[];if(0==Model.tableDisplays.where({modelId:b.get("modelId")})){b=Model.references;c=d.get("id");for(e=0;e<b.size();e++)f=b.at(e),(f.get("pkTableId")===c||f.get("fkTableId")===c)&&a.push(f);for(e=0;e<a.length;e++)Commands.deleteReference(a[e].get("id"));Commands.deleteTableOnly(d)}Commands.endGroupCommands();this.afterChangeHook();this.refreshDiagram();this.notifySelectionChanged()}},deleteTableOnly:function(a){Model.selection.deselectAndDetachElement(a);
Model.tables.remove(a);this.register(this._addTableOnly,[a],"Add table",this.deleteTableOnly,[a],"Delete table")},deleteTableDisplayOnly:function(a){Display.selection.deselectAndDetachElement(a);Model.tableDisplays.remove(a);this.register(this._addTableDisplayOnly,[a],"Add table display",this.deleteTableDisplayOnly,[a],"Delete table display")},createTableUsingJson:function(a){a=Model.tables.create(a);this.register(this.deleteTable,[a.get("id")],"Delete table",this._addTableOnly,[a],"add table");this.afterChangeHook();
this.refreshDiagram()},createTableDisplayUsingJson:function(a){a=Model.tableDisplays.create(a);this.register(this.deleteTableDisplay,[a.get("id")],"Delete table display",this._addTableDisplayOnly,[a,[]],"Add table display");this.afterChangeHook();this.refreshDiagram()},createTable:function(a,b){Commands.beginGroupCommands();var c=Commands.createTableOnly(),c=Commands.createTableDisplayOnly(c.get("id"),a,b);Commands.endGroupCommands();Display.selection.selectElement(c);this.afterChangeHook();this.refreshDiagram();
this.notifySelectionChanged()},createTableOnly:function(){var a=Model.nextId("table"),b="Table_"+a.slice(1),a=Model.tables.create({id:a,name:b,description:"",columns:[],alternateKeys:[],indexes:[],tableChecks:[],additionalSqlBefore:"",additionalSqlAfter:""});this.register(this.deleteTableOnly,[a],"Delete table",this._addTableOnly,[a],"add table");return a},createTableDisplayOnly:function(a,b,c){var d=Model.nextId("tableDisplay");a=Model.tableDisplays.create({id:d,modelId:a,x:Math.floor(b)-60+0.5,
y:Math.floor(c)-30+0.5,width:120,height:60,lineColor:"#000000",fillColor:"#ffffff",fixedSize:!1});this.register(this.deleteTableDisplayOnly,[a],"Delete table display",this._addTableDisplayOnly,[a],"add table display");return a},createTableDisplay:function(a,b,c){Model.tables.get(a);var d=Model.nextId("tableDisplay");a=Model.tableDisplays.create({id:d,modelId:a,x:b-60+0.5,y:c-30+0.5,width:120,height:60,lineColor:"#000000",fillColor:"#ffffff",fixedSize:!1});this.register(this.deleteTableDisplay,[d],
"Delete table",this._addTableDisplayOnly,[a],"add ghost table");Display.selection.selectElement(a);this.afterChangeHook();this.refreshDiagram();this.notifySelectionChanged()},moveTableDisplay:function(a,b,c,d){var e=Model.tableDisplays.get(a),f,g;f=e.has("oldx")?e.get("oldx"):e.get("x");g=e.has("oldy")?e.get("oldy"):e.get("y");e.moveTo(b,c,d);void 0!==d&&!0===d&&this.register(this.moveTableDisplay,[a,f,g,!0],"Move table",this.moveTableDisplay,[a,b,c,!0],"Move table");this.afterChangeHook();this.refreshDiagram()},
moveTableDisplayControlPointTo:function(a,b,c,d,e){var f=a.getPreviousCPPosition(b);a.moveControlPointTo(b,c,d,!0);void 0!==e&&!0===e&&this.register(this.moveTableDisplayControlPointTo,[a,b,f.x,f.y,!0],"Move table CP",this.moveTableDisplayControlPointTo,[a,b,c,d,!0],"Move table CP");this.afterChangeHook();this.refreshDiagram()},resizeTableDisplay:function(a,b,c){if(!this.denied()){var d=Model.tableDisplays.get(a),e=d.get("width"),f=d.get("height");d.resize(b,c);this.register(this.resizeTableDisplay,
[a,e,f],"resize table",this.resizeTableDisplay,[a,b,c],"resize table");this.afterChangeHook();this.refreshDiagram()}},_getTableDisplaySizeFitToText:function(a){a=Model.tableDisplays.get(a);for(var b=Model.tables.get(a.get("modelId")).getContentOfColumnLines(),c=0,d=0,e=0,f=0;f<b.length;f++){var g=b[f][0],h=b[f][1],k=b[f][2],g=app.getDiagram().measureColumnText(g),h=app.getDiagram().measureColumnText(h),k=app.getDiagram().measureColumnText(k);c<g&&(c=g);d<h&&(d=h);e<k&&(e=k)}f=a.get("width");k=a.get("height");
f=a.getMinWidth();c=c+d+e+25;f<c&&(f=c);c=a.getTitleText();c=app.getDiagram().measureTableTitle(c)+5;f<c&&(f=c);k=a.getMinHeight();a=app.getDiagram().measureHeight(b.length)+30;k<a&&(k=a);return{width:f,height:k}},adjustTableDisplaySizeToText:function(a){var b=this._getTableDisplaySizeFitToText(a);Commands.resizeTableDisplay(a,b.width,b.height)},eventuallyEnlargeTableSize:function(a){Model.tables.get(a);a=Model.tableDisplays.where({modelId:a});for(var b=0;b<a.length;b++){var c=a[b],d=this._getTableDisplaySizeFitToText(c.get("id")),
e=c.get("width"),f=c.get("height"),g=!1,h=e,k=f;e<d.width&&(h=d.width,g=!0);f<d.height&&(k=d.height,g=!0);!0===g&&!1==c.get("fixedSize")&&this.resizeTableDisplay(c.get("id"),h,k)}},setTableColumnsOrder:function(a,b){if(!this.denied()){var c=Model.tables.get(a).get("columns"),d=c.getOrder();c.setOrder(b);this.register(this.setTableColumnsOrder,[a,d],"Set table columns order",this.setTableColumnsOrder,[a,b],"set table columns order");this.afterChangeHook();this.refreshDiagram()}},_addTableColumn:function(a,
b,c,d,e){a=Model.tables.get(a);var f=a.get("columns");f.add(b);f.setOrder(c);f.trigger("after-add",b,f);if(void 0!=d)for(b=0;b<d.length;b++)c=d[b],a.get("alternateKeys").get(c.id).set("columns",c.columns);if(void 0!=e)for(b=0;b<e.length;b++)c=e[b],a.get("indexes").get(c.id).set("columns",c.columns);this.afterChangeHook()},deleteTableColumn:function(a,b){if(!this.denied()){for(var c=Model.tables.get(a),d=c.get("columns"),e=d.getOrder(),f=d.get(b),g=[],h=[],k=0;k<c.get("alternateKeys").size();k++){var m=
c.get("alternateKeys").at(k),n=m.get("columns"),r=n.indexOf(b);if(0<=r){var l=n.slice(0),n=n.slice(0);n.splice(r,1);g.push({id:m.get("id"),columns:l});m.set("columns",n)}}for(k=0;k<c.get("indexes").size();k++){m=c.get("indexes").at(k);n=m.get("columns");r=-1;for(l=0;l<n.length;l++)if(n[l].id==b){r=l;break}0<=r&&(l=n.slice(0),n=n.slice(0),n.splice(r,1),h.push({id:m.get("id"),columns:l}),m.set("columns",n))}d.remove(f);this.register(this._addTableColumn,[a,f,e,g,h],"Add column to table",this.deleteTableColumn,
[a,b],"Delete column");this.afterChangeHook();this.refreshDiagram()}},createTableColumn:function(a){if(!this.denied()){var b=Model.tables.get(a),c=b.createColumn(),d=c.get("id"),b=b.get("columns"),e=b.getOrder();this.register(this.deleteTableColumn,[a,d],"Delete column",this._addTableColumn,[a,c,e],"Add column to table");b.trigger("after-add",c,b);this.refreshDiagram();this.afterChangeHook();return c}},changeTableColumn:function(a,b,c,d){if(!this.denied()){var e=Model.tables.get(a).get("columns").get(b),
f=e.get(c);e.set(c,d);this.register(this.changeTableColumn,[a,b,c,f],"change table column",this.changeTableColumn,[a,b,c,d],"change table column");this.afterChangeHook();this.refreshDiagram()}},_addTableAlternateKey:function(a,b){Model.tables.get(a).get("alternateKeys").add(b)},createTableAlternateKey:function(a,b){if(!this.denied()){var c=Model.tables.get(a).createAlternateKey(b),d=c.get("id");this.register(this.deleteTableAlternateKey,[a,d],"Delete alternate key",this._addTableAlternateKey,[a,c],
"Add alternate key to table");this.afterChangeHook();return c}},deleteTableAlternateKey:function(a,b){if(!this.denied()){var c=Model.tables.get(a).get("alternateKeys"),d=c.get(b);c.remove(d);this.register(this._addTableAlternateKey,[a,d],"Add alternate key to table",this.deleteTableAlternateKey,[a,b],"delete alternate key");this.afterChangeHook()}},changeTableAlternateKey:function(a,b,c,d){if(!this.denied()){var e=Model.tables.get(a).get("alternateKeys").get(b),f=e.get(c);e.set(c,d);this.register(this.changeTableAlternateKey,
[a,b,c,f],"change alternate key",this.changeTableAlternateKey,[a,b,c,d],"change alternate key");this.afterChangeHook()}},_addTableIndex:function(a,b){Model.tables.get(a).get("indexes").add(b)},createTableIndex:function(a,b){if(!this.denied()){var c=Model.tables.get(a).createIndex(b),d=c.get("id");this.register(this.deleteTableIndex,[a,d],"Delete alternate index",this._addTableIndex,[a,c],"Add alternate index to table");this.afterChangeHook();return c}},deleteTableIndex:function(a,b){if(!this.denied()){var c=
Model.tables.get(a).get("indexes"),d=c.get(b);c.remove(d);this.register(this._addTableIndex,[a,d],"Add alternate index to table",this.deleteTableIndex,[a,b],"delete alternate index");this.afterChangeHook()}},changeTableIndex:function(a,b,c,d){if(!this.denied()){var e=Model.tables.get(a).get("indexes").get(b),f=e.get(c);e.set(c,d,{silent:!0});e.trigger("change:"+c,e);e.trigger("change",e);this.register(this.changeTableIndex,[a,b,c,f],"change alternate index",this.changeTableIndex,[a,b,c,d],"change alternate index");
this.afterChangeHook()}},_addTableTableCheck:function(a,b){Model.tables.get(a).get("tableChecks").add(b)},createTableTableCheck:function(a){if(!this.denied()){var b=Model.tables.get(a).createTableCheck(),c=b.get("id");this.register(this.deleteTableTableCheck,[a,c],"Delete table check",this._addTableTableCheck,[a,b],"Add table check to table");this.afterChangeHook();return b}},deleteTableTableCheck:function(a,b){if(!this.denied()){var c=Model.tables.get(a).get("tableChecks"),d=c.get(b);c.remove(d);
this.register(this._addTableTableCheck,[a,d],"Add table check to table",this.deleteTableTableCheck,[a,b],"delete  table check");this.afterChangeHook()}},changeTableTableCheck:function(a,b,c,d){if(!this.denied()){var e=Model.tables.get(a).get("tableChecks").get(b),f=e.get(c);e.set(c,d);this.register(this.changeTableTableCheck,[a,b,c,f],"change table check",this.changeTableTableCheck,[a,b,c,d],"change table check");this.afterChangeHook()}},_addReference:function(a){Model.references.add(a)},_addReferenceDisplays:function(a,
b){void 0!==b&&null!=b&&null==Model.references.get(b.get("id"))&&Model.references.add(b);for(var c=0;c<a.length;c++)Model.referenceDisplays.add(a[c])},deleteReference:function(a){console.log("Deleting reference");var b=Model.references.get(a);if(void 0!=b){Commands.beginGroupCommands();for(var c=Model.tables.get(b.get("fkTableId")),b=b.get("referenceColumns"),d=0;d<b.size();d++){var e=b.at(d),f=e.get("fkColumnId");console.log(e);console.log("FkColumId: ",f);null!=f&&Commands.deleteTableColumn(c.get("id"),
f)}Commands.deleteReferenceAllDisplays(a);Commands.deleteReferenceOnly(a);Commands.endGroupCommands();this.afterChangeHook();this.refreshDiagram();this.notifySelectionChanged()}},deleteReferenceAllDisplays:function(a){for(var b=Model.referenceDisplays.where({modelId:a}),c=0;c<b.length;c++){var d=b[c].get("id"),d=Model.referenceDisplays.get(d);Display.selection.deselectAndDetachElement(d);Model.referenceDisplays.remove(d)}this.register(this._addReferenceDisplays,[b],"Add reference",this.deleteReferenceAllDisplays,
[a],"Delete reference displays");this.afterChangeHook();this.refreshDiagram();this.notifySelectionChanged()},deleteReferenceDisplay:function(a){console.log("Deleting reference display");var b=Model.referenceDisplays.get(a);if(null!=b){Commands.beginGroupCommands();var c=Model.referenceDisplays.where({modelId:b.get("modelId")});Display.selection.deselectAndDetachElement(b);Model.referenceDisplays.remove(b);var d=Model.references.get(b.get("modelId"));1===c.length&&(Model.selection.deselectAndDetachElement(d),
Commands.deleteReference(d.get("id")));this.register(this._addReferenceDisplays,[[b],d],"Add reference",this.deleteReferenceDisplay,[a],"Delete reference displays");Commands.endGroupCommands();this.afterChangeHook();this.refreshDiagram();this.notifySelectionChanged()}},deleteReferenceOnly:function(a){if(!this.denied()){var b=Model.references.get(a);void 0!=b&&(Model.selection.deselectAndDetachElement(b),Model.references.remove(b),b.triggerTables(!1),this.register(this._addReference,[b],"Add reference",
this.deleteReferenceOnly,[a],"Delete referece"),this.afterChangeHook(),this.refreshDiagram(),this.notifySelectionChanged())}},_buildReferenceColumn:function(a,b,c){var d=Model.tables.get(b),e=Model.tables.get(c);c=[];b=d.getPrimaryKeyColumns();if(0==b.length)return[{pkColumnId:null,fkColumnId:null}];e.get("name");var d=d.get("name"),f=function(a,b){var c=Commands.createTableColumn(e.get("id"));Commands.changeTableColumn(e.get("id"),c.get("id"),"name",a);Commands.changeTableColumn(e.get("id"),c.get("id"),
"type",b);return c},g;for(g in b){var h=b[g],k=d+"_"+h.get("name"),m=e.getColumn(k);if(null==m)m=f(k,Model.databaseTypes.getFkType(h.get("type")));else{var n=2;a:for(;;n++)if(k=d+"_"+n+"_"+h.get("name"),m=e.getColumn(k),null==m){m=f(k,Model.databaseTypes.getFkType(h.get("type")));break a}}c.push({pkColumnId:h.get("id"),fkColumnId:m.get("id")})}g=new Model.ReferenceColumns(c);this.changeReference(a,"referenceColumns",g);return c},createReference:function(a,b,c,d){Commands.beginGroupCommands();var e=
Model.tableDisplays.get(a).get("modelId"),f=Model.tableDisplays.get(b).get("modelId"),g=Commands.createReferenceOnly(e,f);Commands.createReferenceDisplayOnly(g,a,b,c,d);Commands._buildReferenceColumn(g,e,f);Commands.eventuallyEnlargeTableSize(f);Commands.endGroupCommands();this.afterChangeHook();this.refreshDiagram();this.notifySelectionChanged()},createReferenceOnly:function(a,b){if(!this.denied()){var c=Model.tables.get(a),d=Model.tables.get(b),c=Model.createReference(c,d),d=c.get("id");this.register(this.deleteReference,
[d],"Delete referece",this._addReference,[c],"Add reference");c.triggerTables(!0);return d}},createReferenceDisplayOnly:function(a,b,c,d,e){this.denied()||(b=Model.tableDisplays.get(b),c=Model.tableDisplays.get(c),a=Display.createReferenceDisplay(b,c,d,e,a),this.register(this.deleteReferenceDisplay,[a.get("id")],"Delete reference display",this._addReferenceDisplays,[[a]],"Add reference display"),Display.selection.selectElement(a),this.afterChangeHook(),this.refreshDiagram(),this.notifySelectionChanged())},
createReferenceUsingJson:function(a){a=Model.references.create(a);var b=a.get("id");this.register(this.deleteReference,[b],"Delete referece",this._addReference,[a],"Add reference");a.triggerTables(!0);this.afterChangeHook();this.refreshDiagram()},createReferenceDisplayUsingJson:function(a){a=Model.referenceDisplays.create(a);var b=a.get("id");this.register(this.deleteReferenceDisplay,[b],"Delete referece display",this._addReferenceDisplays,[[a]],"Add reference display");this.afterChangeHook();this.refreshDiagram()},
changeReference:function(a,b,c){if(!this.denied()){var d=Model.references.get(a),e=d.get(b);d.set(b,c);d.triggerTables(!0);this.register(this.changeReference,[a,b,e],"change table column",this.changeReference,[a,b,c],"change table column");this.afterChangeHook();this.refreshDiagram()}},changeReferenceDisplay:function(a,b,c){if(!this.denied()){var d=Model.referenceDisplays.get(a),e=d.get(b);d.set(b,c);this.register(this.changeReferenceDisplay,[a,b,e],"change table column",this.changeReferenceDisplay,
[a,b,c],"change table column");this.afterChangeHook();this.refreshDiagram()}},removeReferenceColumns:function(a,b){if(!this.denied()){var c=Model.references.get(a),c=new Model.ReferenceColumns(c.get("referenceColumns").toJSON()),d=c.at(b);c.remove(d);Commands.changeReference(a,"referenceColumns",c)}},addReferenceColumns:function(a){if(!this.denied()){a=Model.references.get(a);var b=new Model.ReferenceColumns(a.get("referenceColumns").toJSON()),c=new Model.ReferenceColumn({pkColumnId:null,fkColumnId:null});
b.add(c);Commands.changeReference(a.get("id"),"referenceColumns",b)}},changeReferenceColumns:function(a,b,c,d){if(!this.denied()){a=Model.references.get(a);var e=new Model.ReferenceColumns(a.get("referenceColumns").toJSON());b=e.at(b);dbwm.check(b).notNull();b.set(c+"ColumnId",d);Commands.changeReference(a.get("id"),"referenceColumns",e)}},swapReference:function(a){this.denied()||(Model.references.get(a).swap(),this.register(this.swapReference,[a],"swap reference",this.swapReference,[a],"swap reference"),
this.afterChangeHook(),this.refreshDiagram())},changeReferenceMandatory:function(a,b){Commands.beginGroupCommands();for(var c=Model.references.get(a),d=Model.tables.get(c.get("fkTableId")),c=c.get("referenceColumns"),e=0;e<c.size();e++){var f=c.at(e).get("fkColumnId");null!=f&&Commands.changeTableColumn(d,f,"nullable",!b)}Commands.changeReference(a,"mandatory",b);Commands.endGroupCommands()},_addSequence:function(a){Model.sequences.add(a);this.afterChangeHook()},deleteSequence:function(a){if(!this.denied()){var b=
Model.sequences.get(a);Display.selection.deselectAndDetachElement(b);Model.sequences.remove(b);this.register(this._addSequence,[b],"Add sequence",this.deleteSequence,[a],"Delete sequence");this.refreshDiagram();this.afterChangeHook();this.notifySelectionChanged()}},moveReferenceDisplay:function(a,b,c,d){var e=a.get("controlPoints").at(0),f=e.get("x")-a.get("oldx"),e=e.get("y")-a.get("oldy");a.move(b,c,d);void 0!==d&&!0===d&&this.register(this.moveReferenceDisplay,[a,-f,-e,!0],"Move reference display",
this.moveReferenceDisplay,[a,b,c,!0],"Move reference display");this.afterChangeHook()},moveReferenceDisplayLinePartTo:function(a,b,c,d,e,f){var g=a.getPreviousLinePosition();a.moveLinePartTo(b,c,d,e,!0);void 0!==f&&!0===f&&this.register(this.moveReferenceDisplayLinePartTo,[a,b,c,g.x,g.y,!0],"Move reference line",this.moveReferenceDisplayLinePartTo,[a,b,c,d,e,!0],"Move reference line");this.afterChangeHook();this.refreshDiagram()},moveReferenceDisplayControlPointTo:function(a,b,c,d,e){var f=a.getPreviousCPPosition();
a.moveControlPointTo(b,c,d,!0);void 0!==e&&!0===e&&this.register(this.moveReferenceDisplayControlPointTo,[a,b,f.x,f.y,!0],"Move reference control point",this.moveReferenceDisplayControlPointTo,[a,b,c,d,!0],"Move reference control point");this.afterChangeHook();this.refreshDiagram()},createSequence:function(){if(!this.denied()){var a=Model.nextId("sequence"),b="Sequence_"+a.slice(1),a=Model.sequences.create({id:a,name:b,description:"",startWith:"",incrementBy:"",minValue:"",hasMinValue:!1,maxValue:"",
hasMaxValue:!1,cycle:!1,cache:"",hasCache:!1,additionalSqlBefore:"",additionalSqlAfter:"",properties:[]});this.register(this.deleteSequence,[a.get("id")],"delete sequence",this._addSequence,[a,[]],"add sequence");Display.selection.selectElement(a);this.afterChangeHook();this.notifySelectionChanged()}},changeSequence:function(a,b,c){if(!this.denied()){var d=Model.sequences.get(a),e=d.get(b);d.set(b,c);this.register(this.changeSequence,[a,b,e],"change sequence",this.changeSequence,[a,b,c],"change sequence");
this.afterChangeHook()}},_addNote:function(a){Model.notes.add(a);this.afterChangeHook()},createNote:function(a,b){if(!this.denied()){var c=Model.nextId("note"),d="Note "+c.slice(1),c=Model.notes.create({id:c,name:d,content:"",x:a-60+0.5,y:b-30+0.5,width:120,height:60,lineColor:"#000000",fillColor:"#fff9c3"});this.register(this.deleteNote,[c.get("id")],"Delete note",this._addNote,[c,[]],"add note");Display.selection.selectElement(c);this.afterChangeHook();this.refreshDiagram();this.notifySelectionChanged()}},
deleteNote:function(a){if(!this.denied()){var b=Model.notes.get(a);Display.selection.deselectAndDetachElement(b);Model.notes.remove(b);this.register(this._addNote,[b],"Add note",this.deleteNote,[a],"Delete note");this.refreshDiagram();this.notifySelectionChanged();this.afterChangeHook()}},changeNote:function(a,b,c){if(!this.denied()){var d=Model.notes.get(a),e=d.get(b);d.set(b,c);this.register(this.changeNote,[a,b,e],"change note",this.changeNote,[a,b,c],"change note");this.afterChangeHook();this.refreshDiagram()}},
createNoteUsingJson:function(a){a=Model.notes.create(a);this.register(this.deleteNote,[a.get("id")],"Delete note",this._addNote,[a,[]],"add note");this.afterChangeHook();this.refreshDiagram()},moveNote:function(a,b,c,d){if(!this.denied()){var e=Model.notes.get(a),f,g;f=e.has("oldx")?e.get("oldx"):e.get("x");g=e.has("oldy")?e.get("oldy"):e.get("y");e.moveTo(b,c,d);void 0!==d&&!0===d&&this.register(this.moveNote,[a,f,g,!0],"Move note",this.moveNote,[a,b,c,!0],"Move note");this.afterChangeHook();this.refreshDiagram()}},
moveNoteControlPointTo:function(a,b,c,d,e){var f=a.getPreviousCPPosition(b);a.moveControlPointTo(b,c,d,!0);void 0!==e&&!0===e&&this.register(this.moveNoteControlPointTo,[a,b,f.x,f.y,!0],"Move note CP",this.moveNoteControlPointTo,[a,b,c,d,!0],"Move note CP");this.afterChangeHook();this.refreshDiagram()},resizeNote:function(a,b,c){if(!this.denied()){var d=Model.notes.get(a),e=d.get("width"),f=d.get("height");d.resize(b,c);this.register(this.resizeNote,[a,e,f,!0],"resize note",this.resizeNote,[a,b,c,
!0],"resize note");this.afterChangeHook();this.refreshDiagram()}},_getNoteSizeFitToText:function(a){var b=Model.notes.get(a);a=b.get("width");var c=b.get("height"),d=b.get("content").split("\n");a=b.getMinWidth();for(c=0;c<d.length;++c){var e=d[c],e=app.getDiagram().measureNoteTextWidth(e)+25;a<e&&(a=e)}c=b.getMinHeight();b=app.getDiagram().measureHeight(d.length)+15;c<b&&(c=b);return{width:a,height:c}},adjustNoteSizeToText:function(a){var b=this._getNoteSizeFitToText(a);this.resizeNote(a,b.width,
b.height)},eventuallyEnlargeNoteSize:function(a){var b=Model.notes.get(a),c=b.get("width"),b=b.get("height"),d=this._getNoteSizeFitToText(a),e=!1,f=c,g=b;c<d.width&&(f=d.width,e=!0);b<d.height&&(g=d.height,e=!0);!0===e&&this.resizeNote(a,f,g)},_addAdditionalProperty:function(a,b){a.add(b);this.register(this.disableAdditionalProperty,[a,b.get("id")],"disable additonal property",this._addAdditionalProperty,[a,b],"enable additional property");this.afterChangeHook()},disableAdditionalProperty:function(a,
b){if(!this.denied()){var c=a.get(b);a.remove(b);this.register(this._addAdditionalProperty,[a,c],"disable additonal property",this.disableAdditionalProperty,[a,b],"enable additional property");this.afterChangeHook()}},enableAdditionalProperty:function(a,b){if(!this.denied()){var c=b.get("default_value"),d=b.get("type");null==c&&("boolean"==d?c="false":"text"==d?c="":"list"==d&&(d=b.get("options"),0<d.length&&(c=d[0])));c=new Model.Property({id:b.get("id"),value:c});a.add(c);this.register(this.disableAdditionalProperty,
[a,c.get("id")],"disable additonal property",this.enableAdditionalProperty,[a,b],"enable additional property");this.afterChangeHook()}},changeAdditionalProperty:function(a,b,c){if(!this.denied()){var d=a.get(b),e=d.get("value");d.set("value",c);this.register(this.changeAdditionalProperty,[a,b,e],"disable additonal property",this.changeAdditionalProperty,[a,b,c],"enable additional property");this.afterChangeHook()}},_addViewOnly:function(a){Model.views.add(a);this.afterChangeHook()},_addViewDisplayOnly:function(a){Model.viewDisplays.add(a);
this.afterChangeHook()},createView:function(a,b){Commands.beginGroupCommands();var c=Commands.createViewOnly(),c=Commands.createViewDisplayOnly(c.get("id"),a,b);Commands.endGroupCommands();Display.selection.selectElement(c);this.refreshDiagram();this.notifySelectionChanged();this.afterChangeHook()},createViewOnly:function(){var a=Model.nextId("view"),b="View_"+a.slice(1),a=Model.views.create({id:a,name:b,description:"",sqlQuery:"",columns:[],additionalSqlBefore:"",additionalSqlAfter:"",dependencies:[]});
this.register(this.deleteViewOnly,[a.get("id")],"Delete view",this._addViewOnly,[a],"Add view");return a},createViewDisplayOnly:function(a,b,c){var d=Model.nextId("viewDisplay");a=Model.viewDisplays.create({id:d,modelId:a,x:b-60+0.5,y:c-30+0.5,width:120,height:60,lineColor:"#000000",fillColor:"#C9DAF8",fixedSize:!1,modelId:a});this.register(this.deleteViewDisplayOnly,[a],"Delete view display",this._addViewDisplayOnly,[a],"add view display");return a},createViewDisplay:function(a,b,c){Model.views.get(a);
var d=Model.nextId("viewDisplay");a=Model.viewDisplays.create({id:d,modelId:a,x:b-60+0.5,y:c-30+0.5,width:120,height:60,lineColor:"#000000",fillColor:"#C9DAF8",fixedSize:!1,modelId:a});this.register(this.deleteViewDisplay,[d],"Delete view",this._addViewDisplayOnly,[a],"Add view display");Display.selection.selectElement(a);this.afterChangeHook();this.refreshDiagram();this.notifySelectionChanged()},createViewUsingJson:function(a){a=Model.views.create(a);this.register(this.deleteViewOnly,[a],"Delete view",
this._addViewOnly,[a],"Add view");this.refreshDiagram();this.afterChangeHook()},createViewDisplayUsingJson:function(a){a=Model.viewDisplays.create(a);this.register(this.deleteViewDisplayOnly,[a],"Delete view",this._addViewDisplayOnly,[a],"Add view");this.refreshDiagram();this.afterChangeHook()},createAreaUsingJson:function(a){a=Model.areas.create(a);this.register(this.deleteArea,[a.get("id")],"Delete area",this._addArea,[a],"Add area");this.refreshDiagram();this.afterChangeHook()},_resetViewDependenciesWithResize:function(a,
b,c){b=a.get("height")+app.getDiagram().measureHeight(c.length)-app.getDiagram().measureHeight(b.length);a.resetDependencies(c);a.resize(a.get("width"),b)},deleteView:function(a){if(!this.denied()){a=Model.views.get(a);var b=Model.viewDisplays.where({modelId:a.get("id")});Commands.beginGroupCommands();for(var c=0;c<b.length;c++)Commands.deleteViewDisplayOnly(b[c]);Commands.deleteViewOnly(a);Commands.endGroupCommands();this.refreshDiagram();this.notifySelectionChanged();this.afterChangeHook()}},deleteViewDisplayOnly:function(a){Display.selection.deselectAndDetachElement(a);
Model.viewDisplays.remove(a);this.register(this._addViewDisplayOnly,[a],"Add view display",this.deleteViewDisplayOnly,[a],"Delete view display")},deleteViewOnly:function(a){for(var b=0;b<Model.views.size();++b){var c=Model.views.at(b),d=_.clone(c.get("dependencies")),e=d.indexOf(c.get("id"));if(0<=e){var f=_.clone(d);d.splice(e,1);this._resetViewDependenciesWithResize(c,f,d)}}Model.selection.deselectAndDetachElement(a);Model.views.remove(a);this.register(this._addViewOnly,[a],"Add view",this.deleteViewOnly,
[a],"Delete view")},deleteViewDisplay:function(a){if(!this.denied()){Commands.beginGroupCommands();a=Model.viewDisplays.get(a);var b=Model.viewDisplays.where({modelId:a.get("modelId")});Commands.deleteViewDisplayOnly(a);1==b.length&&(a=Model.views.get(a.get("modelId")),Commands.deleteViewOnly(a));Commands.endGroupCommands();this.refreshDiagram();this.notifySelectionChanged();this.afterChangeHook()}},changeView:function(a,b,c){if(!this.denied()){var d=Model.views.get(a),e=d.get(b);d.set(b,c);for(d=
0;d<Model.views.size();++d){var f=Model.views.at(d);0<=f.get("dependencies").indexOf(a)&&f.resetDependencies(f.get("dependencies"))}this.register(this.changeView,[a,b,e],"change view",this.changeView,[a,b,c],"change view");this.afterChangeHook();this.refreshDiagram()}},changeViewDisplay:function(a,b,c){if(!this.denied()){var d=Model.viewDisplays.get(a),e=d.get(b);d.set(b,c);this.register(this.changeViewDisplay,[a,b,e],"change view display",this.changeViewDisplay,[a,b,c],"change view display");this.afterChangeHook();
this.refreshDiagram()}},moveViewDisplay:function(a,b,c,d){var e=Model.viewDisplays.get(a),f,g;f=e.has("oldx")?e.get("oldx"):e.get("x");g=e.has("oldy")?e.get("oldy"):e.get("y");e.moveTo(b,c,d);void 0!==d&&!0===d&&this.register(this.moveViewDisplay,[a,f,g,!0],"Move view display",this.moveViewDisplay,[a,b,c,!0],"Move view display");this.afterChangeHook();this.refreshDiagram()},moveViewDisplayControlPointTo:function(a,b,c,d,e){var f=a.getPreviousCPPosition(b);a.moveControlPointTo(b,c,d,!0);void 0!==e&&
!0===e&&this.register(this.moveViewDisplayControlPointTo,[a,b,f.x,f.y,!0],"Move view CP",this.moveViewDisplayControlPointTo,[a,b,c,d,!0],"Move view CP");this.afterChangeHook();this.refreshDiagram()},setViewColumnsOrder:function(a,b){if(!this.denied()){var c=Model.views.get(a).get("columns"),d=c.getOrder();c.setOrder(b);this.register(this.setViewColumnsOrder,[a,d],"Set view columns order",this.setViewColumnsOrder,[a,b],"set view columns order");this.afterChangeHook();this.refreshDiagram()}},_addViewColumn:function(a,
b,c){a=Model.views.get(a).get("columns");a.add(b);a.setOrder(c);this.afterChangeHook()},deleteViewColumn:function(a,b){if(!this.denied()){var c=Model.views.get(a).get("columns"),d=c.getOrder(),e=c.get(b);c.remove(e);this.register(this._addViewColumn,[a,e,d],"Add column to view",this.deleteViewColumn,[a,b],"Delete view column");this.afterChangeHook();this.refreshDiagram()}},createViewColumn:function(a){if(!this.denied()){var b=Model.views.get(a),c=b.createColumn(),d=c.get("id"),b=b.get("columns").getOrder();
this.register(this.deleteViewColumn,[a,d],"Delete view column",this._addViewColumn,[a,c,b],"Add column to view");this.refreshDiagram();this.afterChangeHook();return c}},changeViewColumn:function(a,b,c,d){if(!this.denied()){var e=Model.views.get(a).get("columns").get(b),f=e.get(c);e.set(c,d);this.register(this.changeViewColumn,[a,b,c,f],"change view column",this.changeViewColumn,[a,b,c,d],"change view column");this.afterChangeHook();this.refreshDiagram()}},adjustViewDisplaySizeToText:function(a){var b=
this._getViewDisplaySizeFitToText(a);Commands.resizeViewDisplay(a,b.width,b.height);this.afterChangeHook();this.refreshDiagram()},_getViewDisplaySizeFitToText:function(a){var b=Model.viewDisplays.get(a),c=Model.views.get(b.get("modelId")),d=c.getContentOfColumnLines();a=b.get("width");var e=b.get("height");a=b.getMinWidth();for(var f=0,g=0,e=0;e<d.length;e++){var h=d[e][0],k=d[e][1],h=app.getDiagram().measureColumnText(h),k=app.getDiagram().measureColumnText(k);f<h&&(f=h);g<k&&(g=k)}e=f+g+20;a<e&&
(a=e);e=app.getDiagram().measureTableTitle(c.get("name"))+10;a<e&&(a=e);f=0;c=c.get("dependencies");for(e=0;e<c.length;++e)g=Model.views.get(c[e]),g=app.getDiagram().measureColumnText(g.get("name"))+10,f<g&&(f=g);a<f&&(a=f);e=b.getMinHeight();b=app.getDiagram().measureHeight(d.length)+app.getDiagram().measureHeight(c.length)+40;0===c.length&&(b+=10);e<b&&(e=b);return{width:a,height:e}},eventuallyEnlargeViewSize:function(a){Model.views.get(a);a=Model.viewDisplays.where({modelId:a});for(var b=0;b<a.length;b++){var c=
a[b],d=this._getViewDisplaySizeFitToText(c.get("id")),e=c.get("width"),f=c.get("height"),g=!1,h=e,k=f;e<d.width&&(h=d.width,g=!0);f<d.height&&(k=d.height,g=!0);!0===g&&this.resizeViewDisplay(c.get("id"),h,k)}},resizeViewDisplay:function(a,b,c){if(!this.denied()){var d=Model.viewDisplays.get(a),e=d.get("width"),f=d.get("height");d.getMinHeight()>c||(d.resize(b,c),this.register(this.resizeViewDisplay,[a,e,f],"resize view display",this.resizeViewDisplay,[a,b,c],"resize view display"),this.afterChangeHook(),
this.refreshDiagram())}},resetViewColumns:function(a,b){if(!this.denied()){var c=Model.views.get(a),d=c.get("columns").toArray();c.resetColumns(b);this.register(this.resetViewColumns,[a,d],"reset view columns",this.resetViewColumns,[a,b],"reset view columns");this.afterChangeHook();this.refreshDiagram()}},changeViewDependencies:function(a,b){if(!this.denied()){var c=Model.views.get(a),d=c.get("dependencies");this._resetViewDependenciesWithResize(c,d,b);this.register(this.changeViewDependencies,[a,
d],"change view dependencies",this.changeViewDependencies,[a,b],"change view dependencies");this.afterChangeHook();this.refreshDiagram()}},createArea:function(a,b,c,d){var e=Model.nextId("area"),f="Area_"+e.slice(2),g=new Kinetic.Text({padding:10,align:"center",text:f,fontSize:15,fontFamily:"Arial",fontStyle:"bold",fill:"black"});c=Math.max(c,Model.Area.MIN_WIDTH);d=Math.max(d,Model.Area.MIN_HEIGHT);var h=g.getWidth(),g=g.getHeight();a=Model.areas.create({id:e,name:f,x:a+0.5,y:b+0.5,width:c,height:d,
lineColor:"#000000",fillColor:"#FFFFFF",dashArray:[5,5],nameX:c-h,nameY:d-g,nameColor:"#000000",zIndex:Model.areas.getNextZIndex()});this.register(this.deleteArea,[a.get("id")],"Delete area",this._addArea,[a],"Add area");Display.selection.selectElement(a);this.refreshDiagram();this.notifySelectionChanged();this.afterChangeHook()},_addArea:function(a){Model.areas.add(a);this.afterChangeHook()},deleteArea:function(a){if(!this.denied()){var b=Model.areas.get(a);Display.selection.deselectAndDetachElement(b);
Model.areas.remove(b);this.register(this._addArea,[b],"Add area",this.deleteArea,[a],"Delete area");this.refreshDiagram();this.notifySelectionChanged();this.afterChangeHook()}},moveArea:function(a,b,c,d){var e=Model.areas.get(a),f,g;f=e.has("oldx")?e.get("oldx"):e.get("x");g=e.has("oldy")?e.get("oldy"):e.get("y");e.moveTo(b,c,d);void 0!==d&&!0===d&&this.register(this.moveArea,[a,f,g,!0],"Move area",this.moveArea,[a,b,c,!0],"Move area");this.afterChangeHook();this.refreshDiagram()},moveAreaControlPointTo:function(a,
b,c,d,e){var f=a.getPreviousCPPosition(b);a.moveControlPointTo(b,c,d,!0);void 0!==e&&!0===e&&this.register(this.moveAreaControlPointTo,[a,b,f.x,f.y,!0],"Move area CP",this.moveAreaControlPointTo,[a,b,c,d,!0],"Move area CP");this.afterChangeHook();this.refreshDiagram()},changeArea:function(a,b,c){if(!this.denied()){var d=Model.areas.get(a),e=d.get(b);d.set(b,c);this.register(this.changeArea,[a,b,e],"change area",this.changeArea,[a,b,c],"change area");this.afterChangeHook();this.refreshDiagram()}},
moveAreaName:function(a,b,c){var d=Model.areas.get(a),e=d.get("nameX"),f=d.get("nameY");d.moveAreaName(b,c);this.register(this.moveAreaName,[a,e,f],"move area name",this.moveAreaName,[a,b,c],"move area name");this.afterChangeHook();this.refreshDiagram()},_getOldAreaOrder:function(){return _.map(Model.areas.models,function(a){return{id:a.get("id"),zIndex:a.get("zIndex")}})},bringAreaToTop:function(a){var b=Model.areas.get(a),c=this._getOldAreaOrder();b.moveToTop();this.register(this.bringAreaToPosition,
[c],"revert area order",this.bringAreaToTop,[a],"bring area to top");this.afterChangeHook();this.refreshDiagram()},bringAreaToBottom:function(a){var b=Model.areas.get(a),c=this._getOldAreaOrder();b.moveToBottom();this.register(this.bringAreaToPosition,[c],"revert area order",this.bringAreaToBottom,[a],"bring area to bottom");this.afterChangeHook();this.refreshDiagram()},bringAreaUp:function(a){var b=Model.areas.get(a),c=this._getOldAreaOrder();b.moveUp();this.register(this.bringAreaToPosition,[c],
"revert area order",this.bringAreaUp,[a],"bring area up");this.afterChangeHook();this.refreshDiagram()},bringAreaDown:function(a){var b=Model.areas.get(a),c=this._getOldAreaOrder();b.moveDown();this.register(this.bringAreaToPosition,[c],"revert area order",this.bringAreaUp,[a],"bring area down");this.afterChangeHook();this.refreshDiagram()},bringAreaToPosition:function(a){for(var b=this._getOldAreaOrder(),c=_.sortBy(a,function(a){return-a.zIndex}),d=0;d<c.length;d++)Model.areas.get(c[d].id).setZIndex(c.length-
d);this.register(this.bringAreaToPosition,[b],"revert area order",this.bringAreaToPosition,[a],"revert area order");this.afterChangeHook();this.refreshDiagram()},showReferences:function(){Commands.beginGroupCommands();for(var a=Display.selection.getAttachedElements(),b=[],c=0;c<a.length;c++){var d=a[c];d instanceof Model.TableDisplay&&b.push(d)}for(c=0;c<b.length;c++){a=b[c];for(d=c;d<b.length;d++){var e=b[d];this._addMissingReferenceDisplays(a,e);a.get("id")!=e.get("id")&&this._addMissingReferenceDisplays(e,
a)}}Commands.endGroupCommands();this.afterChangeHook();this.refreshDiagram()},_addMissingReferenceDisplays:function(a,b){for(var c=a.get("id"),d=b.get("id"),e=a.get("modelId"),f=b.get("modelId"),e=Model.references.where({pkTableId:e,fkTableId:f}),g=f=0;g<e.length;g++){var h=e[g];if(0==Model.referenceDisplays.where({modelId:h.get("id"),pkTableDisplayId:c,fkTableDisplayId:d}).length){var k=this._computePoint(a,f),m=this._computePoint(b,f);Commands.createReferenceDisplayOnly(h.get("id"),c,d,k,m);f++}}},
_computePoint:function(a){var b=a.computeCenter(),c=2*Math.random()-1,d=2*Math.random()-1,e=Math.random()+2;b.x+=c*(a.get("width")/e);b.y+=d*(a.get("height")/e);return b},changeModelProperty:function(a,b){var c=Model.properties.get(a),d=c.get("value");c.set("value",b);this.register(this.changeModelProperty,[c,d],"change model property",this.changeModelProperty,[c,b],"change model property");this.afterChangeHook()},changeSqlQuoteProperty:function(a){var b=Model.properties.get("sql_quote"),c;void 0==
b?(Model.properties.add(new Model.Property({id:"sql_quote",value:a})),c=!a):(c=b.get("value"),b.set("value",a));this.register(this.changeModelProperty,[b,c],"change model property",this.changeModelProperty,[b,a],"change model property");this.afterChangeHook()},createSequenceUsingJson:function(a){a=Model.sequences.create(a);this.register(this.deleteSequence,[a.get("id")],"Delete sequence",this._addSequence,[a,[]],"Add sequence");this.afterChangeHook();this.refreshDiagram()}},Clipboard={idMap:{},pasteCount:0,
init:function(){var a=this;window.addEventListener("storage",function(b){a.updateEmptyClipboardMark()},!1);a.updateEmptyClipboardMark()},updateEmptyClipboardMark:function(){var a=this.getStore();this.markAsEmpty(null==a)},getStore:function(){var a=localStorage.getItem("clipboard");if(void 0==a||null==a)return null;a=JSON.parse(a);return null==a||void 0==a.tableDisplays?null:a},markAsEmpty:function(a){Model.applicationProperties.set("emptyClipboard",a)},"delete":function(){var a=this;Model.groupOperation.doWithLock(function(){a._doDelete()})},
_doDelete:function(){if(!1!=app.isEditable()){var a=Display.selection.getAttachedElements();Commands.beginGroupCommands();Model.groupOperation.doWithLock(function(){for(var b=0;b<a.length;b++){var c=a[b].get("id");if(a[b]instanceof Model.TableDisplay)Commands.deleteTableDisplay(c);else if(a[b]instanceof Model.ReferenceDisplay)Commands.deleteReferenceDisplay(c);else if(a[b]instanceof Model.Note)Commands.deleteNote(c);else if(a[b]instanceof Model.ViewDisplay)Commands.deleteViewDisplay(c);else if(a[b]instanceof
Model.Area)Commands.deleteArea(c);else if(a[b]instanceof Model.Sequence)Commands.deleteSequence(c);else throw Error("Unsupported object");}});Commands.endGroupCommands();Model.Validation.Validator.touch()}},clear:function(){localStorage.setItem("clipboard",null);this.markAsEmpty(!0)},_isCutPossible:function(){for(var a=!1,b=0;b<Model.selection.getAttachedElements().length;b++)if(Model.selection.getAttachedElements()[b].toJSON(),Model.selection.getAttachedElements()[b]instanceof Model.Table){a=!0;
break}else if(Model.selection.getAttachedElements()[b]instanceof Model.Note){a=!0;break}else if(Model.selection.getAttachedElements()[b]instanceof Model.View){a=!0;break}else if(Model.selection.getAttachedElements()[b]instanceof Model.Area){a=!0;break}else if(Model.selection.getAttachedElements()[b]instanceof Model.Sequence){a=!0;break}return a},cut:function(){!1!=app.isEditable()&&(!1==this._isCutPossible()?this.clear():(this.copy(),this.delete()))},copy:function(){this.pasteCount=0;for(var a=[],
b=[],c=[],d=[],e=[],f=[],g=[],h=[],k=[],m=0;m<Display.selection.getAttachedElements().length;m++){var n=Display.selection.getAttachedElements()[m].toJSON();if(Display.selection.getAttachedElements()[m]instanceof Model.TableDisplay)b.push(n),n=Model.tables.get(n.modelId),a.push(n);else if(Display.selection.getAttachedElements()[m]instanceof Model.ReferenceDisplay)d.push(n),n=Model.references.get(n.modelId),c.push(n);else if(Display.selection.getAttachedElements()[m]instanceof Model.Note)e.push(n);
else if(Display.selection.getAttachedElements()[m]instanceof Model.ViewDisplay)g.push(n),n=Model.views.get(n.modelId),f.push(n);else if(Display.selection.getAttachedElements()[m]instanceof Model.Area)h.push(n);else throw Error("Unsupported object ");}for(m=0;m<Model.selection.getAttachedElements().length;m++)n=Model.selection.getAttachedElements()[m].toJSON(),Model.selection.getAttachedElements()[m]instanceof Model.Sequence&&k.push(n);0==b.length&&0==a.length&&0==c.length&&0==d.length&&0==e.length&&
0==f.length&&0==g.length&&0==h.length&&0==k.length?this.clear():(a=JSON.stringify({tables:a,tableDisplays:b,references:c,referenceDisplays:d,notes:e,views:f,viewDisplays:g,areas:h,sequences:k}),localStorage.setItem("clipboard",a),this.markAsEmpty(!1))},newId:function(a,b){var c=Model.nextId(b);this.idMap[a.id]=c;a.id=c},newIds:function(a,b){for(var c=0;c<a.length;c++)this.newId(a[c],b)},remapId:function(a){return this.idMap[a]},remapAlterneteKeys:function(a){for(var b=0;b<a.length;b++){for(var c=
a[b].columns,d=[],e=0;e<c.length;e++)d.push(this.remapId(c[e]));a[b].columns=d}},remapIndexes:function(a){for(var b=0;b<a.length;b++)for(var c=a[b].columns,d=0;d<c.length;d++){var e=this.remapId(c[d].id);c[d].id=e}},remapReferenceColumns:function(a){for(var b=0;b<a.length;b++)null!=a[b].pkColumnId&&(a[b].pkColumnId=this.remapId(a[b].pkColumnId)),null!=a[b].fkColumnId&&(a[b].fkColumnId=this.remapId(a[b].fkColumnId))},paste:function(){var a=this;Model.groupOperation.doWithLock(function(){a._doPaste()});
Commands.refreshDiagram();Commands.notifySelectionChanged();Model.Validation.Validator.touch()},pasteAsShortcut:function(){if(Model.metaInfo.get("accountPlanFree"))console.log("Free account plan: cannot paste as shortcut");else{var a=this;Model.groupOperation.doWithLock(function(){a._doPasteAsShortcut()});Commands.refreshDiagram();Commands.notifySelectionChanged();Model.Validation.Validator.touch()}},_doPaste:function(){if(!1!=app.isEditable()){this.idMap={};var a=this.getStore();if(null!=a){var b=
a.tables,c=a.tableDisplays,d=a.references,e=a.referenceDisplays,f=a.notes,g=a.views,h=a.viewDisplays,k=a.areas,m=a.sequences;this.pasteCount++;var a=this._computeShift(a),n=a.x,r=a.y;Commands.beginGroupCommands();for(var a=[],l=0;l<b.length;l++){var p=b[l],q=p.id,q=this.remapId(q);if(void 0==q||null==q)this.newId(p,"table"),a.push(p.id),0<Model.tables.where({name:p.name}).length&&(p.name="Copy_of_"+p.name),this.newIds(p.columns,"column"),this.newIds(p.alternateKeys,"alternate_key"),this.remapAlterneteKeys(p.alternateKeys),
this.newIds(p.indexes,"index"),this.remapIndexes(p.indexes),this.newIds(p.tableChecks,"table_check"),p.selected=!1,p.attached=!1,Commands.createTableUsingJson(p)}b=[];for(l=0;l<c.length;l++)p=c[l],this.newId(p,"tableDisplay"),b.push(p.id),p.x+=n,p.y+=r,p.modelId=this.remapId(p.modelId),p.selected=!1,p.attached=!1,Commands.createTableDisplayUsingJson(p);c=[];for(l=0;l<d.length;l++)if(p=d[l],q=p.id,q=this.remapId(q),void 0===q||null==q)0<Model.references.where({name:p.name}).length&&(p.name="Copy_of_"+
p.name),void 0!=this.idMap[p.pkTableId]&&(p.pkTableId=this.remapId(p.pkTableId),void 0!=this.idMap[p.fkTableId]&&(p.fkTableId=this.remapId(p.fkTableId),this.remapReferenceColumns(p.referenceColumns),p.selected=!1,p.attached=!1,this.newId(p,"reference"),c.push(p.id),Commands.createReferenceUsingJson(p)));d=[];for(l=0;l<e.length;l++)if(p=e[l],p.modelId=this.remapId(p.modelId),void 0!=this.idMap[p.pkTableDisplayId]&&(p.pkTableDisplayId=this.remapId(p.pkTableDisplayId),void 0!=this.idMap[p.fkTableDisplayId])){p.fkTableDisplayId=
this.remapId(p.fkTableDisplayId);for(q=0;q<p.controlPoints.length;q++)p.controlPoints[q].x+=n,p.controlPoints[q].y+=r;p.selected=!1;p.attached=!1;this.newId(p,"referenceDisplay");d.push(p.id);Commands.createReferenceDisplayUsingJson(p)}e=[];for(l=0;l<f.length;l++)q=f[l],this.newId(q,"note"),e.push(q.id),0<Model.notes.where({name:q.name}).length&&(q.name="Copy_of_"+q.name),q.x+=n,q.y+=r,q.selected=!1,q.attached=!1,Commands.createNoteUsingJson(q);f=[];for(l=0;l<g.length;l++)q=g[l],this.newId(q,"view"),
f.push(q.id),0<Model.views.where({name:q.name}).length&&(q.name="Copy_of_"+q.name),this.newIds(q.columns,"view_column"),q.selected=!1,q.attached=!1,Commands.createViewUsingJson(q);g=[];for(l=0;l<h.length;l++)q=h[l],this.newId(q,"viewDisplay"),g.push(q.id),q.modelId=this.remapId(q.modelId),q.x+=n,q.y+=r,q.selected=!1,q.attached=!1,Commands.createViewDisplayUsingJson(q);h=[];k=_.sortBy(k,function(a){return a.zIndex});for(l=0;l<k.length;l++)q=k[l],this.newId(q,"area"),h.push(q.id),0<Model.areas.where({name:q.name}).length&&
(q.name="Copy_of_"+q.name),q.x+=n,q.y+=r,q.selected=!1,q.attached=!1,q.zIndex=Model.areas.getNextZIndex(),Commands.createAreaUsingJson(q);k=[];for(l=0;l<m.length;l++)n=m[l],this.newId(n,"sequence"),k.push(n.id),0<Model.sequences.where({name:n.name}).length&&(n.name="Copy_of_"+n.name),n.selected=!1,n.attached=!1,Commands.createSequenceUsingJson(n);Commands.endGroupCommands();this.idMap={};if(0==a.length&&0==b.length&&0==c.length&&0==d.length&&0==e.length&&0==f.length&&0==g.length&&0==h.length&&0==
k.length)this.clear();else{Display.selection.clearAll();for(l=0;l<a.length;l++)Model.selection.attachElement(Model.tables.get(a[l]));for(l=0;l<b.length;l++)Display.selection.attachElement(Model.tableDisplays.get(b[l]));for(l=0;l<c.length;l++)Model.selection.attachElement(Model.references.get(c[l]));for(l=0;l<d.length;l++)Display.selection.attachElement(Model.referenceDisplays.get(d[l]));for(l=0;l<e.length;l++)Model.selection.attachElement(Model.notes.get(e[l]));for(l=0;l<f.length;l++)Model.selection.attachElement(Model.views.get(f[l]));
for(l=0;l<g.length;l++)Display.selection.attachElement(Model.viewDisplays.get(g[l]));for(l=0;l<h.length;l++)Model.selection.attachElement(Model.areas.get(h[l]));for(l=0;l<k.length;l++)Model.selection.attachElement(Model.sequences.get(k[l]));Model.selection.triggerSelectionChanged();Commands.refreshDiagram()}}}},_computeShift:function(a){a=this._computePositions(a);var b;if(this._inVisibleArea(a))b=50*this.pasteCount,a=50*this.pasteCount;else{b=app.diagram.getArea();var c=(b.ymin+b.ymax)/2;b=(b.xmin+
b.xmax)/2-a.centerX+50*this.pasteCount;a=c-a.centerY+50*this.pasteCount}return{x:b,y:a}},_inVisibleArea:function(a){var b=app.diagram.getArea(),c=Math.max(a.minX,b.xmin),d=Math.max(a.minY,b.ymin),e=Math.min(a.maxX,b.xmax);a=Math.min(a.maxY,b.ymax);return c<e&&d<a},_computePositions:function(a){var b=a.tableDisplays,c=a.notes,d=a.viewDisplays;a=a.areas;for(var e=1E5,f=1E5,g=-1E5,h=-1E5,k=0;k<b.length;k++){var m=b[k],n=m.x,m=m.y;n<e&&(e=n);m<f&&(f=m);g<n&&(g=n);h<m&&(h=m)}for(k=0;k<c.length;k++)m=c[k],
n=m.x,m=m.y,n<e&&(e=n),m<f&&(f=m),g<n&&(g=n),h<m&&(h=m);for(k=0;k<d.length;k++)m=d[k],n=m.x,m=m.y,n<e&&(e=n),m<f&&(f=m),g<n&&(g=n),h<m&&(h=m);for(k=0;k<a.length;k++)m=a[k],n=m.x,m=m.y,n<e&&(e=n),m<f&&(f=m),g<n&&(g=n),h<m&&(h=m);return{minX:e,maxX:g,minY:f,maxY:h,centerX:(e+g)/2,centerY:(f+h)/2}},_doPasteAsShortcut:function(){if(!1!=app.isEditable()){this.idMap={};var a=this.getStore();if(null!=a){var b=a.tables,c=a.tableDisplays,d=a.references,e=a.referenceDisplays,f=a.notes,g=a.views,h=a.viewDisplays,
k=a.areas,m=a.sequences;this.pasteCount++;var a=this._computeShift(a),n=a.x,r=a.y;Commands.beginGroupCommands();for(var a=[],l=0;l<b.length;l++){var p=b[l],q=p.id;null==Model.tables.get(q)&&(a.push(p.id),p.selected=!1,p.attached=!1,Commands.createTableUsingJson(p))}b=[];for(l=0;l<c.length;l++)p=c[l],this.newId(p,"tableDisplay"),b.push(p.id),p.x+=n,p.y+=r,p.selected=!1,p.attached=!1,Commands.createTableDisplayUsingJson(p);c=[];for(l=0;l<d.length;l++)p=d[l],q=p.id,null==Model.references.get(q)&&(c.push(p.id),
p.selected=!1,p.attached=!1,Commands.createReferenceUsingJson(p));d=[];for(l=0;l<e.length;l++)if(p=e[l],void 0!=this.idMap[p.pkTableDisplayId]&&(p.pkTableDisplayId=this.remapId(p.pkTableDisplayId),void 0!=this.idMap[p.fkTableDisplayId])){p.fkTableDisplayId=this.remapId(p.fkTableDisplayId);for(q=0;q<p.controlPoints.length;q++)p.controlPoints[q].x+=n,p.controlPoints[q].y+=r;p.selected=!1;p.attached=!1;this.newId(p,"referenceDisplay");d.push(p.id);Commands.createReferenceDisplayUsingJson(p)}e=[];for(l=
0;l<f.length;l++)q=f[l],this.newId(q,"note"),e.push(q.id),0<Model.notes.where({name:q.name}).length&&(q.name="Copy_of_"+q.name),q.x+=n,q.y+=r,q.selected=!1,q.attached=!1,Commands.createNoteUsingJson(q);f=[];for(l=0;l<g.length;l++)p=g[l],q=p.id,null==Model.views.get(q)&&(f.push(p.id),p.selected=!1,p.attached=!1,Commands.createViewUsingJson(p));g=[];for(l=0;l<h.length;l++)p=h[l],this.newId(p,"viewDisplay"),g.push(p.id),p.x+=n,p.y+=r,p.selected=!1,p.attached=!1,Commands.createViewDisplayUsingJson(p);
h=[];k=_.sortBy(k,function(a){return a.zIndex});for(l=0;l<k.length;l++)p=k[l],this.newId(p,"area"),h.push(p.id),0<Model.areas.where({name:p.name}).length&&(p.name="Copy_of_"+p.name),p.x+=n,p.y+=r,p.selected=!1,p.attached=!1,p.zIndex=Model.areas.getNextZIndex(),Commands.createAreaUsingJson(p);k=[];for(l=0;l<m.length;l++)n=m[l],this.newId(n,"sequence"),k.push(n.id),0<Model.sequences.where({name:n.name}).length&&(n.name="Copy_of_"+n.name),n.selected=!1,n.attached=!1,Commands.createSequenceUsingJson(n);
Commands.endGroupCommands();this.idMap={};if(0==a.length&&0==b.length&&0==c.length&&0==d.length&&0==e.length&&0==f.length&&0==g.length&&0==h.length&&0==k.length)this.clear();else{Display.selection.clearAll();for(l=0;l<a.length;l++)Model.selection.attachElement(Model.tables.get(a[l]));for(l=0;l<b.length;l++)Display.selection.attachElement(Model.tableDisplays.get(b[l]));for(l=0;l<c.length;l++)Model.selection.attachElement(Model.references.get(c[l]));for(l=0;l<d.length;l++)Display.selection.attachElement(Model.referenceDisplays.get(d[l]));
for(l=0;l<e.length;l++)Model.selection.attachElement(Model.notes.get(e[l]));for(l=0;l<f.length;l++)Model.selection.attachElement(Model.views.get(f[l]));for(l=0;l<g.length;l++)Display.selection.attachElement(Model.viewDisplays.get(g[l]));for(l=0;l<h.length;l++)Model.selection.attachElement(Model.areas.get(h[l]));for(l=0;l<k.length;l++)Model.selection.attachElement(Model.sequences.get(k[l]));Model.selection.triggerSelectionChanged();Commands.refreshDiagram()}}}}},Display={init:function(){Backbone.sync=
function(a,b,c){}},makeSelectable:function(a){a.prototype.select=function(){this.set("selected",!0);this.trigger("selected",this)};a.prototype.isSelected=function(){void 0===this.get("selected")&&this.set("selected",!1);return this.get("selected")};a.prototype.deselect=function(){this.set("selected",!1);this.trigger("deselected",this)};a.prototype.attach=function(){!0!=this.get("attached")&&(this.set("attached",!0),this.trigger("attached",this))};a.prototype.isAttached=function(){void 0===this.get("attached")&&
this.set("attached",!1);return this.get("attached")};a.prototype.detach=function(){this.set("attached",!1);this.trigger("detached",this)}}};
Display.Selection=Backbone.Model.extend({initialize:function(a){this.set("selected_element",null);this.set("attached_elements",[])},getSelectedElement:function(){return this.get("selected_element")},getAttachedElements:function(){return this.get("attached_elements").slice(0)},selectElement:function(a){this.clearAll();this.set("selected_element",a);a.select();this.trigger("element_selected",a,this);this.set("attached_elements",[a]);a.attach();this.trigger("element_attached",a,this);a=this.getModel(a);
Model.selection.selectElement(a);this.triggerSelectionChanged()},selectAndAttachElement:function(a){var b=this.get("selected_element");a!==b&&(null!==b&&(this.set("selected_element",null),b.deselect(),this.trigger("element_deselected",b,this)),this.set("selected_element",a),a.select(),this.trigger("element_selected",a,this),!1===a.isAttached()&&(b=this.get("attached_elements").slice(0),b.push(a),this.set("attached_elements",b),a.attach(),this.trigger("element_attached",a,this)),a=this.getModel(a),
Model.selection.selectAndAttachElement(a),this.triggerSelectionChanged())},attachElement:function(a){if(!1===a.isAttached()){var b=this.get("attached_elements").slice(0);b.push(a);this.set("attached_elements",b);a.attach();this.trigger("element_attached",a,this)}a=this.getModel(a);Model.selection.attachElement(a);this.triggerSelectionChanged()},deselectAndDetachElement:function(a){var b=this.get("selected_element"),c=this.get("attached_elements");null!==b&&b.get("id")===a.get("id")&&(this.set("selected_element",
null),b.deselect(),this.trigger("element_deselected",b,this));for(b=0;b<c.length;b++){var d=c[b];if(d.get("id")===a.get("id")){c.splice(b,1);d.detach();this.trigger("element_detached",d,this);break}}a=this.getModel(a);Model.selection.deselectAndDetachElement(a);this.triggerSelectionChanged()},deselectCurrentElement:function(){var a=this.get("selected_element");null!==a&&(a.deselect(),this.set("selected_element",null),this.trigger("element_deselected",a,this),a=this.getModel(a),Model.selection.deselectCurrentElement(a),
this.triggerSelectionChanged())},getModel:function(a){return a instanceof Model.TableDisplay?(a=a.get("modelId"),Model.tables.get(a)):a instanceof Model.ReferenceDisplay?(a=a.get("modelId"),Model.references.get(a)):a instanceof Model.ViewDisplay?(a=a.get("modelId"),Model.views.get(a)):a},clearAll:function(){this.deselectCurrentElement();var a=this.get("attached_elements");if(0<a.length){this.set("attached_elements",[]);for(var b=0;b<a.length;b++)a[b].detach();this.trigger("elements_detached",a,this)}Model.selection.clearAll();
this.triggerSelectionChanged()},selectDisplay:function(a,b){this.clearAll();var c=b.getArea(),c=this.getAreaCenter(c),d=1E9;if(a instanceof Model.Table){for(var e=Model.tableDisplays.where({modelId:a.get("id")}),f=null,g=0;g<e.length;g++){var h=e[g],k=h.computeCenter(),k=this.distance(k,c);k<d&&(d=k,f=h)}this.selectElement(f);return f}if(a instanceof Model.Reference){e=Model.referenceDisplays.where({modelId:a.get("id")});f=null;for(g=0;g<e.length;g++)h=e[g],k=h.computeCenter(),k=this.distance(k,c),
k<d&&(d=k,f=h);this.selectElement(f);return f}if(a instanceof Model.View){e=Model.viewDisplays.where({modelId:a.get("id")});f=null;for(g=0;g<e.length;g++)h=e[g],k=h.computeCenter(),k=this.distance(k,c),k<d&&(d=k,f=h);this.selectElement(f);return f}},getAreaCenter:function(a){return{x:(a.xmin+a.xmax)/2,y:(a.ymin+a.ymax)/2}},distance:function(a,b){var c=a.x-b.x,d=a.y-b.y;return c*c+d*d},_doTriggerSelectionChanged:function(){Display.selection.trigger("selection-changed")},triggerSelectionChanged:function(){Model.groupOperation.isInProgress()?
Model.groupOperation.addOnRelease(Display.selection._doTriggerSelectionChanged):this._doTriggerSelectionChanged()}});
Model.TableDisplay=Backbone.Model.extend({initialize:function(a){},getBoundaryRect:function(){return{xmin:this.get("x"),ymin:this.get("y"),xmax:this.get("x")+this.get("width"),ymax:this.get("y")+this.get("height")}},moveControlPointTo:function(a,b,c,d){var e=Model.Util.alignPoint({x:b,y:c});b=e.x;c=e.y;var e=this.get("width"),f=this.get("height");a===Diagram.TableControlPointIndex.TOP_LEFT?(e=this.get("width")+(this.get("x")-b),f=this.get("height")+(this.get("y")-c),this.moveTo(b,c,d)):a===Diagram.TableControlPointIndex.TOP_RIGHT?
(e=b-this.get("x"),f=this.get("height")+(this.get("y")-c),this.moveTo(this.get("x"),c,d)):a===Diagram.TableControlPointIndex.BOTTOM_LEFT?(e=this.get("width")+(this.get("x")-b),f=c-this.get("y"),this.moveTo(b,this.get("y"),d)):a===Diagram.TableControlPointIndex.BOTTOM_RIGHT&&(e=b-this.get("x"),f=c-this.get("y"));e=Math.floor(e);f=Math.floor(f);a=e-this.get("width");b=f-this.get("height");if(!this.has("oldwidth")||!this.has("oldheight"))this.trigger("resizestart",this,this.get("width"),this.get("height")),
this.set("oldwidth",this.get("width")),this.set("oldheight",this.get("height"));if(0!==a||0!==b)this.set("width",e),this.set("height",f),this.trigger("resize",this,e,f,a,b);void 0!==d&&!0===d&&(this.trigger("resizeend",this,this.get("oldwidth"),this.get("oldheight"),this.get("width"),this.get("height")),this.unset("oldwidth"),this.unset("oldheight"))},moveTo:function(a,b,c){b=Model.Util.alignPoint({x:a,y:b});a=b.x;b=b.y;var d=a-this.get("x"),e=b-this.get("y");if(!this.has("oldx")||!this.has("oldy"))this.trigger("movestart",
this,this.get("x"),this.get("y")),this.set("oldx",this.get("x")),this.set("oldy",this.get("y"));if(0!==d||0!==e)this.set("x",a),this.set("y",b),this.trigger("move",this,d,e);void 0!==c&&!0===c&&(this.trigger("moveend",this,this.get("oldx"),this.get("oldy"),this.get("x"),this.get("y")),this.unset("oldx"),this.unset("oldy"))},resize:function(a,b){a=Math.floor(a);b=Math.floor(b);var c=this.get("width"),d=this.get("height"),e=a-this.get("width"),f=b-this.get("height");this.trigger("resizestart",this,
this.get("width"),this.get("height"));this.set({width:a,height:b});this.trigger("resize",this,a,b,e,f);this.trigger("resizeend",this,c,d,this.get("width"),this.get("height"))},getPreviousCPPosition:function(a){var b,c,d,e;b=this.has("oldx")?this.get("oldx"):this.get("x");c=this.has("oldy")?this.get("oldy"):this.get("y");d=this.has("oldwidth")?this.get("oldwidth"):this.get("width");e=this.has("oldheight")?this.get("oldheight"):this.get("height");if(a===Diagram.TableControlPointIndex.TOP_LEFT)a=b;else if(a===
Diagram.TableControlPointIndex.TOP_RIGHT)a=b+d;else if(a===Diagram.TableControlPointIndex.BOTTOM_LEFT)a=b,c+=e;else if(a===Diagram.TableControlPointIndex.BOTTOM_RIGHT)a=b+d,c+=e;else throw"Unknown table index "+a;return{x:a,y:c}},getMinWidth:function(){return 105},getMinHeight:function(){return 42},adjustPointToInsideMargin:function(a){var b=this.getBoundaryRect(),c=this.getInsideMargin();a={x:a.x,y:a.y};a.x<b.xmin+c&&(a.x=b.xmin+c);a.x>b.xmax-c&&(a.x=b.xmax-c);a.y<b.ymin+c&&(a.y=b.ymin+c);a.y>b.ymax-
c&&(a.y=b.ymax-c);return a},getInsideMargin:function(){return 10},inArea:function(a){return this.get("x")<a.xmin||this.get("y")<a.ymin||this.get("x")+this.get("width")>a.xmax||this.get("y")+this.get("height")>a.ymax?!1:!0},getTitleText:function(){var a=Model.tables.get(this.get("modelId")),a=null==a?"":a.get("name");if(!1==this.isGhost())return a;for(var b=this.getAreaLabel(this),c=Model.tableDisplays.where({modelId:this.get("modelId")}),d=[],e=0;e<c.length;e++){var f=c[e],g=this.getAreaLabel(f);
b==g&&d.push(f)}_.sortBy(d,function(a){return a.get("id")});var h=this;if(0==_.filter(d,function(a){return a.get("id")!=h.get("id")}).length)return a+b;c=_.indexOf(d,this)+1;0==c&&(c=d.length+1);return a+b+":"+c},isGhost:function(){var a=this,b=Model.tableDisplays.where({modelId:this.get("modelId")});return 0!=_.filter(b,function(b){return b.get("id")!=a.get("id")}).length},getAreaLabel:function(a){for(var b=[],c=Model.areas.models,d=0;d<c.length;d++){var e=c[d];a.inArea(e.getArea())&&b.push(e.get("name").trim())}_.sortBy(b,
function(a){return a});return _.reduce(b,function(a,b){return void 0==b||null==b||""==b?a:a+":"+b.trim()},"")},computeCenter:function(){return{x:this.get("x")+this.get("width")/2,y:this.get("y")+this.get("height")/2}},setInSearchResults:function(){this.set("inSearchResults",!0);this.trigger("setInSearchResults",this);Model.tableDisplays.trigger("tableDisplay_setInSearchResults",Model.tables,this)},unsetInSearchResults:function(){this.set("inSearchResults",!1);this.trigger("unsetInSearchResults",this);
Model.tableDisplays.trigger("tableDisplay_unsetInSearchResults",Model.tables,this)}});Model.TableDisplays=Backbone.Collection.extend({model:Model.TableDisplay,findTableDisplayInArea:function(a,b){for(var c=this.where({modelId:a}),d=Model.areas.get(b).getArea(),e=0;e<c.length;e++){var f=c[e];if(f.inArea(d))return f}return null}});Model.tableDisplays=new Model.TableDisplays;Display.makeSelectable(Model.TableDisplay);
Model.ViewDisplay=Backbone.Model.extend({initialize:function(a){this._updateMinHeight()},getBoundaryRect:function(){return{xmin:this.get("x"),ymin:this.get("y"),xmax:this.get("x")+this.get("width"),ymax:this.get("y")+this.get("height")}},getMinWidth:function(){return 105},_updateMinHeight:function(){var a=62+13*Model.views.get(this.get("modelId")).get("dependencies").length;this.set("minHeight",a)},getMinHeight:function(){return this.get("minHeight")},moveTo:function(a,b,c){b=Model.Util.alignPoint({x:a,
y:b});a=b.x;b=b.y;var d=a-this.get("x"),e=b-this.get("y");if(!this.has("oldx")||!this.has("oldy"))this.trigger("movestart",this,this.get("x"),this.get("y")),this.set("oldx",this.get("x")),this.set("oldy",this.get("y"));if(0!==d||0!==e)this.set("x",a),this.set("y",b),this.trigger("move",this,d,e);void 0!==c&&!0===c&&(this.trigger("moveend",this,this.get("oldx"),this.get("oldy"),this.get("x"),this.get("y")),this.unset("oldx"),this.unset("oldy"))},moveControlPointTo:function(a,b,c,d){var e=Model.Util.alignPoint({x:b,
y:c});b=e.x;c=e.y;var e=this.get("width"),f=this.get("height");a===Diagram.ViewControlPointIndex.TOP_LEFT?(e=this.get("width")+(this.get("x")-b),f=this.get("height")+(this.get("y")-c),this.moveTo(b,c,d)):a===Diagram.ViewControlPointIndex.TOP_RIGHT?(e=b-this.get("x"),f=this.get("height")+(this.get("y")-c),this.moveTo(this.get("x"),c,d)):a===Diagram.ViewControlPointIndex.BOTTOM_LEFT?(e=this.get("width")+(this.get("x")-b),f=c-this.get("y"),this.moveTo(b,this.get("y"),d)):a===Diagram.ViewControlPointIndex.BOTTOM_RIGHT&&
(e=b-this.get("x"),f=c-this.get("y"));e=Math.floor(e);f=Math.floor(f);a=e-this.get("width");b=f-this.get("height");if(!this.has("oldwidth")||!this.has("oldheight"))this.trigger("resizestart",this,this.get("width"),this.get("height")),this.set("oldwidth",this.get("width")),this.set("oldheight",this.get("height"));if(0!==a||0!==b)this.set("width",e),this.set("height",f),this.trigger("resize",this,e,f,a,b);void 0!==d&&!0===d&&(this.trigger("resizeend",this,this.get("oldwidth"),this.get("oldheight"),
this.get("width"),this.get("height")),this.unset("oldwidth"),this.unset("oldheight"))},getPreviousCPPosition:function(a){var b,c,d,e;b=this.has("oldx")?this.get("oldx"):this.get("x");c=this.has("oldy")?this.get("oldy"):this.get("y");d=this.has("oldwidth")?this.get("oldwidth"):this.get("width");e=this.has("oldheight")?this.get("oldheight"):this.get("height");if(a===Diagram.ViewControlPointIndex.TOP_LEFT)a=b;else if(a===Diagram.ViewControlPointIndex.TOP_RIGHT)a=b+d;else if(a===Diagram.ViewControlPointIndex.BOTTOM_LEFT)a=
b,c+=e;else if(a===Diagram.ViewControlPointIndex.BOTTOM_RIGHT)a=b+d,c+=e;else throw"Unknown view index "+a;return{x:a,y:c}},resize:function(a,b){a=Math.floor(a);b=Math.floor(b);var c=this.get("width"),d=this.get("height"),e=a-this.get("width"),f=b-this.get("height");this.trigger("resizestart",this,this.get("width"),this.get("height"));this.set({width:a,height:b});this.trigger("resize",this,a,b,e,f);this.trigger("resizeend",this,c,d,this.get("width"),this.get("height"))},computeCenter:function(){return{x:this.get("x")+
this.get("width")/2,y:this.get("y")+this.get("height")/2}},getTitleText:function(){var a=Model.views.get(this.get("modelId")),b="";null!=a&&(b=a.get("name"));if(!1==this.isGhost())return b;for(var a=this.getAreaLabel(this),c=Model.viewDisplays.where({modelId:this.get("modelId")}),d=[],e=0;e<c.length;e++){var f=c[e],g=this.getAreaLabel(f);a==g&&d.push(f)}_.sortBy(d,function(a){return a.get("id")});var h=this;if(0==_.filter(d,function(a){return a.get("id")!=h.get("id")}).length)return b+a;c=_.indexOf(d,
this)+1;0==c&&(c=d.length+1);return b+a+":"+c},isGhost:function(){var a=this,b=Model.viewDisplays.where({modelId:this.get("modelId")});return 0!=_.filter(b,function(b){return b.get("id")!=a.get("id")}).length},getAreaLabel:function(a){for(var b=[],c=Model.areas.models,d=0;d<c.length;d++){var e=c[d];a.inArea(e.getArea())&&b.push(e.get("name").trim())}_.sortBy(b,function(a){return a});return _.reduce(b,function(a,b){return void 0==b||null==b||""==b?a:a+":"+b.trim()},"")},inArea:function(a){return this.get("x")<
a.xmin||this.get("y")<a.ymin||this.get("x")+this.get("width")>a.xmax||this.get("y")+this.get("height")>a.ymax?!1:!0},setInSearchResults:function(){this.set("inSearchResults",!0);this.trigger("setInSearchResults",this);Model.viewDisplays.trigger("viewDisplay_setInSearchResults",Model.tables,this)},unsetInSearchResults:function(){this.set("inSearchResults",!1);this.trigger("unsetInSearchResults",this);Model.viewDisplays.trigger("viewDisplay_unsetInSearchResults",Model.tables,this)}});
Model.ViewDisplays=Backbone.Collection.extend({model:Model.ViewDisplay,findViewDisplayInArea:function(a,b){for(var c=this.where({modelId:a}),d=Model.areas.get(b).getArea(),e=0;e<c.length;e++){var f=c[e];if(f.inArea(d))return f}return null}});Model.viewDisplays=new Model.ViewDisplays;Display.makeSelectable(Model.ViewDisplay);Model.DisplayPoint=Backbone.Model.extend({initialize:function(a){}});Model.DisplayPoints=Backbone.Collection.extend({model:Model.Point});
Model.ReferenceDisplay=Backbone.Model.extend({initialize:function(a){a=new Model.DisplayPoints;void 0!=this.get("controlPoints")&&(a=new Model.DisplayPoints(this.get("controlPoints")));this.set("controlPoints",a);this.bindAllEvents()},bindAllEvents:function(){var a=this.get("controlPoints"),b=Model.tableDisplays.get(this.get("pkTableDisplayId")),c=Model.tableDisplays.get(this.get("fkTableDisplayId")),d=this;this.get("name");this.unbindAllEvents();var d=this,e=Model.references.get(this.get("modelId"));
if(null!=e)e.on("swap_reference",function(){d.swap()},d);b.on("movestart",function(a,b,c,e,m){d.set("oldControlPoints",Model.ReferenceDisplay.getCPsAsArray(d.get("controlPoints")));d.set("oldControlPointsType",d.get("controlPointsType"))},d);b.on("move",function(a,b,c){a=d.recalculateRCPsAfterTableMove(d,a,b,c);d.get("controlPoints").reset(a.controlPoints);d.set("controlPointsType",a.controlPointsType)},d);b.on("moveend",function(a,b,c,e,m){d.unset("oldControlPoints");d.unset("oldControlPointsType")},
d);b.on("resizestart",function(a,b,c){d.set("oldControlPoints",Model.ReferenceDisplay.getCPsAsArray(d.get("controlPoints")));d.set("oldControlPointsType",d.get("controlPointsType"))},d);b.on("resize",function(a,b,c,e,m){a=d.recalculateRCPsAfterTableResize(d,a,b,c,e,m);d.get("controlPoints").reset(a.controlPoints);d.set("controlPointsType",a.controlPointsType)},d);b.on("resizeend",function(a,b,c,e,m){d.unset("oldControlPoints");d.unset("oldControlPointsType")},d);b.get("id")!==c.get("id")&&(c.on("movestart",
function(a,b,c,e,m){d.set("oldControlPoints",Model.ReferenceDisplay.getCPsAsArray(d.get("controlPoints")));d.set("oldControlPointsType",d.get("controlPointsType"))},d),c.on("move",function(a,b,c){a=d.recalculateRCPsAfterTableMove(d,a,b,c);d.get("controlPoints").reset(a.controlPoints);d.set("controlPointsType",a.controlPointsType)},d),c.on("moveend",function(a,b,c,e,m){d.unset("oldControlPoints");d.unset("oldControlPointsType")},d),c.on("resizestart",function(a,b,c){d.set("oldControlPoints",Model.ReferenceDisplay.getCPsAsArray(d.get("controlPoints")));
d.set("oldControlPointsType",d.get("controlPointsType"))},d),c.on("resize",function(a,b,c,e,m){a=d.recalculateRCPsAfterTableResize(d,a,b,c,e,m);d.get("controlPoints").reset(a.controlPoints);d.set("controlPointsType",a.controlPointsType)},d),c.on("resizeend",function(a,b,c,e,m){d.unset("oldControlPoints");d.unset("oldControlPointsType")},d));this.bindChangeControlPointsEvents(a)},recalculateRCPsAfterTableMove:function(a,b,c,d){var e=Model.tableDisplays.get(a.get("pkTableDisplayId")),f=Model.tableDisplays.get(a.get("fkTableDisplayId")),
g=[],h=a.get("oldControlPointsType"),k=a.get("controlPointsType"),m=a.get("controlPoints"),n=m.at(0),r=m.at(m.length-1),l,p;b.get("id")===e.get("id")?(l={x:n.get("x")+c,y:n.get("y")+d},p={x:r.get("x"),y:r.get("y")}):(l={x:n.get("x"),y:n.get("y")},p={x:r.get("x")+c,y:r.get("y")+d});if(h===Model.RCPType.VERTICAL_2CP)return b.get("id")===e.get("id")?Model.ReferenceDisplay.calculateRCPs_Vertical_2CP(e,f,l,p,!1,!0):Model.ReferenceDisplay.calculateRCPs_Vertical_2CP(e,f,l,p,!0,!1);if(h===Model.RCPType.HORIZONTAL_2CP)return b.get("id")===
e.get("id")?Model.ReferenceDisplay.calculateRCPs_Horizontal_2CP(e,f,l,p,!1,!0):Model.ReferenceDisplay.calculateRCPs_Horizontal_2CP(e,f,l,p,!0,!1);if(h===Model.RCPType.CROSS_3CP)c=m.at(1),b.get("id")===e.get("id")?c.get("x")===r.get("x")?g[1]={x:p.x,y:l.y}:g[1]={x:l.x,y:p.y}:c.get("x")===n.get("x")?g[1]={x:l.x,y:p.y}:g[1]={x:p.x,y:l.y},g[0]={x:l.x,y:l.y},g[2]={x:p.x,y:p.y};else if(h===Model.RCPType.HORIZONTAL_4CP)b.get("id")===e.get("id")?(g=Model.ReferenceDisplay.getCPsAsArray(a.get("controlPoints")),
g[0]={x:l.x,y:l.y},g[1]={x:g[1].x,y:l.y}):(g=Model.ReferenceDisplay.getCPsAsArray(a.get("controlPoints")),g[2]={x:g[2].x,y:p.y},g[3]={x:p.x,y:p.y});else if(h===Model.RCPType.VERTICAL_4CP)b.get("id")===e.get("id")?(g=Model.ReferenceDisplay.getCPsAsArray(a.get("controlPoints")),g[0]={x:l.x,y:l.y},g[1]={x:l.x,y:g[1].y}):(g=Model.ReferenceDisplay.getCPsAsArray(a.get("controlPoints")),g[2]={x:p.x,y:g[2].y},g[3]={x:p.x,y:p.y});else if(h===Model.RCPType.SELF_4CP||h===Model.RCPType.SELF_5CP)for(b=0;b<m.length;b++)e=
m.at(b),g[b]={x:e.get("x")+c,y:e.get("y")+d};return Model.ReferenceDisplay.alignControlPoints({controlPoints:g,controlPointsType:k})},unbindAllEvents:function(){var a=this.get("controlPoints"),b=Model.tableDisplays.get(this.get("pkTableDisplayId")),c=Model.tableDisplays.get(this.get("fkTableDisplayId"));a.off(null,null,this);b.off(null,null,this);b.get("id")!==c.get("id")&&c.off(null,null,this);a=Model.references.get(this.get("modelId"));null!=a&&a.off(null,null,this)},bindChangeControlPointsEvents:function(a){var b=
this;a.on("all",function(c){if("add"===c||"remove"===c||"reset"===c||"change"===c)b.trigger("change:controlPoints",b,a),b.trigger("change",b)},b)},moveControlPointTo:function(a,b,c,d){var e=Model.tableDisplays.get(this.get("pkTableDisplayId")),f=Model.tableDisplays.get(this.get("fkTableDisplayId")),g=this.get("controlPointsType"),h=this.get("controlPoints");b=Math.floor(b)+0.5;c=Math.floor(c)+0.5;if(!this.has("oldcpx")||!this.has("oldcpy"))this.trigger("movecpstart",this,a,h.at(a).get("x"),h.at(a).get("y")),
this.set("oldcpx",h.at(a).get("x")),this.set("oldcpy",h.at(a).get("y"));if(g===Model.RCPType.HORIZONTAL_2CP)h.at(0).set("y",c),h.at(1).set("y",c),0===a?h.at(0).set("x",b):h.at(1).set("x",b);else if(g===Model.RCPType.VERTICAL_2CP)h.at(0).set("x",b),h.at(1).set("x",b),0===a?h.at(0).set("y",c):h.at(1).set("y",c);else if(g===Model.RCPType.CROSS_3CP)if(0===a||2===a){var g=h.at(a),k=h.at(1);g.get("x")===k.get("x")&&g.get("y")===k.get("y")||(g.get("x")===k.get("x")?k.set("x",b):k.set("y",c));b===k.get("x")&&
c===k.get("y")||(g.set("x",b),g.set("y",c))}else{if(1===a){var k=h.at(1),m=h.at(0),g=h.at(2),n=(m.get("x")-b)*(g.get("y")-c)-(m.get("y")-c)*(g.get("x")-b),r;r=m.get("x")!==g.get("x")?(g.get("y")-m.get("y"))/(g.get("x")-m.get("x")):100;m.get("x")===k.get("x")?(b<e.get("x")+10&&(b=e.get("x")+10),b>e.get("x")+e.get("width")-10&&(b=e.get("x")+e.get("width")-10),m.set("x",b)):(c<e.get("y")+10&&(c=e.get("y")+10),c>e.get("y")+e.get("height")-10&&(c=e.get("y")+e.get("height")-10),m.set("y",c));g.get("x")===
k.get("x")?(b<f.get("x")+10&&(b=f.get("x")+10),b>f.get("x")+f.get("width")-10&&(b=f.get("x")+f.get("width")-10),g.set("x",b)):(c<f.get("y")+10&&(c=f.get("y")+10),c>f.get("y")+f.get("height")-10&&(c=f.get("y")+f.get("height")-10),g.set("y",c));0<n*r?(k.set("x",m.get("x")),k.set("y",g.get("y"))):(k.set("x",g.get("x")),k.set("y",m.get("y")))}}else g===Model.RCPType.HORIZONTAL_4CP?0===a?(h.at(0).set("x",b),h.at(0).set("y",c),h.at(1).set("y",c)):1===a?(h.at(0).set("y",c),h.at(1).set("x",b),h.at(1).set("y",
c),h.at(2).set("x",b)):2===a?(h.at(1).set("x",b),h.at(2).set("x",b),h.at(2).set("y",c),h.at(3).set("y",c)):3===a&&(h.at(2).set("y",c),h.at(3).set("x",b),h.at(3).set("y",c)):g===Model.RCPType.VERTICAL_4CP?0===a?(h.at(0).set("x",b),h.at(0).set("y",c),h.at(1).set("x",b)):1===a?(h.at(0).set("x",b),h.at(1).set("x",b),h.at(1).set("y",c),h.at(2).set("y",c)):2===a?(h.at(1).set("y",c),h.at(2).set("x",b),h.at(2).set("y",c),h.at(3).set("x",b)):3===a&&(h.at(2).set("x",b),h.at(3).set("x",b),h.at(3).set("y",c)):
g===Model.RCPType.SELF_4CP?0===a?(m=h.at(0),e=h.at(1),e.get("x")===m.get("x")?e.set("x",b):e.set("y",c),m.set("x",b),m.set("y",c)):1===a?(m=h.at(0),e=h.at(1),g=h.at(2),m.get("x")===e.get("x")?m.set("x",b):m.set("y",c),g.get("x")===e.get("x")?g.set("x",b):g.set("y",c),e.set("x",b),e.set("y",c)):2===a?(e=h.at(1),g=h.at(2),f=h.at(3),e.get("x")===g.get("x")?e.set("x",b):e.set("y",c),f.get("x")===g.get("x")?f.set("x",b):f.set("y",c),g.set("x",b),g.set("y",c)):3===a&&(g=h.at(2),f=h.at(3),g.get("x")===f.get("x")?
g.set("x",b):g.set("y",c),f.set("x",b),f.set("y",c)):g===Model.RCPType.SELF_5CP&&(0===a?(m=h.at(0),e=h.at(1),e.get("x")===m.get("x")?e.set("x",b):e.set("y",c),m.set("x",b),m.set("y",c)):1===a?(m=h.at(0),e=h.at(1),g=h.at(2),m.get("x")===e.get("x")?m.set("x",b):m.set("y",c),g.get("x")===e.get("x")?g.set("x",b):g.set("y",c),e.set("x",b),e.set("y",c)):2===a?(e=h.at(1),g=h.at(2),f=h.at(3),e.get("x")===g.get("x")?e.set("x",b):e.set("y",c),f.get("x")===g.get("x")?f.set("x",b):f.set("y",c),g.set("x",b),g.set("y",
c)):3===a?(g=h.at(2),f=h.at(3),e=h.at(4),g.get("x")===f.get("x")?g.set("x",b):g.set("y",c),e.get("x")===f.get("x")?e.set("x",b):e.set("y",c),f.set("x",b),f.set("y",c)):4===a&&(f=h.at(3),e=h.at(4),f.get("x")===e.get("x")?f.set("x",b):f.set("y",c),e.set("x",b),e.set("y",c)));this.trigger("movecp",this,a);void 0!==d&&!0===d&&(this.trigger("movecpend",this,this.get("oldcpx"),this.get("oldcpy"),h.at(a).get("x"),h.at(a).get("y")),this.unset("oldcpx"),this.unset("oldcpy"))},recalculateRCPsAfterTableResize:function(a,
b,c,d,e,f){var g=Model.tableDisplays.get(a.get("pkTableDisplayId")),h=Model.tableDisplays.get(a.get("fkTableDisplayId"));c=[];var k=a.get("oldControlPointsType");d=a.get("controlPointsType");var m=a.get("controlPoints"),n=m.at(0),r=m.at(m.length-1);e={x:n.get("x"),y:n.get("y")};f={x:r.get("x"),y:r.get("y")};if(b.get("id")===g.get("id")){var l=n.get("x"),p=n.get("y");l>g.get("x")+g.get("width")-10&&(l=g.get("x")+g.get("width")-10);p>g.get("y")+g.get("height")-10&&(p=g.get("y")+g.get("height")-10);
e={x:l,y:p}}b.get("id")===h.get("id")&&(l=r.get("x"),p=r.get("y"),l>h.get("x")+h.get("width")-10&&(l=h.get("x")+h.get("width")-10),p>h.get("y")+h.get("height")-10&&(p=h.get("y")+h.get("height")-10),f={x:l,y:p});if(k===Model.RCPType.VERTICAL_2CP)return b.get("id")===g.get("id")?Model.ReferenceDisplay.calculateRCPs_Vertical_2CP(g,h,e,f,!1,!0):Model.ReferenceDisplay.calculateRCPs_Vertical_2CP(g,h,e,f,!0,!1);if(k===Model.RCPType.HORIZONTAL_2CP)return b.get("id")===g.get("id")?Model.ReferenceDisplay.calculateRCPs_Horizontal_2CP(g,
h,e,f,!1,!0):Model.ReferenceDisplay.calculateRCPs_Horizontal_2CP(g,h,e,f,!0,!1);k===Model.RCPType.CROSS_3CP?(a=m.at(1),b.get("id")===g.get("id")?a.get("x")===r.get("x")?c[1]={x:f.x,y:e.y}:c[1]={x:e.x,y:f.y}:a.get("x")===n.get("x")?c[1]={x:e.x,y:f.y}:c[1]={x:f.x,y:e.y},c[0]={x:e.x,y:e.y},c[2]={x:f.x,y:f.y}):k===Model.RCPType.HORIZONTAL_4CP?b.get("id")===g.get("id")?(c=Model.ReferenceDisplay.getCPsAsArray(a.get("controlPoints")),c[0]={x:e.x,y:e.y},c[1]={x:c[1].x,y:e.y}):(c=Model.ReferenceDisplay.getCPsAsArray(a.get("controlPoints")),
c[2]={x:c[2].x,y:f.y},c[3]={x:f.x,y:f.y}):k===Model.RCPType.VERTICAL_4CP?b.get("id")===g.get("id")?(c=Model.ReferenceDisplay.getCPsAsArray(a.get("controlPoints")),c[0]={x:e.x,y:e.y},c[1]={x:e.x,y:c[1].y}):(c=Model.ReferenceDisplay.getCPsAsArray(a.get("controlPoints")),c[2]={x:f.x,y:c[2].y},c[3]={x:f.x,y:f.y}):k===Model.RCPType.SELF_4CP?(c=Model.ReferenceDisplay.getCPsAsArray(a.get("controlPoints")),b=c[0],a=c[1],n=c[2],g=c[3],a.x===b.x?a.x=e.x:a.y=e.y,n.x===g.x?n.x=f.x:n.y=f.y,b.x=e.x,b.y=e.y,g.x=
f.x,g.y=f.y):k===Model.RCPType.SELF_5CP&&(c=Model.ReferenceDisplay.getCPsAsArray(a.get("controlPoints")),b=c[0],a=c[1],g=c[3],n=c[4],a.x===b.x?a.x=e.x:a.y=e.y,g.x===n.x?g.x=f.x:g.y=f.y,b.x=e.x,b.y=e.y,n.x=f.x,n.y=f.y);return Model.ReferenceDisplay.alignControlPoints({controlPoints:c,controlPointsType:d})},move:function(a,b,c){var d,e,f=this.get("controlPoints"),g=f.at(0);if(!this.has("oldx")||!this.has("oldy"))this.trigger("movestart",this,g.get("x"),g.get("y")),this.set("oldx",g.get("x")),this.set("oldy",
g.get("y"));d=g.get("x")-this.get("oldx");e=g.get("y")-this.get("oldy");for(var h=0;h<f.size();h++){var k=f.at(h);k.set("x",Math.floor(k.get("x")-d+a)+0.5);k.set("y",Math.floor(k.get("y")-e+b)+0.5)}this.trigger("move",this);void 0!==c&&!0===c&&(this.trigger("moveend",this,this.get("oldx"),this.get("oldy"),g.get("x"),g.get("y")),this.unset("oldx"),this.unset("oldy"))},computeCenter:function(){for(var a=Number.MAX_VALUE,b=-Number.MAX_VALUE,c=Number.MAX_VALUE,d=-Number.MAX_VALUE,e=0;e<this.get("controlPoints").size();e++){var f=
this.get("controlPoints").at(e),g=f.get("x"),f=f.get("y");g>b&&(b=g);g<a&&(a=g);f>d&&(d=f);f<c&&(c=f)}return{x:(b-a)/2+a,y:(d-c)/2+c}},moveLinePartTo:function(a,b,c,d,e){var f=this.get("controlPoints"),g=f.at(a);b=f.at(b);f=this.get("controlPointsType");c=Math.floor(c)+0.5;d=Math.floor(d)+0.5;if(!this.has("oldlinex")||!this.has("oldliney"))this.trigger("movelinestart",this,g.get("x"),g.get("y")),this.set("oldlinex",g.get("x")),this.set("oldliney",g.get("y"));f===Model.RCPType.HORIZONTAL_2CP?(g.set("y",
d),b.set("y",d)):f===Model.RCPType.VERTICAL_2CP?(g.set("x",c),b.set("x",c)):f===Model.RCPType.CROSS_3CP?g.get("x")===b.get("x")?(g.set("x",c),b.set("x",c)):(g.set("y",d),b.set("y",d)):f===Model.RCPType.HORIZONTAL_4CP?1===a?(g.set("x",c),b.set("x",c)):(g.set("y",d),b.set("y",d)):f===Model.RCPType.VERTICAL_4CP?1===a?(g.set("y",d),b.set("y",d)):(g.set("x",c),b.set("x",c)):f===Model.RCPType.SELF_4CP?g.get("x")===b.get("x")?(g.set("x",c),b.set("x",c)):(g.set("y",d),b.set("y",d)):f===Model.RCPType.SELF_5CP&&
(g.get("x")===b.get("x")?(g.set("x",c),b.set("x",c)):(g.set("y",d),b.set("y",d)));this.trigger("moveline",this);void 0!==e&&!0===e&&(this.trigger("movelineend",this,this.get("oldlinex"),this.get("oldliney"),g.get("x"),g.get("y")),this.unset("oldlinex"),this.unset("oldliney"))},getPreviousLinePosition:function(){return{x:this.get("oldlinex"),y:this.get("oldliney")}},getPreviousCPPosition:function(){return{x:this.get("oldcpx"),y:this.get("oldcpy")}},getBoundaryRect:function(){for(var a=Number.MAX_VALUE,
b=-Number.MAX_VALUE,c=Number.MAX_VALUE,d=-Number.MAX_VALUE,e=0;e<this.get("controlPoints").size();e++){var f=this.get("controlPoints").at(e),g=f.get("x"),f=f.get("y");g>b&&(b=g);g<a&&(a=g);f>d&&(d=f);f<c&&(c=f)}return{xmin:a,ymin:c,xmax:b,ymax:d}},inArea:function(a){for(var b=this.get("controlPoints"),c=0;c<b.size();c++){var d=b.at(c);if(d.get("x")<a.xmin||d.get("x")>a.xmax||d.get("y")<a.ymin||d.get("y")>a.ymax)return!1}return!0},setInSearchResults:function(){this.set("inSearchResults",!0);this.trigger("setInSearchResults",
this);Model.referenceDisplays.trigger("referenceDisplay_setInSearchResults",Model.referenceDisplays,this)},unsetInSearchResults:function(){this.set("inSearchResults",!1);this.trigger("unsetInSearchResults",this);Model.referenceDisplays.trigger("referenceDisplay_unsetInSearchResults",Model.referenceDisplays,this)},swap:function(){var a=this.get("pkTableDisplayId");this.set("pkTableDisplayId",this.get("fkTableDisplayId"));this.set("fkTableDisplayId",a);a=Model.ReferenceDisplay.getCPsAsArray(this.get("controlPoints"));
this.get("controlPoints").reset(a.reverse())}});Model.ReferenceDisplay.calculateRCPs_Horizontal_2CP=function(a,b,c,d,e,f){var g=[],h=Model.RCPType.HORIZONTAL_2CP;if(!1===f&&c.y>b.get("y")&&c.y<b.get("y")+b.get("height"))g[0]={x:c.x,y:c.y},g[1]={x:d.x,y:c.y};else if(!1===e&&d.y>a.get("y")&&d.y<a.get("y")+a.get("height"))g[0]={x:c.x,y:d.y},g[1]={x:d.x,y:d.y};else return Model.ReferenceDisplay.calculateRCPs_Horizontal_4CP(a,b,c,d);return Model.ReferenceDisplay.alignControlPoints({controlPoints:g,controlPointsType:h})};
Model.ReferenceDisplay.calculateRCPs_Horizontal_4CP=function(a,b,c,d){a=[];b=Model.RCPType.HORIZONTAL_4CP;var e=(c.x+d.x)/2;a[0]={x:c.x,y:c.y};a[1]={x:e,y:c.y};a[2]={x:e,y:d.y};a[3]={x:d.x,y:d.y};return Model.ReferenceDisplay.alignControlPoints({controlPoints:a,controlPointsType:b})};
Model.ReferenceDisplay.calculateRCPs_Cross_3CP=function(a,b,c,d){a=[];b=Model.RCPType.CROSS_3CP;var e;e=c.x!==d.x?Math.abs((d.y-c.y)/(d.x-c.x)):100;a[0]={x:c.x,y:c.y};a[1]=1>e?{x:d.x,y:c.y}:{x:c.x,y:d.y};a[2]={x:d.x,y:d.y};return Model.ReferenceDisplay.alignControlPoints({controlPoints:a,controlPointsType:b})};
Model.ReferenceDisplay.calculateRCPs_Vertical_2CP=function(a,b,c,d,e,f){var g=[],h=Model.RCPType.VERTICAL_2CP;if(!1===f&&c.x>b.get("x")&&c.x<b.get("x")+b.get("width"))g[0]={x:c.x,y:c.y},g[1]={x:c.x,y:d.y};else if(!1===e&&d.x>a.get("x")&&d.x<a.get("x")+a.get("width"))g[0]={x:d.x,y:c.y},g[1]={x:d.x,y:d.y};else return Model.ReferenceDisplay.calculateRCPs_Vertical_4CP(a,b,c,d);return Model.ReferenceDisplay.alignControlPoints({controlPoints:g,controlPointsType:h})};
Model.ReferenceDisplay.calculateRCPs_Vertical_4CP=function(a,b,c,d){a=[];b=Model.RCPType.VERTICAL_4CP;var e=(c.y+d.y)/2;a[0]={x:c.x,y:c.y};a[1]={x:c.x,y:e};a[2]={x:d.x,y:e};a[3]={x:d.x,y:d.y};return Model.ReferenceDisplay.alignControlPoints({controlPoints:a,controlPointsType:b})};
Model.ReferenceDisplay.calculateRCPs_Self=function(a,b,c){var d=[],e=Model.RCPType.SELF_5CP,f;f=b.y>a.get("y")+a.get("height")/2?a.get("y")+a.get("height")+30:a.get("y")-30;a=b.x>a.get("x")+a.get("width")/2?a.get("x")+a.get("width")+30:a.get("x")-30;d[0]={x:b.x,y:b.y};d[1]={x:b.x,y:f};d[2]={x:a,y:f};d[3]={x:a,y:c.y};d[4]={x:c.x,y:c.y};return Model.ReferenceDisplay.alignControlPoints({controlPoints:d,controlPointsType:e})};
Model.ReferenceDisplay.calculateRCPs=function(a,b,c,d){if(a.get("id")===b.get("id"))return Model.ReferenceDisplay.calculateRCPs_Self(a,c,d);if(c.x===d.x)return Model.ReferenceDisplay.calculateRCPs_Vertical_2CP(a,b,c,d,!1,!1);var e=Math.abs((d.y-c.y)/(d.x-c.x));return 0.2>e?Model.ReferenceDisplay.calculateRCPs_Horizontal_2CP(a,b,c,d,!1,!1):0.4>e?Model.ReferenceDisplay.calculateRCPs_Horizontal_4CP(a,b,c,d):2.5>e?Model.ReferenceDisplay.calculateRCPs_Cross_3CP(a,b,c,d):5>e?Model.ReferenceDisplay.calculateRCPs_Vertical_4CP(a,
b,c,d):Model.ReferenceDisplay.calculateRCPs_Vertical_2CP(a,b,c,d,!1,!1)};Model.ReferenceDisplay.alignControlPoints=function(a){for(var b=a.controlPoints,c=[],d=0;d<b.length;++d){var e=b[d];c.push({x:Math.floor(e.x)+0.5,y:Math.floor(e.y)+0.5})}return{controlPoints:c,controlPointsType:a.controlPointsType}};Model.ReferenceDisplay.getCPsAsArray=function(a){for(var b=[],c=0;c<a.length;c++){var d=a.at(c);b[c]={x:d.get("x"),y:d.get("y")}}return b};
Model.ReferenceDisplays=Backbone.Collection.extend({model:Model.ReferenceDisplay,findReferenceDisplayInArea:function(a,b){for(var c=this.where({modelId:a}),d=Model.areas.get(b).getArea(),e=0;e<c.length;e++){var f=c[e];if(f.inArea(d))return f}return null}});Model.referenceDisplays=new Model.ReferenceDisplays;Model.referenceDisplays.on("remove",function(a){a.unbindAllEvents()});Model.referenceDisplays.on("add",function(a){a.bindAllEvents()});Display.makeSelectable(Model.ReferenceDisplay);
Display.initialize=function(a){Model.tableDisplays.reset(a.tableDisplays);Model.referenceDisplays.reset(a.referenceDisplays)};Display.createReferenceDisplay=function(a,b,c,d,e){c=Model.ReferenceDisplay.calculateRCPs(a,b,c,d);return Model.referenceDisplays.create({id:Model.nextId("referenceDisplay"),modelId:e,pkTableDisplayId:a.get("id"),fkTableDisplayId:b.get("id"),color:"#000000",controlPoints:c.controlPoints,controlPointsType:c.controlPointsType})};Display.selection=new Display.Selection;
var Diagram={MIN_ZOOM:0.25,MAX_ZOOM:4,Diagram:function(a){this._initDiagram(a)}};
Diagram.Diagram.prototype={_initDiagram:function(a){this.DIAGRAM_MARGIN=20;Kinetic.Stage.call(this,a);void 0==Model.diagramProperties.get("zoom")?(this.zoom=1,Model.diagramProperties.set("zoom",this.zoom,{silent:!0})):this.zoom=Model.diagramProperties.get("zoom");this.setDraggable(!0);this.setDragBoundFunc(this.diagramDragBoundFunc);var b=new Diagram.BackgroundLayer({diagram:this}),c=new Diagram.ReferenceLayer({diagram:this}),d=new Diagram.TableLayer({diagram:this}),e=new Diagram.SelectionLayer({diagram:this});
this.add(b);this.add(c);this.add(d);this.add(e);this.setAttrs({backgroundLayer:b,referenceLayer:c,tableLayer:d,selectionLayer:e,isDiagramExporter:a.isDiagramExporter});this.bindModelEvents();this.on("mousemove",this.mouseMoveEventHandler);this.on("mouseup",this.mouseUpEventHandler);this.on("mousedown",this.mouseDownEventHandler);this.disableZoomWhileDragging=!1;var f=this;this.on("dragend",function(){f.disableZoomWhileDragging=!1;f.stopCenterDaemon();var a=this.getPosition();Model.diagramProperties.set({"position-x":a.x,
"position-y":a.y})});this.on("dblclick",function(a){this.stopCenterDaemon();Model.applicationProperties.set("display-right-panel",!0)});this.setMode(Model.diagramMode.get("mode"));setInterval(this.centerDaemon.bind(this),50)},repositionDiagram:function(){if(void 0==Model.diagramProperties.get("position-x")){var a=this._findCenterPointInModel(),b=-a.x,a=-a.y;this.setX(b);this.setY(a);Model.diagramProperties.set("position-y",a,{silent:!0});Model.diagramProperties.set("position-x",b,{silent:!0})}else this.setX(Model.diagramProperties.get("position-x")),
this.setY(Model.diagramProperties.get("position-y"));this.isDiagramExporter||this.zoomInternal()},_findCenterPointInModel:function(){var a=null;if(0==Model.tables.size())var a=this.getDiagramWidth()/2-this.getWidth()/2,b=this.getDiagramHeight()/2-this.getHeight()/2;else var b=Model.tableDisplays.sortBy(function(a){return a.get("x")}),c=Model.tableDisplays.sortBy(function(a){return a.get("y")}),d=b[b.length-1],a=c[0],c=c[c.length-1],b=(b[0].get("x")+(d.get("x")+d.get("width")))/2,d=(a.get("y")+(c.get("y")+
c.get("height")))/2,a=b-this.getWidth()/2,b=d-this.getHeight()/2;return a={x:a,y:b}},redrawDiagram:function(){Model.groupOperation.isInProgress()||(this.draw(),this.fire("diagram-redraw"))},diagramDragBoundFunc:function(a){var b=a.x,c=a.y;a.x<this.getWidth()-this.getDiagramWidth()*this.zoom-this.DIAGRAM_MARGIN&&(b=this.getWidth()-this.getDiagramWidth()*this.zoom-this.DIAGRAM_MARGIN);a.x>this.DIAGRAM_MARGIN&&(b=this.DIAGRAM_MARGIN);a.y<this.getHeight()-this.getDiagramHeight()*this.zoom-this.DIAGRAM_MARGIN&&
(c=this.getHeight()-this.getDiagramHeight()*this.zoom-this.DIAGRAM_MARGIN);a.y>this.DIAGRAM_MARGIN&&(c=this.DIAGRAM_MARGIN);return{x:b,y:c}},bindModelEvents:function(){var a=this;Model.tableDisplays.on("reset",function(b){a.deleteAllTables();for(var c=0;c<b.size();c++){var d=b.at(c);a.addTable(d)}a.redrawDiagram()},a);Model.referenceDisplays.on("reset",function(b){a.deleteAllReferences();for(var c=0;c<b.size();c++){var d=b.at(c);a.addReference(d)}a.redrawDiagram()},a);Model.notes.on("reset",function(b){a.deleteAllNotes();
for(var c=0;c<b.size();c++){var d=b.at(c);a.addNote(d)}a.redrawDiagram()},a);Model.viewDisplays.on("reset",function(b){a.deleteAllViews();for(var c=0;c<b.size();c++){var d=b.at(c);a.addViewDisplay(d)}a.redrawDiagram()},a);Model.areas.on("reset",function(b){a.deleteAllAreas();b=_.sortBy(b.models,function(a){return a.get("zIndex")});for(var c=0;c<b.length;c++)a.addArea(b[c]);a.redrawDiagram()},a);Model.tableDisplays.on("add",function(b){a.addTable(b)},a);Model.tables.on("remove",function(b){a.deleteTable(b.get("id"))},
a);Model.tableDisplays.on("remove",function(b){a.deleteTableDisplay(b.get("id"))},a);Model.referenceDisplays.on("add",function(b){a.addReference(b)},a);Model.referenceDisplays.on("remove",function(b){a.deleteReferenceDisplay(b.get("id"))},a);Model.notes.on("add",function(b){a.addNote(b)},a);Model.notes.on("remove",function(b){a.deleteNote(b.get("id"))},a);Model.viewDisplays.on("add",function(b){a.addViewDisplay(b)},a);Model.viewDisplays.on("remove",function(b){a.deleteViewDisplay(b.get("id"))},a);
Model.areas.on("add",function(b){a.addArea(b)},a);Model.areas.on("remove",function(b){a.deleteArea(b.get("id"))},a);Model.diagramProperties.on("change",function(b){a.zoom=b.get("zoom");var c=b.get("position-x");b=b.get("position-y");c={x:c,y:b};a.setScale(a.zoom,a.zoom);a.setPosition(c);a.redrawDiagram()});Model.diagramMode.on("change:mode",function(b,c){a.setMode(c)})},mouseDownEventHandler:function(){this.disableZoomWhileDragging=!0;this.stopCenterDaemon();$("#diagram").focus();if(Model.diagramMode.is(Model.diagramMode.SELECT_RECT_MODE)||
Model.diagramMode.is(Model.diagramMode.ADD_AREA_MODE)){var a=this.getPointerPosition(),b=this.getPosition(),c=this.getScale(),a=Model.Util.alignPoint({x:(-b.x+a.x)*(1/c.x),y:(-b.y+a.y)*(1/c.x)});this.setSelectRectStartPoint(a)}},mouseMoveEventHandler:function(a){if(Model.diagramMode.is(Model.diagramMode.ADD_RELATIONSHIP_MODE)){if(this.setDraggable(!1),a=this.getReferenceStartCP(),void 0!==a&&null!==a){var b=this.getPointerPosition(),c=this.getPosition(),d=this.getScale(),b=Model.Util.alignPoint({x:(-c.x+
b.x)*(1/d.x),y:(-c.y+b.y)*(1/d.x)});this.getSelectionLayer().addTempReferenceLine(a,b);this.getSelectionLayer().draw()}}else if(Model.diagramMode.is(Model.diagramMode.SELECT_RECT_MODE)||Model.diagramMode.is(Model.diagramMode.ADD_AREA_MODE))this.setDraggable(!1),a=this.getSelectRectStartPoint(),void 0!==a&&null!==a&&(b=this.getPointerPosition(),c=this.getPosition(),d=this.getScale(),b=Model.Util.alignPoint({x:(-c.x+b.x)*(1/d.x),y:(-c.y+b.y)*(1/d.x)}),this.getSelectionLayer().addTempSelectRect(a,b),
this.getSelectionLayer().draw())},mouseUpEventHandler:function(){this.disableZoomWhileDragging=!1;this.stopCenterDaemon();if(Model.diagramMode.is(Model.diagramMode.ADD_RELATIONSHIP_MODE))this.setReferenceStartCP(null),this.getSelectionLayer().removeTempReferenceLine(),this.redrawDiagram();else if(Model.diagramMode.is(Model.diagramMode.SELECT_RECT_MODE)){var a=this.getSelectRectStartPoint();if(!(null==a||void 0===a)){var b=this;Model.groupOperation.doWithLock(function(){b.selectElements()});this.setSelectRectStartPoint(null);
this.getSelectionLayer().removeTempSelectRect();Model.diagramMode.setMode(Model.diagramMode.SELECT_MODE);this.redrawDiagram()}}else Model.diagramMode.is(Model.diagramMode.ADD_AREA_MODE)&&(a=this.getSelectRectStartPoint(),null==a||void 0===a||(a=this.computeAreaPosition(),Commands.createArea(a.x,a.y,a.width,a.height),this.setSelectRectStartPoint(null),this.getSelectionLayer().removeTempSelectRect(),Model.diagramMode.setMode(Model.diagramMode.ADD_AREA_MODE),this.redrawDiagram()))},computeAreaPosition:function(){var a=
this.getPointerPosition(),b=this.getPosition(),c=this.getScale(),d=this.getSelectRectStartPoint(),a=Model.Util.alignPoint({x:(-b.x+a.x)*(1/c.x),y:(-b.y+a.y)*(1/c.x)}),b=Math.abs(a.x-d.x),c=Math.abs(a.y-d.y);return{x:a.x<d.x?a.x:d.x,y:a.y<d.y?a.y:d.y,width:b,height:c}},addTable:function(a){var b=this.getTableLayer(),c=Model.tables.get(a.get("modelId"));a=new Diagram.Table({tableModel:c,tableLayer:b,tableDisplay:a});b.add(a)},deleteTable:function(a){for(var b=this.getSelectionLayer(),c=this.getTableLayer(),
d=0;d<b.getSelectedTables().length;d++){var e=b.getSelectedTables()[d];if(e.getTableModel().get("id")===a){e.unbindModelEvents();b.removeTableDisplayControlPoints(e.getTableDisplay());e.destroy();return}}for(d=0;d<c.getChildren().length;d++)if(b=c.getChildren()[d],b instanceof Diagram.Table&&b.getTableModel().get("id")===a){b.unbindModelEvents();b.destroy();break}},deleteTableDisplay:function(a){for(var b=this.getSelectionLayer(),c=this.getTableLayer(),d=0;d<b.getSelectedTables().length;d++){var e=
b.getSelectedTables()[d];if(e.getTableDisplay().get("id")===a){e.unbindModelEvents();b.removeTableDisplayControlPoints(e.getTableDisplay());e.destroy();return}}for(d=0;d<c.getChildren().length;d++)if(b=c.getChildren()[d],b instanceof Diagram.Table&&b.getTableDisplay().get("id")===a){b.unbindModelEvents();b.destroy();break}},deleteAllTables:function(){for(var a=this.getSelectionLayer(),b=this.getTableLayer(),c=_.clone(a.getSelectedTables()),d=0;d<c.length;d++){var e=c[d];e.unbindModelEvents();a.removeTableDisplayControlPoints(e.getTableDisplay());
e.destroy()}a=_.clone(b.getChildren());for(d=0;d<a.length;d++)b=a[d],b instanceof Diagram.Table&&(b.unbindModelEvents(),b.destroy())},addReference:function(a){var b=this.getReferenceLayer(),c=Model.references.get(a.get("modelId"));a=new Diagram.Reference({referenceLayer:b,referenceModel:c,referenceDisplay:a});b.add(a)},deleteReferenceDisplay:function(a){for(var b=this.getSelectionLayer(),c=this.getReferenceLayer(),d=0;d<b.getSelectedReferences().length;d++){var e=b.getSelectedReferences()[d];if(e.getReferenceDisplay().get("id")===
a){e.unbindModelEvents();b.removeReferenceDisplayControlPoints(e.getReferenceDisplay());e.destroy();return}}for(d=0;d<c.getChildren().length;d++)if(b=c.getChildren()[d],b instanceof Diagram.Reference&&b.getReferenceDisplay().get("id")===a){b.unbindModelEvents();b.destroy();break}},deleteAllReferences:function(){for(var a=this.getSelectionLayer(),b=this.getReferenceLayer(),c=_.clone(a.getSelectedReferences()),d=0;d<c.length;d++){var e=c[d];e.unbindModelEvents();a.removeReferenceControlPoints(e.getReferenceModel());
e.destroy()}a=_.clone(b.getChildren());for(d=0;d<a.length;d++)b=a[d],b instanceof Diagram.Reference&&(b.unbindModelEvents(),b.destroy())},addNote:function(a){var b=this.getTableLayer();a=new Diagram.Note({noteModel:a,noteLayer:b});b.add(a)},deleteNote:function(a){for(var b=this.getSelectionLayer(),c=this.getTableLayer(),d=0;d<b.getSelectedNotes().length;d++){var e=b.getSelectedNotes()[d];if(e.getNoteModel().get("id")===a){e.unbindModelEvents();b.removeNoteControlPoints(e.getNoteModel());e.destroy();
return}}for(d=0;d<c.getChildren().length;d++)if(b=c.getChildren()[d],b instanceof Diagram.Note&&b.getNoteModel().get("id")===a){b.unbindModelEvents();b.destroy();break}},deleteAllNotes:function(){for(var a=this.getSelectionLayer(),b=this.getTableLayer(),c=_.clone(a.getSelectedNotes()),d=0;d<c.length;d++){var e=c[d];e.unbindModelEvents();a.removeNoteControlPoints(e.getNoteModel());e.destroy()}a=_.clone(b.getChildren());for(d=0;d<a.length;d++)b=a[d],b instanceof Diagram.Note&&(b.unbindModelEvents(),
b.destroy())},addViewDisplay:function(a){var b=this.getTableLayer(),c=Model.views.get(a.get("modelId"));a=new Diagram.View({viewModel:c,viewLayer:b,viewDisplay:a});b.add(a)},deleteViewDisplay:function(a){for(var b=this.getSelectionLayer(),c=this.getTableLayer(),d=0;d<b.getSelectedViews().length;d++){var e=b.getSelectedViews()[d];if(e.getViewDisplay().get("id")===a){e.unbindModelEvents();b.removeViewDisplayControlPoints(e.getViewDisplay());e.destroy();return}}for(d=0;d<c.getChildren().length;d++)if(b=
c.getChildren()[d],b instanceof Diagram.View&&b.getViewDisplay().get("id")===a){b.unbindModelEvents();b.destroy();break}},deleteAllViews:function(){for(var a=this.getSelectionLayer(),b=this.getTableLayer(),c=_.clone(a.getSelectedViews()),d=0;d<c.length;d++){var e=c[d];e.unbindModelEvents();a.removeViewDisplayControlPoints(e.getViewModel());e.destroy()}a=_.clone(b.getChildren());for(d=0;d<a.length;d++)b=a[d],b instanceof Diagram.View&&(b.unbindModelEvents(),b.destroy())},addArea:function(a){var b=
this.getBackgroundLayer(),c=b.getAreaGroup();a=new Diagram.Area({areaModel:a,areaLayer:b});c.add(a)},deleteArea:function(a){for(var b=this.getBackgroundLayer().getAreaGroup(),c=0;c<b.getChildren().length;c++){var d=b.getChildren()[c];if(d instanceof Diagram.Area&&d.getAreaModel().get("id")===a){d.unbindModelEvents();d.destroy();break}}},deleteAllAreas:function(){for(var a=this.getSelectionLayer(),b=this.getBackgroundLayer().getAreaGroup(),c=_.clone(a.getSelectedAreas()),d=0;d<c.length;d++){var e=
c[d];e.unbindModelEvents();a.removeAreaControlPoints(e.getAreaModel());a.detachAreaFromSelection(e);e.destroy()}a=_.clone(b.getChildren());for(d=0;d<a.length;d++)b=a[d],b instanceof Diagram.Area&&(b.unbindModelEvents(),b.destroy())},selectTableDisplay:function(a){this.getSelectionLayer().addTableDisplayControlPoints(a.getTableDisplay())},deselectTableDisplay:function(a){this.getSelectionLayer().removeTableDisplayControlPoints(a.getTableDisplay())},attachTableToSelection:function(a){var b=a.getAbsolutePosition();
a.moveTo(this.getSelectionLayer().getSelectionGroup());a.setAbsolutePosition(b)},detachTableFromSelection:function(a){var b=a.getAbsolutePosition();a.moveTo(this.getTableLayer());a.setAbsolutePosition(b)},selectReference:function(a){this.getSelectionLayer().addReferenceDisplayControlPoints(a.getReferenceDisplay())},deselectReference:function(a){this.getSelectionLayer().removeReferenceDisplayControlPoints(a.getReferenceDisplay())},attachReferenceToSelection:function(a){},detachReferenceFromSelection:function(a){},
selectNote:function(a){this.getSelectionLayer().addNoteControlPoints(a.getNoteModel())},deselectNote:function(a){this.getSelectionLayer().removeNoteControlPoints(a.getNoteModel())},attachNoteToSelection:function(a){var b=a.getAbsolutePosition();a.moveTo(this.getSelectionLayer().getSelectionGroup());a.setAbsolutePosition(b)},detachNoteFromSelection:function(a){var b=a.getAbsolutePosition();a.moveTo(this.getTableLayer());a.setAbsolutePosition(b)},selectView:function(a){this.getSelectionLayer().addViewControlPoints(a.getViewDisplay())},
deselectView:function(a){this.getSelectionLayer().removeViewDisplayControlPoints(a.getViewDisplay())},attachViewToSelection:function(a){var b=a.getAbsolutePosition();a.moveTo(this.getSelectionLayer().getSelectionGroup());a.setAbsolutePosition(b)},detachViewFromSelection:function(a){var b=a.getAbsolutePosition();a.moveTo(this.getTableLayer());a.setAbsolutePosition(b)},selectArea:function(a){this.getSelectionLayer().addAreaControlPoints(a.getAreaModel(),a)},deselectArea:function(a){this.getSelectionLayer().removeAreaControlPoints(a.getAreaModel())},
attachAreaToSelection:function(a){var b=a.focusArea,c=new Diagram.AreaFocusArea({areaModel:a.focusArea.areaModel,areaLayer:a.focusArea.areaLayer,areaRect:a.focusArea.areaRect});a.focusArea.getParent().add(c);a.focusArea.getParent().focusArea=c;a=b.getAbsolutePosition();b.moveTo(this.getSelectionLayer().getSelectionGroup());b.setAbsolutePosition(a)},detachAreaFromSelection:function(a){this.getSelectionLayer().detachAreaFromSelection(a)},startNewReference:function(a){var b=this.getPointerPosition(),
c=this.getPosition(),d=this.getScale();this.referencePkTableDisplay=a;var e=a.get("modelId");this.referencePkTable=Model.tables.get(e);b=Model.Util.alignPoint({x:(-c.x+b.x)*(1/d.x),y:(-c.y+b.y)*(1/d.x)});b=a.adjustPointToInsideMargin(b);this.setReferenceStartCP(b)},createNewReference:function(a){var b=this.getPointerPosition(),c=this.getPosition(),d=this.getScale(),e=this.getReferenceStartCP();void 0!==e&&null!==e&&(b=Model.Util.alignPoint({x:(-c.x+b.x)*(1/d.x),y:(-c.y+b.y)*(1/d.x)}),b=a.adjustPointToInsideMargin(b),
Commands.createReference(this.referencePkTableDisplay,a,this.getReferenceStartCP(),b))},selectElements:function(){var a=this.getSelectRectStartPoint(),b=this.getPointerPosition(),c=this.getPosition(),d=this.getScale(),e=Model.Util.alignPoint({x:(-c.x+b.x)*(1/d.x),y:(-c.y+b.y)*(1/d.x)}),b=Math.min(a.x,e.x),c=Math.max(a.x,e.x),d=Math.min(a.y,e.y),a=Math.max(a.y,e.y),a={xmin:b,ymin:d,xmax:c,ymax:a};Display.selection.clearAll();for(b=0;b<Model.tableDisplays.size();b++)c=Model.tableDisplays.at(b),c.inArea(a)&&
Display.selection.attachElement(c);for(b=0;b<Model.notes.size();b++)c=Model.notes.at(b),c.inArea(a)&&Display.selection.attachElement(c);for(b=0;b<Model.referenceDisplays.size();b++)c=Model.referenceDisplays.at(b),c.inArea(a)&&Display.selection.attachElement(c);for(b=0;b<Model.viewDisplays.size();b++)c=Model.viewDisplays.at(b),c.inArea(a)&&Display.selection.attachElement(c);for(b=0;b<Model.areas.size();b++)c=Model.areas.at(b),c.inArea(a)&&Display.selection.attachElement(c);Display.selection.triggerSelectionChanged()},
getReferenceStartCP:function(){return this.referenceStartCP},setReferenceStartCP:function(a){this.referenceStartCP=a},getSelectRectStartPoint:function(){return this.selectRectStartPoint},setSelectRectStartPoint:function(a){this.selectRectStartPoint=a},zoomIn:function(a){this.disableZoomWhileDragging||(this.zoom<Diagram.MAX_ZOOM&&(this.zoom+=0.1),this.zoomInternal(a))},zoomOut:function(a){this.disableZoomWhileDragging||(this.zoom>Diagram.MIN_ZOOM&&(this.zoom-=0.1),this.zoomInternal(a))},zoom11:function(a){this.disableZoomWhileDragging||
(this.zoom=1,this.zoomInternal(a))},zoomCustom:function(a,b){a>=Diagram.MIN_ZOOM&&a<=Diagram.MAX_ZOOM&&(this.zoom=a);this.zoomInternal(b)},zoomInternal:function(a){var b=this.getPosition();if(void 0==b)throw Error("Undefined diagramPos.");var c=this.getScale();if(void 0==b)throw Error("Undefined diagramScale.");this.zoom>Diagram.MAX_ZOOM&&(this.zoom=Diagram.MAX_ZOOM);this.zoom<Diagram.MIN_ZOOM&&(this.zoom=Diagram.MIN_ZOOM);if(a){if(a=this.getPointerPosition(),void 0==a){logger.warn("Diagram.zoomInternal focusPointAbsolute is undefined. Do nothing.");
return}}else a={x:this.getWidth()/2,y:this.getHeight()/2};Model.diagramProperties.set({zoom:this.zoom,"position-x":Math.floor(a.x-(-b.x+a.x)*(1/c.x)*this.zoom),"position-y":Math.floor(a.y-(-b.y+a.y)*(1/c.x)*this.zoom)})},resize:function(a,b){this.setWidth(a);this.setHeight(b);this.redrawDiagram()},setMode:function(a){var b="auto";switch(a){case Model.diagramMode.ADD_TABLE_MODE:b="url(/assets/stylesheets/cursors/tabela.cur), auto";break;case Model.diagramMode.ADD_RELATIONSHIP_MODE:b="url(/assets/stylesheets/cursors/zwiazek.cur), auto";
break;case Model.diagramMode.ADD_NOTE_MODE:b="url(/assets/stylesheets/cursors/ramka_tekst.cur), auto";break;case Model.diagramMode.ADD_VIEW_MODE:b="url(/assets/stylesheets/cursors/widok.cur), auto";break;case Model.diagramMode.ADD_AREA_MODE:b="url(/assets/stylesheets/cursors/plaszczyzna.cur), auto"}Model.diagramMode.is(Model.diagramMode.ADD_RELATIONSHIP_MODE)||Model.diagramMode.is(Model.diagramMode.SELECT_RECT_MODE)?this.setDraggable(!1):this.setDraggable(!0);$("#diagram").css("cursor",b)},targetPosition:null,startPosition:null,targetZoom:null,
halfWayZoom:null,centerProgress:null,stopCenterDaemon:function(){this.centerProgress=this.targetZoom=this.startPosition=this.targetPosition=null},centerDaemon:function(){if(null!=this.centerProgress){0==this.centerProgress&&this.stopCenterDaemon();if(1==this.centerProgress){var a=this.halfWayZoom,b=Model.diagramProperties.get("zoom"),c=a-0.3*(a-b);0.01>Math.abs(b-c)&&(c=a);this.zoomCustom(c);c==a&&(this.centerProgress=2)}if(2==this.centerProgress){var b=Model.diagramProperties.get("zoom"),a=-this.targetPosition.x*
b+Model.applicationProperties.get("width")/2,b=-this.targetPosition.y*b+Model.applicationProperties.get("height")/2,d=Model.diagramProperties.get("position-x"),c=Model.diagramProperties.get("position-y"),d=Math.round(a-0.5*(a-d)),c=Math.round(b-0.5*(b-c));3>Math.abs(d-a)&&3>Math.abs(c-b)&&(d=Math.round(a),c=Math.round(b),this.centerProgress=3);Model.diagramProperties.set({"position-x":d,"position-y":c})}3==this.centerProgress&&(a=this.targetZoom,b=Model.diagramProperties.get("zoom"),c=a-0.3*(a-b),
0.01>Math.abs(b-c)&&(c=a),this.zoomCustom(c),c==a&&(this.centerProgress=0))}},center:function(a){if(null==this.centerProgress){var b=Model.diagramProperties.get("zoom");this.targetZoom=b;this.halfWayZoom=0.5>b?b:0.5;this.halfWayZoom>Diagram.MAX_ZOOM&&(this.halfWayZoom=Diagram.MAX_ZOOM);this.halfWayZoom<Diagram.MIN_ZOOM&&(this.halfWayZoom=Diagram.MIN_ZOOM)}this.startPosition={x:Model.diagramProperties.get("position-x"),y:Model.diagramProperties.get("position-y")};this.targetPosition={x:a.x,y:a.y};
this.centerProgress=1},measureColumnText:function(a){var b=this.getTableLayer().getContext()._context;b.font="12px Arial";b.textAlign="left";b.fillStyle="black";return b.measureText(a).width},measureTableTitle:function(a){var b=this.getTableLayer().getContext()._context;b.font="bold 12px Arial";b.textAlign="left";b.fillStyle="black";return b.measureText(a).width},measureNoteTextWidth:function(a){var b=this.getTableLayer().getContext()._context;b.font="13px Arial";b.textAlign="left";b.fillStyle="black";
return b.measureText(a).width},measureHeight:function(a){return 14.4*a},trimText:function(a,b,c,d){var e=a,f=c.measureText(a).width;if(void 0===d||null==d)d=0;if(100<=d)return e;f>b&&(e=this.trimText(a.slice(0,Math.floor(a.length*b/f)),b,c,d+1));return e},getAbsoluteX:function(a){var b=this.getPosition(),c=this.getScale();return a*c.x+b.x},getAbsoluteY:function(a){var b=this.getPosition(),c=this.getScale();return a*c.y+b.y},getAbsolutePos:function(a){var b=this.getPosition(),c=this.getScale();return{x:a.x*
c.x+b.x,y:a.y*c.y+b.y}},getArea:function(){var a=this.getPosition(),b=this.getScale(),c=1*-a.x/b.x,a=1*-a.y/b.y,d=c+1*this.getWidth()/b.x,b=a+1*this.getHeight()/b.y;return{xmin:c,xmax:d,ymin:a,ymax:b}},getAreaCenter:function(){var a=this.getArea();return{x:(a.xmin+a.xmax)/2,y:(a.ymin+a.ymax)/2}},getSelectColor:function(){return"#007de7"},getSearchColor:function(){return"#ffa200"}};
Diagram.Exporter={_MARGIN:10,_LOGO_LAYER_HEIGHT:50,_LOGO_LAYER_MIN_WIDTH:170,_LOGO_HEIGHT:36,_LOGO_WIDTH:149,_tables:null,_references:null,_views:null,_notes:null,_areas:null,exportToImage:function(){this._fillElementsToExport();var a=this._getBoundaryRect(),b=a.maxX-a.minX+2*this._MARGIN,c=a.maxY-a.minY+2*this._MARGIN;if(!(3E3<b||3E3<c)||confirm("The size of the model you try to export is very big: "+b+"x"+c+" px.\nThis may cause a crash of the browser.\nAre you sure you want to export that large image?\n\nHINT: you may select and export a part of the model!")){var d=
this._shouldAddLogoToDiagram();!0==d&&(b=b>=this._LOGO_LAYER_MIN_WIDTH?b:this._LOGO_LAYER_MIN_WIDTH,c+=this._LOGO_LAYER_HEIGHT);var e={x:Math.floor(-a.minX+this._MARGIN),y:Math.floor(-a.minY+this._MARGIN)};!0==d&&(e.y=Math.floor(-a.minY+this._MARGIN+this._LOGO_LAYER_HEIGHT));a=new Diagram.Diagram({model:Model,container:"diagram_as_image",width:b,height:c,diagramWidth:b-e.x,diagramHeight:c-e.y,isDiagramExporter:!0});this._addObjectsToDiagram(a);a.setScale(1);a.setPosition(e);!0==d&&this._addLogoToDiagram(a);
a.draw();a.toDataURL({callback:function(a){window.open(a)}})}},_fillElementsToExport:function(){this._tables=[];this._references=[];this._views=[];this._notes=[];this._areas=[];0==Display.selection.getAttachedElements().length?this._readWholeModel():this._readAttachedElements()},_readWholeModel:function(){for(var a=0;a<Model.tableDisplays.size();a++){var b=Model.tableDisplays.at(a);this._tables.push(b)}for(a=0;a<Model.referenceDisplays.size();a++)b=Model.referenceDisplays.at(a),this._references.push(b);
for(a=0;a<Model.viewDisplays.size();a++)b=Model.viewDisplays.at(a),this._views.push(b);for(a=0;a<Model.notes.size();a++)b=Model.notes.at(a),this._notes.push(b);for(a=0;a<Model.areas.size();a++)b=Model.areas.at(a),this._areas.push(b)},_readAttachedElements:function(){for(var a=Display.selection.getAttachedElements(),b=0;b<a.length;++b){var c=a[b];c instanceof Model.TableDisplay?this._tables.push(c):c instanceof Model.ReferenceDisplay?this._references.push(c):c instanceof Model.ViewDisplay?this._views.push(c):
c instanceof Model.Note?this._notes.push(c):c instanceof Model.Area&&this._areas.push(c)}a=_.clone(this._references);for(b=0;b<a.length;++b){var c=a[b],d=Model.tableDisplays.get(c.get("pkTableDisplayId")),e=Model.tableDisplays.get(c.get("fkTableDisplayId"));(0>this._tables.indexOf(d)||0>this._tables.indexOf(e))&&this._references.splice(this._references.indexOf(c),1)}},_getBoundaryRect:function(){for(var a=[],a=a.concat(this._tables),a=a.concat(this._references),a=a.concat(this._views),a=a.concat(this._notes),
a=a.concat(this._areas),b=1E4,c=1E4,d=0,e=0,f=0;f<a.length;++f){var g=a[f].getBoundaryRect();b>g.xmin&&(b=g.xmin);c>g.ymin&&(c=g.ymin);d<g.xmax&&(d=g.xmax);e<g.ymax&&(e=g.ymax)}return{minX:b,minY:c,maxX:d,maxY:e}},_addObjectsToDiagram:function(a){for(var b=0;b<this._areas.length;b++)a.addArea(this._areas[b]);for(b=0;b<this._tables.length;++b)a.addTable(this._tables[b]);for(b=0;b<this._references.length;++b){var c=this._references[b];a.addReference(c)}for(b=0;b<this._views.length;++b)a.addViewDisplay(this._views[b]);
for(b=0;b<this._notes.length;++b)a.addNote(this._notes[b]);for(var d=a.getReferenceLayer().getChildren(),b=0;b<d.length;++b)for(var c=d[b],e=c.getReferenceDisplay(),c=c.getChildren(),e=e.get("color"),f=0;f<c.length;f++)c[f].setStroke(e);a.getLayers().each(function(a){a.getChildren().each(function(a){void 0!==a.shouldDraw&&(a.shouldDraw=function(){return!0})})})},_addLogoToDiagram:function(a){var b=this,c=new Kinetic.Layer,d=a.getPosition(),e=new Kinetic.Rect({x:-d.x,y:-d.y,width:a.getDiagramWidth(),
height:this._LOGO_LAYER_HEIGHT,fill:"#222222",stroke:"#222222",strokeWidth:1,lineJoin:"bevel"});c.add(e);var f=new Image;f.onload=function(){var a=new Kinetic.Image({x:-d.x+10,y:-d.y+8,image:f,width:b._LOGO_WIDTH,height:b._LOGO_HEIGHT});c.add(a)};f.src="/assets/images/logo.png";a.add(c)},_shouldAddLogoToDiagram:function(){var a=Model.metaInfo.get("accountPlan");return void 0===a||null===a?!0:-1!=a.indexOf("Basic")||-1!=a.indexOf("Premium")||-1!=a.indexOf("In-House")||-1!=a.indexOf("Enterprise")?!1:!0}};
Kinetic.Util.extend(Diagram.Diagram,Kinetic.Stage);Kinetic.Factory.addGetterSetter(Diagram.Diagram,"model");Kinetic.Factory.addGetterSetter(Diagram.Diagram,"diagramWidth");Kinetic.Factory.addGetterSetter(Diagram.Diagram,"diagramHeight");Kinetic.Factory.addGetterSetter(Diagram.Diagram,"backgroundLayer");Kinetic.Factory.addGetterSetter(Diagram.Diagram,"referenceLayer");Kinetic.Factory.addGetterSetter(Diagram.Diagram,"tableLayer");Kinetic.Factory.addGetterSetter(Diagram.Diagram,"selectionLayer");
Diagram.DiagramPreview=function(a){this._initDiagramPreview(a)};
Diagram.DiagramPreview.prototype={_initDiagramPreview:function(a){Kinetic.Stage.call(this,a);void 0==Model.diagramProperties.get("show_preview")?(this.isOpen=!0,Model.diagramProperties.set({show_preview:!0},{silent:!0})):this.isOpen=Model.diagramProperties.get("show_preview");this.originalWidth=this.getWidth();this.originalHeight=this.getHeight();this.buttonHeight=this.buttonWidth=20;a=new Kinetic.Layer;var b=this;this.background=new Kinetic.Rect({x:0,y:0,width:this.getWidth(),height:this.getHeight(),
fill:"white",stroke:"#515151",strokeWidth:"1"});this.viewBox=new Kinetic.Rect({x:75,y:75,width:50,height:50,stroke:"#f7ba00",strokeWidth:"1",fill:"#fef4cc",draggable:!1,opacity:0.9});this.dragLayer=new Kinetic.Rect({x:0,y:0,width:this.getWidth(),height:this.getHeight(),fill:"black",stroke:"#515151",strokeWidth:"1",draggable:!0,opacity:0});this.resetViewBoxPosition();this.resetDragLayerPosition();this.dragLayer.on("dragstart",function(a){this.startPos=this.getPosition()});var c=Model.applicationProperties.get("width"),
d=Model.applicationProperties.get("height");this.dragLayer.on("dragmove",function(a){a=this.getPosition();var c=this.startPos.y-a.y,d=3*(this.startPos.x-a.x)/b.getWidth(),c=3*c/b.getHeight(),h=Model.diagramProperties.get("position-x"),k=Model.diagramProperties.get("position-y"),m=Model.applicationProperties.get("width"),n=Model.applicationProperties.get("height");Model.diagramProperties.set({"position-x":Math.floor(h+d*m),"position-y":Math.floor(k+c*n)});this.startPos=a});this.dragLayer.on("dragend",
function(a){b.resetDragLayerPosition();b.updateElements()});this.diagram=new Kinetic.Group({x:this.getWidth()/3,y:this.getHeight()/3,width:this.getWidth(),height:this.getHeight(),listening:!1});c=c>d?this.getWidth()/3/c:this.getHeight()/3/d;this.diagram.setScale(c);this.elements=new Kinetic.Group({x:0,y:0,width:this.getWidth(),height:this.getHeight()});a.add(this.background);a.add(this.viewBox);a.add(this.dragLayer);this.diagram.add(this.elements);a.add(this.diagram);this.button=this.buildCollapseButton();
a.add(this.button);this.add(a);Model.tableDisplays.on("reset",function(a){b.resetTables()},this);Model.tableDisplays.on("add",function(a){b.addElement(a)},this);Model.tableDisplays.on("remove",function(a){b.removeElement(a)},this);Model.viewDisplays.on("reset",function(a){b.resetViews()},this);Model.viewDisplays.on("add",function(a){b.addElement(a)},this);Model.viewDisplays.on("remove",function(a){b.removeElement(a)},this);Model.notes.on("reset",function(a){b.resetNotes()},this);Model.notes.on("add",
function(a){b.addElement(a)},this);Model.notes.on("remove",function(a){b.removeElement(a)},this);app.getDiagram().on("diagram-redraw",function(){b.updateElements()},this);Model.applicationProperties.on("change:width",function(){b.resize();b.reposition()},this);Model.applicationProperties.on("change:height",function(){b.resize();b.reposition()},this);Model.diagramProperties.on("change:show_preview",function(a,c){(b.isOpen=c)?b.expand():b.collapse()});this.isOpen=!0;Model.diagramProperties.set("show_preview",
this.isOpen);this.expand()},resize:function(){if(this.isOpen){var a=Model.applicationProperties.get("width"),b=Model.applicationProperties.get("height"),c=b/8*(4/3),d=b/8;this.background.setWidth(c);this.background.setHeight(d);this.dragLayer.setWidth(c);this.dragLayer.setHeight(d);this.diagram.setWidth(c);this.diagram.setHeight(d);this.diagram.setX(c/3);this.diagram.setY(d/3);this.button.setX(c-this.buttonWidth);this.button.setY(d-this.buttonWidth);this.setWidth(c);this.setHeight(d);this.originalWidth=
c;this.originalHeight=d;this.diagram.setScale(a>b?c/3/a:d/3/b);this.resetViewBoxPosition()}},resetViewBoxPosition:function(){if(this.isOpen){var a=Model.applicationProperties.get("width"),b=Model.applicationProperties.get("height"),c,d,e,f;a>b?(c=this.getWidth()/3,d=this.getHeight()/3,e=this.getWidth()/3,f=e*(b/a)):(c=this.getWidth()/3,d=this.getHeight()/3,f=this.getHeight()/3,e=f*(a/b));this.viewBox.setPosition(c,d);this.viewBox.setWidth(e);this.viewBox.setHeight(f);this.draw()}},resetDragLayerPosition:function(){var a=
this.getWidth(),b=this.getHeight();this.dragLayer.setPosition(0,0);this.dragLayer.setWidth(a);this.dragLayer.setHeight(b);this.draw()},addElement:function(a){a=new Diagram.DiagramPreview.UIElement({model:a});this.elements.add(a)},removeElement:function(a){for(var b=0;b<this.elements.getChildren().length;++b){var c=this.elements.getChildren()[b];if(c.getModel().get("id")===a.get("id")){c.destroy();break}}},resetTables:function(){for(var a=[],b=0;b<this.elements.getChildren().length;++b){var c=this.elements.getChildren()[b];
c.getModel()instanceof Model.TableDisplay&&a.push(c)}_.each(a,function(a){a.destroy()});for(b=0;b<Model.tableDisplays.size();b++)a=Model.tableDisplays.at(b),this.addElement(a)},resetViews:function(){for(var a=[],b=0;b<this.elements.getChildren().length;++b){var c=this.elements.getChildren()[b];c.getModel()instanceof Model.ViewDisplay&&a.push(c)}_.each(a,function(a){a.destroy()});for(b=0;b<Model.viewDisplays.size();b++)a=Model.viewDisplays.at(b),this.addElement(a)},resetNotes:function(){for(var a=
[],b=0;b<this.elements.getChildren().length;++b){var c=this.elements.getChildren()[b];c.getModel()instanceof Model.Note&&a.push(c)}_.each(a,function(a){a.destroy()});for(b=0;b<Model.notes.size();b++)a=Model.notes.at(b),this.addElement(a)},_updateElements:function(){var a=Model.diagramProperties.get("position-x"),b=Model.diagramProperties.get("position-y"),c=Model.diagramProperties.get("zoom");Model.applicationProperties.get("width");Model.applicationProperties.get("height");this.elements.setScale(c);
this.elements.setX(a);this.elements.setY(b);this.draw()},updateElements:function(){Model.groupOperation.isInProgress()?Model.groupOperation.addOnRelease(this._updateElements.bind(this)):this._updateElements()},reposition:function(){var a,b;this.isOpen?(a=this.originalWidth,b=this.originalHeight):b=a=this.buttonWidth;$("#preview").css({position:"absolute",width:a,height:b,right:0,bottom:0})},collapse:function(){this.setWidth(this.buttonWidth);this.setHeight(this.buttonWidth);this.button.arrow.setRotationDeg(180);
this.button.arrow.setX(this.buttonWidth);this.button.arrow.setY(this.buttonWidth);this.button.setX(0);this.button.setY(0);this.draw();this.reposition()},expand:function(){this.resize();this.setWidth(this.originalWidth);this.setHeight(this.originalHeight);this.button.arrow.setRotationDeg(0);this.button.arrow.setX(0);this.button.arrow.setY(0);this.button.setX(this.getWidth()-this.buttonWidth);this.button.setY(this.getHeight()-this.buttonWidth);this.draw();this.reposition()},toggle:function(){var a=
Model.diagramProperties.get("show_preview");Model.diagramProperties.set("show_preview",!a)},buildCollapseButton:function(){var a=this.buttonWidth,b=this.buttonWidth,c=new Kinetic.Group({x:this.getWidth()-a,y:this.getHeight()-b,width:a,height:b});c.add(new Kinetic.Rect({x:0,y:0,width:a,height:b}));a=new Image;a.src="/assets/images/diagram-preview-arrow.png";a=new Kinetic.Image({x:0,y:0,image:a,width:this.buttonWidth,height:this.buttonWidth});c.arrow=a;c.add(a);var d=this;c.on("click",function(){d.toggle()});
return c}};Diagram.DiagramPreview.UIElement=function(a){this._initElement(a)};
Diagram.DiagramPreview.UIElement.prototype={_initElement:function(a){var b=a.model;Kinetic.Group.call(this,{x:b.get("x"),y:b.get("y"),draggable:!1});this.setAttrs(a);this.bindModelEvents(b);this.build()},bindModelEvents:function(a){var b=this;a.on("move",function(a,d,e){b.setPosition({x:a.get("x"),y:a.get("y")})},b);a.on("resize",function(a,d,e,f,g){b.box.setWidth(d);b.box.setHeight(e)},b);a.on("change:width",function(a,d){b.box.setWidth(d)},b);a.on("change:height",function(a,d){b.box.setHeight(d)},
b)},build:function(){this.box=new Kinetic.Rect({x:0,y:0,width:this.getModel().get("width"),height:this.getModel().get("height"),stroke:"#535353",fill:"#d3d8db",strokeWidth:"2"});this.add(this.box)}};Kinetic.Util.extend(Diagram.DiagramPreview.UIElement,Kinetic.Group);Kinetic.Factory.addGetter(Diagram.DiagramPreview.UIElement,"model");Kinetic.Util.extend(Diagram.DiagramPreview,Kinetic.Stage);Kinetic.Factory.addGetterSetter(Diagram.DiagramPreview,"diagram");Diagram.BackgroundLayer=function(a){this._initBackgroundLayer(a)};
Diagram.BackgroundLayer.prototype={_initBackgroundLayer:function(a){Kinetic.Layer.call(this,a);var b=this.getDiagram();a=b.getDiagramWidth();var b=b.getDiagramHeight(),c=new Kinetic.Rect({x:-0.5,y:-0.5,width:a-0,height:b-0,fill:"#FFFFFF",stroke:"#D0D0D0",strokeWidth:1});this.add(c);a=new Kinetic.Group({x:-0.5,y:-0.5,width:a-0,height:b-0});this.add(a);this.setAttrs({areaGroup:a});this.on("mousedown",this.mouseDownEventHandler)},mouseDownEventHandler:function(){var a=this.getDiagram(),b=this.getDiagram().getPointerPosition();
void 0==b&&(b={x:0,y:0});if(Model.diagramMode.is(Model.diagramMode.ADD_TABLE_MODE)){var a=this.getDiagram().getPosition(),c=this.getDiagram().getScale();Commands.createTable((-a.x+b.x)*(1/c.x),(-a.y+b.y)*(1/c.y))}else Model.diagramMode.is(Model.diagramMode.ADD_NOTE_MODE)?(a=this.getDiagram().getPosition(),c=this.getDiagram().getScale(),Commands.createNote((-a.x+b.x)*(1/c.x),(-a.y+b.y)*(1/c.y))):Model.diagramMode.is(Model.diagramMode.ADD_VIEW_MODE)?(a=this.getDiagram().getPosition(),c=this.getDiagram().getScale(),
Commands.createView((-a.x+b.x)*(1/c.x),(-a.y+b.y)*(1/c.y))):Model.diagramMode.is(Model.diagramMode.SELECT_MODE)&&(Display.selection.clearAll(),a.draw())}};Kinetic.Util.extend(Diagram.BackgroundLayer,Kinetic.Layer);Kinetic.Factory.addGetter(Diagram.BackgroundLayer,"diagram");Kinetic.Factory.addGetter(Diagram.BackgroundLayer,"areaGroup");Diagram.ReferenceLayer=function(a){this._initReferenceLayer(a)};Diagram.ReferenceLayer.prototype={_initReferenceLayer:function(a){Kinetic.Layer.call(this,a)}};
Kinetic.Util.extend(Diagram.ReferenceLayer,Kinetic.Layer);Kinetic.Factory.addGetter(Diagram.ReferenceLayer,"diagram");Diagram.TableLayer=function(a){this._initTableLayer(a)};Diagram.TableLayer.prototype={_initTableLayer:function(a){Kinetic.Layer.call(this,a)}};Kinetic.Util.extend(Diagram.TableLayer,Kinetic.Layer);Kinetic.Factory.addGetter(Diagram.TableLayer,"diagram");Diagram.SelectionLayer=function(a){this._initSelectionLayer(a)};
Diagram.SelectionLayer.prototype={_initSelectionLayer:function(a){Kinetic.Layer.call(this,a);a=new Kinetic.Group({x:0,y:0,draggable:!0});var b=new Kinetic.Group({x:0,y:0,draggable:!1}),c=new Kinetic.Group({x:0,y:0,draggable:!1}),d=new Kinetic.Group({x:0,y:0,draggable:!1}),e=new Kinetic.Group({x:0,y:0,draggable:!1}),f=new Kinetic.Group({x:0,y:0,draggable:!1});this.add(a);this.add(b);this.add(c);this.add(d);this.add(e);this.add(f);this.setAttrs({selectionGroup:a,tableCPs:b,referenceCPs:c,noteCPs:d,
viewCPs:e,areaCPs:f});var g=this;a.on("dragmove",function(a){g.selectionGroupDragMoveEventHandler(a)});a.on("dragend",function(a){Model.groupOperation.doWithLock(function(){g.selectionGroupDragEndEventHandler(a)})});Model.metaInfo.on("change:mode",this.updateEditableReadonly,this);this.updateEditableReadonly()},updateEditableReadonly:function(){var a=app.isEditable();this.getSelectionGroup().setDraggable(a);this.getTableCPs().setDraggable(a);this.getReferenceCPs().setDraggable(a);this.getNoteCPs().setDraggable(a);
this.getViewCPs().setDraggable(a);this.getAreaCPs().setDraggable(a);"read_only_edit_no_longer"==Model.metaInfo.get("mode")&&(console.log("mode = ",Model.metaInfo.get("mode")),this.getReferenceCPs().removeChildren(),this.draw())},addTempReferenceLine:function(a,b){if(void 0===this.tempRefLine||null===this.tempRefLine)this.tempRefLine=new Kinetic.Line({points:[],stroke:"black",strokeWidth:1,lineCap:"round",lineJoin:"round",dashArray:[8,8]}),this.add(this.tempRefLine);var c=b.x>a.x?-2:2;this.tempRefLine.setPoints([a.x,
a.y,b.x+c,b.y+c])},removeTempReferenceLine:function(){void 0!==this.tempRefLine&&null!==this.tempRefLine&&(this.tempRefLine.destroy(),this.tempRefLine=null)},addTempSelectRect:function(a,b){if(void 0===this.tempSelectRect||null===this.tempSelectRect)this.tempSelectRect=new Kinetic.Rect({stroke:this.getDiagram().getSelectColor(),strokeWidth:1,lineCap:"round",lineJoin:"round",dashArrayEnabled:!0,dashArray:[8,8]}),this.add(this.tempSelectRect);var c=Math.round(2/this.getDiagram().getScale().x),d=Math.round(2/
this.getDiagram().getScale().y);this.tempSelectRect.setX(a.x);this.tempSelectRect.setY(a.y);this.tempSelectRect.setWidth(b.x-a.x-c);this.tempSelectRect.setHeight(b.y-a.y-d)},removeTempSelectRect:function(){void 0!==this.tempSelectRect&&null!==this.tempSelectRect&&(this.tempSelectRect.destroy(),this.tempSelectRect=null)},addTableDisplayControlPoints:function(a){if(!1!=app.isEditable()){var b=this.getTableCPs();this.buildTableDisplayCPs(a,b);a.on("move",function(a){for(a=0;a<b.getChildren().length;a++)b.getChildren()[a].updatePosition()},
this);a.on("resize",function(a){for(a=0;a<b.getChildren().length;a++)b.getChildren()[a].updatePosition()},this)}},removeTableDisplayControlPoints:function(a){var b=this.getTableCPs();for(a.off(null,null,this);0<b.getChildren().length;)b.getChildren()[0].destroy()},addReferenceDisplayControlPoints:function(a){if(!1!=app.isEditable()){var b=this.getReferenceCPs();this.buildReferenceDisplayCPs(a,b);a.on("change:controlPoints",function(a,d){for(var e=0;e<b.getChildren().length;e++)b.getChildren()[e].updatePosition()},
this)}},removeReferenceDisplayControlPoints:function(a){var b=this.getReferenceCPs();for(a.off(null,null,this);0<b.getChildren().length;)b.getChildren()[0].destroy()},addNoteControlPoints:function(a){if(!1!=app.isEditable()){var b=this.getNoteCPs();this.buildNoteCPs(a,b);a.on("move",function(a){for(a=0;a<b.getChildren().length;a++)b.getChildren()[a].updatePosition()},this);a.on("resize",function(a){for(a=0;a<b.getChildren().length;a++)b.getChildren()[a].updatePosition()},this)}},removeNoteControlPoints:function(a){var b=
this.getNoteCPs();for(a.off(null,null,this);0<b.getChildren().length;)b.getChildren()[0].destroy()},addViewControlPoints:function(a){if(!1!=app.isEditable()){var b=this.getViewCPs();this.buildViewCPs(a,b);a.on("move",function(a){for(a=0;a<b.getChildren().length;a++)b.getChildren()[a].updatePosition()},this);a.on("resize",function(a){for(a=0;a<b.getChildren().length;a++)b.getChildren()[a].updatePosition()},this)}},removeViewDisplayControlPoints:function(a){var b=this.getViewCPs();for(a.off(null,null,
this);0<b.getChildren().length;)b.getChildren()[0].destroy()},addAreaControlPoints:function(a,b){if(!1!=app.isEditable()){var c=this.getAreaCPs();this.buildAreaCPs(a,c,b);a.on("move",function(a){for(a=0;a<c.getChildren().length;a++)c.getChildren()[a].updatePosition()},this);a.on("resize",function(a){for(a=0;a<c.getChildren().length;a++)c.getChildren()[a].updatePosition()},this)}},removeAreaControlPoints:function(a){var b=this.getAreaCPs();for(a.off(null,null,this);0<b.getChildren().length;)b.getChildren()[0].destroy()},
buildTableDisplayCPs:function(a,b){var c=Model.tables.get(a.get("modelId"));b.add(new Diagram.TableControlPoint({layer:this.getLayer(),tableModel:c,tableDisplay:a,index:Diagram.TableControlPointIndex.TOP_LEFT}));b.add(new Diagram.TableControlPoint({layer:this.getLayer(),tableModel:c,tableDisplay:a,index:Diagram.TableControlPointIndex.TOP_RIGHT}));b.add(new Diagram.TableControlPoint({layer:this.getLayer(),tableModel:c,tableDisplay:a,index:Diagram.TableControlPointIndex.BOTTOM_LEFT}));b.add(new Diagram.TableControlPoint({layer:this.getLayer(),
tableModel:c,tableDisplay:a,index:Diagram.TableControlPointIndex.BOTTOM_RIGHT}))},buildReferenceDisplayCPs:function(a,b){for(var c=0;c<a.get("controlPoints").size();c++)b.add(new Diagram.ReferenceDisplayControlPoint({layer:this.getLayer(),referenceDisplay:a,index:c}))},buildNoteCPs:function(a,b){b.add(new Diagram.NoteControlPoint({layer:this.getLayer(),noteModel:a,index:Diagram.NoteControlPointIndex.TOP_LEFT}));b.add(new Diagram.NoteControlPoint({layer:this.getLayer(),noteModel:a,index:Diagram.NoteControlPointIndex.TOP_RIGHT}));
b.add(new Diagram.NoteControlPoint({layer:this.getLayer(),noteModel:a,index:Diagram.NoteControlPointIndex.BOTTOM_LEFT}));b.add(new Diagram.NoteControlPoint({layer:this.getLayer(),noteModel:a,index:Diagram.NoteControlPointIndex.BOTTOM_RIGHT}))},buildViewCPs:function(a,b){b.add(new Diagram.ViewControlPoint({layer:this.getLayer(),viewDisplay:a,index:Diagram.ViewControlPointIndex.TOP_LEFT}));b.add(new Diagram.ViewControlPoint({layer:this.getLayer(),viewDisplay:a,index:Diagram.ViewControlPointIndex.TOP_RIGHT}));
b.add(new Diagram.ViewControlPoint({layer:this.getLayer(),viewDisplay:a,index:Diagram.ViewControlPointIndex.BOTTOM_LEFT}));b.add(new Diagram.ViewControlPoint({layer:this.getLayer(),viewDisplay:a,index:Diagram.ViewControlPointIndex.BOTTOM_RIGHT}))},buildAreaCPs:function(a,b,c){b.add(new Diagram.AreaControlPoint({layer:this.getLayer(),areaModel:a,index:Diagram.AreaControlPointIndex.TOP_LEFT,areaRect:c}));b.add(new Diagram.AreaControlPoint({layer:this.getLayer(),areaModel:a,index:Diagram.AreaControlPointIndex.TOP_RIGHT,
areaRect:c}));b.add(new Diagram.AreaControlPoint({layer:this.getLayer(),areaModel:a,index:Diagram.AreaControlPointIndex.BOTTOM_LEFT,areaRect:c}));b.add(new Diagram.AreaControlPoint({layer:this.getLayer(),areaModel:a,index:Diagram.AreaControlPointIndex.BOTTOM_RIGHT,areaRect:c}))},getSelectedTables:function(){for(var a=[],b=0;b<this.getSelectionGroup().getChildren().length;b++){var c=this.getSelectionGroup().getChildren()[b];c instanceof Diagram.Table&&a.push(c)}return a},getSelectedReferences:function(){for(var a=
[],b=0;b<this.getSelectionGroup().getChildren().length;b++){var c=this.getSelectionGroup().getChildren()[b];c instanceof Diagram.Reference&&a.push(c)}return a},getSelectedNotes:function(){for(var a=[],b=0;b<this.getSelectionGroup().getChildren().length;b++){var c=this.getSelectionGroup().getChildren()[b];c instanceof Diagram.Note&&a.push(c)}return a},getSelectedViews:function(){for(var a=[],b=0;b<this.getSelectionGroup().getChildren().length;b++){var c=this.getSelectionGroup().getChildren()[b];c instanceof
Diagram.View&&a.push(c)}return a},getSelectedAreas:function(){for(var a=[],b=0;b<this.getSelectionGroup().getChildren().length;b++){var c=this.getSelectionGroup().getChildren()[b];c instanceof Diagram.AreaFocusArea&&a.push(c.getAreaRect())}return a},getSelectedAreasRects:function(){for(var a=[],b=0;b<this.getSelectionGroup().getChildren().length;b++){var c=this.getSelectionGroup().getChildren()[b];c instanceof Diagram.AreaFocusArea&&a.push(c)}return a},detachAreaFromSelection:function(a){this.getSelectedAreas();
for(var b=0;b<this.getSelectionGroup().getChildren().length;b++){var c=this.getSelectionGroup().getChildren()[b];c instanceof Diagram.AreaFocusArea&&c.areaModel.get("id")==a.getAreaModel().get("id")&&(a.getAreaModel().off(null,null,c),c.destroy())}},selectionGroupDragMoveEventHandler:function(a){if(void 0===this.selectionMoveInProgress||!1===this.selectionMoveInProgress)this.selectionMoveInProgress=!0,(this.selectionMoveWithCtrl=a.ctrlKey)&&this.setAttachedObjectsToSelectedAreas();var b=[],c=[],d=
[];!0===this.selectionMoveWithCtrl&&(a=this.getAllAttachedObjectsInSelectedAreas(),b=a.tableDisplays,c=a.viewDisplays,d=a.notes);a=this.getLayer();for(var e=a.getDiagram().getPosition(),f=a.getDiagram().getScale(),g=a.getSelectedTables(),h=0;h<g.length;h++){var k=g[h],m=k.getTableDisplay(),k=k.getAbsolutePosition();0<=b.indexOf(m)||m.moveTo((-e.x+k.x)*(1/f.x),(-e.y+k.y)*(1/f.y),!1)}b=a.getSelectedNotes();for(h=0;h<b.length;h++)g=b[h],m=g.getNoteModel(),k=g.getAbsolutePosition(),0<=d.indexOf(g)||m.moveTo((-e.x+
k.x)*(1/f.x),(-e.y+k.y)*(1/f.y),!1);d=a.getSelectedViews();for(h=0;h<d.length;h++)g=d[h],b=g.getViewDisplay(),g=g.getAbsolutePosition(),0<=c.indexOf(b)||b.moveTo((-e.x+g.x)*(1/f.x),(-e.y+g.y)*(1/f.y),!1);c=a.getSelectedAreasRects();for(h=0;h<c.length;h++)if(b=c[h],d=b.getAreaModel(),b=b.getAbsolutePosition(),m=(-e.x+b.x)*(1/f.x),k=(-e.y+b.y)*(1/f.y),b=m-d.get("x"),g=k-d.get("y"),d.moveTo(m,k,!1),!0===this.selectionMoveWithCtrl&&d.has("attachedObjects")){for(var m=d.get("attachedTables"),k=d.get("attachedViews"),
d=d.get("attachedNotes"),n=0;n<m.length;n++)this.moveObjectInArea(m[n],b,g,e,f);for(n=0;n<k.length;n++)this.moveObjectInArea(k[n],b,g,e,f);for(n=0;n<d.length;n++)this.moveObjectInArea(d[n],b,g,e,f)}a.getDiagram().redrawDiagram()},setAttachedObjectsToSelectedAreas:function(){for(var a=this.getLayer().getSelectedAreasRects(),b=0;b<a.length;b++){var c=a[b].getAreaModel();if(!c.has("attachedObjects")){Model.referenceDisplays.filter(function(a){return a.inArea(c.getArea())});var d=Model.tableDisplays.filter(function(a){return a.inArea(c.getArea())}),
e=Model.viewDisplays.filter(function(a){return a.inArea(c.getArea())}),f=Model.notes.filter(function(a){return a.inArea(c.getArea())});c.set("attachedTables",d);c.set("attachedViews",e);c.set("attachedNotes",f);c.set("attachedObjects",!0)}}},unsetAttachedObjectsToSelectedAreas:function(){for(var a=this.getLayer().getSelectedAreasRects(),b=0;b<a.length;b++){var c=a[b].getAreaModel();c.has("attachedObjects")&&(c.unset("attachedTables"),c.unset("attachedViews"),c.unset("attachedNotes"),c.unset("attachedObjects"))}},
getAllAttachedObjectsInSelectedAreas:function(){var a=[],b=[],c=[],d=this.getLayer().getSelectedAreasRects();if(!0===this.selectionMoveWithCtrl)for(var e=0;e<d.length;e++){var f=d[e].getAreaModel();f.has("attachedObjects")&&($.merge(a,f.get("attachedTables")),$.merge(b,f.get("attachedViews")),$.merge(c,f.get("attachedNotes")))}return{tableDisplays:a,viewDisplays:b,notes:c}},moveObjectInArea:function(a,b,c){b=a.get("x")+b;c=a.get("y")+c;a.moveTo(b,c,!1)},moveObjectInAreaCommand:function(a,b,c){b=a.get("x")+
b;c=a.get("y")+c;a instanceof Model.TableDisplay?Commands.moveTableDisplay(a.get("id"),b,c,!0):a instanceof Model.ViewDisplay?Commands.moveViewDisplay(a.get("id"),b,c,!0):a instanceof Model.Note&&Commands.moveNote(a.get("id"),b,c,!0)},selectionGroupDragEndEventHandler:function(a){var b=[],c=[],d=[];!0===this.selectionMoveWithCtrl&&(a=this.getAllAttachedObjectsInSelectedAreas(),b=a.tableDisplays,c=a.viewDisplays,d=a.notes);a=this.getLayer();var e=a.getDiagram().getPosition(),f=a.getDiagram().getScale();
Commands.beginGroupCommands();for(var g=a.getSelectedTables(),h=0;h<g.length;h++){var k=g[h],m=k.getTableDisplay(),k=k.getAbsolutePosition();0<=b.indexOf(m)||Commands.moveTableDisplay(m.get("id"),(-e.x+k.x)*(1/f.x),(-e.y+k.y)*(1/f.y),!0)}b=a.getSelectedNotes();for(h=0;h<b.length;h++)g=b[h],m=g.getNoteModel(),k=g.getAbsolutePosition(),0<=d.indexOf(g)||Commands.moveNote(m.get("id"),(-e.x+k.x)*(1/f.x),(-e.y+k.y)*(1/f.y),!0);d=a.getSelectedViews();for(h=0;h<d.length;h++)g=d[h],b=g.getViewDisplay(),g=
g.getAbsolutePosition(),0<=c.indexOf(b)||Commands.moveViewDisplay(b.get("id"),(-e.x+g.x)*(1/f.x),(-e.y+g.y)*(1/f.y),!0);c=a.getSelectedAreasRects();for(h=0;h<c.length;h++)if(b=c[h],d=b.getAreaModel(),b=b.getAbsolutePosition(),m=(-e.x+b.x)*(1/f.x),k=(-e.y+b.y)*(1/f.y),b=m-d.get("x"),g=k-d.get("y"),Commands.moveArea(d.get("id"),m,k,!0),!0===this.selectionMoveWithCtrl&&d.has("attachedObjects")){for(var m=d.get("attachedTables"),k=d.get("attachedViews"),d=d.get("attachedNotes"),n=0;n<m.length;n++)this.moveObjectInAreaCommand(m[n],
b,g,e,f);for(n=0;n<k.length;n++)this.moveObjectInAreaCommand(k[n],b,g,e,f);for(n=0;n<d.length;n++)this.moveObjectInAreaCommand(d[n],b,g,e,f)}Commands.endGroupCommands();this.selectionMoveInProgress=!1;this.unsetAttachedObjectsToSelectedAreas();a.getDiagram().redrawDiagram()},selectionGroupMove:function(a){if(!1!=app.isEditable()){var b=this;Model.groupOperation.doWithLock(function(){b._doSelectionGroupMove(a)})}},_doSelectionGroupMove:function(a){var b=this.getLayer(),c=b.getDiagram().getPosition(),
d=b.getDiagram().getScale(),e=10*a.x;a=10*a.y;Commands.beginGroupCommands();for(var f=b.getSelectedTables(),g=0;g<f.length;g++){var h=f[g],k=h.getTableDisplay(),h=h.getAbsolutePosition();Commands.moveTableDisplay(k.get("id"),(-c.x+h.x+e)*(1/d.x),(-c.y+h.y+a)*(1/d.y),!0)}f=b.getSelectedNotes();for(g=0;g<f.length;g++)h=f[g],k=h.getNoteModel(),h=h.getAbsolutePosition(),Commands.moveNote(k.get("id"),(-c.x+h.x+e)*(1/d.x),(-c.y+h.y+a)*(1/d.y),!0);f=b.getSelectedViews();for(g=0;g<f.length;g++)h=f[g],k=h.getViewDisplay(),
h=h.getAbsolutePosition(),Commands.moveViewDisplay(k.get("id"),(-c.x+h.x+e)*(1/d.x),(-c.y+h.y+a)*(1/d.y),!0);f=b.getSelectedAreasRects();for(g=0;g<f.length;g++){var k=f[g],h=k.getAreaModel(),m=k.getAbsolutePosition();Commands.moveArea(h.get("id"),(-c.x+m.x+e)*(1/d.x),(-c.y+m.y+a)*(1/d.y),!1);k.setAbsolutePosition({x:c.x+h.get("x")*d.x,y:c.y+h.get("y")*d.y})}Commands.endGroupCommands();b.getDiagram().redrawDiagram()}};Kinetic.Util.extend(Diagram.SelectionLayer,Kinetic.Layer);
Kinetic.Factory.addGetterSetter(Diagram.SelectionLayer,"diagram");Kinetic.Factory.addGetterSetter(Diagram.SelectionLayer,"selectionGroup");Kinetic.Factory.addGetterSetter(Diagram.SelectionLayer,"tableCPs");Kinetic.Factory.addGetterSetter(Diagram.SelectionLayer,"referenceCPs");Kinetic.Factory.addGetterSetter(Diagram.SelectionLayer,"noteCPs");Kinetic.Factory.addGetterSetter(Diagram.SelectionLayer,"viewCPs");Kinetic.Factory.addGetterSetter(Diagram.SelectionLayer,"areaCPs");
Diagram.ReferenceDisplayControlPoint=function(a){this._initReferenceDisplayControlPoint(a)};
Diagram.ReferenceDisplayControlPoint.prototype={_initReferenceDisplayControlPoint:function(a){this.CENTER_OFFSET=4;this.MARGIN=10;Kinetic.Rect.call(this,{x:0,y:0,width:8,height:8,fill:"white",stroke:a.layer.getDiagram().getSelectColor(),strokeWidth:1,visible:!0,draggable:!0});this.setLayer(a.layer);this.setReferenceDisplay(a.referenceDisplay);this.setIndex(a.index);this.updatePosition();this.setDragBoundFunc(this.referenceCPDragBoundFunc);this.on("mouseover",this.mouseOverEventHandler);this.on("mouseout",
this.mouseOutEventHandler);this.on("mousedown",this.mouseDownEventHandler);this.on("dragmove",this.dragMoveEventHandler);this.on("dragend",this.dragEndEventHandler)},getCenterX:function(){return this.getX()+this.CENTER_OFFSET},getCenterY:function(){return this.getY()+this.CENTER_OFFSET},setCenterX:function(a){this.setX(a-this.CENTER_OFFSET)},setCenterY:function(a){this.setY(a-this.CENTER_OFFSET)},updatePosition:function(){var a=this.getReferenceDisplay(),b=this.getIndex(),a=a.get("controlPoints").at(b);
this.setCenterX(a.get("x"));this.setCenterY(a.get("y"))},referenceCPDragBoundFunc:function(a){var b=this.getLayer().getDiagram(),c=this.getReferenceDisplay(),d=this.getIndex(),e=c.get("controlPointsType"),f=Model.tableDisplays.get(c.get("pkTableDisplayId")),g=Model.tableDisplays.get(c.get("fkTableDisplayId")),c=c.get("controlPoints"),h=c.at(d),k=a.x;a=a.y;var m,n,r,l;e===Model.RCPType.HORIZONTAL_2CP?(0===d?(m=f.get("x")+10,n=f.get("x")+f.get("width")-10):(m=g.get("x")+10,n=g.get("x")+g.get("width")-
10),r=Math.max(f.get("y")+10,g.get("y")+10),l=Math.min(f.get("y")+f.get("height")-10,g.get("y")+g.get("height")-10)):e===Model.RCPType.VERTICAL_2CP?0===d?(m=Math.max(f.get("x")+10,g.get("x")+10),n=Math.min(f.get("x")+f.get("width")-10,g.get("x")+g.get("width")-10),r=f.get("y")+10,l=f.get("y")+f.get("height")-10):(m=Math.max(f.get("x")+10,g.get("x")+10),n=Math.min(f.get("x")+f.get("width")-10,g.get("x")+g.get("width")-10),r=g.get("y")+10,l=g.get("y")+g.get("height")-10):e===Model.RCPType.CROSS_3CP?
0===d?(m=f.get("x")+10,n=f.get("x")+f.get("width")-10,r=f.get("y")+10,l=f.get("y")+f.get("height")-10):1===d?(m=Math.min(f.get("x")+10,g.get("x")+10),n=Math.max(f.get("x")+f.get("width")-10,g.get("x")+g.get("width")-10),r=Math.min(f.get("y")+10,g.get("y")+10),l=Math.max(f.get("y")+f.get("height")-10,g.get("y")+g.get("height")-10)):2===d&&(m=g.get("x")+10,n=g.get("x")+g.get("width")-10,r=g.get("y")+10,l=g.get("y")+g.get("height")-10):e===Model.RCPType.HORIZONTAL_4CP?0===d?(m=f.get("x")+10,n=f.get("x")+
f.get("width")-10,r=f.get("y")+10,l=f.get("y")+f.get("height")-10):1===d?(r=f.get("y")+10,l=f.get("y")+f.get("height")-10):2===d?(r=g.get("y")+10,l=g.get("y")+g.get("height")-10):3===d&&(m=g.get("x")+10,n=g.get("x")+g.get("width")-10,r=g.get("y")+10,l=g.get("y")+g.get("height")-10):e===Model.RCPType.VERTICAL_4CP?0===d?(m=f.get("x")+10,n=f.get("x")+f.get("width")-10,r=f.get("y")+10,l=f.get("y")+f.get("height")-10):1===d?(m=f.get("x")+10,n=f.get("x")+f.get("width")-10):2===d?(m=g.get("x")+10,n=g.get("x")+
g.get("width")-10):3===d&&(m=g.get("x")+10,n=g.get("x")+g.get("width")-10,r=g.get("y")+10,l=g.get("y")+g.get("height")-10):e!==Model.RCPType.SELF_4CP&&e===Model.RCPType.SELF_5CP&&(0===d?(m=f.get("x")+10,n=f.get("x")+f.get("width")-10,r=f.get("y")+10,l=f.get("y")+f.get("height")-10):1===d?c.at(0).get("x")===h.get("x")?(m=f.get("x")+10,n=f.get("x")+f.get("width")-10):(r=f.get("y")+10,l=f.get("y")+f.get("height")-10):3===d?c.at(4).get("x")===h.get("x")?(m=g.get("x")+10,n=g.get("x")+g.get("width")-10):
(r=g.get("y")+10,l=g.get("y")+g.get("height")-10):4===d&&(m=g.get("x")+10,n=g.get("x")+g.get("width")-10,r=g.get("y")+10,l=g.get("y")+g.get("height")-10));void 0!==m&&(m=b.getAbsoluteX(m-this.CENTER_OFFSET),k<m&&(k=m));void 0!==n&&(n=b.getAbsoluteX(n-this.CENTER_OFFSET),k>n&&(k=n));void 0!==r&&(r=b.getAbsoluteY(r-this.CENTER_OFFSET),a<r&&(a=r));void 0!==l&&(l=b.getAbsoluteY(l-this.CENTER_OFFSET),a>l&&(a=l));return{x:k,y:a}},mouseOverEventHandler:function(){var a=this.getLayer().getDiagram();document.body.style.cursor=
"pointer";this.setFill(a.getSelectColor());this.setStroke(a.getSelectColor());this.getLayer().draw()},mouseOutEventHandler:function(){var a=this.getLayer().getDiagram();document.body.style.cursor="default";this.setFill("white");this.setStroke(a.getSelectColor());this.getLayer().draw()},mouseDownEventHandler:function(a){a.cancelBubble=!0},dragMoveEventHandler:function(){this.getReferenceDisplay().moveControlPointTo(this.getIndex(),this.getCenterX(),this.getCenterY(),!1);this.getLayer().getDiagram().redrawDiagram()},
dragEndEventHandler:function(){Commands.moveReferenceDisplayControlPointTo(this.getReferenceDisplay(),this.getIndex(),this.getCenterX(),this.getCenterY(),!0)}};Kinetic.Util.extend(Diagram.ReferenceDisplayControlPoint,Kinetic.Rect);Kinetic.Factory.addGetterSetter(Diagram.ReferenceDisplayControlPoint,"referenceModel");Kinetic.Factory.addGetterSetter(Diagram.ReferenceDisplayControlPoint,"referenceDisplay");Kinetic.Factory.addGetterSetter(Diagram.ReferenceDisplayControlPoint,"index");
Kinetic.Factory.addGetterSetter(Diagram.ReferenceDisplayControlPoint,"layer");Diagram.TableControlPointIndex={};Diagram.TableControlPointIndex.TOP_LEFT=1;Diagram.TableControlPointIndex.TOP_RIGHT=2;Diagram.TableControlPointIndex.BOTTOM_LEFT=3;Diagram.TableControlPointIndex.BOTTOM_RIGHT=4;Diagram.TableControlPoint=function(a){this._initTableControlPoint(a)};
Diagram.TableControlPoint.prototype={_initTableControlPoint:function(a){this.CENTER_OFFSET=4;Kinetic.Rect.call(this,{x:0,y:0,width:8,height:8,fill:"white",stroke:a.layer.getDiagram().getSelectColor(),strokeWidth:1,draggable:!0});this.setLayer(a.layer);this.setTableModel(a.tableModel);this.setTableDisplay(a.tableDisplay);this.setIndex(a.index);this.updatePosition();this.setDragBoundFunc(this.tableCPDragBoundFunc);this.on("mouseover",this.mouseOverEventHandler);this.on("mouseout",this.mouseOutEventHandler);
this.on("mousedown",this.mouseDownEventHandler);this.on("dragmove",this.dragMoveEventHandler);this.on("dragend",this.dragEndEventHandler)},getCenterX:function(){return this.getX()+this.CENTER_OFFSET},getCenterY:function(){return this.getY()+this.CENTER_OFFSET},setCenterX:function(a){this.setX(a-this.CENTER_OFFSET)},setCenterY:function(a){this.setY(a-this.CENTER_OFFSET)},updatePosition:function(){var a=this.getTableDisplay(),b=this.getIndex(),c=this.getX(),d=this.getY();b===Diagram.TableControlPointIndex.TOP_LEFT?
(c=a.get("x"),d=a.get("y")):b===Diagram.TableControlPointIndex.TOP_RIGHT?(c=a.get("x")+a.get("width"),d=a.get("y")):b===Diagram.TableControlPointIndex.BOTTOM_LEFT?(c=a.get("x"),d=a.get("y")+a.get("height")):b===Diagram.TableControlPointIndex.BOTTOM_RIGHT&&(c=a.get("x")+a.get("width"),d=a.get("y")+a.get("height"));this.setCenterX(c);this.setCenterY(d)},tableCPDragBoundFunc:function(a){var b=this.getLayer().getDiagram(),c=this.getTableDisplay(),d=this.getIndex(),e=a.x;a=a.y;d===Diagram.TableControlPointIndex.TOP_LEFT?
(d=b.getAbsoluteX(c.get("x")+c.get("width")-c.getMinWidth()-this.CENTER_OFFSET),b=b.getAbsoluteY(c.get("y")+c.get("height")-c.getMinHeight()-this.CENTER_OFFSET),e>d&&(e=d),a>b&&(a=b)):d===Diagram.TableControlPointIndex.TOP_RIGHT?(d=b.getAbsoluteX(c.get("x")+c.getMinWidth()-this.CENTER_OFFSET),b=b.getAbsoluteY(c.get("y")+c.get("height")-c.getMinHeight()-this.CENTER_OFFSET),e<d&&(e=d),a>b&&(a=b)):d===Diagram.TableControlPointIndex.BOTTOM_LEFT?(d=b.getAbsoluteX(c.get("x")+c.get("width")-c.getMinWidth()-
this.CENTER_OFFSET),b=b.getAbsoluteY(c.get("y")+c.getMinHeight()-this.CENTER_OFFSET),e>d&&(e=d),a<b&&(a=b)):d===Diagram.TableControlPointIndex.BOTTOM_RIGHT&&(d=b.getAbsoluteX(c.get("x")+c.getMinWidth()-this.CENTER_OFFSET),b=b.getAbsoluteY(c.get("y")+c.getMinHeight()-this.CENTER_OFFSET),e<d&&(e=d),a<b&&(a=b));return{x:e,y:a}},mouseOverEventHandler:function(){var a=this.getLayer().getDiagram();document.body.style.cursor="pointer";this.setFill(a.getSelectColor());this.setStroke(a.getSelectColor());this.getLayer().draw()},
mouseOutEventHandler:function(){var a=this.getLayer().getDiagram();document.body.style.cursor="default";this.setFill("white");this.setStroke(a.getSelectColor());this.getLayer().draw()},mouseDownEventHandler:function(a){a.cancelBubble=!0},dragMoveEventHandler:function(){this.getTableDisplay().moveControlPointTo(this.getIndex(),this.getCenterX(),this.getCenterY(),!1);this.getLayer().getDiagram().redrawDiagram()},dragEndEventHandler:function(){Commands.moveTableDisplayControlPointTo(this.getTableDisplay(),
this.getIndex(),this.getCenterX(),this.getCenterY(),!0)}};Kinetic.Util.extend(Diagram.TableControlPoint,Kinetic.Rect);Kinetic.Factory.addGetterSetter(Diagram.TableControlPoint,"tableModel");Kinetic.Factory.addGetterSetter(Diagram.TableControlPoint,"tableDisplay");Kinetic.Factory.addGetterSetter(Diagram.TableControlPoint,"index");Kinetic.Factory.addGetterSetter(Diagram.TableControlPoint,"layer");Diagram.NoteControlPointIndex={};Diagram.NoteControlPointIndex.TOP_LEFT=1;
Diagram.NoteControlPointIndex.TOP_RIGHT=2;Diagram.NoteControlPointIndex.BOTTOM_LEFT=3;Diagram.NoteControlPointIndex.BOTTOM_RIGHT=4;Diagram.NoteControlPoint=function(a){this._initNoteControlPoint(a)};
Diagram.NoteControlPoint.prototype={_initNoteControlPoint:function(a){this.CENTER_OFFSET=4;Kinetic.Rect.call(this,{x:0,y:0,width:8,height:8,fill:"white",stroke:a.layer.getDiagram().getSelectColor(),strokeWidth:1,draggable:!0});this.setLayer(a.layer);this.setNoteModel(a.noteModel);this.setIndex(a.index);this.updatePosition();this.setDragBoundFunc(this.noteCPDragBoundFunc);this.on("mouseover",this.mouseOverEventHandler);this.on("mouseout",this.mouseOutEventHandler);this.on("mousedown",this.mouseDownEventHandler);
this.on("dragmove",this.dragMoveEventHandler);this.on("dragend",this.dragEndEventHandler)},getCenterX:function(){return this.getX()+this.CENTER_OFFSET},getCenterY:function(){return this.getY()+this.CENTER_OFFSET},setCenterX:function(a){this.setX(a-this.CENTER_OFFSET)},setCenterY:function(a){this.setY(a-this.CENTER_OFFSET)},updatePosition:function(){var a=this.getNoteModel(),b=this.getIndex(),c=this.getX(),d=this.getY();b===Diagram.NoteControlPointIndex.TOP_LEFT?(c=a.get("x"),d=a.get("y")):b===Diagram.NoteControlPointIndex.TOP_RIGHT?
(c=a.get("x")+a.get("width"),d=a.get("y")):b===Diagram.NoteControlPointIndex.BOTTOM_LEFT?(c=a.get("x"),d=a.get("y")+a.get("height")):b===Diagram.NoteControlPointIndex.BOTTOM_RIGHT&&(c=a.get("x")+a.get("width"),d=a.get("y")+a.get("height"));this.setCenterX(c);this.setCenterY(d)},noteCPDragBoundFunc:function(a){var b=this.getLayer().getDiagram(),c=this.getNoteModel(),d=this.getIndex(),e=a.x;a=a.y;d===Diagram.NoteControlPointIndex.TOP_LEFT?(d=b.getAbsoluteX(c.get("x")+c.get("width")-c.getMinWidth()-
this.CENTER_OFFSET),b=b.getAbsoluteY(c.get("y")+c.get("height")-c.getMinHeight()-this.CENTER_OFFSET),e>d&&(e=d),a>b&&(a=b)):d===Diagram.NoteControlPointIndex.TOP_RIGHT?(d=b.getAbsoluteX(c.get("x")+c.getMinWidth()-this.CENTER_OFFSET),b=b.getAbsoluteY(c.get("y")+c.get("height")-c.getMinHeight()-this.CENTER_OFFSET),e<d&&(e=d),a>b&&(a=b)):d===Diagram.NoteControlPointIndex.BOTTOM_LEFT?(d=b.getAbsoluteX(c.get("x")+c.get("width")-c.getMinWidth()-this.CENTER_OFFSET),b=b.getAbsoluteY(c.get("y")+c.getMinHeight()-
this.CENTER_OFFSET),e>d&&(e=d),a<b&&(a=b)):d===Diagram.NoteControlPointIndex.BOTTOM_RIGHT&&(d=b.getAbsoluteX(c.get("x")+c.getMinWidth()-this.CENTER_OFFSET),b=b.getAbsoluteY(c.get("y")+c.getMinHeight()-this.CENTER_OFFSET),e<d&&(e=d),a<b&&(a=b));return{x:e,y:a}},mouseOverEventHandler:function(){var a=this.getLayer().getDiagram();document.body.style.cursor="pointer";this.setFill(a.getSelectColor());this.setStroke(a.getSelectColor());this.getLayer().draw()},mouseOutEventHandler:function(){var a=this.getLayer().getDiagram();
document.body.style.cursor="default";this.setFill("white");this.setStroke(a.getSelectColor());this.getLayer().draw()},mouseDownEventHandler:function(a){a.cancelBubble=!0},dragMoveEventHandler:function(){this.getNoteModel().moveControlPointTo(this.getIndex(),this.getCenterX(),this.getCenterY(),!1);this.getLayer().getDiagram().redrawDiagram()},dragEndEventHandler:function(){Commands.moveNoteControlPointTo(this.getNoteModel(),this.getIndex(),this.getCenterX(),this.getCenterY(),!0)}};
Kinetic.Util.extend(Diagram.NoteControlPoint,Kinetic.Rect);Kinetic.Factory.addGetterSetter(Diagram.NoteControlPoint,"noteModel");Kinetic.Factory.addGetterSetter(Diagram.NoteControlPoint,"index");Kinetic.Factory.addGetterSetter(Diagram.NoteControlPoint,"layer");Diagram.ViewControlPointIndex={};Diagram.ViewControlPointIndex.TOP_LEFT=1;Diagram.ViewControlPointIndex.TOP_RIGHT=2;Diagram.ViewControlPointIndex.BOTTOM_LEFT=3;Diagram.ViewControlPointIndex.BOTTOM_RIGHT=4;Diagram.ViewControlPoint=function(a){this._initViewControlPoint(a)};
Diagram.ViewControlPoint.prototype={_initViewControlPoint:function(a){this.CENTER_OFFSET=4;Kinetic.Rect.call(this,{x:0,y:0,width:8,height:8,fill:"white",stroke:a.layer.getDiagram().getSelectColor(),strokeWidth:1,draggable:!0});this.setLayer(a.layer);this.setViewDisplay(a.viewDisplay);this.setIndex(a.index);this.updatePosition();this.setDragBoundFunc(this.viewCPDragBoundFunc);this.on("mouseover",this.mouseOverEventHandler);this.on("mouseout",this.mouseOutEventHandler);this.on("mousedown",this.mouseDownEventHandler);
this.on("dragmove",this.dragMoveEventHandler);this.on("dragend",this.dragEndEventHandler)},getCenterX:function(){return this.getX()+this.CENTER_OFFSET},getCenterY:function(){return this.getY()+this.CENTER_OFFSET},setCenterX:function(a){this.setX(a-this.CENTER_OFFSET)},setCenterY:function(a){this.setY(a-this.CENTER_OFFSET)},updatePosition:function(){var a=this.getViewDisplay(),b=this.getIndex(),c=this.getX(),d=this.getY();b===Diagram.ViewControlPointIndex.TOP_LEFT?(c=a.get("x"),d=a.get("y")):b===Diagram.ViewControlPointIndex.TOP_RIGHT?
(c=a.get("x")+a.get("width"),d=a.get("y")):b===Diagram.ViewControlPointIndex.BOTTOM_LEFT?(c=a.get("x"),d=a.get("y")+a.get("height")):b===Diagram.ViewControlPointIndex.BOTTOM_RIGHT&&(c=a.get("x")+a.get("width"),d=a.get("y")+a.get("height"));this.setCenterX(c);this.setCenterY(d)},viewCPDragBoundFunc:function(a){var b=this.getLayer().getDiagram(),c=this.getViewDisplay(),d=this.getIndex(),e=a.x;a=a.y;d===Diagram.ViewControlPointIndex.TOP_LEFT?(d=b.getAbsoluteX(c.get("x")+c.get("width")-c.getMinWidth()-
this.CENTER_OFFSET),b=b.getAbsoluteY(c.get("y")+c.get("height")-c.getMinHeight()-this.CENTER_OFFSET),e>d&&(e=d),a>b&&(a=b)):d===Diagram.ViewControlPointIndex.TOP_RIGHT?(d=b.getAbsoluteX(c.get("x")+c.getMinWidth()-this.CENTER_OFFSET),b=b.getAbsoluteY(c.get("y")+c.get("height")-c.getMinHeight()-this.CENTER_OFFSET),e<d&&(e=d),a>b&&(a=b)):d===Diagram.ViewControlPointIndex.BOTTOM_LEFT?(d=b.getAbsoluteX(c.get("x")+c.get("width")-c.getMinWidth()-this.CENTER_OFFSET),b=b.getAbsoluteY(c.get("y")+c.getMinHeight()-
this.CENTER_OFFSET),e>d&&(e=d),a<b&&(a=b)):d===Diagram.ViewControlPointIndex.BOTTOM_RIGHT&&(d=b.getAbsoluteX(c.get("x")+c.getMinWidth()-this.CENTER_OFFSET),b=b.getAbsoluteY(c.get("y")+c.getMinHeight()-this.CENTER_OFFSET),e<d&&(e=d),a<b&&(a=b));return{x:e,y:a}},mouseOverEventHandler:function(){var a=this.getLayer().getDiagram();document.body.style.cursor="pointer";this.setFill(a.getSelectColor());this.setStroke(a.getSelectColor());this.getLayer().draw()},mouseOutEventHandler:function(){var a=this.getLayer().getDiagram();
document.body.style.cursor="default";this.setFill("white");this.setStroke(a.getSelectColor());this.getLayer().draw()},mouseDownEventHandler:function(a){a.cancelBubble=!0},dragMoveEventHandler:function(){this.getViewDisplay().moveControlPointTo(this.getIndex(),this.getCenterX(),this.getCenterY(),!1);this.getLayer().getDiagram().redrawDiagram()},dragEndEventHandler:function(){Commands.moveViewDisplayControlPointTo(this.getViewDisplay(),this.getIndex(),this.getCenterX(),this.getCenterY(),!0)}};
Kinetic.Util.extend(Diagram.ViewControlPoint,Kinetic.Rect);Kinetic.Factory.addGetterSetter(Diagram.ViewControlPoint,"viewDisplay");Kinetic.Factory.addGetterSetter(Diagram.ViewControlPoint,"index");Kinetic.Factory.addGetterSetter(Diagram.ViewControlPoint,"layer");Diagram.AreaControlPointIndex={};Diagram.AreaControlPointIndex.TOP_LEFT=1;Diagram.AreaControlPointIndex.TOP_RIGHT=2;Diagram.AreaControlPointIndex.BOTTOM_LEFT=3;Diagram.AreaControlPointIndex.BOTTOM_RIGHT=4;Diagram.AreaControlPoint=function(a){this._initAreaControlPoint(a)};
Diagram.AreaControlPoint.prototype={_initAreaControlPoint:function(a){this.CENTER_OFFSET=4;Kinetic.Rect.call(this,{x:0,y:0,width:8,height:8,fill:"white",stroke:a.layer.getDiagram().getSelectColor(),strokeWidth:1,draggable:!0});this.setLayer(a.layer);this.setAreaModel(a.areaModel);this.setIndex(a.index);this.setAreaRect(a.areaRect);this.updatePosition();this.setDragBoundFunc(this.areaCPDragBoundFunc);this.on("mouseover",this.mouseOverEventHandler);this.on("mouseout",this.mouseOutEventHandler);this.on("mousedown",
this.mouseDownEventHandler);this.on("dragmove",this.dragMoveEventHandler);this.on("dragend",this.dragEndEventHandler)},getCenterX:function(){return this.getX()+this.CENTER_OFFSET},getCenterY:function(){return this.getY()+this.CENTER_OFFSET},setCenterX:function(a){this.setX(a-this.CENTER_OFFSET)},setCenterY:function(a){this.setY(a-this.CENTER_OFFSET)},updatePosition:function(){var a=this.getAreaModel(),b=this.getIndex(),c=this.getX(),d=this.getY();b===Diagram.AreaControlPointIndex.TOP_LEFT?(c=a.get("x"),
d=a.get("y")):b===Diagram.AreaControlPointIndex.TOP_RIGHT?(c=a.get("x")+a.get("width"),d=a.get("y")):b===Diagram.AreaControlPointIndex.BOTTOM_LEFT?(c=a.get("x"),d=a.get("y")+a.get("height")):b===Diagram.AreaControlPointIndex.BOTTOM_RIGHT&&(c=a.get("x")+a.get("width"),d=a.get("y")+a.get("height"));this.setCenterX(c);this.setCenterY(d)},areaCPDragBoundFunc:function(a){var b=this.getLayer().getDiagram(),c=this.getAreaModel(),d=this.getIndex(),e=a.x;a=a.y;d===Diagram.AreaControlPointIndex.TOP_LEFT?(d=
b.getAbsoluteX(c.get("x")+c.get("width")-c.getMinWidth()-this.CENTER_OFFSET),b=b.getAbsoluteY(c.get("y")+c.get("height")-c.getMinHeight()-this.CENTER_OFFSET),e>d&&(e=d),a>b&&(a=b)):d===Diagram.AreaControlPointIndex.TOP_RIGHT?(d=b.getAbsoluteX(c.get("x")+c.getMinWidth()-this.CENTER_OFFSET),b=b.getAbsoluteY(c.get("y")+c.get("height")-c.getMinHeight()-this.CENTER_OFFSET),e<d&&(e=d),a>b&&(a=b)):d===Diagram.AreaControlPointIndex.BOTTOM_LEFT?(d=b.getAbsoluteX(c.get("x")+c.get("width")-c.getMinWidth()-this.CENTER_OFFSET),
b=b.getAbsoluteY(c.get("y")+c.getMinHeight()-this.CENTER_OFFSET),e>d&&(e=d),a<b&&(a=b)):d===Diagram.AreaControlPointIndex.BOTTOM_RIGHT&&(d=b.getAbsoluteX(c.get("x")+c.getMinWidth()-this.CENTER_OFFSET),b=b.getAbsoluteY(c.get("y")+c.getMinHeight()-this.CENTER_OFFSET),e<d&&(e=d),a<b&&(a=b));return{x:e,y:a}},mouseOverEventHandler:function(){var a=this.getLayer().getDiagram();document.body.style.cursor="pointer";this.setFill(a.getSelectColor());this.setStroke(a.getSelectColor());this.getLayer().draw()},
mouseOutEventHandler:function(){var a=this.getLayer().getDiagram();document.body.style.cursor="default";this.setFill("white");this.setStroke(a.getSelectColor());this.getLayer().draw()},mouseDownEventHandler:function(a){a.cancelBubble=!0},dragMoveEventHandler:function(){this.getAreaModel().moveControlPointTo(this.getIndex(),this.getCenterX(),this.getCenterY(),!1);this.getLayer().getDiagram().redrawDiagram()},dragEndEventHandler:function(){Commands.moveAreaControlPointTo(this.getAreaModel(),this.getIndex(),
this.getCenterX(),this.getCenterY(),!0)}};Kinetic.Util.extend(Diagram.AreaControlPoint,Kinetic.Rect);Kinetic.Factory.addGetterSetter(Diagram.AreaControlPoint,"areaModel");Kinetic.Factory.addGetterSetter(Diagram.AreaControlPoint,"index");Kinetic.Factory.addGetterSetter(Diagram.AreaControlPoint,"layer");Kinetic.Factory.addGetterSetter(Diagram.AreaControlPoint,"areaRect");Diagram.Element=function(a){this._initElement(a)};
Diagram.Element.prototype={_initElement:function(a){Kinetic.Group.call(this,a)},isBoundaryRectOnScene:function(a){var b=app.getDiagram(),c=b.getX(),d=b.getY(),e=app.getDiagram().getScale(),f=b.getWidth(),b=b.getHeight(),g=d+a.ymin*e.y,h=c+a.xmax*e.x,d=d+a.ymax*e.y;return c+a.xmin*e.x>f||g>b||0>h||0>d?!1:!0},shouldDraw:function(){return!0},drawScene:function(a){this.shouldDraw()&&Kinetic.Group.prototype.drawScene.call(this,a);return this},drawHit:function(a){this.shouldDraw()&&Kinetic.Group.prototype.drawHit.call(this,
a);return this}};Kinetic.Util.extend(Diagram.Element,Kinetic.Group);Diagram.Table=function(a){this._initTable(a)};
Diagram.Table.prototype={TITLE_HEIGHT:20,_initTable:function(a){var b=a.tableLayer,c=a.tableModel,d=a.tableDisplay;Diagram.Element.call(this,{x:d.get("x"),y:d.get("y"),draggable:!1});this.setAttrs(a);this.buildTable(b,c,d);this.bindModelEvents(c,d);this.on("mousedown",this.mouseDownEventHandler);this.on("mouseup",this.mouseUpEventHandler);this.on("click",this.clickEventHandler)},updateEditableReadonly:function(){},shouldDraw:function(){return this.isBoundaryRectOnScene(this.getTableDisplay().getBoundaryRect())},
bindModelEvents:function(a,b){var c=this;b.on("move",function(a,b,f){b=c.getTableLayer().getDiagram().getPosition();f=c.getTableLayer().getDiagram().getScale();c.setAbsolutePosition({x:b.x+a.get("x")*f.x,y:b.y+a.get("y")*f.y});c.updateTitleText(c.tableModel,a)},c);b.on("resize",function(a,b,f,g,h){c.resize(b,f,g,h);c.updateTitleText(c.tableModel,a)},c);b.on("change:width",function(a,b){c.box.setWidth(b);c.title.setWidth(b);c.titleBox.setWidth(b);this.rebuildColumnsBox();c.updateTitleText(c.tableModel,
a)},c);b.on("change:height",function(a,b){this.box.setHeight(b);this.rebuildColumnsBox();c.updateTitleText(c.tableModel,a)},c);b.on("selected",function(){c.box.setStrokeWidth(1.6);c.titleBox.setStrokeWidth(1.6);c.getTableLayer().getDiagram().selectTableDisplay(c)},c);b.on("deselected",function(){c.box.setStrokeWidth(1);c.titleBox.setStrokeWidth(1);c.getTableLayer().getDiagram().deselectTableDisplay(c)},c);b.on("attached",function(){c.updateLineColor();c.getTableLayer().getDiagram().attachTableToSelection(c)},
c);b.on("detached",function(){c.updateLineColor();c.getTableLayer().getDiagram().detachTableFromSelection(c)},c);b.on("setInSearchResults",function(){c.updateLineColor()},c);b.on("unsetInSearchResults",function(){c.updateLineColor()},c);a.on("change:name",function(a,e){c.updateTitleText(a,b)},c);b.on("change:lineColor",function(a,b){c.updateLineColor()},c);b.on("change:fillColor",function(a,b){c.box.setFill(b)},c);a.on("reference_disconnected",function(a){c.rebuildColumnsBox()},c);a.on("reference_connected",
function(a){c.rebuildColumnsBox()},c);a.get("columns").on("all",function(){c.rebuildColumnsBox()},c);Model.tableDisplays.on("add",function(d){b.get("modelId")==d.get("modelId")&&(c.updateTitleText(a,b),c.updateBoxDashArray(b))},c);Model.tableDisplays.on("remove",function(d){b.get("modelId")==d.get("modelId")&&(c.updateTitleText(a,b),c.updateBoxDashArray(b))},c);Model.tableDisplays.on("change",function(d){b.get("modelId")==d.get("modelId")&&c.updateTitleText(a,b)},c);Model.areas.on("add",function(d){c.updateTitleText(a,
b)},c);Model.areas.on("remove",function(d){c.updateTitleText(a,b)},c);Model.areas.on("move",function(d){c.updateTitleText(a,b)});Model.areas.on("resize",function(d){c.updateTitleText(a,b)});Model.areas.on("reset",function(d){c.updateTitleText(a,b)},c);Model.areas.on("change",function(d){c.updateTitleText(a,b)},c)},unbindModelEvents:function(){var a=this.getTableModel(),b=this.getTableDisplay(),c=a.get("columns");a.off(null,null,this);b.off(null,null,this);c.off(null,null,this);Model.areas.off(null,
null,this);Model.tableDisplays.off(null,null,this)},updateLineColor:function(){var a=this.getTableLayer().getDiagram();this.getTableModel();var b=this.getTableDisplay(),c=b.get("lineColor");b.get("inSearchResults")&&(c=a.getSearchColor());b.isAttached()&&(c=a.getSelectColor());this.box.setStroke(c);this.titleBox.setStroke(c)},mouseDownEventHandler:function(a){var b=this.getLayer().getDiagram();this.getTableModel();var c=this.getTableDisplay();Model.diagramMode.is(Model.diagramMode.SELECT_MODE)?(!1==
a.shiftKey?c.isAttached()?Display.selection.selectAndAttachElement(c):Display.selection.selectElement(c):c.isAttached()?Display.selection.deselectAndDetachElement(c):Display.selection.selectAndAttachElement(c),Display.selection.triggerSelectionChanged(),b.draw()):Model.diagramMode.is(Model.diagramMode.ADD_RELATIONSHIP_MODE)&&(this.getTableLayer().getDiagram().startNewReference(this.getTableDisplay()),a.cancelBubble=!0)},mouseUpEventHandler:function(a){this.getTableLayer().getDiagram();Model.diagramMode.is(Model.diagramMode.SELECT_MODE)||
Model.diagramMode.is(Model.diagramMode.ADD_RELATIONSHIP_MODE)&&this.getTableLayer().getDiagram().createNewReference(this.getTableDisplay())},clickEventHandler:function(a){},resize:function(a,b,c,d){this.box.setWidth(a);this.box.setHeight(b);this.title.setWidth(a);this.titleBox.setWidth(a);this.rebuildColumnsBox()},buildTable:function(a,b,c){a=c.get("fillColor");var d=c.get("lineColor");this.box=new Kinetic.Rect({x:0,y:0,width:c.get("width"),height:c.get("height"),fill:a,stroke:d,strokeWidth:1,lineJoin:"bevel",
dashArray:this.getBoxDashArray(c)});this.titleBox=new Kinetic.Rect({x:0,y:0,width:c.get("width"),height:this.TITLE_HEIGHT,fill:"#f0f0f0",stroke:d,strokeWidth:1,dashArray:this.getBoxDashArray(c),lineJoin:"bevel"});this.title=new Kinetic.Text({x:0,y:2,width:c.get("width"),height:this.TITLE_HEIGHT,padding:1,align:"center",text:this.getTitleText(b,c),fontSize:12,fontFamily:"Arial",fontStyle:"bold",fill:"black"});this.columnsBox=new Kinetic.Group({x:0,y:this.TITLE_HEIGHT,width:c.get("width")});this.add(this.box);
this.add(this.titleBox);this.add(this.title);this.add(this.columnsBox);this.rebuildColumnsBox()},getBoxDashArray:function(a){var b=this.getTableDisplay().get("id");a=Model.tableDisplays.where({modelId:a.get("modelId")});return 0==_.filter(a,function(a){return a.get("id")!=b}).length?null:[2,2]},updateBoxDashArray:function(a){a=this.getBoxDashArray(a);this.box.setDashArray(a);this.titleBox.setDashArray(a)},getTitleText:function(a,b){return b.getTitleText()},updateTitleText:function(a,b){var c=this.getTitleText(a,
b);this.title.setText(c)},rebuildColumnsBox:function(){var a=this.getTableModel().get("columns");this.getTableDisplay().get("width");for(var b=Model.references.findFKReferences(this.getTableModel().get("id")),c=[],d=0;d<b.length;d++)for(var e=b[d].get("referenceColumns"),f=0;f<e.length;f++)c.push(e.at(f).get("fkColumnId"));var g=this.getTableLayer().getContext()._context;g.font="12px Arial";g.textAlign="left";g.fillStyle="black";for(var f=e=b="",h=0,k=0,d=0;d<a.size();d++){var m=a.at(d),n=[];m.get("nullable")&&
n.push("N");m.get("pk")&&n.push("PK");0<=c.indexOf(m.get("id"))&&n.push("FK");var m=g.measureText(m.get("type")).width,r=g.measureText(n).width;m>k&&(k=m);r>h&&(h=r);b+=n.join(" ")+"\n"}c=h;h=k;k>this.getTableDisplay().get("width")-c-25-5-3&&(h=Math.max(25,this.getTableDisplay().get("width")-c-25-5-3));k=this.getTableDisplay().get("width")-c-h-5-3-8;n=this.getTableLayer().getDiagram();for(d=0;d<a.size();d++)m=a.at(d),f+=n.trimText(m.get("name"),k,g)+"\n",e+=n.trimText(m.get("type"),h,g)+"\n";a=this.getTableDisplay().get("height")-
this.TITLE_HEIGHT-4-4;d=new Kinetic.Text({x:5,y:4,width:k,lineHeight:1.2,height:a,align:"left",text:f,fontSize:12,fontFamily:"Arial",fill:"black"});e=new Kinetic.Text({x:5+k+4,y:4,width:h,lineHeight:1.2,height:a,align:"left",text:e,fontSize:12,fontFamily:"Arial",fill:"black"});for(a=new Kinetic.Text({x:5+k+h+8,y:4,width:c,lineHeight:1.2,height:a,align:"left",text:b,fontSize:12,fontFamily:"Arial",fill:"black"});0<this.columnsBox.getChildren().length;)this.columnsBox.getChildren()[0].destroy();this.columnsBox.add(d);
this.columnsBox.add(e);this.columnsBox.add(a)}};Kinetic.Util.extend(Diagram.Table,Diagram.Element);Kinetic.Factory.addGetter(Diagram.Table,"tableLayer");Kinetic.Factory.addGetter(Diagram.Table,"tableModel");Kinetic.Factory.addGetter(Diagram.Table,"tableDisplay");Diagram.Reference=function(a){this._initReference(a)};
Diagram.Reference.prototype={_initReference:function(a){this.referenceLayer=a.referenceLayer;this.referenceModel=a.referenceModel;this.referenceDisplay=a.referenceDisplay;Diagram.Element.call(this,{draggable:!1});this.setAttrs(a);this.buildReference(this.referenceLayer,this.referenceModel,this.referenceDisplay);this.bindModelEvents(this.referenceModel,this.referenceLayer,this.referenceDisplay)},bindModelEvents:function(a,b,c){var d=this;c.on("change:controlPoints",function(a,b){for(;0<d.getChildren().length;)d.getChildren()[0].destroy();
d.buildReference(d.referenceLayer,d.referenceModel,d.referenceDisplay)},d);a.on("change:cardinality",function(a){for(;0<d.getChildren().length;)d.getChildren()[0].destroy();d.buildReference(d.referenceLayer,d.referenceModel,d.referenceDisplay)},d);a.on("change:mandatory",function(a){for(;0<d.getChildren().length;)d.getChildren()[0].destroy();d.buildReference(d.referenceLayer,d.referenceModel,d.referenceDisplay)},d);c.on("selected",function(){for(var a=d.getChildren(),b=0;b<a.length;b++)a[b].setStrokeWidth(1.6);
d.getReferenceLayer().getDiagram().selectReference(d)},d);c.on("deselected",function(){for(var a=d.getChildren(),b=0;b<a.length;b++)a[b].setStrokeWidth(1);d.getReferenceLayer().getDiagram().deselectReference(d)},d);c.on("attached",function(){var a=d.getLayer().getDiagram();d.updateLineColor();a.attachReferenceToSelection(d)},d);c.on("detached",function(){d.updateLineColor();d.getReferenceLayer().getDiagram().detachReferenceFromSelection(d)},d);c.on("setInSearchResults",function(){d.updateLineColor()},
d);c.on("unsetInSearchResults",function(){d.updateLineColor()},d);Model.referenceDisplays.on("remove",function(a){if(a.get("modelId")==d.referenceDisplay.get("modelId")){for(;0<d.getChildren().length;)d.getChildren()[0].destroy();d.buildReference(d.referenceLayer,d.referenceModel,d.referenceDisplay)}},d);Model.referenceDisplays.on("add",function(a){if(a.get("modelId")==d.referenceDisplay.get("modelId")){for(;0<d.getChildren().length;)d.getChildren()[0].destroy();d.buildReference(d.referenceLayer,
d.referenceModel,d.referenceDisplay)}},d)},unbindModelEvents:function(){var a=this.getReferenceModel(),b=this.getReferenceDisplay();a.off(null,null,this);b.off(null,null,this);Model.referenceDisplays.off(null,null,this)},shouldDraw:function(){return this.isBoundaryRectOnScene(this.getReferenceDisplay().getBoundaryRect())},updateLineColor:function(){var a=this.getChildren(),b=this.getLayer().getDiagram();this.getReferenceModel();var c=this.getReferenceDisplay(),d=c.get("color");c.get("inSearchResults")&&
(d=b.getSearchColor());c.isAttached()&&(d=b.getSelectColor());for(b=0;b<a.length;b++)a[b].setStroke(d)},buildReference:function(a,b,c){this.buildReferenceLine(a,b,c);this.buildCardinalitySymbol(a,b,c);this.buildMandatorySymbol(a,b,c);this.buildFocusAreas(a,b,c)},buildFocusAreas:function(a,b,c){for(var d=0;d<c.get("controlPoints").size()-1;d++){var e=new Diagram.ReferenceFocusArea({referenceLayer:a,referenceModel:b,referenceDisplay:c,startIndex:d,endIndex:d+1});this.add(e)}},buildReferenceLine:function(a,
b,c){for(var d=[],e=0;e<c.get("controlPoints").size();e++){var f=c.get("controlPoints").at(e);d[2*e]=f.get("x");d[2*e+1]=f.get("y")}e=c.get("color");f=1;c.isSelected()&&(f=1.6);c.isAttached()&&(e=a.getDiagram().getSelectColor());a=[2,2];1==Model.referenceDisplays.where({modelId:b.get("id")}).length&&(a=null);b=new Kinetic.Line({points:d,stroke:e,strokeWidth:f,lineCap:"round",lineJoin:"round",dashArray:a});this.add(b)},buildCardinalitySymbol:function(a,b,c){c.get("controlPointsType");Model.tableDisplays.get(c.get("pkTableDisplayId"));
var d=Model.tableDisplays.get(c.get("fkTableDisplayId"));a=c.get("controlPoints");for(var d=d.getBoundaryRect(),e=a.size()-1;0<e;e--){var f=a.at(e),g=a.at(e-1),f={x:f.get("x"),y:f.get("y")},g={x:g.get("x"),y:g.get("y")},f=this.computeIntersectionPoint(f,g,d);if(f.intersect){a=f.intersectionPoint;if(0<(f.p2code&this.POINT_TOP)){g.y>a.y-15&&(a.y=g.y+15);if(a.x>d.xmax-6)break;if(a.x<d.xmin+6)break;d=[a.x,a.y-15,a.x-6,a.y];e=[a.x,a.y-15,a.x+6,a.y];g=[a.x-6,a.y-15,a.x+6,a.y-15];a={x:a.x,y:a.y-15}}else if(0<
(f.p2code&this.POINT_BOTTOM)){g.y<a.y+15&&(a.y=g.y-15);if(a.x>d.xmax-6)break;if(a.x<d.xmin+6)break;d=[a.x,a.y+15,a.x-6,a.y];e=[a.x,a.y+15,a.x+6,a.y];g=[a.x-6,a.y+15,a.x+6,a.y+15];a={x:a.x,y:a.y+15}}else if(0<(f.p2code&this.POINT_LEFT)){g.x>a.x-15&&(a.x=g.x+15);if(a.y>d.ymax-6)break;if(a.y<d.ymin+6)break;d=[a.x-15,a.y,a.x,a.y-6];e=[a.x-15,a.y,a.x,a.y+6];g=[a.x-15,a.y-6,a.x-15,a.y+6];a={x:a.x-15,y:a.y}}else if(0<(f.p2code&this.POINT_RIGHT)){g.x<a.x+15&&(a.x=g.x-15);if(a.y>d.ymax-6)break;if(a.y<d.ymin+
6)break;d=[a.x+15,a.y,a.x,a.y-6];e=[a.x+15,a.y,a.x,a.y+6];g=[a.x+15,a.y-6,a.x+15,a.y+6];a={x:a.x+15,y:a.y}}else break;"0..1"===b.get("cardinality")?this.buildCardinalityZeroCircle(a,3.5,b,c):"1..1"===b.get("cardinality")?this.buildCardinalityLine(g,b,c):"0..*"===b.get("cardinality")?(this.buildCardinalityLine(d,b,c),this.buildCardinalityLine(e,b,c),this.buildCardinalityZeroCircle(a,3.5,b,c)):"1..*"===b.get("cardinality")&&(this.buildCardinalityLine(d,b,c),this.buildCardinalityLine(e,b,c),this.buildCardinalityLine(g,
b,c));break}}},buildMandatorySymbol:function(a,b,c){c.get("controlPointsType");var d=Model.tableDisplays.get(c.get("pkTableDisplayId"));Model.tableDisplays.get(c.get("fkTableDisplayId"));a=c.get("controlPoints");for(var d=d.getBoundaryRect(),e=0;e<a.size()-1;e++){var f=a.at(e),g=a.at(e+1),f={x:f.get("x"),y:f.get("y")},g={x:g.get("x"),y:g.get("y")},f=this.computeIntersectionPoint(f,g,d);if(f.intersect){a=f.intersectionPoint;if(0<(f.p2code&this.POINT_TOP)){g.y>a.y-15&&(a.y=g.y+15);if(a.x>d.xmax-6)break;
if(a.x<d.xmin+6)break;d=[a.x-6,a.y-15,a.x+6,a.y-15];a={x:a.x,y:a.y-15}}else if(0<(f.p2code&this.POINT_BOTTOM)){g.y<a.y+15&&(a.y=g.y-15);if(a.x>d.xmax-6)break;if(a.x<d.xmin+6)break;d=[a.x-6,a.y+15,a.x+6,a.y+15];a={x:a.x,y:a.y+15}}else if(0<(f.p2code&this.POINT_LEFT)){g.x>a.x-15&&(a.x=g.x+15);if(a.y>d.ymax-6)break;if(a.y<d.ymin+6)break;d=[a.x-15,a.y-6,a.x-15,a.y+6];a={x:a.x-15,y:a.y}}else if(0<(f.p2code&this.POINT_RIGHT)){g.x<a.x+15&&(a.x=g.x-15);if(a.y>d.ymax-6)break;if(a.y<d.ymin+6)break;d=[a.x+15,
a.y-6,a.x+15,a.y+6];a={x:a.x+15,y:a.y}}else break;!0===b.get("mandatory")?this.buildCardinalityLine(d,b,c):this.buildCardinalityZeroCircle(a,3.5,b,c);break}}},buildCardinalityLine:function(a,b,c){b=c.get("color");var d=1;c.isSelected()&&(d=1.6);c.isAttached()&&(b=app.getDiagram().getSelectColor());a=new Kinetic.Line({points:a,stroke:b,strokeWidth:d,lineCap:"round",lineJoin:"round"});this.add(a)},buildCardinalityZeroCircle:function(a,b,c,d){c=d.get("color");var e=1;d.isSelected()&&(e=1.6);d.isAttached()&&
(c=app.getDiagram().getSelectColor());a=new Kinetic.Circle({x:a.x,y:a.y,radius:b,stroke:c,strokeWidth:e,fill:"white"});this.add(a)},POINT_INSIDE:0,POINT_LEFT:1,POINT_RIGHT:2,POINT_BOTTOM:4,POINT_TOP:8,computePointCode:function(a,b,c){var d=this.POINT_INSIDE;a<c.xmin?d|=this.POINT_LEFT:a>c.xmax&&(d|=this.POINT_RIGHT);b<c.ymin?d|=this.POINT_TOP:b>c.ymax&&(d|=this.POINT_BOTTOM);return d},computeIntersectionPoint:function(a,b,c){a=this.computePointCode(a.x,a.y,c);var d=this.computePointCode(b.x,b.y,c),
e=!0,f={};a|d?a&d?e=!1:d&this.POINT_TOP?f={x:b.x,y:c.ymin}:d&this.POINT_BOTTOM?f={x:b.x,y:c.ymax}:d&this.POINT_RIGHT?f={x:c.xmax,y:b.y}:d&this.POINT_LEFT&&(f={x:c.xmin,y:b.y}):e=!1;return{intersect:e,p2code:d,intersectionPoint:f}}};Kinetic.Util.extend(Diagram.Reference,Diagram.Element);Kinetic.Factory.addGetterSetter(Diagram.Reference,"referenceLayer");Kinetic.Factory.addGetterSetter(Diagram.Reference,"referenceModel");Kinetic.Factory.addGetterSetter(Diagram.Reference,"referenceDisplay");
Diagram.ReferenceFocusArea=function(a){this._initReferenceFocusArea(a)};
Diagram.ReferenceFocusArea.prototype={_initReferenceFocusArea:function(a){this.SENSITIVITY=5;this.MARGIN=10;var b=a.referenceDisplay,c=b.get("controlPoints").at(a.startIndex),d=b.get("controlPoints").at(a.endIndex),b=Math.min(c.get("x"),d.get("x"))-this.SENSITIVITY,e=Math.min(c.get("y"),d.get("y"))-this.SENSITIVITY,f=Math.max(c.get("x"),d.get("x"))+this.SENSITIVITY,c=Math.max(c.get("y"),d.get("y"))+this.SENSITIVITY;Kinetic.Rect.call(this,{x:b,y:e,width:f-b,height:c-e,fill:"#FF0000",stroke:"#FF0000",
strokeWidth:1,opacity:0,draggable:!1});this.setAttrs(a);this.setDragBoundFunc(this.referenceFADragBoundFunc);this.on("dragmove",this.dragMoveEventHandler);this.on("mousedown",this.mouseDownEventHandler);this.on("dragend",this.dragEndEventHandler);this.on("dragstart",this.dragStartEventHandler);Model.metaInfo.on("change:mode",this.updateEditableReadonly,this);this.updateEditableReadonly()},updateEditableReadonly:function(){this.setDraggable(app.isEditable())},referenceFADragBoundFunc:function(a){var b=
this.getLayer().getDiagram();this.getReferenceModel();var c=this.getReferenceDisplay(),d=c.get("controlPointsType"),e=Model.tableDisplays.get(c.get("pkTableDisplayId")),f=Model.tableDisplays.get(c.get("fkTableDisplayId")),g=c.get("controlPoints"),c=g.at(this.getStartIndex()),g=g.at(this.getEndIndex()),h=a.x;a=a.y;var k,m,n,r;if(d===Model.RCPType.HORIZONTAL_2CP)n=Math.max(e.get("y"),f.get("y")),r=Math.min(e.get("y")+e.get("height"),f.get("y")+f.get("height")),h=b.getAbsoluteX(this.getX());else if(d===
Model.RCPType.VERTICAL_2CP)k=Math.max(e.get("x"),f.get("x")),m=Math.min(e.get("x")+e.get("width"),f.get("x")+f.get("width")),a=b.getAbsoluteY(this.getY());else if(d===Model.RCPType.CROSS_3CP){var l;l=0===this.getStartIndex()?e:f;c.get("x")===g.get("x")?(k=l.get("x"),m=l.get("x")+l.get("width"),a=b.getAbsoluteY(this.getY())):(n=l.get("y"),r=l.get("y")+l.get("height"),h=b.getAbsoluteX(this.getX()))}else d===Model.RCPType.HORIZONTAL_4CP?0===this.getStartIndex()?(n=e.get("y"),r=e.get("y")+e.get("height"),
h=b.getAbsoluteX(this.getX())):1===this.getStartIndex()?a=b.getAbsoluteY(this.getY()):2===this.getStartIndex()&&(n=f.get("y"),r=f.get("y")+f.get("height"),h=b.getAbsoluteX(this.getX())):d===Model.RCPType.VERTICAL_4CP?0===this.getStartIndex()?(k=e.get("x"),m=e.get("x")+e.get("width"),a=b.getAbsoluteY(this.getY())):1===this.getStartIndex()?h=b.getAbsoluteX(this.getX()):2===this.getStartIndex()&&(k=f.get("x"),m=f.get("x")+f.get("width"),a=b.getAbsoluteY(this.getY())):d!==Model.RCPType.SELF_4CP&&d===
Model.RCPType.SELF_5CP&&(0===this.getStartIndex()||3===this.getStartIndex()?(0===this.getStartIndex()?l=e:3===this.getStartIndex()&&(l=f),c.get("x")===g.get("x")?(k=l.get("x"),m=l.get("x")+l.get("width"),a=b.getAbsoluteY(this.getY())):(n=l.get("y"),r=l.get("y")+l.get("height"),h=b.getAbsoluteX(this.getX()))):c.get("x")===g.get("x")?a=b.getAbsoluteY(this.getY()):h=b.getAbsoluteX(this.getX()));void 0!==k&&(k=b.getAbsoluteX(k-this.SENSITIVITY+this.MARGIN),h<k&&(h=k));void 0!==m&&(m=b.getAbsoluteX(m-
this.SENSITIVITY-this.MARGIN),h>m&&(h=m));void 0!==n&&(n=b.getAbsoluteY(n-this.SENSITIVITY+this.MARGIN),a<n&&(a=n));void 0!==r&&(r=b.getAbsoluteY(r-this.SENSITIVITY-this.MARGIN),a>r&&(a=r));return{x:h,y:a}},mouseDownEventHandler:function(a){this.getLayer().getDiagram();this.getReferenceModel();var b=this.getReferenceDisplay();Model.diagramMode.is(Model.diagramMode.SELECT_MODE)&&(!1==a.shiftKey?b.isAttached()?Display.selection.selectAndAttachElement(b):Display.selection.selectElement(b):b.isAttached()?
Display.selection.deselectAndDetachElement(b):Display.selection.selectAndAttachElement(b),Display.selection.triggerSelectionChanged(),this.getLayer().getDiagram().draw())},clone:function(){return new Diagram.ReferenceFocusArea(this.attrs)},dragStartEventHandler:function(){this.getParent().add(this.clone());var a=this.getAbsolutePosition();this.moveTo(this.getLayer());this.setAbsolutePosition(a)},dragMoveEventHandler:function(){this.getReferenceModel();var a=this.getReferenceDisplay(),b=this.getX()+
this.getWidth()/2,c=this.getY()+this.getHeight()/2;a.moveLinePartTo(this.getStartIndex(),this.getEndIndex(),b,c,!1);this.getLayer().getDiagram().draw()},dragEndEventHandler:function(){this.getReferenceModel();var a=this.getReferenceDisplay(),b=this.getX()+this.getWidth()/2,c=this.getY()+this.getHeight()/2;Commands.moveReferenceDisplayLinePartTo(a,this.getStartIndex(),this.getEndIndex(),b,c,!0);a=this.getLayer().getDiagram();this.destroy();a.draw()}};
Kinetic.Util.extend(Diagram.ReferenceFocusArea,Kinetic.Rect);Kinetic.Factory.addGetter(Diagram.ReferenceFocusArea,"referenceLayer");Kinetic.Factory.addGetter(Diagram.ReferenceFocusArea,"referenceModel");Kinetic.Factory.addGetter(Diagram.ReferenceFocusArea,"referenceDisplay");Kinetic.Factory.addGetter(Diagram.ReferenceFocusArea,"startIndex");Kinetic.Factory.addGetter(Diagram.ReferenceFocusArea,"endIndex");Diagram.Note=function(a){this._initNote(a)};
Diagram.Note.prototype={FOLD_SIZE:15,_initNote:function(a){var b=a.noteLayer,c=a.noteModel;Diagram.Element.call(this,{x:c.get("x"),y:c.get("y"),draggable:!1});this.setAttrs(a);this.buildNote(b,c);this.bindModelEvents(c);this.on("mousedown",this.mouseDownEventHandler)},bindModelEvents:function(a){var b=this;a.on("move",function(a,d,e){d=b.getLayer().getDiagram().getPosition();e=b.getLayer().getDiagram().getScale();b.setAbsolutePosition({x:d.x+a.get("x")*e.x,y:d.y+a.get("y")*e.y})},b);a.on("resize",
function(a,d,e,f,g){b.resize(d,e,f,g)},b);a.on("selected",function(){b.box.setStrokeWidth(1.6);b.getNoteLayer().getDiagram().selectNote(b)},b);a.on("deselected",function(){b.box.setStrokeWidth(1);b.getNoteLayer().getDiagram().deselectNote(b)},b);a.on("attached",function(){b.updateLineColor();b.getNoteLayer().getDiagram().attachNoteToSelection(b)},b);a.on("detached",function(){b.updateLineColor();b.getNoteLayer().getDiagram().detachNoteFromSelection(b)},b);a.on("setInSearchResults",function(){b.updateLineColor()},
b);a.on("unsetInSearchResults",function(){b.updateLineColor()},b);a.on("change:lineColor",function(a,d){b.updateLineColor()},b);a.on("change:fillColor",function(a,d){b.box.setFill(d)},b);a.on("change:content",function(a,d){b.adjustContent()},b)},unbindModelEvents:function(){this.getNoteModel().off(null,null,this)},shouldDraw:function(){return this.isBoundaryRectOnScene(this.getNoteModel().getBoundaryRect())},updateLineColor:function(){var a=this.getLayer().getDiagram(),b=this.getNoteModel(),c=b.get("lineColor");
b.get("inSearchResults")&&(c=a.getSearchColor());b.isAttached()&&(c=a.getSelectColor());this.box.setStroke(c);this.line.setStroke(c)},mouseDownEventHandler:function(a){var b=this.getLayer().getDiagram(),c=this.getNoteModel();Model.diagramMode.is(Model.diagramMode.SELECT_MODE)&&(!1==a.shiftKey?c.isAttached()?Display.selection.selectAndAttachElement(c):Display.selection.selectElement(c):c.isAttached()?Display.selection.deselectAndDetachElement(c):Display.selection.selectAndAttachElement(c),Display.selection.triggerSelectionChanged(),
b.draw())},resize:function(a,b,c,d){c=this.FOLD_SIZE;this.box.setPoints([0,0,a-c,0,a,c,a,b,0,b]);this.line.setPoints([a-c,0,a-c,c,a,c]);this.content.setWidth(a);this.content.setHeight(b);this.adjustContent()},buildNote:function(a,b){var c=b.get("width"),d=b.get("height"),e=this.FOLD_SIZE;this.box=new Kinetic.Polygon({points:[0,0,c-e,0,c,e,c,d,0,d],fill:b.get("fillColor"),stroke:b.get("lineColor"),strokeWidth:1,lineJoin:"bevel"});this.line=new Kinetic.Polygon({points:[c-e,0,c-e,e,c,e],stroke:b.get("lineColor"),
strokeWidth:1,lineJoin:"bevel"});this.content=new Kinetic.Text({x:0,y:0,width:c,height:d,padding:5,align:"left",text:"",lineHeight:1.1,fontSize:13,fontFamily:"Arial",fill:"black"});this.add(this.box);this.add(this.line);this.add(this.content);this.adjustContent()},adjustContent:function(){var a=this.getNoteModel().get("width")-10,b=this.getNoteModel().get("content").split("\n"),c=[],d=this.getNoteLayer().getContext()._context;d.font="13px Arial";d.textAlign="left";d.fillStyle="black";if(0<b.length){this.getNoteLayer().getDiagram();
for(var a=a-this.FOLD_SIZE,e=b[0].split(" "),f=[],g=0,h=f.join(" "),h=d.measureText(h).width;h<a&&g<e.length;)f.push(e[g]),h=f.join(" "),h=d.measureText(h).width,g++;h>=a&&(f.pop(),g--);c.push(f.join(" "));if(g!=e.length){for(f=[];g<e.length;g++)f.push(e[g]);c.push(f.join(" "))}}if(1<b.length)for(g=1;g<b.length;g++)c.push(b[g]);this.content.setText(c.join("\n"))}};Kinetic.Util.extend(Diagram.Note,Diagram.Element);Kinetic.Factory.addGetter(Diagram.Note,"noteLayer");
Kinetic.Factory.addGetter(Diagram.Note,"noteModel");Diagram.View=function(a){this._initView(a)};
Diagram.View.prototype={TITLE_HEIGHT:20,MIN_RELATED_ELEMENTS_HEIGHT:20,_initView:function(a){var b=a.viewLayer,c=a.viewModel,d=a.viewDisplay;Diagram.Element.call(this,{x:d.get("x"),y:d.get("y"),draggable:!1});this.setAttrs(a);this.buildView(b,c,d);this.bindModelEvents(c,d);this.on("mousedown",this.mouseDownEventHandler);this.on("mouseup",this.mouseUpEventHandler);this.on("click",this.clickEventHandler)},shouldDraw:function(){return this.isBoundaryRectOnScene(this.getViewDisplay().getBoundaryRect())},
updateEditableReadonly:function(){},bindModelEvents:function(a,b){var c=this;b.on("move",function(a,e,f){a=c.getLayer().getDiagram().getPosition();e=c.getLayer().getDiagram().getScale();c.setAbsolutePosition({x:a.x+b.get("x")*e.x,y:a.y+b.get("y")*e.y});c.updateTitleText()},c);b.on("resize",function(a,b,f,g,h){c.resize(b,f,g,h);c.updateTitleText()},c);b.on("change:width",function(a,b){c.box.setWidth(b);c.title.setWidth(b);c.titleSeparator.setPoints([0,c.titleSeparator.getHeight(),b,c.titleSeparator.getHeight()]);
c.relatedElementsGroup.setWidth(b);c.relatedElementsSeparator.setPoints([0,1,b,1]);c.rebuildRelatedElementsBox();c.rebuildColumnsBox();c.updateTitleText()},c);b.on("change:height",function(a,b){c.box.setHeight(b);c.relatedElementsGroup.setY(Math.floor(b-c.relatedElementsGroup.getHeight()));c.rebuildColumnsBox();c.updateTitleText()},c);b.on("selected",function(){c.box.setStrokeWidth(1.6);c.titleSeparator.setStrokeWidth(1.6);c.relatedElementsSeparator.setStrokeWidth(1.6);c.getViewLayer().getDiagram().selectView(c)},
c);b.on("deselected",function(){c.box.setStrokeWidth(1);c.titleSeparator.setStrokeWidth(1);c.relatedElementsSeparator.setStrokeWidth(1);c.getViewLayer().getDiagram().deselectView(c)},c);b.on("attached",function(){c.updateLineColor();c.getViewLayer().getDiagram().attachViewToSelection(c)},c);b.on("detached",function(){c.updateLineColor();c.getViewLayer().getDiagram().detachViewFromSelection(c)},c);b.on("setInSearchResults",function(){c.updateLineColor()},c);b.on("unsetInSearchResults",function(){c.updateLineColor()},
c);a.on("change:name",function(a,b){c.updateTitleText()},c);b.on("change:lineColor",function(a,b){c.updateLineColor()},c);b.on("change:fillColor",function(a,b){c.box.setFill(b)},c);a.get("columns").on("all",function(){c.rebuildColumnsBox()},c);a.on("change:dependencies",function(a,b){c.rebuildRelatedElementsBox()},c);Model.viewDisplays.on("add",function(a){b.get("modelId")==a.get("modelId")&&(c.updateTitleText(),c.updateBoxDashArray(b))},c);Model.viewDisplays.on("remove",function(a){b.get("modelId")==
a.get("modelId")&&(c.updateTitleText(),c.updateBoxDashArray(b))},c);Model.viewDisplays.on("change",function(a){b.get("modelId")==a.get("modelId")&&c.updateTitleText()},c);Model.areas.on("add",function(a){c.updateTitleText()},c);Model.areas.on("remove",function(a){c.updateTitleText()},c);Model.areas.on("move",function(a){c.updateTitleText()},c);Model.areas.on("resize",function(a){c.updateTitleText()},c);Model.areas.on("reset",function(a){c.updateTitleText()});Model.areas.on("change",function(a){c.updateTitleText()})},
unbindModelEvents:function(){var a=this.getViewDisplay(),b=this.getViewModel(),c=b.get("columns");a.off(null,null,this);b.off(null,null,this);c.off(null,null,this);Model.areas.off(null,null,this);Model.viewDisplays.off(null,null,this)},updateLineColor:function(){var a=this.getLayer().getDiagram(),b=this.getViewDisplay();this.getViewModel();var c=b.get("lineColor");b.get("inSearchResults")&&(c=a.getSearchColor());b.isAttached()&&(c=a.getSelectColor());this.box.setStroke(c);this.titleSeparator.setStroke(c);
this.relatedElementsSeparator.setStroke(c)},mouseDownEventHandler:function(a){var b=this.getLayer().getDiagram(),c=this.getViewDisplay();Model.diagramMode.is(Model.diagramMode.SELECT_MODE)&&(!1==a.shiftKey?c.isAttached()?Display.selection.selectAndAttachElement(c):Display.selection.selectElement(c):c.isAttached()?Display.selection.deselectAndDetachElement(c):Display.selection.selectAndAttachElement(c),Display.selection.triggerSelectionChanged(),b.draw())},mouseUpEventHandler:function(a){this.getLayer().getDiagram();
Model.diagramMode.is(Model.diagramMode.SELECT_MODE)},clickEventHandler:function(a){},resize:function(a,b,c,d){this.box.setWidth(a);this.box.setHeight(b);this.title.setWidth(a);this.titleSeparator.setPoints([0,this.titleSeparator.getHeight(),a,this.titleSeparator.getHeight()]);this.relatedElementsGroup.setWidth(a);this.relatedElementsGroup.setY(Math.floor(b-this.relatedElementsGroup.getHeight()));this.relatedElementsSeparator.setPoints([0,1,a,1]);this.rebuildColumnsBox()},_getRelatedElementsHeight:function(a){return 0===
a?this.MIN_RELATED_ELEMENTS_HEIGHT:10+app.getDiagram().measureHeight(a)},buildView:function(a,b,c){a=c.get("fillColor");var d=c.get("lineColor"),e=this.getBoxDashArray(c);this.box=new Kinetic.Rect({x:0,y:0,width:c.get("width"),height:c.get("height"),fill:a,stroke:d,strokeWidth:1,lineJoin:"bevel",cornerRadius:10,dashArray:e});this.titleGroup=new Kinetic.Group({x:0,y:0,width:c.get("width"),height:this.TITLE_HEIGHT});this.titleSeparator=new Kinetic.Line({x:0,y:0,width:c.get("width"),height:this.TITLE_HEIGHT,
points:[0,this.TITLE_HEIGHT,c.get("width"),this.TITLE_HEIGHT],stroke:d,strokeWidth:1});a=c.getTitleText();this.title=new Kinetic.Text({x:0,y:2,width:c.get("width"),height:this.TITLE_HEIGHT,padding:1,align:"center",text:a,fontSize:12,fontFamily:"Arial",fontStyle:"bold",fill:"black"});this.titleGroup.add(this.titleSeparator);this.titleGroup.add(this.title);b=b.get("dependencies").length;b=this._getRelatedElementsHeight(b);this.relatedElementsGroup=new Kinetic.Group({x:0,y:Math.floor(c.get("height")-
b),width:c.get("width"),height:b});this.columnsBox=new Kinetic.Group({x:0,y:this.TITLE_HEIGHT,width:c.get("width"),height:c.get("width")-this.titleGroup.getHeight()-this.relatedElementsGroup.getHeight()});this.add(this.box);this.add(this.titleGroup);this.add(this.columnsBox);this.add(this.relatedElementsGroup);this.rebuildRelatedElementsBox();this.rebuildColumnsBox()},getBoxDashArray:function(a){var b=this.getViewDisplay().get("id");a=Model.viewDisplays.where({modelId:a.get("modelId")});return 0==
_.filter(a,function(a){return a.get("id")!=b}).length?null:[2,2]},updateBoxDashArray:function(a){a=this.getBoxDashArray(a);this.box.setDashArray(a)},updateTitleText:function(){var a=this.getViewDisplay().getTitleText();this.title.setText(a)},rebuildColumnsBox:function(){var a=this.getViewModel(),b=this.getViewDisplay(),c=a.get("columns");b.get("width");var d=this.getViewLayer().getContext()._context;d.font="12px Arial";d.textAlign="left";d.fillStyle="black";for(var e=a="",f="",g=0,h=0,k=0;k<c.size();k++){var m=
c.at(k),n=[],m=d.measureText(m.get("type")).width,r=d.measureText(n).width;m>h&&(h=m);r>g&&(g=r);a+=n.join(" ")+"\n"}n=h;h>this.getViewDisplay().get("width")-g-25-5-3&&(n=Math.max(25,this.getViewDisplay().get("width")-g-25-5-3));h=this.getViewDisplay().get("width")-g-n-5-3-8;m=this.getViewLayer().getDiagram();for(k=0;k<c.size();k++)r=c.at(k),f+=m.trimText(r.get("name"),h,d)+"\n",e+=m.trimText(r.get("type"),n,d)+"\n";c=this.getViewDisplay().get("height")-this.titleGroup.getHeight()-this.relatedElementsGroup.getHeight()-
4-4;f=new Kinetic.Text({x:5,y:4,width:h,lineHeight:1.2,height:c,align:"left",text:f,fontSize:12,fontFamily:"Arial",fill:"black"});e=new Kinetic.Text({x:5+h+4,y:4,width:n,lineHeight:1.2,height:c,align:"left",text:e,fontSize:12,fontFamily:"Arial",fill:"black"});for(a=new Kinetic.Text({x:5+h+n+8,y:4,width:g,lineHeight:1.2,height:c,align:"left",text:a,fontSize:12,fontFamily:"Arial",fill:"black"});0<this.columnsBox.getChildren().length;)this.columnsBox.getChildren()[0].destroy();this.columnsBox.setHeight(b.get("width")-
this.titleGroup.getHeight()-this.relatedElementsGroup.getHeight());this.columnsBox.add(f);this.columnsBox.add(e);this.columnsBox.add(a)},rebuildRelatedElementsBox:function(){var a=this.getViewModel(),b=this.getViewDisplay(),a=a.get("dependencies"),c=this.getViewLayer().getContext()._context;c.font="12px Arial";c.textAlign="left";for(c.fillStyle="black";0<this.relatedElementsGroup.getChildren().length;)this.relatedElementsGroup.getChildren()[0].destroy();var d=this._getRelatedElementsHeight(a.length);
this.relatedElementsGroup.setHeight(d);this.relatedElementsSeparator=new Kinetic.Line({x:0,y:0,points:[0,1,b.get("width"),1],stroke:b.get("lineColor"),strokeWidth:1});this.relatedElementsGroup.add(this.relatedElementsSeparator);for(var d="",b=b.get("width")-5-3,e=this.getViewLayer().getDiagram(),f=0;f<a.length;f++)var g=Model.views.get(a[f]),d=d+(e.trimText(g.get("name"),b,c)+"\n");a=new Kinetic.Text({x:5,y:5,width:b,lineHeight:1.2,height:this.relatedElementsGroup.getHeight()-4,align:"left",text:d,
fontSize:12,fontFamily:"Arial",fill:"black"});this.relatedElementsGroup.add(a)}};Kinetic.Util.extend(Diagram.View,Diagram.Element);Kinetic.Factory.addGetter(Diagram.View,"viewLayer");Kinetic.Factory.addGetter(Diagram.View,"viewModel");Kinetic.Factory.addGetter(Diagram.View,"viewDisplay");Diagram.Area=function(a){this._initArea(a)};
Diagram.Area.prototype={_initArea:function(a){var b=a.areaLayer,c=a.areaModel;Diagram.Element.call(this,{x:c.get("x"),y:c.get("y"),draggable:!1});this.setAttrs(a);this.buildArea(b,c);this.bindModelEvents(c)},bindModelEvents:function(a){var b=this;a.on("move",function(a,d,e){d=b.getLayer().getDiagram().getPosition();e=b.getLayer().getDiagram().getScale();b.setAbsolutePosition({x:d.x+a.get("x")*e.x,y:d.y+a.get("y")*e.y});b.focusArea.destroy();b.buildFocusAreas(b.getLayer(),a)},b);a.on("resize",function(a,
d,e,f,g){b.resize(d,e,f,g)},b);a.on("selected",function(){b.box.setStrokeWidth(1.6);b.getLayer().getDiagram().selectArea(b)},b);a.on("deselected",function(){b.box.setStrokeWidth(1);b.getLayer().getDiagram().deselectArea(b)},b);a.on("attached",function(){b.updateLineColor();b.getAreaLayer().getDiagram().attachAreaToSelection(b)},b);a.on("detached",function(){b.updateLineColor();b.getAreaLayer().getDiagram().detachAreaFromSelection(b)},b);a.on("setInSearchResults",function(){b.updateLineColor()},b);
a.on("unsetInSearchResults",function(){b.updateLineColor()},b);a.on("change:lineColor",function(a,d){b.updateLineColor()},b);a.on("change:fillColor",function(a,d){b.box.setFill(d)},b);a.on("change:dashArray",function(a,d){b.box.setDashArray(d)},b);a.on("change:name",function(a){b.updateName()},b);a.on("move:name",function(a,d,e){b.title.setX(d);b.title.setY(e)},b);a.on("change:nameColor",function(a,d){b.title.setFill(d)},b);a.on("change:moveToTop",function(a){b.moveAreaToTop()},b);a.on("change:moveToBottom",
function(a){b.moveAreaToBottom()},b);a.on("change:moveUp",function(a){b.moveAreaUp()},b);a.on("change:moveDown",function(a){b.moveAreaDown()},b);a.on("change:setZIndex",function(a,d){b.setAreaZIndex(d)},b);Model.metaInfo.on("change:mode",b.updateEditableReadonly,b)},unbindModelEvents:function(){this.getAreaModel().off(null,null,this);Model.metaInfo.off(null,null,this)},shouldDraw:function(){return this.isBoundaryRectOnScene(this.getAreaModel().getBoundaryRect())},updateName:function(){var a=this.getAreaModel();
this.title.setText(a.get("name"))},updateLineColor:function(){var a=this.getLayer().getDiagram(),b=this.getAreaModel(),c=b.get("lineColor");b.get("inSearchResults")&&(c=a.getSearchColor());b.isAttached()&&(c=a.getSelectColor());this.box.setStroke(c)},resize:function(a,b,c,d){this.box.setWidth(a);this.box.setHeight(b);this.updateNamePosition();this.focusArea.destroy();this.buildFocusAreas(this.getAreaLayer(),this.getAreaModel())},updateEditableReadonly:function(){var a=app.isEditable();this.title.setDraggable(a)},
buildArea:function(a,b){b.get("width");b.get("height");var c=b.get("fillColor"),d=b.get("lineColor"),e=b.get("dashArray");this.box=new Kinetic.Rect({x:0,y:0,width:b.get("width"),height:b.get("height"),fill:c,stroke:d,strokeWidth:1,lineJoin:"bevel",dashArray:e,dashEnabled:!0});var f=this;this.title=new Kinetic.Text({x:b.get("nameX"),y:b.get("nameY"),padding:1,align:"center",text:b.get("name"),fontSize:15,fontFamily:"Arial",fontStyle:"bold",fill:b.get("nameColor"),draggable:!0,dragBoundFunc:function(a){var b=
f.getLayer().getDiagram(),c=b.getScale(),d=f.getAreaModel(),e=a.x,r=a.y,l=b.getAbsoluteX(d.get("x")+d.get("width"))+0.5*f.title.getWidth()*c.x,p=b.getAbsoluteX(d.get("x"))-1.5*f.title.getWidth()*c.x;a.x<p&&(e=p);a.x>l&&(e=l);l=b.getAbsoluteY(d.get("y"))-1.5*f.title.getHeight()*c.x;b=b.getAbsoluteY(d.get("y")+d.get("height"))+0.5*f.title.getHeight()*c.x;a.y<l&&(r=l);a.y>b&&(r=b);return{x:e,y:r}}});this.title.areaModel=b;this.title.area=this;this.title.on("dragend",this.areaNameDragEndMouseHandler);
this.add(this.box);this.add(this.title);this.title.setZIndex(7);this.buildFocusAreas(a,b);this.updateEditableReadonly()},areaNameDragEndMouseHandler:function(a){a=a.targetNode;Commands.moveAreaName(a.areaModel.get("id"),a.getX(),a.getY())},updateNamePosition:function(){var a=this.getAreaModel();this.title.setX(a.get("nameX"));this.title.setY(a.get("nameY"))},buildFocusAreas:function(a,b){this.focusArea=new Diagram.AreaFocusArea({areaModel:b,areaLayer:a,areaRect:this});this.add(this.focusArea);this.focusArea.setZIndex(1)},
getFocusAreas:function(){return this.focusAreas},moveAreaToTop:function(){this.moveToTop()},moveAreaToBottom:function(){this.moveToBottom()},moveAreaUp:function(){this.moveUp()},moveAreaDown:function(){this.moveDown()},setAreaZIndex:function(a){this.setZIndex(a)}};Kinetic.Util.extend(Diagram.Area,Diagram.Element);Kinetic.Factory.addGetter(Diagram.Area,"areaLayer");Kinetic.Factory.addGetter(Diagram.Area,"areaModel");Diagram.AreaFocusAreaPart=function(a){this._initAreaFocusAreaPart(a)};
Diagram.AreaFocusAreaPart.prototype={_initAreaFocusAreaPart:function(a){this.SENSITIVITY=15;this.areaModel=a.areaModel;this.areaLineX1=a.areaLineX1;this.areaLineY1=a.areaLineY1;this.areaLineX2=a.areaLineX2;this.areaLineY2=a.areaLineY2;var b=this.areaLineX1-this.SENSITIVITY,c=this.areaLineY1-this.SENSITIVITY;Kinetic.Rect.call(this,{x:b,y:c,width:this.areaLineX2+this.SENSITIVITY-b,height:this.areaLineY2+this.SENSITIVITY-c,fill:"#FF0000",stroke:"#FF0000",strokeWidth:1,opacity:0});this.setAttrs(a)},resize:function(a){this.setAbsolutePosition(a.getAbsolutePosition());
this.setWidth(a.getWidth());this.setHeight(a.getHeight())},move:function(a){this.setAbsolutePosition(a.getAbsolutePosition());this.setX(a.getX());this.setY(a.getY());this.setWidth(a.getWidth());this.setHeight(a.getHeight())}};Kinetic.Util.extend(Diagram.AreaFocusAreaPart,Kinetic.Rect);Kinetic.Factory.addGetter(Diagram.AreaFocusAreaPart,"areaLayer");Kinetic.Factory.addGetter(Diagram.AreaFocusAreaPart,"areaModel");Diagram.AreaFocusArea=function(a){this._initAreaFocusArea(a)};
Diagram.AreaFocusArea.prototype={_initAreaFocusArea:function(a){this.areaModel=a.areaModel;this.areaLayer=a.areaLayer;this.areaRect=a.areaRect;this.focusArea1=new Diagram.AreaFocusAreaPart({areaLineX1:0,areaLineY1:0,areaLineX2:this.areaModel.get("width"),areaLineY2:0,areaModel:this.areaModel,areaRect:this});this.focusArea2=new Diagram.AreaFocusAreaPart({areaLineX1:0,areaLineY1:0,areaLineX2:0,areaLineY2:this.areaModel.get("height"),areaModel:this.areaModel,areaRect:this});this.focusArea3=new Diagram.AreaFocusAreaPart({areaLineX1:this.areaModel.get("width"),
areaLineY1:0,areaLineX2:this.areaModel.get("width"),areaLineY2:this.areaModel.get("height"),areaModel:this.areaModel,areaRect:this});this.focusArea4=new Diagram.AreaFocusAreaPart({areaLineX1:0,areaLineY1:this.areaModel.get("height"),areaLineX2:this.areaModel.get("width"),areaLineY2:this.areaModel.get("height"),areaModel:this.areaModel,areaRect:this});Kinetic.Group.call(this,{});this.add(this.focusArea1);this.add(this.focusArea2);this.add(this.focusArea3);this.add(this.focusArea4);this.setAttrs(a);
this.on("mousedown",this.mouseDownEventHandler);this.areaModel.on("resizeend",this.resize,this);this.areaModel.on("moveend",this.move,this)},mouseDownEventHandler:function(a){var b=this.getLayer().getDiagram(),c=this.getAreaModel();Model.diagramMode.is(Model.diagramMode.SELECT_MODE)&&(!1==a.shiftKey?c.isAttached()?Display.selection.selectAndAttachElement(c):Display.selection.selectElement(c):c.isAttached()?Display.selection.deselectAndDetachElement(c):Display.selection.selectAndAttachElement(c),Display.selection.triggerSelectionChanged(),
b.draw())},resize:function(){this.setAbsolutePosition(this.areaRect.getAbsolutePosition());this.focusArea1.resize(this.areaRect.focusArea.focusArea1);this.focusArea2.resize(this.areaRect.focusArea.focusArea2);this.focusArea3.resize(this.areaRect.focusArea.focusArea3);this.focusArea4.resize(this.areaRect.focusArea.focusArea4)},move:function(){this.setAbsolutePosition(this.areaRect.getAbsolutePosition());this.focusArea1.move(this.areaRect.focusArea.focusArea1);this.focusArea2.move(this.areaRect.focusArea.focusArea2);
this.focusArea3.move(this.areaRect.focusArea.focusArea3);this.focusArea4.move(this.areaRect.focusArea.focusArea4)}};Kinetic.Util.extend(Diagram.AreaFocusArea,Kinetic.Group);Kinetic.Factory.addGetterSetter(Diagram.AreaFocusArea,"areaModel");Kinetic.Factory.addGetterSetter(Diagram.AreaFocusArea,"areaLayer");Kinetic.Factory.addGetterSetter(Diagram.AreaFocusArea,"areaRect");
var UI={init:function(){},_unescapeHtmlBody:function(a){if(null==a)throw"text can not be null";a=epoint.ow.Utils.replaceAllString(a,"&amp;","&");a=epoint.ow.Utils.replaceAllString(a,"&lt;","<");a=epoint.ow.Utils.replaceAllString(a,"&gt;",">");a=epoint.ow.Utils.replaceAllString(a,"&quot;",'"');a=epoint.ow.Utils.replaceAllString(a,"&#x27;","'");return a=epoint.ow.Utils.replaceAllString(a,"&#x2F;","/")},template:function(a){var b=$("#"+a);if(0==b.length)throw Error("No such template: "+a);a=UI._unescapeHtmlBody(b.html());
return _.template(a)}};
UI.ProblemListRow=Backbone.View.extend({initialize:function(){this.hideName=!1;this.problemType=this.options.problemType;void 0!=this.options.hideName&&(this.hideName=this.options.hideName);this.render()},events:{"click .problems_list_row":"goTo"},goTo:function(a){var b=$(a.target).closest("div");a=b.data("goto").split(":");b=b.data("property");app.goTo(a[0],b)},renderProblems:function(a,b){for(var c=UI.template("problems-list-row-problem-template"),d=0;d<b.size();d++){var e=b.at(d);a.append(c({message:e.escape("message"),
id:e.get("id"),name:e.get("name"),property:e.get("property"),description:e.escape("description")}))}},render:function(){var a=this.model.get(this.problemType);this.size=a.size();if(0==a.size())return this;var b=UI.template("problems-list-element-"+this.problemType+"-template"),c="",d=this.model.get("name").toLowerCase(),d=d.substring(0,d.indexOf(":"));!1==this.hideName&&(c=this.model.escape("name"));this.$el.html(b({name:c}));this.renderProblems(this.$(".list"),a);this.$el.addClass("problems").addClass(d+
"-problems");return this}});UI.CommonProblemsList=Backbone.View.extend({_initBlockContentsStickyHeaders:function(a){a.addClass("sticky-headers");a.find("> .content").scroll(function(){var a=$(this),c,d=a.find(".details");d.find("summary").css("top","0");var e=0,f=0;d.each(function(){var d=$(this);if(a[0].scrollTop>e+d.height())e+=d.height();else return c=d,!1});d=c.find("SUMMARY");f=e+c.height()-d.height()-a[0].scrollTop;f=Math.min(f,0);d.css("top",a[0].scrollTop-e+f)})},initialize:function(){this._initBlockContentsStickyHeaders(this.$el.closest(".block"))}});
UI.ProblemsList=UI.CommonProblemsList.extend({initialize:function(){UI.CommonProblemsList.prototype.initialize.apply(this,arguments);this.isRenderingEnabled=!0;void 0!==this.options.renderingEnabled&&(this.isRenderingEnabled=this.options.renderingEnabled);this.render();var a=this;this.model.on("reset",function(b){a.render()});this.model.on("remove",function(b){a.render()});this.model.on("add",function(b){a.render()});this.hideHints=this.options.hideHints||!1},enableRendering:function(){this.isRenderingEnabled=
!0},disableRendering:function(){this.isRenderingEnabled=!1},render:function(){var a=!0;!1===this.isRenderingEnabled&&(a=!1);this.$el.html("");var b=["errors","warnings","hints"];this.hideHints&&(b=["errors","warnings"]);for(var c=0,d=0;d<b.length;d++){var e=0,f=UI.template("problems-list-group-"+b[d]+"-template");this.$el.append(f());for(var f=this.$(".content").last(),g=0;g<this.model.size();g++){var h=this.model.at(g),k=h.get(b[d]).size(),e=e+k;!0==a&&(h=new UI.ProblemListRow({model:h,collection:this.model,
hideName:!1,problemType:b[d]}),0<h.size&&f.append(h.$el))}this.$("SUMMARY SPAN.title_details").last().html("("+e+")");c+=e}a=this.$el.closest(".block").find(".header");a.toggleClass("important",0<c);a.find(".title_details").html(0<c?" ("+c+")":"");return this}});
UI.ProblemsOfObject=UI.CommonProblemsList.extend({initialize:function(){UI.CommonProblemsList.prototype.initialize.apply(this,arguments);var a=this;this.id=this.options.id;this.model.on("reset",function(b){a.render()},this);this.model.on("remove",function(b){a.render()},this);this.model.on("add",function(b){a.render()},this);this.model.on("change",function(b){a.render()},this);this.render()},unbind:function(){this.model.off(null,null,this)},render:function(){this.$el.html("");var a=this.model.get(this.id),
b=!0;if(void 0==a||null==a)b=!1;for(var c=["errors","warnings","hints"],d=0;d<c.length;d++){var e=0,f=UI.template("problems-list-group-"+c[d]+"-template");this.$el.append(f());f=this.$(".content").last();e=0;b&&(e=new UI.ProblemListRow({model:a,collection:this.model,hideName:!0,problemType:c[d]}),f.append(e.$el),e=e.size);this.$("SUMMARY SPAN.title_details").last().html("("+e+")")}return this}});UI.AdditionalPropertiesCounter=1;
UI.AdditionalPropertySet=Backbone.View.extend({initialize:function(){this.properties=this.options.properties;this.availableProperty=this.options.availableProperty;this.type=this.availableProperty.get("type");UI.AdditionalPropertiesCounter++;this.elementId="additionalProperty"+UI.AdditionalPropertiesCounter;this.render()},events:{"change input[type=text]":"changeString","change input[type=radio]":"changeBoolean","change select":"changeList","click button[name='unset']":"clickUnset"},changeString:function(){var a=
this.$('input[name="'+this.elementId+'"]').val();Commands.changeAdditionalProperty(this.properties,this.model.get("id"),a)},changeBoolean:function(){var a=this.$('input:radio[name="'+this.elementId+'"]:checked').val();Commands.changeAdditionalProperty(this.properties,this.model.get("id"),a)},changeList:function(){var a=this.$('select[name="'+this.elementId+'"]').val();Commands.changeAdditionalProperty(this.properties,this.model.get("id"),a)},clickUnset:function(){Commands.disableAdditionalProperty(this.properties,
this.model.get("id"))},unbind:function(){},updateEditableReadonly:function(){app.isEditable()?(this.$("input[type=text]").attr("readonly",!1),this.$("select").attr("disabled",!1),this.$("input[type=checkbox]").attr("disabled",!1),this.$("input[type=radio]").attr("disabled",!1)):(this.$("input[type=text]").attr("readonly",!0),this.$("select").attr("disabled",!0),this.$("input[type=checkbox]").attr("disabled",!0),this.$("input[type=radio]").attr("disabled",!0))},render:function(){if("text"==this.type){var a=
UI.template("additional-property-text-template"),b=this.availableProperty.get("name");this.$el.html(a({name:b,elementId:this.elementId}));this.$('input[name="'+this.elementId+'"]').val(this.model.get("value"))}else if("boolean"==this.type)a=UI.template("additional-property-boolean-template"),b=this.availableProperty.get("name"),this.$el.html(a({name:b,elementId:this.elementId})),this.$('input[name="'+this.elementId+'"][value="'+this.model.get("value")+'"]').attr("checked","checked");else if("list"==
this.type){a=UI.template("additional-property-list-template");b=this.availableProperty.get("name");this.$el.html(a({name:b,elementId:this.elementId}));for(var a=this.availableProperty.get("options"),b=this.$("select[name='"+this.elementId+"']"),c=0;c<a.length;c++){var d=$("<option></option>");d.append(a[c]);d.attr("value",a[c]);b.append(d)}this.$('select[name="'+this.elementId+'"]').val(this.model.get("value"))}return this}});
UI.AdditionalPropertyUnset=Backbone.View.extend({initialize:function(){this.properties=this.options.properties;this.type=this.model.get("type");UI.AdditionalPropertiesCounter++;this.elementId="additionalProperty"+UI.AdditionalPropertiesCounter;this.render();this.update()},events:{"click button[name='set']":"clickSet"},clickSet:function(){Commands.enableAdditionalProperty(this.properties,this.model)},update:function(){},unbind:function(){},updateEditableReadonly:function(){this.$("input[type=text]").attr("readonly",
!0);this.$("select").attr("disabled",!0);this.$("input[type=checkbox]").attr("disabled",!0);this.$("input[type=radio]").attr("disabled",!0)},render:function(){var a=UI.template("additional-property-"+this.type+"-unset-template");this.$el.html(a({name:this.model.get("name"),elementId:this.elementId}));return this}});
UI.AdditionalProperties=Backbone.View.extend({initialize:function(){var a=this;this.availableProperties=this.options.availableProperties;this.propertiesType=this.options.propertiesType;if(void 0==this.propertiesType)throw Error("Not defined propertiesType. Internal error.");this.model.on("add",this.update,this);this.model.on("remove",this.update,this);this.model.on("change",this.update,this);_.each(this.vertabeloPlugins,function(b){b.initialize(a)});this.rows=[];this.render();this.updateEditableReadonly()},
events:{},update:function(){this.render()},updateEditableReadonly:function(){for(var a=0;a<this.rows.length;a++)this.rows[a].updateEditableReadonly()},unbind:function(){var a=this;this.model.unbind(null,null,this);for(var b=0;b<this.rows.length;b++)this.rows[b].unbind();this.rows=[];_.each(this.vertabeloPlugins,function(b){b.shutdown(a)})},render:function(){var a=UI.template("additional-properties-template");this.$el.html(a({}));for(var a=this.$(".additional-properties-list"),b=0;b<this.availableProperties.size();b++){var c=
this.availableProperties.at(b),d=this.model.get(this.availableProperties.at(b).get("id"));void 0==d&&(d=null);var e=null,e=$("<div></div>");a.append(e);e=null!=d?new UI.AdditionalPropertySet({el:e,model:d,availableProperty:c,properties:this.model}):new UI.AdditionalPropertyUnset({el:e,model:c,properties:this.model});this.rows.push(e)}var f=this;_.each(this.vertabeloPlugins,function(a){a.render(f)});return this}});UI.AdditionalProperties.prototype.vertabeloPlugins=[];
UI.AdditionalProperties.addPlugin=function(a){UI.AdditionalProperties.prototype.vertabeloPlugins.push(a)};
UI.ColorPicker=Backbone.View.extend({initialize:function(){this.render()},events:{},hide:function(){this.options.originField.focus();this.$el.hide()},generateGreyHashColors:function(){return"#000000 #434343 #666666 #999999 #B7B7B7 #CCCCCC #D9D9D9 #EFEFEF #F3F3F3 #FFFFFF".split(" ")},generateGreyRgbColors:function(){return"RGB(0, 0, 0);RGB(67, 67, 67);RGB(102, 102, 102);RGB(153, 153, 153);RGB(183, 183, 183);RGB(204, 204, 204);RGB(217, 217, 217);RGB(239, 239, 239);RGB(243, 243, 243);RGB(255, 255, 255)".split(";")},generateJuicyHashColors:function(){return"#7D0000 #FF0000 #FF9900 #FFFF00 #00FF00 #00FFFF #4A86E8 #0000FF #9900FF #FF00FF".split(" ")},
generateJuicyRgbColors:function(){return"RGB(125, 0, 0);RGB(255, 0, 0);RGB(255, 153, 0);RGB(255, 255, 0);RGB(0, 255, 0);RGB(0, 255, 255);RGB(74, 134, 232);RGB(0, 0, 255);RGB(153, 0, 255);RGB(255, 0, 255)".split(";")},generateHashColors:function(){return"#E6B8AF #F4CCCC #FCE5CD #FFF2CC #D9EAD3 #D0E0E3 #C9DAF8 #CFE2F3 #D9D2E9 #EAD1DC #DD7E6B #EA9999 #F9CB9C #FFE599 #B6D7A8 #A2C4C9 #A4C2F4 #9FC5E8 #B4A7D6 #D5A6BD #CC4125 #E06666 #F6B26B #FFD966 #93C47D #76A5AF #6D9EEB #6FA8DC #8E7CC3 #C27BA0 #A61C00 #CC0000 #E69138 #F1C232 #6AA84F #45818E #3C78D8 #3D85C6 #674EA7 #A64D79 #85200C #990000 #B45F06 #BF9000 #38761D #134F5C #1155CC #0B5394 #351C75 #741B47 #5B0F00 #660000 #783F04 #7F6000 #274E13 #0C343D #1C457D #073763 #20124D #4C1130".split(" ")},
generateRgbColors:function(){return"RGB(230, 184, 175);RGB(244, 204, 204);RGB(252, 229, 205);RGB(255, 242, 204);RGB(217, 234, 211);RGB(208, 224, 227);RGB(201, 218, 248);RGB(207, 226, 243);RGB(217, 210, 233);RGB(234, 209, 220);RGB(221, 126, 107);RGB(234, 153, 153);RGB(249, 203, 156);RGB(255, 229, 153);RGB(182, 215, 168);RGB(162, 196, 201);RGB(164, 194, 244);RGB(159, 197, 232);RGB(180, 167, 214);RGB(213, 166, 189);RGB(204, 65, 37);RGB(224, 102, 102);RGB(246, 178, 107);RGB(255, 217, 102);RGB(147, 196, 125);RGB(118, 165, 175);RGB(109, 158, 235);RGB(111, 168, 220);RGB(142, 124, 195);RGB(194, 123, 160);RGB(166, 28, 0);RGB(204, 0, 0);RGB(230, 145, 56);RGB(241, 194, 50);RGB(106, 168, 79);RGB(69, 129, 142);RGB(60, 120, 216);RGB(61, 133, 198);RGB(103, 78, 167);RGB(166, 77, 121);RGB(133, 32, 12);RGB(153, 0, 0);RGB(180, 95, 6);RGB(191, 144, 0);RGB(56, 118, 29);RGB(19, 79, 92);RGB(17, 85, 204);RGB(11, 83, 148);RGB(53, 28, 117);RGB(116, 27, 71);RGB(91, 15, 0);RGB(102, 0, 0);RGB(120, 63, 4);RGB(127, 96, 0);RGB(39, 78, 19);RGB(12, 52, 61);RGB(28, 69, 135);RGB(7, 55, 99);RGB(32, 18, 77);RGB(76, 17, 48)".split(";")},
generateTableInside:function(a,b,c,d){for(var e=" ",f=0;f<d;f++){for(var e=e+"<tr>",g=0;g<c;g++)e=e+'<td style="cursor: pointer; height: 16px; width: 16px;" id="'+a[f*c+g]+'" bgcolor="'+a[f*c+g]+'" title="'+b[f*c+g]+'" ></td>';e+="</tr>"}return e},render:function(){var a=UI.template("color-picker-template"),b=$("#color-picker"),c=this.options.originField;this.$el.html(a);a=this.generateTableInside(this.generateGreyHashColors(),this.generateGreyRgbColors(),10,1);$("#color-picker-gray-colors").append(a);
$("#color-picker-gray-colors").bind("mousedown",function(a){c.val($(a.target).attr("bgcolor"));b.hide();c.trigger("change")});a=this.generateTableInside(this.generateJuicyHashColors(),this.generateJuicyRgbColors(),10,1);$("#color-picker-juicy-colors").append(a);$("#color-picker-juicy-colors").bind("mousedown",function(a){c.val($(a.target).attr("bgcolor"));b.hide();c.trigger("change")});a=this.generateTableInside(this.generateHashColors(),this.generateRgbColors(),10,6);$("#color-picker-colors").append(a);
$("#color-picker-colors").bind("mousedown",function(a){c.val($(a.target).attr("bgcolor"));b.hide();c.trigger("change")});c.bind("keydown",function(a){13==a.keyCode&&b.hide()});c.bind("blur",function(a){b.hide()});c.bind("focus",function(a){b.show()});c.bind("mousedown",function(a){b.show()});this.$el.show();a=c.offset();this.$el.css({left:a.left-5,top:Math.max(0,a.top+c.outerHeight()+Math.min(0,app.calcHeight()-(a.top+c.outerHeight()+this.$el.outerHeight())))});return this}});
UI.EditorWindow=Backbone.View.extend({initialize:function(){this.render()},events:{"click .save-button":"save","click .cancel-button":"cancel"},fixWindow:function(){var a=this.$el.outerHeight(),a=a-this.$(".header").outerHeight(),a=a-this.$(".footer").outerHeight();this.$(".content").outerHeight(a)},render:function(){var a=this,b=UI.template("editor-window-template");this.$el.html(b({title:this.options.title}));try{this.$el.draggable("destroy"),this.$el.resizable("destroy")}catch(c){}this.$el.addClass("draggable").draggable({handle:".header"}).resizable({handles:"n, e, s, w, ne, se, sw, nw",
helper:"popup-resizable-helper",stop:function(){a.fixWindow()}});var b=this.options.origin,d={mode:b.options.mode,extraKeys:{F11:function(b){a.save()},Esc:function(b){a.cancel()}}},d=this.editor=CodeMirror.fromTextArea(this.$("textarea")[0],d);d.getWrapperElement().classList.add("CodeMirror-vertabelo-editor-field");this.show();d.setValue(this.options.origin.getValue());b=b.getCursor();d.setCursor(b.line,b.ch);d.focus()},show:function(){var a=$(window).width(),b=a/2;this.$el.css({left:b,top:108,width:a/
2,height:app.calcCenterAvailHeight()-10}).show();this.fixWindow()},hide:function(){this.$el.hide()},close:function(){this.options.editorCancelFunction(this.editor);this.hide()},save:function(){this.options.editorSaveFunction(this.editor);this.hide()},cancel:function(){this.options.editorCancelFunction(this.editor);this.hide()}});Diagram.DragDiagram={};Diagram.DragDiagram=function(a){this._initDiagram(a)};
Diagram.DragDiagram.prototype={_initDiagram:function(a){Kinetic.Stage.call(this,a);this.setAttrs(a);$(this.getContent()).css("background","transparent");this.layer=new Kinetic.Layer({x:0,y:0,width:this.getWidth(),height:this.getHeight()});var b=this;this.layer.getDiagram=function(){return b};this.add(this.layer);this.draw()},addElement:function(a){this.layer.add(a);this.draw()},removeElement:function(a){this.layer.remove(a);a.destroy();this.draw()}};Diagram.DragDiagram.prototype.trimText=Diagram.Diagram.prototype.trimText;
Kinetic.Util.extend(Diagram.DragDiagram,Kinetic.Stage);
UI.AreaNavigationListRow=Backbone.View.extend({tagName:"li",initialize:function(a){this.area=a.area;this.what=a.what;this.label=a.label;this.rowModel=a.rowModel;this.clicksMap=a.clicksMap;this.render();var b=this;this.rowModel.on("change:name",function(){b.render()},this)},events:{click:"select",contextmenu:"select","click .context-menu-trigger":"menu_call","contextmenu .context-menu-trigger":"menu_call",dblclick:"find_in_diagram"},_getClosestElement:function(a,b){var c=$(a);return c.is(b)?a:c.closest(b)[0]},
_getClosestTreeItemElement:function(a){return this._getClosestElement(a,"LI")},find_in_diagram:function(a){if(this.model instanceof Model.TableDisplay){var b=Display.selection.getSelectedElement();app.getDiagram().center(b.computeCenter())}this.model instanceof Model.Table&&(b=Display.selection.getSelectedElement(),app.getDiagram().center(b.computeCenter()));this.model instanceof Model.ReferenceDisplay&&(b=Display.selection.getSelectedElement(),app.getDiagram().center(b.computeCenter()));this.model instanceof
Model.Reference&&(b=Display.selection.getSelectedElement(),app.getDiagram().center(b.computeCenter()));this.model instanceof Model.ViewDisplay&&(b=Display.selection.getSelectedElement(),app.getDiagram().center(b.computeCenter()));this.model instanceof Model.View&&(b=Display.selection.getSelectedElement(),app.getDiagram().center(b.computeCenter()));this.model instanceof Model.Note&&(b=Display.selection.getSelectedElement(),app.getDiagram().center(b.computeCenter()));a.stopPropagation()},_getElementId:function(){return this.$el.children(":first-child").attr("id")},
incClicks:function(){var a=this._getElementId(),b=this.clicksMap[a];this.clicksMap[a]=null==b||void 0==b?1:b+1},setClicks:function(a){var b=this._getElementId();this.clicksMap[b]=a},getClicks:function(){var a=this._getElementId();return this.clicksMap[a]},select:function(a){var b=this;if(!$(a.target).is(".context-menu-trigger")){setTimeout(function(){2<=b.getClicks()&&(b.setClicks(0),b.find_in_diagram(a))},500);this.incClicks();if(this.model instanceof Model.Table){var c=Model.tableDisplays.findTableDisplayInArea(this.model.get("id"),
this.area.get("id"));null!=c&&(Display.selection.selectElement(c),app.getDiagram().center(c.computeCenter()))}this.model instanceof Model.TableDisplay&&(Display.selection.selectElement(this.model),app.getDiagram().redrawDiagram());this.model instanceof Model.Reference&&(c=Model.referenceDisplays.findReferenceDisplayInArea(this.model.get("id"),this.area.get("id")),null!=c&&(Display.selection.selectElement(c),app.getDiagram().center(c.computeCenter())));this.model instanceof Model.ReferenceDisplay&&
(Display.selection.selectElement(this.model),app.getDiagram().redrawDiagram());this.model instanceof Model.Note&&(Display.selection.selectElement(this.model),app.getDiagram().redrawDiagram());this.model instanceof Model.View&&(c=Model.viewDisplays.findViewDisplayInArea(this.model.get("id"),this.area.get("id")),null!=c&&(Display.selection.selectElement(c),app.getDiagram().center(c.computeCenter())));this.model instanceof Model.ViewDisplay&&(Display.selection.selectElement(this.model),app.getDiagram().redrawDiagram());
Display.selection.triggerSelectionChanged()}},menu_call:function(a,b){this._getClosestTreeItemElement(a.target)==this.$el[0]&&(a.preventDefault(),app.handyMenu.selectElement(this.what,this.label,this.model),app.handyMenu.show(a.target,b||{}))},render:function(){var a=UI.template("area-list-template"),b={name:this.getName(),id:"list-row-"+this.area.get("id")+"-"+this.model.get("id"),classname:""},a=a(b);this.$el.html(a);return this},getName:function(){if(this.model instanceof Model.TableDisplay){var a=
Model.tables.get(this.model.get("modelId"));return a.escape("name")}return this.model instanceof Model.ViewDisplay?(a=Model.views.get(this.model.get("modelId")),a.escape("name")):this.model instanceof Model.ReferenceDisplay?(a=Model.references.get(this.model.get("modelId")),null==a?"":a.escape("name")):this.model.escape("name")},unbindAllEvents:function(){this.rowModel.off(null,null,this)},addClass:function(a){this.$el.closest("li").addClass(a)},removeClass:function(a){this.$el.closest("li").removeClass(a)}});
UI.AreaNavigationList=Backbone.View.extend({initialize:function(a){this.area=a.area;this.type=a.type;this.what=a.what;this.displays=a.displays;this.clicksMap=a.clicksMap;this.render();var b=this;a=_.throttle(this.render,1E3,{leading:!1});this.model.on("change:name",function(a){var d=b.model.get(a.get("id"));a=b.findDisplaysInArea(a.get("id"),b.area.get("id"));1==a.length?b.moveRow(a[0]):b.moveRow(d)},this);if("reference"==this.type)this.displays.on("change:controlPoints",a,this);this.displays.on("remove",
function(a){if(a.inArea(this.area.getArea())){var d=b.findDisplaysInArea(this._getModelId(a),b.area.get("id"));0==d.length?b.removeRow(a):1==d.length&&(d=b.model.get(a.get("modelId")),b.removeRow(d),b.addRow(a))}},this);this.displays.on("add",function(a){if(a.inArea(this.area.getArea())){var d=b.findDisplaysInArea(this._getModelId(a),b.area.get("id"));1==d.length?(a=b.model.get(this._getModelId(a)),b.removeRow(a),b.addRow(a)):2==d.length&&(d=d[0].get("id")==a.get("id")?d[1]:d[0],b.removeRow(d),a=
b.model.get(a.get("modelId")),b.addRow(a))}},this);this.displays.on("resize",a,this);this.displays.on("move",a,this);this.area.on("move",a,this);this.area.on("resize",a,this);this.bindCollectionEvents()},bindCollectionEvents:function(){var a=this;Model.areas.on("move",function(){a._updateLastElementCss()});Model.areas.on("resize",function(){a._updateLastElementCss()});"view"!=this.type&&(Model.viewDisplays.on("add",function(b){b.inArea(this.area.getArea())&&a._updateLastElementCss()},this),Model.viewDisplays.on("remove",
function(b){b.inArea(this.area.getArea())&&a._updateLastElementCss()},this),Model.viewDisplays.on("move",function(b){a._updateLastElementCss()},this),Model.viewDisplays.on("resize",function(b){a._updateLastElementCss()},this),"note"!=this.type&&(Model.notes.on("add",function(b){b.inArea(this.area.getArea())&&a._updateLastElementCss()},this),Model.notes.on("remove",function(b){b.inArea(this.area.getArea())&&a._updateLastElementCss()},this),Model.notes.on("move",function(b){a._updateLastElementCss()},
this),Model.notes.on("resize",function(b){a._updateLastElementCss()},this),"reference"!=this.type&&(Model.referenceDisplays.on("add",function(b){b.inArea(this.area.getArea())&&a._updateLastElementCss()},this),Model.referenceDisplays.on("remove",function(b){b.inArea(this.area.getArea())&&a._updateLastElementCss()},this),Model.referenceDisplays.on("move",function(b){a._updateLastElementCss()},this),Model.referenceDisplays.on("resize",function(b){a._updateLastElementCss()},this))))},_updateLastElementCss:function(){this._isLastSection()?
0<this.rows.length&&this.rows[this.rows.length-1].addClass("last-visible-child"):0<this.rows.length&&this.rows[this.rows.length-1].removeClass("last-visible-child")},findDisplaysInArea:function(a,b){var c=this.displays.where({modelId:a});"note"==this.type&&(c=this.displays.where({id:a}));for(var d=Model.areas.get(b).getArea(),e=[],f=0;f<c.length;f++){var g=c[f];g.inArea(d)&&e.push(g)}return e},_findRowForElement:function(a){for(var b=0;b<this.rows.length;b++){var c=this.rows[b];if(a.get("id")===c.model.get("id"))return c}return null},
removeRow:function(a){a=this._findRowForElement(a);if(null!=a){var b=this.rows.indexOf(a);a.remove();this.rows.splice(b,1);a.unbindAllEvents();this._updateLastElementCss()}},_getModelId:function(a){var b;if(a instanceof Model.Table||a instanceof Model.View||a instanceof Model.Note||a instanceof Model.Reference)b=a.get("id");else if(a instanceof Model.TableDisplay||a instanceof Model.ViewDisplay||a instanceof Model.ReferenceDisplay)b=a.get("modelId");return b},_areObjectsInArea:function(a){for(var b=
0,c=0;c<a.size();c++)a.at(c).inArea(this.area.getArea())&&b++;return 0<b},_countDisplaysInArea:function(a){var b=this.displays.where({modelId:a});"note"==this.type&&(b=this.displays.where({id:a}));a=0;for(var c,d=null,e=0;e<b.length;e++)c=b[e],c.inArea(this.area.getArea())&&(a++,d=c);return{count:a,display:d}},addRow:function(a){var b=this,c=this.model.sortBy(this.sortByName),c=c.filter(function(a){return 0<b.findDisplaysInArea(a.get("id"),b.area.get("id")).length}),d=this._getModelId(a),e=Model.getById(d),
f=this._countDisplaysInArea(d),d=f.display,f=f.count;if(0<f){var g=this.type,h=this.type;1==f&&(g+=" shortcut",h+=" display",a=d);a=new UI.AreaNavigationListRow({model:a,rowModel:e,attributes:{"class":"nocontrol "+this.type},area:this.area,what:h,label:g,clicksMap:this.clicksMap});e=c.indexOf(e);d=this._isLastSection();0==c.length?(d&&a.addClass("last-visible-child"),this.$el.prepend(a.$el),this.rows.splice(0,0,a)):e==c.length-1?(d&&(a.addClass("last-visible-child"),0<this.rows.length&&this.rows[this.rows.length-
1].removeClass("last-visible-child")),this.$el.append(a.$el),this.rows.push(a)):(this.rows[e].$el.before(a.$el),this.rows.splice(e,0,a))}},sortByName:function(a){return a instanceof Model.TableDisplay?Model.tables.get(a.get("modelId")).get("name").toLowerCase():a instanceof Model.Table?a.get("name").toLowerCase():a instanceof Model.ReferenceDisplay?Model.references.get(a.get("modelId")).get("name").toLowerCase():a instanceof Model.ViewDisplay?Model.views.get(a.get("modelId")).get("name").toLowerCase():
a.get("name").toLowerCase()},_isLastSection:function(){if("view"==this.type)return!0;if("note"==this.type)return!this._areObjectsInArea(Model.viewDisplays);if("reference"==this.type){var a=this._areObjectsInArea(Model.viewDisplays),b=this._areObjectsInArea(Model.notes);return!b&&!a}if("table"==this.type){var a=this._areObjectsInArea(Model.viewDisplays),b=this._areObjectsInArea(Model.notes),c=this._areObjectsInArea(Model.referenceDisplays);return!b&&!a&&!c}return!1},render:function(){this.$el.html("");
this.unbindRowEvents();var a=this.model.size();this.rows=[];for(var b=this.model.sortBy(this.sortByName),c=0;c<a;c++){var d=b[c],e=this._countDisplaysInArea(d.get("id")),f=e.display,e=e.count;if(0<e){var g=this.type,h=this.type,k=d;1==e&&(g+=" shortcut",h+=" display",k=f);d=new UI.AreaNavigationListRow({model:k,rowModel:d,attributes:{"class":"nocontrol "+this.type},area:this.area,what:h,label:g,clicksMap:this.clicksMap});this.rows.push(d)}}this._isLastSection()&&0<this.rows.length&&this.rows[this.rows.length-
1].addClass("last-visible-child");for(c=0;c<this.rows.length;c++)d=this.rows[c],this.$el.append(d.$el);return this},moveRow:function(a){var b=this._findRowForElement(a);if(null!=b){var c=this.rows.indexOf(b),d=this,e=this.model.sortBy(this.sortByName),e=e.filter(function(a){return 0<d.findDisplaysInArea(a.get("id"),d.area.get("id")).length});a=this._getModelId(a);a=Model.getById(a);a=e.indexOf(a);1!=e.length&&(a==e.length-1?(this._isLastSection()&&(b.addClass("last-visible-child"),this.rows[this.rows.length-
1].removeClass("last-visible-child")),this.$el.append(b.$el),this.rows.splice(c,1)):(this.rows.splice(c,1),this.rows[a].$el.before(b.$el)),this.rows.splice(a,0,b))}},unbindAllEvents:function(){this.model.off(null,null,this);this.displays.off(null,null,this);this.area.off(null,null,this);Model.viewDisplays.off(null,null,this);Model.notes.off(null,null,this);Model.referenceDisplays.off(null,null,this);Model.areas.off(null,null,this);this.unbindRowEvents()},unbindRowEvents:function(){if(null!=this.rows)for(var a=
0;a<this.rows.length;a++)this.rows[a].unbindAllEvents()}});
UI.AreaNavigationTree=Backbone.View.extend({initialize:function(a){this.clicksMap={};this.render()},events:{},render:function(){this.tableList=new UI.AreaNavigationList({el:$('<div class="area-tables"/>').appendTo(this.$el),model:Model.tables,area:this.model,type:"table",clicksMap:this.clicksMap,displays:Model.tableDisplays});this.referenceList=new UI.AreaNavigationList({el:$('<div class="area-references"/>').appendTo(this.$el),model:Model.references,area:this.model,type:"reference",what:"reference display",
clicksMap:this.clicksMap,displays:Model.referenceDisplays});this.noteList=new UI.AreaNavigationList({el:$('<div class="area-notes"/>').appendTo(this.$el),model:Model.notes,area:this.model,type:"note",what:"note",clicksMap:this.clicksMap,displays:Model.notes});this.viewList=new UI.AreaNavigationList({el:$('<div class="area-views"/>').appendTo(this.$el),model:Model.views,area:this.model,type:"view",what:"view display",clicksMap:this.clicksMap,displays:Model.viewDisplays});return this},unbindAllEvents:function(){this.tableList.unbindAllEvents();
this.referenceList.unbindAllEvents();this.noteList.unbindAllEvents();this.viewList.unbindAllEvents()}});
UI.NavigationListRow=Backbone.View.extend({tagName:"li",initialize:function(){this.render();var a=this;this.model.on("change:name",function(b){a.render()});this.model.on("change:hasErrors",function(b){a.updateCssStyle()});this.model.on("change:hasWarnings",function(b){a.updateCssStyle()});this.model.on("change:hasHints",function(b){a.updateCssStyle()});this.model.on("change:inSearchResults",function(b){a.updateCssStyle()});this.model.on("change:selectedInSearchResults",function(b){a.updateCssStyle()});
this.model.on("setInSearchResults",function(a){});this.model.on("change:selected",function(b){a.updateCssStyle()})},events:{click:"select",contextmenu:"select","click .context-menu-trigger":"menu_call","contextmenu .context-menu-trigger":"menu_call",dblclick:"find_in_diagram",dragstart:"drag_row_start",dragstop:"drag_row_end"},_getClosestElement:function(a,b){var c=$(a);return c.is(b)?a:c.closest(b)[0]},_getClosestTreeItemElement:function(a){return this._getClosestElement(a,"LI")},drag_row_start:function(a){if(!(!1==
Model.setup.isSaveEnabled||Model.metaInfo.get("accountPlanFree"))){this.dragDiagram=new Diagram.DragDiagram({container:"helper-diagram",width:122,height:62});a=this.model.get("id");if(this.model instanceof Model.Table){var b=new Model.TableDisplay({id:Model.nextId("tableDisplay"),modelId:a,x:0.5,y:0.5,width:120,height:60,lineColor:"#000000",fillColor:"#ffffff",fixedSize:!0});a=new Diagram.Table({tableModel:Model.tables.get(a),tableLayer:this.dragDiagram.layer,tableDisplay:b})}else if(this.model instanceof
Model.View)b=new Model.ViewDisplay({id:Model.nextId("viewDisplay"),modelId:a,x:0.5,y:0.5,width:120,height:60,lineColor:"#000000",fillColor:"#C9DAF8",fixedSize:!0}),a=new Diagram.View({viewModel:Model.views.get(a),viewLayer:this.dragDiagram.layer,viewDisplay:b});else return;a.shouldDraw=function(){return!0};this.dragDiagram.addElement(a)}},drag_row_end:function(a){if(!(!1==Model.setup.isSaveEnabled||Model.metaInfo.get("accountPlanFree"))){if(this._inDiagramVisibleArea(event)){var b=$("#diagram_container").offset(),
c=app.diagram.getPosition(),d=app.diagram.getScale(),e=(-c.x+a.pageX-b.left)*(1/d.x);a=(-c.y+a.pageY-b.top)*(1/d.y);this.model instanceof Model.Table?Commands.createTableDisplay(this.model.get("id"),e,a):this.model instanceof Model.View&&Commands.createViewDisplay(this.model.get("id"),e,a)}this.dragDiagram.destroy();this.dragDiagram=null}},_inDiagramVisibleArea:function(a){var b=$("#diagram_container").offset(),c=$("#diagram_container").width(),d=$("#diagram_container").height(),c=b.left+c,e=b.top,
d=b.top+d;return b.left<a.pageX&&a.pageX<c&&e<a.pageY&&a.pageY<d},menu_call:function(a,b){this._getClosestTreeItemElement(a.target)==this.$el[0]&&(a.preventDefault(),app.handyMenu.show(a.target,b||{}))},find_in_diagram:function(a){this.model instanceof Model.Table&&(a=Display.selection.getSelectedElement(),app.getDiagram().center(a.computeCenter()));this.model instanceof Model.Reference&&(a=Display.selection.getSelectedElement(),app.getDiagram().center(a.computeCenter()));this.model instanceof Model.Note&&
(a=Display.selection.getSelectedElement(),app.getDiagram().center(a.computeCenter()));this.model instanceof Model.View&&(a=Display.selection.getSelectedElement(),app.getDiagram().center(a.computeCenter()));this.model instanceof Model.Area&&(a=Display.selection.getSelectedElement(),app.getDiagram().center(a.computeCenter()))},select:function(a){this._getClosestTreeItemElement(a.target)==this.$el[0]&&!$(a.target).is(".context-menu-trigger")&&(this.model instanceof Model.Table&&(Model.selection.selectElement(this.model),
Display.selection.selectDisplay(this.model,app.getDiagram()),app.getDiagram().redrawDiagram()),this.model instanceof Model.Reference&&(Model.selection.selectElement(this.model),Display.selection.selectDisplay(this.model,app.getDiagram()),app.getDiagram().redrawDiagram()),this.model instanceof Model.Sequence&&(Model.selection.selectElement(this.model),app.getDiagram().redrawDiagram()),this.model instanceof Model.Note&&(Display.selection.selectElement(this.model),app.getDiagram().redrawDiagram()),this.model instanceof
Model.View&&(Model.selection.selectElement(this.model),Display.selection.selectDisplay(this.model,app.getDiagram()),app.getDiagram().redrawDiagram()),this.model instanceof Model.Area&&(Display.selection.selectElement(this.model),app.getDiagram().redrawDiagram()))},_getClassNames:function(){var a=[];this.model.isSelected()&&a.push("selected");this.model.get("inSearchResults")&&a.push("in-search-results");this.model.get("hasErrors")&&a.push("has-errors");this.model.get("hasWarnings")&&a.push("has-warnings");
return a},updateCssStyle:function(){var a=this._getClassNames(),b=this.$(".div_el");b.removeClass("selected");b.removeClass("in-search-results");b.removeClass("has-errors");b.removeClass("has-warnings");_.each(a,function(a){b.addClass(a)})},render:function(){void 0!=this.areaNavigationTree&&null!=this.areaNavigationTree&&(this.areaNavigationTree.unbindAllEvents(),Model.areas.off(null,null,this));var a=UI.template("element-list-row-template");this.model instanceof Model.Area&&(a=UI.template("area-element-list-row-template"));
var b=this.model.isSelected(),c=["div_el"].concat(this._getClassNames()),b={name:this.model.escape("name"),selected:b,classname:c.join(" "),id:"list-row-"+this.model.get("id")},a=a(b);this.$el.html(a);(this.model instanceof Model.Table||this.model instanceof Model.View)&&this.makeRowDraggable();this.updateCssStyle();if(this.model instanceof Model.Area){a=this.$(".objects_list");this.areaNavigationTree=new UI.AreaNavigationTree({el:a,model:this.model});this.$el.find("div").addClass("collapsed");this.$el.find("ul").hide();
var d=this;Model.areas.on("remove",function(a){a.get("id")==d.model.get("id")&&(d.areaNavigationTree.unbindAllEvents(),Model.areas.off(null,null,d))},this)}return this},makeRowDraggable:function(){var a=$(".border_layout").children("tbody").children("tr")[1];this.$el.draggable({helper:function(a){return $("<div id='helper-diagram' style='background: transparent;'></div>")},cursor:"move",cursorAt:{top:30,left:60},zIndex:100,containment:a,opacity:1,scroll:!1})}});
UI.NavigationList=Backbone.View.extend({initialize:function(){this.render();var a=this;this.model.on("reset",function(b){a.render()});this.model.on("remove",function(b){a.removeRow(b)});this.model.on("add",function(b){a.addRow(b)});this.model.on("change:name",function(b){a.moveRow(b)})},_findRowForElement:function(a){for(var b=0;b<this.rows.length;b++){var c=this.rows[b];if(a.get("id")===c.model.get("id"))return c}return null},removeRow:function(a){a=this._findRowForElement(a);if(null!=a){var b=this.rows.indexOf(a);
a.remove();this.rows.splice(b,1)}},addRow:function(a){var b=this.model.sortBy(function(a){return a.get("name").toLowerCase()}),c=b.indexOf(a),d={};a instanceof Model.Area||(d={"class":"nocontrol"});a=new UI.NavigationListRow({model:a,collection:this.model,attributes:d});0==b.length?(this.$el.prepend(a.$el),this.rows.splice(0,0,a)):c==b.length-1?(this.$el.append(a.$el),this.rows.push(a)):(this.rows[c].$el.before(a.$el),this.rows.splice(c,0,a))},moveRow:function(a){var b=this._findRowForElement(a);
if(null!=b){var c=this.rows.indexOf(b),d=this.model.sortBy(function(a){return a.get("name").toLowerCase()});a=d.indexOf(a);1!=d.length&&(a==d.length-1?(this.$el.append(b.$el),this.rows.splice(c,1)):(this.rows.splice(c,1),this.rows[a].$el.before(b.$el)),this.rows.splice(a,0,b))}},render:function(){this.$el.html("");var a=this.model.size();this.rows=[];for(var b=this.model.sortBy(function(a){return a.get("name").toLowerCase()}),c=0;c<a;c++){var d=b[c],e={};d instanceof Model.Area||(e={"class":"nocontrol"});
d=new UI.NavigationListRow({model:d,collection:this.model,attributes:e});this.$el.append(d.$el);this.rows.push(d)}return this}});
UI.NavigationTree=Backbone.View.extend({initialize:function(){var a=this;this.render();$(document).click(function(b){a._isComponentDescendantElement(b.target)||app.handyMenu.hide()});Model.metaInfo.on("change:mode",this.updateEditableReadonly,this);Model.areas.on("add",function(b){a.showSubjectAreas();a.collapseExpandNode($("#list-row-"+b.get("id")))},this);Model.areas.on("remove",function(b){0==Model.areas.length&&Model.metaInfo.get("accountPlanFree")&&a.hideSubjectAreas()},this);Model.areas.on("reset",
function(b){0==Model.areas.length&&Model.metaInfo.get("accountPlanFree")&&a.hideSubjectAreas()},this);Model.metaInfo.on("change:accountPlanFree",function(){0==Model.areas.length&&Model.metaInfo.get("accountPlanFree")&&a.hideSubjectAreas()},this)},events:{"click LI > DIV > .context-menu-trigger":"menu_call","contextmenu LI > DIV > .context-menu-trigger":"menu_call","click LI > DIV > .control":"collapseExpand",click:"selectSection",contextmenu:"selectSection"},_isComponentDescendantElement:function(a){return!!$(a).closest(this.$el)[0]},
_getClosestElement:function(a,b){var c=$(a);return c.is(b)?a:c.closest(b)[0]},_getClosestTreeItemElement:function(a){return this._getClosestElement(a,"LI")},expandNode:function(a){a.removeClass("collapsed").nextAll("ul").show()},collapseExpandNode:function(a){a.toggleClass("collapsed").nextAll("ul").toggle()},collapseExpand:function(a){this.collapseExpandNode($(a.target).closest("div"))},selectSection:function(a){if(!$(a.target).is(".context-menu-trigger")){var b=$(a.target).closest("div").attr("id"),
b=$("#"+b);$("LI > DIV > .label").closest("div").removeClass("selected");b=b.toggleClass("selected");app.handyMenu.hide();app.isEditable()?b.hasClass("div_el")?$(b).find(".context-menu-trigger").show():"reference-list-root-node"==$(b).attr("id")?$(b).find(".context-menu-trigger").hide():$(b).find(".context-menu-trigger").show():b.hasClass("div_el")?$(b).find(".context-menu-trigger").show():$(b).find(".context-menu-trigger").hide();"contextmenu"==a.type&&(a.preventDefault(),$(".tree .context-menu-trigger:visible").trigger("click",
{contextmenu:!0,left:a.clientX}))}},menu_call:function(a,b){this._getClosestTreeItemElement(a.target).parentNode==this.$el.find("> UL ")[0]&&(a.preventDefault(),Model.selection.deselectCurrentElement(),Model.selection.triggerSelectionChanged(),app.handyMenu.selectElement($(a.target).data("what"),$(a.target).data("label"),null),app.handyMenu.show(a.target,b||{}))},onCollectionChange:function(a,b){var c=this;b.on("add",function(){c.expandNode(a)});b.on("after_validation",function(){a.removeClass("has-warnings");
a.removeClass("has-errors");0<b.where({hasErrors:!0}).length?a.addClass("has-errors"):0<b.where({hasWarnings:!0}).length&&a.addClass("has-warnings")})},updateEditableReadonly:function(){},updateLastVisibleChildClass:function(){$($("#area-list")[0]).closest(".tree > UL").find("> LI").removeClass("last-visible-child").filter(":visible").last().addClass("last-visible-child")},hideSubjectAreas:function(){$($("#area-list")[0]).closest("li").hide();this.updateLastVisibleChildClass()},showSubjectAreas:function(){$($("#area-list")[0]).closest("li").show();
this.updateLastVisibleChildClass()},render:function(){Model.supportedObjectTypes.on("reset",function(){Model.supportedObjectTypes.has("sequence")?$("#sequence-list-root-node").parent().show():$("#sequence-list-root-node").parent().hide()});
this.tableList=new UI.NavigationList({el:$("#table-list"),model:Model.tables});
this.referenceList=new UI.NavigationList({el:$("#reference-list"),model:Model.references});
this.sequenceList=new UI.NavigationList({el:$("#sequence-list"),model:Model.sequences});
this.noteList= new UI.NavigationList({el:$("#note-list"),model:Model.notes});
this.viewList=new UI.NavigationList({el:$("#view-list"),model:Model.views});
this.areaList=new UI.NavigationList({el:$("#area-list"),model:Model.areas});
this.onCollectionChange($("#table-list-root-node"),Model.tables);
this.onCollectionChange($("#reference-list-root-node"),Model.references);
this.onCollectionChange($("#sequence-list-root-node"),Model.sequences);
this.onCollectionChange($("#note-list-root-node"),Model.notes);
this.onCollectionChange($("#view-list-root-node"),Model.views);
this.onCollectionChange($("#area-list-root-node"),Model.areas);
for(var a=$(".tree > ul > li > div"),b=0;b<a.length;b++)
	this.collapseExpandNode($(a[b]));0==Model.areas.length&&Model.metaInfo.get("accountPlanFree")&&this.hideSubjectAreas();
	this.updateLastVisibleChildClass();this.updateEditableReadonly();return this}});
UI.HandyMenu=Backbone.View.extend({initialize:function(){var a=this;this.label=this.what="";Model.selection.on("element_selected",function(b){var c="";b instanceof Model.Table?c="table":b instanceof Model.Reference?c="reference":b instanceof Model.Sequence?c="sequence":b instanceof Model.Note?c="note":b instanceof Model.View?c="view":b instanceof Model.Area&&(c="area");a._selectElement(c,c,b)});Model.selection.on("element_deselected",function(b){a._selectElement("","",null);a.hide()})},_selectElement:function(a,
b,c){this.what=a;this.label=b;this.selected=c},selectElement:function(a,b,c){this._selectElement(a,b,c)},events:{"click .handy-menu-create-button":"click_create","click .handy-menu-delete-button":"click_delete","click .handy-menu-find-button":"click_find","click .handy-menu-create-ghost-button":"click_create_ghost","click .handy-menu-create-table-button":"click_create_table_in_area","click .handy-menu-create-view-button":"click_create_view_in_area","click .handy-menu-find-outside-area-button":"click_find_outside_area"},
show:function(a,b){this.render();var c=$(a),d=c.offset();this.$el.css({left:b&&b.left||d.left,top:d.top+c.outerHeight()});this.$el.show()},hide:function(){this.$el.hide()},click_create:function(){this.hide();if("table"===this.what||"tables"===this.what){var a=Model.diagramProperties.get("zoom"),b=(-Model.diagramProperties.get("position-x")+Model.applicationProperties.get("width")/2)*(1/a),a=(-Model.diagramProperties.get("position-y")+Model.applicationProperties.get("height")/2)*(1/a);Commands.createTable(b,
a)}else if("reference"!==this.what)if("sequence"===this.what||"sequences"===this.what)Commands.createSequence();else if("note"===this.what||"notes"===this.what)a=Model.diagramProperties.get("zoom"),b=(-Model.diagramProperties.get("position-x")+Model.applicationProperties.get("width")/2)*(1/a),a=(-Model.diagramProperties.get("position-y")+Model.applicationProperties.get("height")/2)*(1/a),Commands.createNote(b,a);else if("view"===this.what||"views"===this.what)a=Model.diagramProperties.get("zoom"),
b=(-Model.diagramProperties.get("position-x")+Model.applicationProperties.get("width")/2)*(1/a),a=(-Model.diagramProperties.get("position-y")+Model.applicationProperties.get("height")/2)*(1/a),Commands.createView(b,a);else if("area"===this.what||"areas"===this.what)a=Model.diagramProperties.get("zoom"),b=(-Model.diagramProperties.get("position-x")+Model.applicationProperties.get("width")/2)*(1/a),a=(-Model.diagramProperties.get("position-y")+Model.applicationProperties.get("height")/2)*(1/a),Commands.createArea(b,
a,200,100)},click_create_table_in_area:function(){var a=this.selected,b=a.get("x")+a.get("width")/2,a=a.get("y")+a.get("height")/2;Commands.createTable(b,a)},click_create_view_in_area:function(){var a=this.selected,b=a.get("x")+a.get("width")/2,a=a.get("y")+a.get("height")/2;Commands.createView(b,a)},click_create_ghost:function(){this.hide();if("table"===this.what){var a=Model.diagramProperties.get("zoom"),b=(-Model.diagramProperties.get("position-x")+Model.applicationProperties.get("width")/2)*(1/
a),a=(-Model.diagramProperties.get("position-y")+Model.applicationProperties.get("height")/2)*(1/a);Commands.createTableDisplay(this.selected.get("id"),b,a)}else"reference"!==this.what&&"view"===this.what&&(a=Model.diagramProperties.get("zoom"),b=(-Model.diagramProperties.get("position-x")+Model.applicationProperties.get("width")/2)*(1/a),a=(-Model.diagramProperties.get("position-y")+Model.applicationProperties.get("height")/2)*(1/a),Commands.createViewDisplay(this.selected.get("id"),b,a))},click_delete:function(){this.hide();
"table"===this.what?Commands.deleteTable(this.selected.get("id")):"reference"===this.what?Commands.deleteReference(this.selected.get("id")):"sequence"===this.what?Commands.deleteSequence(this.selected.get("id")):"note"===this.what?Commands.deleteNote(this.selected.get("id")):"view"===this.what?Commands.deleteView(this.selected.get("id")):"area"===this.what?Commands.deleteArea(this.selected.get("id")):"table display"==this.what?Commands.deleteTableDisplay(this.selected.get("id")):"view display"==this.what?
Commands.deleteViewDisplay(this.selected.get("id")):"reference display"==this.what&&Commands.deleteReferenceDisplay(this.selected.get("id"))},click_find:function(a){this.hide();"table"===this.what?(a=Display.selection.getSelectedElement(),app.getDiagram().center(a.computeCenter())):"reference"===this.what?(a=Display.selection.getSelectedElement(),app.getDiagram().center(a.computeCenter())):"sequence"!==this.what&&("note"===this.what?app.getDiagram().center(this.selected.computeCenter()):"view"===
this.what?(a=Display.selection.getSelectedElement(),app.getDiagram().center(a.computeCenter())):"area"===this.what?app.getDiagram().center(this.selected.computeCenter()):"table display"==this.what?app.getDiagram().center(this.selected.computeCenter()):"reference display"==this.what?app.getDiagram().center(this.selected.computeCenter()):"view display"==this.what&&app.getDiagram().center(this.selected.computeCenter()))},click_find_outside_area:function(a){this.hide();if("table"===this.what){var b=Model.areas.getTableDisplaysOutsideAreas(this.selected.get("id"));
a=1E9;for(var c=app.getDiagram().getAreaCenter(),d=null,e=0;e<b.length;e++){var f=b[e],g=Display.selection.distance(f.computeCenter(),c);g<a&&(a=g,d=f)}Display.selection.selectElement(d);app.getDiagram().center(d.computeCenter())}else if("reference"===this.what){b=Model.areas.getReferenceDisplaysOutsideAreas(this.selected.get("id"));a=1E9;c=app.getDiagram().getAreaCenter();d=null;for(e=0;e<b.length;e++)f=b[e],g=Display.selection.distance(f.computeCenter(),c),g<a&&(a=g,d=f);Display.selection.selectElement(d);
app.getDiagram().center(d.computeCenter())}else if("sequence"!==this.what)if("note"===this.what)app.getDiagram().center(this.selected.computeCenter());else if("view"===this.what){b=Model.areas.getViewDisplaysOutsideAreas(this.selected.get("id"));a=1E9;c=app.getDiagram().getAreaCenter();d=null;for(e=0;e<b.length;e++)f=b[e],g=Display.selection.distance(f.computeCenter(),c),g<a&&(a=g,d=f);Display.selection.selectElement(d);app.getDiagram().center(d.computeCenter())}else"area"===this.what?app.getDiagram().center(this.selected.computeCenter()):
"table display"==this.what?app.getDiagram().center(this.selected.computeCenter()):"reference display"==this.what?app.getDiagram().center(this.selected.computeCenter()):"view display"==this.what&&app.getDiagram().center(this.selected.computeCenter())},click_find_in_area:function(a){this.hide();"table"===this.what?(a=Model.tableDisplays.findTableDisplayInArea(this.selected.get("id"),a),null!=a&&(Display.selection.selectElement(a),app.getDiagram().center(a.computeCenter()))):"table display"===this.what?
(Display.selection.selectElement(this.selected),app.getDiagram().center(this.selected.computeCenter())):"reference"===this.what?(a=Model.referenceDisplays.findReferenceDisplayInArea(this.selected.get("id"),a),null!=a&&(Display.selection.selectElement(a),app.getDiagram().center(a.computeCenter()))):"view"===this.what&&(a=Model.viewDisplays.findViewDisplayInArea(this.selected.get("id"),a),null!=a&&(Display.selection.selectElement(a),app.getDiagram().center(a.computeCenter())))},bindClickToButton:function(a,
b,c){a.on("click",function(a){c.click_find_in_area(b.get("id"))})},render:function(){this.$el.html("");var a=UI.template("handy-menu-template");this.$el.html(a({what:this.label}));this.$(".handy-menu-create-table-button").hide();this.$(".handy-menu-create-view-button").hide();if("table"===this.what){var b=Model.tableDisplays.where({modelId:this.selected.get("id")}),a=Model.areas.getTableDisplayAreas(this.selected.get("id"));if(1==b.length||0==a.length)this.$(".handy-menu-find-outside-area-button").hide();
else{this.$(".handy-menu-find-button").hide();b=Model.areas.getTableDisplaysOutsideAreas(this.selected.get("id"));0==b.length&&this.$(".handy-menu-find-outside-area-button").hide();for(var b=UI.template("handy-menu-find-in-area-template"),c=0;c<a.length;c++){var d=a[c],e=b({area:d.get("name")});this.$el.append(e);e=this.$el.children(":last");this.bindClickToButton(e,d,this)}}}else if("view"===this.what)if(b=Model.viewDisplays.where({modelId:this.selected.get("id")}),a=Model.areas.getViewDisplayAreas(this.selected.get("id")),
1==b.length||0==a.length)this.$(".handy-menu-find-outside-area-button").hide();else{this.$(".handy-menu-find-button").hide();b=Model.areas.getViewDisplaysOutsideAreas(this.selected.get("id"));0==b.length&&this.$(".handy-menu-find-outside-area-button").hide();b=UI.template("handy-menu-find-in-area-template");for(c=0;c<a.length;c++)d=a[c],e=b({area:d.get("name")}),this.$el.append(e),e=this.$el.children(":last"),this.bindClickToButton(e,d,this)}else if("note"===this.what)this.$(".handy-menu-create-ghost-button").hide(),
this.$(".handy-menu-find-outside-area-button").hide();else if("reference"==this.what)if(this.$(".handy-menu-create-button").hide(),this.$(".handy-menu-create-ghost-button").hide(),b=Model.referenceDisplays.where({modelId:this.selected.get("id")}),a=Model.areas.getReferenceDisplayAreas(this.selected.get("id")),1==b.length||0==a.length)this.$(".handy-menu-find-outside-area-button").hide();else{this.$(".handy-menu-find-button").hide();b=Model.areas.getReferenceDisplaysOutsideAreas(this.selected.get("id"));
0==b.length&&this.$(".handy-menu-find-outside-area-button").hide();b=UI.template("handy-menu-find-in-area-template");for(c=0;c<a.length;c++)d=a[c],e=b({area:d.get("name")}),this.$el.append(e),e=this.$el.children(":last"),this.bindClickToButton(e,d,this)}else"sequence"==this.what?(this.$(".handy-menu-find-button").hide(),this.$(".handy-menu-find-outside-area-button").hide(),this.$(".handy-menu-create-ghost-button").hide()):"table display"==this.what?(this.$(".handy-menu-create-ghost-button").hide(),
this.$(".handy-menu-create-button").hide(),this.$(".handy-menu-find-outside-area-button").hide()):"view display"==this.what?(this.$(".handy-menu-create-ghost-button").hide(),this.$(".handy-menu-create-button").hide(),this.$(".handy-menu-find-outside-area-button").hide()):"reference display"==this.what?(this.$(".handy-menu-create-ghost-button").hide(),this.$(".handy-menu-create-button").hide(),this.$(".handy-menu-find-outside-area-button").hide()):"area"==this.what&&(this.$(".handy-menu-create-ghost-button").hide(),
this.$(".handy-menu-create-table-button").show(),this.$(".handy-menu-create-view-button").show(),this.$(".handy-menu-find-outside-area-button").hide());!1==app.isEditable()&&(this.$(".handy-menu-create-button").hide(),this.$(".handy-menu-create-ghost-button").hide(),this.$(".handy-menu-delete-button").hide());if("references"==this.what||"tables"==this.what||"sequences"==this.what||"notes"==this.what||"views"==this.what||"areas"==this.what)this.$(".handy-menu-delete-button").hide(),this.$(".handy-menu-delete-button").hide(),
this.$(".handy-menu-create-ghost-button").hide(),this.$(".handy-menu-find-outside-area-button").hide(),this.$(".handy-menu-find-button").hide();return this}});
UI.DatabaseTypeSelector=Backbone.View.extend({initialize:function(){this.categories=["numeric","character","datetime","large","others"];this.categoriesLabel=["Numeric","String","Date and time","Large","Other"];this.subcategories=3;this.lastRow=0;this.showPrecision=this.showLength=!1;this.categoryRow=[];var a=this;this.model.on("reset",function(){a.render()});this.model.on("change",function(){a.render()});this.render()},events:{"keydown #database_type_selector_type":"handleKeysOnInput","keydown #database_type_selector_length":"handleKeysOnInput",
"keydown #database_type_selector_precision":"handleKeysOnInput","click #database_type_selector_hide":"hide","submit #database_type_selector_form":"submit","keydown .database-type-selector-matrix":"handleNavi","change .database-type-selector-matrix":"changeTypeFromMatrixOnChange","change #database_type_selector_type":"changeType","change #database_type_selector_length":"changeLength","change #database_type_selector_precision":"changePrecision","click #database_type_selector_cancel":"escape","click #database_type_selector_ok":"submit",
"keydown #database-type-selector":"handleEscapeOrEnter"},parseType:function(a){return new Model.DatabaseTypeParsed(a)},renderParsedType:function(a){return a.render()},changeType:function(){var a=$("#database_type_selector_type").val();this.setType(a)},changeLength:function(){var a=$("#database_type_selector_length").val();null!=this.parsedType.len&&(this.parsedType.len=a,a=this.parsedType.render(),this.setType(a))},changePrecision:function(){var a=$("#database_type_selector_precision").val();null!=
this.parsedType.prec&&(this.parsedType.prec=a,a=this.parsedType.render(),this.setType(a))},changeTypeFromMatrixOnChange:function(a){a=$("#"+a.target.id).focus().val();this.changeTypeFromMatrix(a)},changeTypeFromMatrix:function(a){a=this.parseType(a);null!=a.len&&""!=$("#database_type_selector_length").val()&&(a.len=$("#database_type_selector_length").val());null!=a.prec&&""!=$("#database_type_selector_precision").val()&&(a.prec=$("#database_type_selector_precision").val());this.setType(a.render())},
setType:function(a){this.parsedType=this.parseType(a);this.updateLengthAndPrecision(this.parsedType);this.updateTypeInTypeSelector(this.parsedType);$("#database_type_selector_type").val(this.parsedType.render())},updateLengthAndPrecision:function(a){null!=a.len&&$("#database_type_selector_length").val(a.len);null!=a.prec&&$("#database_type_selector_precision").val(a.prec);$("#database_type_selector_length").attr("disabled",null==a.len);$("#database_type_selector_precision").attr("disabled",null==
a.prec)},updateTypeInTypeSelector:function(a){var b=new Model.DatabaseTypeParsed("");b.type=a.type;b.len=null;b.prec=null;null!=a.len&&(b.len="%");null!=a.prec&&(b.prec="%");var c=this.renderParsedType(b);this.$(".database-type-selector-matrix").each(function(a,b){var f=$(b);f.val()==c?f.prop("checked",!0):f.prop("checked",!1)})},handleNavi:function(a){var b=0,c=0;40==a.keyCode&&(c=1);38==a.keyCode&&(c=-1);37==a.keyCode&&(b=-1);39==a.keyCode&&(b=1);if(0!=b||0!=c){a.stopPropagation();a.preventDefault();
var d=a.target.id.split("_")[1].split("-");a=parseInt(d[0],10);for(var d=parseInt(d[1],10),e=null,f=this.lastRow;0<f;){f--;a=b+a;d=c+d;0>=a&&(a=0);a>=this.subcategories&&(a=this.subcategories-1);if(0>d){$("#database_type_selector_type").focus();return}d>=this.lastRow&&(d=this.lastRow);var g="#database-type-selector-matrix_"+a+"-"+d,e=$(g);if(0<e.length)break;else if(0!=b){for(var h=this.categoryRow[d],k=null,m=this.categoryRowStart[h];m<=this.lastRow&&this.categoryRow[m]==h;m++){g="#database-type-selector-matrix_"+
a+"-"+m;g=$(g);if(0==g.length)break;k=g}if(null!=k){e=k;break}}}null!=e&&(e.attr("checked",!0),e.focus(),this.changeTypeFromMatrix(e.val()))}else this.handleEscapeOrEnter(a)},handleKeysOnInput:function(a){40==a.keyCode?(this.$(".database-type-selector-matrix").first().focus(),this.$(".database-type-selector-matrix").filter(":checked").focus()):this.handleEscapeOrEnter(a)},handleEscapeOrEnter:function(a){27==a.keyCode?this.escape():13==a.keyCode&&this.submit()},submit:function(){this.changePrecision();
this.changeLength();this.changeType();this.accept()},accept:function(){this.originField.val($("#database_type_selector_type").val());this.originField.trigger("change");this.hide()},escape:function(){null!=this.originField&&this.hide()},hide:function(){null!=this.originField&&(this.originField.focus(),this.type=this.originField=null,this.$el.hide(),$(window).unbind("resize.database_type_selector"))},renderElement:function(a,b){return UI.template("database-type-selector-category-element")({element:a.get("type"),
x:b,y:this.lastRow})},renderElementsInRow:function(a,b,c){for(var d="",e=1;e<=this.subcategories;e++)d=void 0!==b[e]&&void 0!==b[e][c]?d+("<td>"+this.renderElement(b[e][c],e-1)+"</td>"):d+"<td>&nbsp;</td>";this.categoryRow[this.lastRow]=a;return d},renderElementsInCategory:function(a){for(var b=[],c=0,d="",e=1;e<=this.subcategories;e++)b[e]=this.model.where({category:this.categories[a],subcategory:e,isVisible:!0}),b[e].length>c&&(c=b[e].length);d="";for(e=0;e<c;e++)d+="<tr>",d+=this.renderElementsInRow(a,
b,e),d+="</tr>",this.lastRow++;return d},renderCategory:function(a){var b=UI.template("database-type-selector-category");a={category:this.categoriesLabel[a],elements:this.renderElementsInCategory(a)};return b(a)},updateTypeSelector:function(){for(var a=$("#database-type-selector-categories"),b=0;b<this.categories.length;b++)this.categoryRowStart.push(this.lastRow),a.append(this.renderCategory(b))},show:function(a,b){function c(){d.$el.find(".content").height("").width("");d.$el.show();var a=d.originField.offset(),
b=app.calcHeight()-3,c=d.$el.outerHeight();d.$el.css({left:Math.max(0,a.left-150),top:Math.max(0,a.top+Math.min(0,b-(a.top+c)))});c>b&&(a=d.$el.find(".popup2-section:visible"),c=a.find(".content"),c.outerHeight(b-a.find(".header").outerHeight()-a.find(".buttons").outerHeight()),c.outerWidth(c.outerWidth()+20))}this.originField=a;this.type=b;this.$("#database_type_selector_type").val("");this.$("#database_type_selector_length").val("");this.$("#database_type_selector_precision").val("");this.setType(b);
var d=this;c();$(window).bind("resize.database_type_selector",c);this.$("#database_type_selector_type").focus()},render:function(){this.lastRow=0;this.categoryRowStart=[];this.categoryRow=[];var a=UI.template("database-type-selector-template");this.$el.html(a({type:this.options.type}));this.updateTypeSelector();return this}});
UI.ColorPicker=Backbone.View.extend({initialize:function(){this.render()},events:{},hide:function(){this.options.originField.focus();this.$el.hide()},generateGreyHashColors:function(){return"#000000 #434343 #666666 #999999 #B7B7B7 #CCCCCC #D9D9D9 #EFEFEF #F3F3F3 #FFFFFF".split(" ")},generateGreyRgbColors:function(){return"RGB(0, 0, 0);RGB(67, 67, 67);RGB(102, 102, 102);RGB(153, 153, 153);RGB(183, 183, 183);RGB(204, 204, 204);RGB(217, 217, 217);RGB(239, 239, 239);RGB(243, 243, 243);RGB(255, 255, 255)".split(";")},
generateJuicyHashColors:function(){return"#7D0000 #FF0000 #FF9900 #FFFF00 #00FF00 #00FFFF #4A86E8 #0000FF #9900FF #FF00FF".split(" ")},generateJuicyRgbColors:function(){return"RGB(125, 0, 0);RGB(255, 0, 0);RGB(255, 153, 0);RGB(255, 255, 0);RGB(0, 255, 0);RGB(0, 255, 255);RGB(74, 134, 232);RGB(0, 0, 255);RGB(153, 0, 255);RGB(255, 0, 255)".split(";")},generateHashColors:function(){return"#E6B8AF #F4CCCC #FCE5CD #FFF2CC #D9EAD3 #D0E0E3 #C9DAF8 #CFE2F3 #D9D2E9 #EAD1DC #DD7E6B #EA9999 #F9CB9C #FFE599 #B6D7A8 #A2C4C9 #A4C2F4 #9FC5E8 #B4A7D6 #D5A6BD #CC4125 #E06666 #F6B26B #FFD966 #93C47D #76A5AF #6D9EEB #6FA8DC #8E7CC3 #C27BA0 #A61C00 #CC0000 #E69138 #F1C232 #6AA84F #45818E #3C78D8 #3D85C6 #674EA7 #A64D79 #85200C #990000 #B45F06 #BF9000 #38761D #134F5C #1155CC #0B5394 #351C75 #741B47 #5B0F00 #660000 #783F04 #7F6000 #274E13 #0C343D #1C457D #073763 #20124D #4C1130".split(" ")},
generateRgbColors:function(){return"RGB(230, 184, 175);RGB(244, 204, 204);RGB(252, 229, 205);RGB(255, 242, 204);RGB(217, 234, 211);RGB(208, 224, 227);RGB(201, 218, 248);RGB(207, 226, 243);RGB(217, 210, 233);RGB(234, 209, 220);RGB(221, 126, 107);RGB(234, 153, 153);RGB(249, 203, 156);RGB(255, 229, 153);RGB(182, 215, 168);RGB(162, 196, 201);RGB(164, 194, 244);RGB(159, 197, 232);RGB(180, 167, 214);RGB(213, 166, 189);RGB(204, 65, 37);RGB(224, 102, 102);RGB(246, 178, 107);RGB(255, 217, 102);RGB(147, 196, 125);RGB(118, 165, 175);RGB(109, 158, 235);RGB(111, 168, 220);RGB(142, 124, 195);RGB(194, 123, 160);RGB(166, 28, 0);RGB(204, 0, 0);RGB(230, 145, 56);RGB(241, 194, 50);RGB(106, 168, 79);RGB(69, 129, 142);RGB(60, 120, 216);RGB(61, 133, 198);RGB(103, 78, 167);RGB(166, 77, 121);RGB(133, 32, 12);RGB(153, 0, 0);RGB(180, 95, 6);RGB(191, 144, 0);RGB(56, 118, 29);RGB(19, 79, 92);RGB(17, 85, 204);RGB(11, 83, 148);RGB(53, 28, 117);RGB(116, 27, 71);RGB(91, 15, 0);RGB(102, 0, 0);RGB(120, 63, 4);RGB(127, 96, 0);RGB(39, 78, 19);RGB(12, 52, 61);RGB(28, 69, 135);RGB(7, 55, 99);RGB(32, 18, 77);RGB(76, 17, 48)".split(";")},
generateTableInside:function(a,b,c,d){for(var e=" ",f=0;f<d;f++){for(var e=e+"<tr>",g=0;g<c;g++)e=e+'<td style="cursor: pointer; height: 16px; width: 16px;" id="'+a[f*c+g]+'" bgcolor="'+a[f*c+g]+'" title="'+b[f*c+g]+'" ></td>';e+="</tr>"}return e},render:function(){var a=UI.template("color-picker-template"),b=$("#color-picker"),c=this.options.originField;this.$el.html(a);a=this.generateTableInside(this.generateGreyHashColors(),this.generateGreyRgbColors(),10,1);$("#color-picker-gray-colors").append(a);
$("#color-picker-gray-colors").bind("mousedown",function(a){c.val($(a.target).attr("bgcolor"));b.hide();c.trigger("change")});a=this.generateTableInside(this.generateJuicyHashColors(),this.generateJuicyRgbColors(),10,1);$("#color-picker-juicy-colors").append(a);$("#color-picker-juicy-colors").bind("mousedown",function(a){c.val($(a.target).attr("bgcolor"));b.hide();c.trigger("change")});a=this.generateTableInside(this.generateHashColors(),this.generateRgbColors(),10,6);$("#color-picker-colors").append(a);
$("#color-picker-colors").bind("mousedown",function(a){c.val($(a.target).attr("bgcolor"));b.hide();c.trigger("change")});c.bind("keydown",function(a){13==a.keyCode&&b.hide()});c.bind("blur",function(a){b.hide()});c.bind("focus",function(a){b.show()});c.bind("mousedown",function(a){b.show()});this.$el.show();a=c.offset();this.$el.css({left:a.left-5,top:Math.max(0,a.top+c.outerHeight()+Math.min(0,app.calcHeight()-(a.top+c.outerHeight()+this.$el.outerHeight())))});return this}});
UI.TableDetailsInternal={};UI.TableDetailsInternal.typeSelector=null;
UI.TableDetailsInternal.Basics=Backbone.View.extend({initialize:function(){var a=this;this.model.on("change:name",this.update,this);this.model.on("change:description",this.update,this);Model.goTo.on("goto_table/name",function(b){a.$("input[name='name']").focus()});this.render();this.update()},events:{"change input[name='name']":"changeName","change textarea[name='description']":"changeDescription","click button[name='delete']":"deleteTable"},deleteTable:function(){Commands.deleteTable(this.model.get("id"))},
changeName:function(){Commands.beginGroupCommands();Commands.changeTableName(this.model.get("id"),this.$('input[name="name"]').val());Commands.eventuallyEnlargeTableSize(this.model.get("id"));Commands.endGroupCommands()},changeDescription:function(){Commands.changeTableDescription(this.model.get("id"),this.$("textarea[name='description']").val())},update:function(){this.$('input[name="name"]').val(this.model.get("name"));this.$("textarea[name='description']").val(this.model.get("description"))},unbind:function(){this.model.off(null,
null,this);Model.goTo.off(null,null,this)},render:function(){var a=UI.template("table-details-basic-template");this.$el.html(a({}));return this}});
UI.TableDetailsInternal.Column=Backbone.View.extend({fieldsOrder:["name","type","nullable","pk"],initialize:function(){var a=this;this.model.on("change",this.update,this);Model.goTo.on("goto_table_column/name",function(b){b==a.model.get("id")&&a.$('input[name="name"]').focus()});Model.goTo.on("goto_table_column/type",function(b){b==a.model.get("id")&&a.$('input[name="type"]').focus()});Model.goTo.on("goto_table_column/nullable",function(b){b==a.model.get("id")&&a.$('input[name="nullable"]').focus()});
this.table=this.options.table;this.columns=this.options.columns;this.renderedMoreInfo=!1;this.additionalProperties=null;this.render();this.update()},events:{'change input[name="name"]':"changeName",'change input[name="type"]':"changeType",'change input[name="pk"]':"changePk",'change input[name="nullable"]':"changeNull",'change textarea[name="description"]':"changeDescription",'change input[name="default_value"]':"changeDefaultValue",'change input[name="check_expression"]':"changeCheckExpression",
'click  button[name="delete"]':"deleteColumn",'click  button[name="more"]':"toggleMore","keydown .table-details-navi-keys":"handleKeys","click .settings_button":"handleSettingsButton"},handleKeys:function(a){var b=a.target.name,c=$(a.target);if("type"==b&&13==a.keyCode)this.openDatabaseTypeSelector(c);else{var d=null;37==a.keyCode&&(d="left");39==a.keyCode&&(d="right");if(null!=d){if("name"==b||"type"==b){var e=c.val().length,c=c.caret().start;if(c<e&&"right"==d||0<c&&"left"==d)return}a.stopPropagation();
a.preventDefault();a=this.fieldsOrder.indexOf(b);"left"==d?a--:a++;0>a&&(a=0);a>=this.fieldsOrder.length&&(a=this.fieldsOrder.length-1);this.$('input[name="'+this.fieldsOrder[a]+'"]').focus()}}},handleSettingsButton:function(a){a=$(a.target).closest(".text_field_wrapper").find("input");this.openDatabaseTypeSelector(a)},openDatabaseTypeSelector:function(a){UI.TableDetailsInternal.typeSelector.show(a,$(a).val())},closeDatabaseTypeSelector:function(){UI.TableDetailsInternal.typeSelector.hide()},toggleMore:function(){this.renderMoreInfo();
this.$el.toggleClass("more-expanded");this.$(".table-details-column-more-section").toggle()},deleteColumn:function(){Commands.deleteTableColumn(this.table.get("id"),this.model.get("id"))},changeName:function(){Commands.beginGroupCommands();Commands.changeTableColumn(this.table.get("id"),this.model.get("id"),"name",this.$('input[name="name"]').val());Commands.eventuallyEnlargeTableSize(this.table.get("id"));Commands.endGroupCommands()},changeType:function(){Commands.beginGroupCommands();Commands.changeTableColumn(this.table.get("id"),
this.model.get("id"),"type",this.$('input[name="type"]').val());Commands.eventuallyEnlargeTableSize(this.table.get("id"));Commands.endGroupCommands()},changeDescription:function(){Commands.changeTableColumn(this.table.get("id"),this.model.get("id"),"description",this.$('textarea[name="description"]').val())},changeDefaultValue:function(){Commands.changeTableColumn(this.table.get("id"),this.model.get("id"),"default_value",this.$('input[name="default_value"]').val())},changeCheckExpression:function(){Commands.changeTableColumn(this.table.get("id"),
this.model.get("id"),"check_expression",this.$('input[name="check_expression"]').val())},changePk:function(){var a=this.$('input[name="pk"]').is(":checked");Commands.beginGroupCommands();Commands.changeTableColumn(this.table.get("id"),this.model.get("id"),"pk",a);a&&Commands.changeTableColumn(this.table.get("id"),this.model.get("id"),"nullable",!1);Commands.endGroupCommands()},changeNull:function(){Commands.changeTableColumn(this.table.get("id"),this.model.get("id"),"nullable",this.$('input[name="nullable"]').is(":checked"))},
unbind:function(){this.model.off(null,null,this);Model.goTo.unbind(null,null,this)},updateEditableReadonly:function(){null!=this.additionalProperties&&this.additionalProperties.updateEditableReadonly();this.model.get("pk")?this.$('input[name="nullable"]').attr("disabled",!0):this.$('input[name="nullable"]').attr("disabled",!1)},update:function(){this.$('input[name="name"]').val(this.model.get("name"));this.$('input[name="type"]').val(this.model.get("type"));this.$('input[name="pk"]').prop("checked",
this.model.get("pk"));this.$('input[name="pk"]').attr("title",this.model.get("pk")?"PRIMARY KEY":null);this.$('input[name="nullable"]').prop("checked",this.model.get("nullable"));this.$('input[name="nullable"]').attr("title",this.model.get("nullable")?"NULL":"NOT NULL");this.$('textarea[name="description"]').val(this.model.get("description"));this.$('input[name="default_value"]').val(this.model.get("default_value"));this.$('input[name="check_expression"]').val(this.model.get("check_expression"));
this.model.get("pk")?this.$('input[name="nullable"]').attr("disabled",!0):this.$('input[name="nullable"]').attr("disabled",!1)},renderMoreInfo:function(){this.renderedMoreInfo||(this.additionalProperties=new UI.AdditionalProperties({el:this.$(".additional-properties"),model:this.model.get("properties"),propertiesType:"column",availableProperties:Model.availableColumnProperties}),this.renderedMoreInfo=!0)},render:function(){var a=UI.template("table-details-columns-column-template");this.$el.html(a({id:this.model.get("id")}));
return this}});
UI.TableDetailsInternal.Columns=Backbone.View.extend({initialize:function(){this.columns=[];var a=this.model.get("columns");a.on("after-add",this.onAddColumn,this);a.on("remove",this.onRemoveColumn,this);this.render()},events:{'click button[name="add-column"]':"addColumn","keydown .table-details-navi-keys":"handleKeys"},handleKeys:function(a){var b=$(a.target).closest("tbody"),c=a.target.name;this.$('input[name="'+c+'"]');var d=null;40==a.keyCode&&(d="down");38==a.keyCode&&(d="up");null!=d&&(a.stopPropagation(),
a.preventDefault(),"down"==d?(a=b.next(),0<a.length?a.find("input[name='"+c+"']").focus():this.addColumn()):"up"==d&&b.prev().find("input[name='"+c+"']").focus())},addColumn:function(){this.$(":focus").blur();Commands.beginGroupCommands();Commands.createTableColumn(this.model.get("id"));Commands.eventuallyEnlargeTableSize(this.model.get("id"));Commands.endGroupCommands();$(".table-details-columns-list").children().last().find('input[name="name"]').focus().select()},onAddColumn:function(a){var b=this.model.get("columns");
b.at(b.size()-1).get("id")==a.get("id")?(b=this.getColumnsContainer(),a=this.renderColumn(a,b),this.columns.push(a)):this.update()},onRemoveColumn:function(a){for(var b=a.get("id"),c=0;c<this.columns.length;c++){var d=this.columns[c];if(d.model.get("id")==b){d.$(":focus").blur();d.unbind();d.remove();this.columns.splice(c,1);a=this.getColumnContainerId(a.get("id"));$("#"+a).remove();this.getColumnsContainer();break}}},unbind:function(){this.model.get("columns").off(null,null,this);this.model.off(null,
null,this)},update:function(){this.renderColumns()},removeColumns:function(){for(var a=0;a<this.columns.length;a++){var b=this.columns[a];b.unbind();b.remove()}},updateEditableReadonly:function(){for(var a=0;a<this.columns.length;a++)this.columns[a].updateEditableReadonly()},getColumnContainerId:function(a){return"table-details-column-"+a},getColumnsContainer:function(){var a=this.model.get("columns"),b=this.$(".table-details-columns-list");b.find("thead").toggle(0<a.length);1<a.length?b.sortable("enable"):
b.sortable("disable");return b},renderColumn:function(a,b){var c=this.getColumnContainerId(a.get("id")),d=$("<tbody></tbody>");b.append(d);d.attr("id",c);d.attr("columnid",a.get("id"));return new UI.TableDetailsInternal.Column({el:d,model:a,table:this.model,columns:this.columns})},renderColumns:function(){this.removeColumns();for(var a=this.model.get("columns"),b=this.getColumnsContainer(),c=0;c<a.length;c++){var d=a.at(c),d=this.renderColumn(d,b);this.columns.push(d)}},sortable:function(){var a=
this;this.$(".table-details-columns-list").sortable({placeholder:"ui-state-highlight",update:function(b,c){var d=[];a.$(".table-details-columns-list").children().not("THEAD").each(function(a,b){d.push($(b).attr("columnid"))});Commands.setTableColumnsOrder(a.model.get("id"),d)},items:"> TBODY"});$("#details_column_list").disableSelection()},render:function(){var a=UI.template("table-details-columns-template");this.$el.html(a({}));this.sortable();this.renderColumns();return this}});
UI.TableDetailsInternal.AlternateKey=Backbone.View.extend({initialize:function(){var a=this;this.model.on("change",this.update,this);this.table=this.options.table;this.keys=this.options.keys;var b=this.table.get("columns");b.on("add",this.update,this);b.on("remove",this.update,this);b.on("change:name",this.update,this);b.on("change:nullable",this.update,this);Model.goTo.on("goto_table_alternate_key/name",function(b){b==a.model.get("id")&&a.$('input[name="name"]').focus()});Model.goTo.on("goto_table_alternate_key/columns",
function(b){b==a.model.get("id")&&(a.$(".table-details-alternate-keys-key-more").show(),a.$('select[name="columns"]').focus())});this.render();this.update()},events:{"click button[name='more']":"toggleMore","click button[name='remove']":"removeKey","change input[name='name']":"change","change textarea[name='description']":"change","click button[name='add-column']":"addColumn","click button[name='remove-column']":"removeColumn"},addColumn:function(){for(var a=this.$('select[name="columns"] option:selected').val(),
b=this.model.get("columns"),c=[],d=0;d<b.length;d++)c.push(b[d]);0<=c.indexOf(a)||(c.push(a),Commands.changeTableAlternateKey(this.table.get("id"),this.model.get("id"),"columns",c))},removeColumn:function(a){a=$(a.target).attr("columnid");for(var b=this.model.get("columns"),c=[],d=0;d<b.length;d++)a!=b[d]&&c.push(b[d]);Commands.changeTableAlternateKey(this.table.get("id"),this.model.get("id"),"columns",c)},change:function(a){var b=a.target.name;a=a.target.value;Commands.changeTableAlternateKey(this.table.get("id"),
this.model.get("id"),b,a)},removeKey:function(){Commands.deleteTableAlternateKey(this.table.get("id"),this.model.get("id"))},toggleMore:function(){this.$el.toggleClass("more-expanded");this.$(".table-details-alternate-keys-key-more").toggle()},updateSelectedColumns:function(){var a=this.$(".table-details-alternate-keys-key-columns");a.html("");for(var b=UI.template("table-details-alternate-keys-key-column-template"),c=this.table.get("columns"),d=0;d<this.model.get("columns").length;d++){var e=this.model.get("columns")[d],
f=c.get(e);dbwm.check(f,"Column must exists "+e).notNull();e=b({id:e,name:f.get("name")});a.append(e)}},updateAvailableColumns:function(){var a=this.$('select[name="columns"]');a.html("");for(var b=this.model.get("columns"),c=0,d=0;d<this.table.get("columns").size();d++){var e=this.table.get("columns").at(d);if(!(0<=b.indexOf(e.get("id")))){var f=$("<option></option>");f.attr("value",e.get("id"));f.append(e.get("name"));a.append(f);c++}}0<c?this.$(".table-details-alternate-keys-key-add-column").show():
this.$(".table-details-alternate-keys-key-add-column").hide()},updateEditableReadonly:function(){this.additionalProperties.updateEditableReadonly()},update:function(){this.$("input[name='name']").val(this.model.get("name"));this.$("textarea[name='description']").val(this.model.get("description"));this.updateAvailableColumns();this.updateSelectedColumns()},unbind:function(){this.model.off(null,null,this);this.table.off(null,null,this);this.table.get("columns").off(null,null,this);null!=this.additionalProperties&&
this.additionalProperties.unbind();Model.goTo.unbind(null,null,this)},sortable:function(){var a=this;this.$(".table-details-alternate-keys-key-columns").sortable({placeholder:"ui-state-highlight",update:function(b,c){var d=[];a.$(".table-details-alternate-keys-key-columns").children().each(function(a,b){d.push($(b).attr("columnid"))});Commands.changeTableAlternateKey(a.table.get("id"),a.model.get("id"),"columns",d)}})},render:function(){var a=UI.template("table-details-alternate-keys-key-template");
this.$el.html(a({id:this.model.get("id")}));this.sortable();this.additionalProperties=new UI.AdditionalProperties({el:this.$(".additional-properties"),model:this.model.get("properties"),propertiesType:"alternate_key",availableProperties:Model.availableAlternateKeyProperties});return this}});
UI.TableDetailsInternal.AlternateKeys=Backbone.View.extend({initialize:function(){this.keys=[];var a=this.model.get("alternateKeys");a.on("add",this.update,this);a.on("remove",this.update,this);this.render()},events:{"click button[name='add-key']":"addKey"},addKey:function(){Commands.createTableAlternateKey(this.model.get("id"));$(".table-details-alternate-keys-list").children().last().find('input[name="name"]').focus().select()},update:function(){this.renderKeys()},unbind:function(){this.model.get("alternateKeys").off(null,
null,this);this.model.off(null,null,this)},removeKeys:function(){for(var a=0;a<this.keys.length;a++){var b=this.keys[a];b.unbind();b.remove()}},updateEditableReadonly:function(){for(var a=0;a<this.keys.length;a++)this.keys[a].updateEditableReadonly()},renderKeys:function(){this.removeKeys();for(var a=this.model.get("alternateKeys"),b=this.$(".table-details-alternate-keys-list"),c=0;c<a.length;c++){var d=a.at(c),d=new UI.TableDetailsInternal.AlternateKey({tagName:"li",model:d,table:this.model,keys:this.keys});
b.append(d.$el);this.keys.push(d)}},render:function(){var a=UI.template("table-details-alternate-keys-template");this.$el.html(a({}));this.renderKeys();return this}});
UI.TableDetailsInternal.Index=Backbone.View.extend({initialize:function(){var a=this;this.model.on("change",this.update,this);this.table=this.options.table;this.indexes=this.options.indexes;var b=this.table.get("columns");b.on("add",this.update,this);b.on("remove",this.update,this);b.on("change:name",this.update,this);b.on("change:nullable",this.update,this);Model.goTo.on("goto_table_index/name",function(b){b==a.model.get("id")&&a.$('input[name="name"]').focus()});Model.goTo.on("goto_table_index/columns",
function(b){b==a.model.get("id")&&(a.$(".table-details-indexes-index-more").show(),a.$('select[name="columns"]').focus())});this.render();this.update()},events:{"click button[name='more']":"toggleMore","click button[name='remove']":"removeIndex","change input[name='name']":"change","change textarea[name='description']":"change","change select[name='ascending']":"changeAscending","click button[name='add-column']":"addColumn","click button[name='remove-column']":"removeColumn"},addColumn:function(){for(var a=
this.$('select[name="columns"] option:selected').val(),b=this.model.get("columns"),c=[],d=0;d<b.length;d++){if(b[d].id==a)return;c.push(b[d])}c.push({id:a,ascending:!0});Commands.changeTableIndex(this.table.get("id"),this.model.get("id"),"columns",c)},removeColumn:function(a){a=$(a.target).attr("columnid");for(var b=this.model.get("columns"),c=[],d=0;d<b.length;d++)a!=b[d].id&&c.push(b[d]);Commands.changeTableIndex(this.table.get("id"),this.model.get("id"),"columns",c)},change:function(a){var b=a.target.name;
a=a.target.value;Commands.changeTableIndex(this.table.get("id"),this.model.get("id"),b,a)},removeIndex:function(){Commands.deleteTableIndex(this.table.get("id"),this.model.get("id"))},toggleMore:function(){this.$el.toggleClass("more-expanded");this.$(".table-details-indexes-index-more").toggle()},changeAscending:function(a){a=$(a.target).attr("columnid");for(var b=[],c="true"==this.$('select[columnid="'+a+'"]').val()?!0:!1,d=0;d<this.model.get("columns").length;d++){var e={},f=this.model.get("columns")[d];
e.id=f.id;e.ascending=f.ascending;e.id==a&&(e.ascending=c);b.push(e)}Commands.changeTableIndex(this.table.get("id"),this.model.get("id"),"columns",b)},updateSelectedColumns:function(){var a=this.$(".table-details-indexes-index-columns");a.html("");for(var b=UI.template("table-details-indexes-index-column-template"),c=this.table.get("columns"),d=0;d<this.model.get("columns").length;d++){var e=this.model.get("columns")[d].id,f=""+this.model.get("columns")[d].ascending,g=c.get(e);dbwm.check(g,"Column must exists "+
e).notNull();g=b({id:e,ascending:f,name:g.get("name")});a.append(g);this.$('select[columnid="'+e+'"]').val(f)}},updateAvailableColumns:function(){var a=this.$('select[name="columns"]');a.html("");for(var b=[],c=0;c<this.model.get("columns").length;c++)b.push(this.model.get("columns")[c].id);for(var d=0,c=0;c<this.table.get("columns").size();c++){var e=this.table.get("columns").at(c);if(!(0<=b.indexOf(e.get("id")))){var f=$("<option></option>");f.attr("value",e.get("id"));f.append(e.get("name"));a.append(f);
d++}}0<d?this.$(".table-details-indexes-index-add-column").show():this.$(".table-details-indexes-index-add-column").hide()},update:function(){this.$("input[name='name']").val(this.model.get("name"));this.$("textare[name='description']").val(this.model.get("description"));this.updateAvailableColumns();this.updateSelectedColumns()},updateEditableReadonly:function(){this.additionalProperties.updateEditableReadonly()},unbind:function(){this.model.off(null,null,this);this.table.off(null,null,this);this.table.get("columns").off(null,
null,this);null!=this.additionalProperties&&this.additionalProperties.unbind();Model.goTo.off(null,null,this)},sortable:function(){var a=this;this.$(".table-details-indexes-index-columns").sortable({placeholder:"ui-state-highlight",update:function(b,c){for(var d=[],e=a.model.get("columns"),f={},g=0;g<e.length;g++)f[e[g].id]=e[g];a.$(".table-details-indexes-index-columns").children().each(function(a,b){d.push(f[$(b).attr("columnid")])});Commands.changeTableIndex(a.table.get("id"),a.model.get("id"),
"columns",d)}})},render:function(){var a=UI.template("table-details-indexes-index-template");this.$el.html(a({id:this.model.get("id")}));this.sortable();this.additionalProperties=new UI.AdditionalProperties({el:this.$(".additional-properties"),propertiesType:"index",model:this.model.get("properties"),availableProperties:Model.availableIndexProperties});return this}});
UI.TableDetailsInternal.Indexes=Backbone.View.extend({initialize:function(){this.indexes=[];var a=this.model.get("indexes");a.on("add",this.update,this);a.on("remove",this.update,this);this.render()},events:{"click button[name='add-index']":"addIndex"},addIndex:function(){Commands.createTableIndex(this.model.get("id"));$(".table-details-indexes-list").children().last().find('input[name="name"]').focus().select()},update:function(){this.renderIndexes()},unbind:function(){this.model.get("indexes").off(null,
null,this);this.model.off(null,null,this)},updateEditableReadonly:function(){for(var a=0;a<this.indexes.length;a++)this.indexes[a].updateEditableReadonly()},removeIndexes:function(){for(var a=0;a<this.indexes.length;a++){var b=this.indexes[a];b.unbind();b.remove()}},renderIndexes:function(){this.removeIndexes();for(var a=this.model.get("indexes"),b=this.$(".table-details-indexes-list"),c=0;c<a.size();c++){var d=a.at(c),d=new UI.TableDetailsInternal.Index({tagName:"li",model:d,table:this.model,indexes:this.indexes});
b.append(d.$el);this.indexes.push(d)}},render:function(){var a=UI.template("table-details-indexes-template");this.$el.html(a({}));this.renderIndexes();return this}});
UI.TableDetailsInternal.TableCheck=Backbone.View.extend({initialize:function(){var a=this;this.additionalProperties=null;this.model.on("change",this.update,this);this.table=this.options.table;this.tableChecks=this.options.tableChecks;Model.goTo.on("goto_table_table_check/name",function(b){b==a.model.get("id")&&a.$('input[name="name"]').focus()});Model.goTo.on("goto_table_table_check/checkExpression",function(b){b==a.model.get("id")&&(a.$(".table-details-table-checks-table-check-more").show(),a.$('textarea[name="checkExpression"]').focus())});
this.render();this.update()},events:{"click button[name='more']":"toggleMore","click button[name='remove']":"removeTableCheck","change textarea[name='checkExpression']":"change","change input[name='name']":"change","change textarea[name='description']":"change"},toggleMore:function(){this.$el.toggleClass("more-expanded");this.$(".table-details-table-checks-table-check-more").toggle();this.sqlEditor.refresh()},change:function(a){var b=a.target.name;a=a.target.value;Commands.changeTableTableCheck(this.table.get("id"),
this.model.get("id"),b,a)},removeTableCheck:function(){Commands.deleteTableTableCheck(this.table.get("id"),this.model.get("id"))},update:function(){this.$("input[name='name']").val(this.model.get("name"));this.$("textarea[name='description']").val(this.model.get("description"));this.sqlEditor.setValue(this.model.get("checkExpression"))},updateEditableReadonly:function(){this.additionalProperties.updateEditableReadonly()},unbind:function(){this.model.off(null,null,this);this.table.off(null,null,this);
null!=this.additionalProperties&&this.additionalProperties.unbind();null!=this.sqlEditor&&this.sqlEditor.close()},render:function(){var a=UI.template("table-details-table-checks-table-check-template");this.$el.html(a({id:this.model.get("id")}));var b=this;this.additionalProperties=new UI.AdditionalProperties({el:this.$(".additional-properties"),model:this.model.get("properties"),propertiesType:"table_check",availableProperties:Model.availableTableCheckProperties});this.sqlEditor=new UI.SQLEditor(this.table.get("name")+
"/"+this.model.get("name")+" - Table check expression",this.$("textarea[name='checkExpression']").get(0));this.$el.bind("section:show",function(){b.sqlEditor.refresh()});return this}});
UI.TableDetailsInternal.TableChecks=Backbone.View.extend({initialize:function(){this.tableChecks=[];var a=this.model.get("tableChecks");a.on("add",this.update,this);a.on("remove",this.update,this);this.render()},events:{"click button[name='add-table-check']":"addTableCheck"},addTableCheck:function(){Commands.createTableTableCheck(this.model.get("id"));$(".table-details-table-checks-list").children().last().find('input[name="name"]').focus().select()},update:function(){this.renderTableChecks()},unbind:function(){this.model.get("tableChecks").off(null,
null,this);this.model.off(null,null,this)},updateEditableReadonly:function(){for(var a=0;a<this.tableChecks.length;a++)this.tableChecks[a].updateEditableReadonly()},removeTableChecks:function(){for(var a=0;a<this.tableChecks.length;a++){var b=this.tableChecks[a];b.unbind();b.remove()}},renderTableChecks:function(){this.removeTableChecks();for(var a=this.model.get("tableChecks"),b=this.$(".table-details-table-checks-list"),c=0;c<a.size();c++){var d=new UI.TableDetailsInternal.TableCheck({tagName:"li",
model:a.at(c),table:this.model,tableChecks:this.tableChecks});b.append(d.$el);this.tableChecks.push(d)}},render:function(){var a=UI.template("table-details-table-checks-template");this.$el.html(a({}));this.renderTableChecks();return this}});
UI.TableDetailsInternal.AdditionalSql=Backbone.View.extend({initialize:function(){var a=this;this.model.on("change:additionalSqlBefore",this.update,this);this.model.on("change:additionalSqlAfter",this.update,this);this.render();this.update();this.refresh();this.$el.bind("section:show",function(){a.refresh()})},events:{"change textarea":"change"},change:function(a){var b=a.target.name;a=a.target.value;Commands.changeTable(this.model.get("id"),b,a)},unbind:function(){this.sqlBeforeEditor.close();this.sqlAfterEditor.close();
this.model.off(null,null,this)},update:function(){this.sqlBeforeEditor.setValue(this.model.get("additionalSqlBefore"));this.sqlAfterEditor.setValue(this.model.get("additionalSqlAfter"))},refresh:function(){this.sqlBeforeEditor.refresh();this.sqlAfterEditor.refresh()},render:function(){var a=UI.template("table-details-table-additional-sql-template");this.$el.html(a({}));this.sqlBeforeEditor=new UI.SQLEditor(this.model.get("name")+" - Additional SQL Script - before table",this.$("textarea[name='additionalSqlBefore']").get(0));
this.sqlAfterEditor=new UI.SQLEditor(this.model.get("name")+" - Additional SQL Script - after table",this.$("textarea[name='additionalSqlAfter']").get(0));return this}});
UI.TableDetailsInternal.Format=Backbone.View.extend({initialize:function(){this.model.on("change:fillColor",this.update,this);this.model.on("change:lineColor",this.update,this);this.model.on("change:fixedSize",this.update,this);this.render();this.update()},events:{"change input[name='lineColor']":"change","change input[name='fillColor']":"change","change input[name='fixedSize']":"changeFixedSize","focus input[name='lineColor']":"handleFocus","focus input[name='fillColor']":"handleFocus","keydown input[name='lineColor']":"handleKeyDown",
"keydown input[name='fillColor']":"handleKeyDown","keydown input[name='fixedSize']":"handleKeyDown"},handleFocus:function(a){!1!=app.isEditable()&&($(a.target).parent(),a=this.$('input[name="'+a.target.name+'"]'),this.colorSelector=new UI.ColorPicker({el:$("#color-picker"),model:null,originField:a,type:a.val()}))},handleKeyDown:function(a){if(13==a.keyCode){var b=a.target.name;if("fillColor"==b||"lineColor"==b){var c=a.target.value;$(a.target).css({"background-color":a.target.value})}Commands.changeTableDisplay(this.model.get("id"),
b,c)}},change:function(a){var b=a.target.name,c=a.target.value;$(a.target).css({"background-color":a.target.value});Commands.changeTableDisplay(this.model.get("id"),b,c)},changeFixedSize:function(a){Commands.changeTableDisplay(this.model.get("id"),"fixedSize",this.$("input[name=fixedSize][value=true]").is(":checked"))},unbind:function(){this.model.off(null,null,this)},update:function(){this.$("input[name=lineColor]").val(this.model.get("lineColor"));this.$("input[name=fillColor]").val(this.model.get("fillColor"));
this.$("input[name=fixedSize][value=true]").attr("checked",this.model.get("fixedSize"));this.$("input[name=fixedSize][value=false]").attr("checked",!this.model.get("fixedSize"));this.$("input[name=lineColor]").css({"background-color":this.model.get("lineColor")});this.$("input[name=fillColor]").css({"background-color":this.model.get("fillColor")})},set:function(a,b){Commands.changeTableDisplay(this.model.get("id"),a,b)},render:function(){var a=UI.template("table-details-format-template");this.$el.html(a({}));
return this}});
UI.TableDetails=Backbone.View.extend({initialize:function(){var a=this;this.selectedDisplay=this.selected=this.columns=this.basics=null;this.sectionOpenStatus={};this.sectionOpenStatus={"primary-data":!0,columns:!0};Model.selection.on("element_selected",function(b){b instanceof Model.Table&&(a.selected=b,a.render())});Display.selection.on("element_selected",function(b){b instanceof Model.TableDisplay&&(a.selectedDisplay=b,a.render())});Model.selection.on("element_deselected",function(b){b instanceof Model.Table&&
(a.$(":focus").blur(),a.selected=null,a.hide(),UI.TableDetailsInternal.typeSelector.hide())});Display.selection.on("element_deselected",function(b){b instanceof Model.TableDisplay&&(a.$(":focus").blur(),a.selectedDisplay=null,a.hide(),UI.TableDetailsInternal.typeSelector.hide())});Model.goTo.on("goto_table_column",function(b){a.sectionOpenStatus.columns=!0;a.updateOpenedSection()});Model.goTo.on("goto_table_index",function(b){a.sectionOpenStatus.indexes=!0;a.updateOpenedSection()});Model.goTo.on("goto_table_alternate_key",
function(b){a.sectionOpenStatus["alternate-keys"]=!0;a.updateOpenedSection()});Model.goTo.on("goto_table_table_check",function(b){a.sectionOpenStatus.checks=!0;a.updateOpenedSection()});Model.metaInfo.on("change:mode",a.updateEditableReadonly,this);this.$el.hide()},events:{"click summary":"toggleDetails","click .preview-button":"showSqlPreview"},showSqlPreview:function(){SqlGenerator.Preview.preview("table",this.selected.get("id"))},updateEditableReadonly:function(){var a="button[name=add-table-check] button[name=add-index] button[name=add-key] button[name=add-column] button[name=delete] .settings_button .preview-button".split(" "),
b=!1;!1==app.isEditable()?(this.$("input[type=text]").attr("readonly",!0),this.$("textarea").attr("readonly",!0),this.$("select").attr("disabled",!0),this.$("input[type=checkbox]").attr("disabled",!0),this.$("input[type=radio]").attr("disabled",!0),b=!0):(this.$("input[type=text]").attr("readonly",!1),this.$("textarea").attr("readonly",!1),this.$("select").attr("disabled",!1),this.$("input[type=checkbox]").attr("disabled",!1),this.$("input[type=radio]").attr("disabled",!1),b=!1);for(var c=0;c<a.length;c++)b?
this.$(a[c]).hide():this.$(a[c]).show();null!=this.additionalProperties&&this.additionalProperties.updateEditableReadonly();null!=this.columns&&this.columns.updateEditableReadonly();null!=this.indexes&&this.indexes.updateEditableReadonly();null!=this.tableChecks&&this.tableChecks.updateEditableReadonly();null!=this.alternateKeys&&this.alternateKeys.updateEditableReadonly()},toggleDetails:function(a){a=$(a.currentTarget).closest(".details");var b=a.attr("section"),c=a.attr("open"),c=!(void 0==c?0:
"open"==c);this.sectionOpenStatus[b]=c;$(a).find(".content > div").trigger(c?"section:show":"section:hide")},updateOpenedSection:function(){this.$("#table-details-common > .details").removeAttr("open");for(var a in this.sectionOpenStatus)!0==this.sectionOpenStatus[a]?(this.$(".details[section="+a+"]").attr("open","open"),this.$(".details[section="+a+"]  .content > div").trigger("section:show")):(this.$(".details[section="+a+"]").removeAttr("open"),this.$(".details[section="+a+"]  .content > div").trigger("section:hide"))},
unbind:function(){null!=this.basics&&(this.basics.unbind(),this.basics=null);null!=this.columns&&(this.columns.unbind(),this.columns=null);null!=this.alternateKeys&&(this.alternateKeys.unbind(),this.alternateKeys=null);null!=this.indexes&&(this.indexes.unbind(),this.indexes=null);null!=this.tableChecks&&(this.tableChecks.unbind(),this.tableChecks=null);null!=this.additionalSql&&(this.additionalSql.unbind(),this.additionalSql=null);null!=this.format&&(this.format.unbind(),this.format=null);null!=this.problems&&
(this.problems.unbind(),this.porblems=null)},hide:function(){this.unbind();this.$el.html("")},render:function(){this.unbind();var a=UI.template("table-details-template");this.$el.html(a({}));null!=this.selected&&(this.basics=new UI.TableDetailsInternal.Basics({el:this.$(".table-details-basic"),model:this.selected}),this.columns=new UI.TableDetailsInternal.Columns({el:this.$(".table-details-columns"),model:this.selected}),this.alternateKeys=new UI.TableDetailsInternal.AlternateKeys({el:this.$(".table-details-alternate-keys"),
model:this.selected}),this.indexes=new UI.TableDetailsInternal.Indexes({el:this.$(".table-details-indexes"),model:this.selected}),this.tableChecks=new UI.TableDetailsInternal.TableChecks({el:this.$(".table-details-table-checks"),model:this.selected}),this.additionalSql=new UI.TableDetailsInternal.AdditionalSql({el:this.$(".table-details-additional-sql"),model:this.selected}),this.additionalProperties=new UI.AdditionalProperties({el:this.$(".table-details-additional-properties"),model:this.selected.get("properties"),
propertiesType:"table",availableProperties:Model.availableTableProperties}),this.problems=new UI.ProblemsOfObject({el:this.$("#table-details-problems .content"),model:Model.problemReports,id:this.selected.get("id")}));null!=this.selectedDisplay&&(this.format=new UI.TableDetailsInternal.Format({el:this.$(".table-details-format"),model:this.selectedDisplay}));this.$el.show();this.updateOpenedSection();this.updateEditableReadonly();return this}});
UI.ReferenceDetails=Backbone.View.extend({initialize:function(){var a=this;this.selectedDisplay=this.selected=null;Model.selection.on("element_selected",function(b){b instanceof Model.Reference&&(a.selected=b,a.$el.show(),a.update())});Display.selection.on("element_selected",function(b){b instanceof Model.ReferenceDisplay&&(a.selectedDisplay=b,a.$el.show(),a.update())});Model.selection.on("element_deselected",function(b){b instanceof Model.Reference&&(a.$(":focus").blur(),a.selected=null,a.$el.hide())});
Display.selection.on("element_deselected",function(b){b instanceof Model.ReferenceDisplay&&(a.$(":focus").blur(),a.selectedDisplay=null,a.$el.hide())});this.model.on("change",function(b,c){null!=a.selected&&!b.hasChanged("selected")&&!b.hasChanged("attached")&&b==a.selected&&a.update()});Model.goTo.on("goto_reference/name",function(a){$("#reference-details-name").focus()});Model.goTo.on("goto_reference/onDeleteAction",function(a){$("#reference-details-delete-constraint-action").focus()});Model.goTo.on("goto_reference/onUpdateAction",
function(a){$("#reference-details-update-constraint-action").focus()});Model.metaInfo.on("change:mode",a.updateEditableReadonly,this);this.tables=this.options.tables;dbwm.check(this.tables).notNull();this.$el.hide();this.render()},updateEditableReadonly:function(){var a=["#reference-details-swap-button","#reference-details-add-column-button",".reference-details-column-delete-button",".preview-button"],b=!1;!1==app.isEditable()?(this.$("input[type=text]").attr("readonly",!0),this.$("textarea").attr("readonly",
!0),this.$("select").attr("disabled",!0),this.$("input[type=checkbox]").attr("disabled",!0),b=!0):(this.$("input[type=text]").attr("readonly",!1),this.$("textarea").attr("readonly",!1),this.$("select").attr("disabled",!1),this.$("input[type=checkbox]").attr("disabled",!1),b=!1);for(var c=0;c<a.length;c++)b?this.$(a[c]).hide():this.$(a[c]).show();null!=this.additionalProperties&&this.additionalProperties.updateEditableReadonly()},events:{"change #reference-details-name":"changeName","change #reference-details-description":"changeDescription",
"click  #reference-details-add-column-button":"addColumn","click .reference-details-column-delete-button":"removeColumns","change #reference-details-cardinality-selector":"changeCardinality","change #reference-details-pk-role":"changePkRole","change #reference-details-fk-role":"changeFkRole","click  #reference-details-delete-button":"delete","click  #reference-details-swap-button":"swap","change #reference-details-delete-constraint-action":"changeOnDeleteAction","change #reference-details-update-constraint-action":"changeOnUpdateAction",
"change #reference-details-mandatory":"changeMandatory","click #reference-details-refresh-preview-button":"refreshPreview","click #reference-details-sql-preview":"showSqlPreview","change #reference-details-color":"changeColor","focus #reference-details-color":"handleFocusColor","keydown #reference-details-color":"handleKeyDownColor","change #reference-details-pk-add":"updateAddButton","change #reference-details-fk-add":"updateAddButton"},updateAddButton:function(){0==$("#reference-details-pk-add").children().size()||
0==$("#reference-details-fk-add").children().size()?$("#reference-details-add-column-button").attr("disabled","disabled"):$("#reference-details-add-column-button").removeAttr("disabled")},handleFocusColor:function(a){!1!=app.isEditable()&&(a=this.$("#reference-details-color"),this.colorSelector=new UI.ColorPicker({el:$("#color-picker"),model:null,originField:a,type:a.val()}))},handleKeyDownColor:function(a){if(13==a.keyCode){var b=a.target.value;$(a.target).css({"background-color":a.target.value});
Commands.changeReferenceDisplay(this.selectedDisplay.get("id"),"color",b)}},changeColor:function(a){var b=a.target.value;$(a.target).css({"background-color":a.target.value});Commands.changeReferenceDisplay(this.selectedDisplay.get("id"),"color",b)},showSqlPreview:function(){SqlGenerator.Preview.preview("reference",this.selected.get("id"))},refreshPreview:function(){var a="/sql/reference/"+this.selected.get("id");$("#reference-details-preview").attr("src",a)},changeMandatory:function(){Commands.changeReferenceMandatory(this.selected.get("id"),
$("#reference-details-mandatory").is(":checked")?!0:!1)},changeOnDeleteAction:function(){Commands.changeReference(this.selected.get("id"),"onDeleteAction",$("#reference-details-delete-constraint-action").val())},changeOnUpdateAction:function(){Commands.changeReference(this.selected.get("id"),"onUpdateAction",$("#reference-details-update-constraint-action").val())},swap:function(){Commands.swapReference(this.selected.get("id"))},"delete":function(){Commands.deleteReference(this.selected.get("id"))},
changePkRole:function(){Commands.changeReference(this.selected.get("id"),"pkRole",$("#reference-details-pk-role").val())},changeFkRole:function(){Commands.changeReference(this.selected.get("id"),"fkRole",$("#reference-details-fk-role").val())},changeCardinality:function(){Commands.changeReference(this.selected.get("id"),"cardinality",$("#reference-details-cardinality-selector").val())},addColumn:function(a){a=$("#reference-details-pk-add").val();var b=$("#reference-details-fk-add").val();if(!(null==
a||null==b)){Commands.beginGroupCommands();Commands.addReferenceColumns(this.selected.get("id"));var c=this.selected.get("referenceColumns").size()-1;Commands.changeReferenceColumns(this.selected.get("id"),c,"pk",a);Commands.changeReferenceColumns(this.selected.get("id"),c,"fk",b);Commands.endGroupCommands()}},removeColumns:function(a){a=a.target.id.slice(32);Commands.removeReferenceColumns(this.selected.get("id"),a)},changeName:function(){Commands.changeReference(this.selected.get("id"),"name",this.$("#reference-details-name").val())},
changeDescription:function(){Commands.changeReference(this.selected.get("id"),"description",this.$("#reference-details-description").val())},renderColumns:function(a,b){for(var c="",d=UI.template("reference-details-columns-column-template"),e=0;e<a.length;e++)var f=a.at(e),f={id:f.get("id"),name:f.get("name"),selected:f.get("id")==b?"selected":""},c=c+d(f);return c},renderSelector:function(a,b,c,d){var e=UI.template("reference-details-columns-template");a={pkfk:a,position:b,columns:this.renderColumns(c,
d)};return e(a)},renderColumnLabel:function(a,b){var c=a.get("columns").get(b),d="-";void 0!=c&&(d=c.get("name"));return UI.template("reference-details-columns-label-template")({name:d})},renderDeleteOperation:function(a){return UI.template("reference-details-op-del-columns-template")({position:a})},renderAddOperation:function(a){return UI.template("reference-details-op-add-column-template")({})},renderReferenceColumns:function(a,b,c,d,e){b=UI.template("reference-details-column-template");c=this.renderColumnLabel(this.pkTable,
c);e=this.renderColumnLabel(this.fkTable,e);d=this.renderDeleteOperation(a);return b({position:a,pk:c,fk:e,op:d})},renderAddColumn:function(){var a=UI.template("reference-details-add-column-template"),b=this.renderSelector("pk","add",this.pkTable.get("columns"),-1),c=this.renderSelector("fk","add",this.fkTable.get("columns"),-1),d=this.renderAddOperation("add");return a({position:"add",pk:b,fk:c,op:d})},updateColumns:function(){this.$("#reference-details-pk-table").html(_.escape(this.pkTable.get("name")));
this.$("#reference-details-fk-table").html(_.escape(this.fkTable.get("name")));this.$("#reference-details-pk-role").val(this.selected.get("pkRole"));this.$("#reference-details-fk-role").val(this.selected.get("fkRole"));this.$("#reference-details-columns").html("");this.referenceColumns=this.selected.get("referenceColumns");for(var a=0;a<this.referenceColumns.size();a++){var b=this.referenceColumns.at(a),b=this.renderReferenceColumns(a,this.pkTable,b.get("pkColumnId"),this.fkTable,b.get("fkColumnId"));
this.$("#reference-details-columns").append(b)}var c=this;this.$("#reference-details-columns").sortable({placeholder:"ui-state-highlight",update:function(a,b){var f=new Model.ReferenceColumns([]),g=c.selected.get("referenceColumns");c.$("#reference-details-columns").children().each(function(a,b){var c=$(b).data("position"),c=g.at(c);f.add(c)});Commands.changeReference(c.selected.get("id"),"referenceColumns",f)},items:"> TBODY"});this.$("#reference-details-add-columns").html(this.renderAddColumn());
this.updateAddButton()},updateSelectsAndCheckboxes:function(){null!=this.selected&&(this.$("#reference-details-cardinality-selector").val(this.selected.get("cardinality")),this.$("#reference-details-delete-constraint-action").val(this.selected.get("onDeleteAction")),this.$("#reference-details-update-constraint-action").val(this.selected.get("onUpdateAction")),$("#reference-details-mandatory")[0].checked=this.selected.get("mandatory"));null!=this.selectedDisplay&&(this.$("#reference-details-color").val(this.selectedDisplay.get("color")),
this.$("#reference-details-color").css({"background-color":this.selectedDisplay.get("color")}))},update:function(){null!=this.selected&&(this.pkTableId=this.selected.get("pkTableId"),this.fkTableId=this.selected.get("fkTableId"),this.pkTable=this.tables.get(this.pkTableId),dbwm.check(this.pkTable).notNull(),this.fkTable=this.tables.get(this.fkTableId),dbwm.check(this.fkTable).notNull(),this.$("#reference-details-name").val(this.selected.get("name")),this.$("#reference-details-description").val(this.selected.get("description")),
this.additionalProperties=new UI.AdditionalProperties({el:this.$(".reference-details-additional-properties"),model:this.selected.get("properties"),propertiesType:"reference",availableProperties:Model.availableReferenceProperties}),null!=this.problems&&(this.problems.unbind(),this.$("#reference-details-problems .content").html("")),this.problems=new UI.ProblemsOfObject({el:this.$("#reference-details-problems .content"),model:Model.problemReports,id:this.selected.get("id")}),this.updateColumns());this.updateSelectsAndCheckboxes();
this.updateEditableReadonly()},render:function(){var a=UI.template("reference-details-template");this.$el.html(a({}));return this}});
UI.EditingMode=Backbone.View.extend({initialize:function(){var a=this;this.model.on("change",function(b){a.render()});this.messageEl=null;a.render();this.takeControlInitiated=!1},events:{"click .take_control_button":"takeControl","click .editing-mode-close-button":"hide"},takeControl:function(){Model.takeControl();this.takeControlInitiated=!0},show:function(){null!=this.messageEl&&app.messages.showOnTop(this.messageEl)},hide:function(){null!=this.messageEl&&app.messages.removeMessage(this.messageEl);
this.messageEl=null},render:function(){var a=this.model.get("mode");if(void 0==a)return this;var b=null;if("edit"==a)if(this.takeControlInitiated)b=UI.template("editing-mode-edit_control_now-template"),this.takeControlInitiated=!1;else return this.show(),this;if("read_only"==a)return this.hide(),this;"read_only_take_control"==a&&(b=null==this.model.get("editor")?UI.template("editing-mode-take-control-no-editor-template"):UI.template("editing-mode-take-control-template"));"read_only_take_control_in_progress"==
a&&(b=UI.template("editing-mode-read_only_take_control_in_progress-template"));if("read_only_edit_no_longer"==a){var b=UI.template("editing-mode-read_only_edit_no_longer-template"),c=function(){Model.releaseControl();Model.applicationProperties.off("after-save",c)};Model.applicationProperties.on("after-save",c);Model.save()}"edit_control_now"==a&&(b=UI.template("editing-mode-edit_control_now-template"));null==b&&(b=UI.template("editing-mode-unknown"));a=b({editor:_.escape(this.model.get("editor")),
mode:a});null==this.messageEl&&(this.messageEl=app.messages.newMessage(),this.setElement(this.messageEl));this.$el.html(a);this.show();return this}});
UI.Search=Backbone.View.extend({initialize:function(){this.render()},events:{"submit form[name='search']":"submitSearch"},submitSearch:function(){for(var a=this.$("input[name='query']").val(),a=this.search(a),b=0;b<a.length;b++)if("separator"!=a[b].type){this.select(a[b].type,a[b].id);this.$("input[name='query']").val(a[b].label);break}this.$("input[name='query']").autocomplete("close");Model.clearSearchResults();app.getDiagram().draw();return!1},acronymSimplePattern:function(a){a=a.replace("_","").replace(" ",
"");for(var b="^",c=0;c<a.length;c++)0<c&&(b+="_"),b+="["+a[c].toUpperCase()+a[c].toLowerCase()+"].+";return RegExp(b)},acronymCamelCasePattern:function(a){a=a.replace("_","").replace(" ","");for(var b="^",c=0;c<a.length;c++)0<c&&(b+=""),b+="["+a[c].toUpperCase()+"].+";return RegExp(b)},find:function(a,b,c){var d=[];b=new Backbone.Collection(b.sortBy("name"));var e=[];e.push(this.acronymSimplePattern(a));e.push(this.acronymCamelCasePattern(a));for(var f=0;f<b.size();f++){var g=b.at(f),h=b.at(f).get("name"),
k=b.at(f).get("id"),m=0,n=h.toLowerCase().indexOf(a.toLowerCase());0==n&&(m+=2);0<n&&(m+=1);for(n=0;n<e.length;n++)e[n].test(h)&&(m+=2);if(0!=m)if(g instanceof Model.Table){g=Model.tableDisplays.where({modelId:g.get("id")});for(n=0;n<g.length;n++)k=g[n],d.push({label:k.getTitleText(),value:h,id:k.get("id"),type:"table display",weight:m})}else if(g instanceof Model.View){g=Model.viewDisplays.where({modelId:g.get("id")});for(n=0;n<g.length;n++)k=g[n],d.push({label:k.getTitleText(),value:h,id:k.get("id"),
type:"view display",weight:m})}else if(g instanceof Model.Reference){g=Model.referenceDisplays.where({modelId:g.get("id")});for(n=0;n<g.length;n++){var k=g[n],r=Model.references.get(k.get("modelId"));d.push({label:r.get("name"),value:h,id:k.get("id"),type:"reference display",weight:m})}}else d.push({label:h,value:h,id:k,type:c,weight:m})}return d=_.sortBy(d,function(a){return-a.weight})},search:function(a){var b=[];if(""==a)return b;var c=this.find(a,Model.tables,"table"),d=this.find(a,Model.references,
"reference"),e=this.find(a,Model.sequences,"sequence"),f=this.find(a,Model.notes,"note"),g=this.find(a,Model.views,"view");a=this.find(a,Model.areas,"area");0<a.length&&(b.push({label:"Subject areas",value:null,id:null,type:"separator"}),b=b.concat(a));0<c.length&&(b.push({label:"Tables",value:null,id:null,type:"separator"}),b=b.concat(c));0<g.length&&(b.push({label:"Views",value:null,id:null,type:"separator"}),b=b.concat(g));0<d.length&&(b.push({label:"References",value:null,id:null,type:"separator"}),
b=b.concat(d));0<e.length&&(b.push({label:"Sequences",value:null,id:null,type:"separator"}),b=b.concat(e));0<f.length&&(b.push({label:"Notes",value:null,id:null,type:"separator"}),b=b.concat(f));return b},tellOther:function(a){Model.clearSearchResults();for(var b=0;b<a.length;b++){var c=a[b].type,d=a[b].id;"table"==c?(c=Model.tables.get(d),Model.tableInSearchResults(c)):"table display"==c?(c=Model.tableDisplays.get(d),Model.tableInSearchResults(c)):"reference"==c?(c=Model.references.get(d),Model.tableInSearchResults(c)):
"reference display"==c?(c=Model.referenceDisplays.get(d),Model.referenceInSearchResults(c)):"sequence"==c?(c=Model.sequences.get(d),Model.sequenceInSearchResults(c)):"note"==c?(c=Model.notes.get(d),Model.noteInSearchResults(c)):"view"==c?(c=Model.views.get(d),Model.viewInSearchResults(c)):"view display"==c?(c=Model.viewDisplays.get(d),Model.viewInSearchResults(c)):"area"==c&&(c=Model.areas.get(d),Model.areaInSearchResults(c))}app.getDiagram().draw()},select:function(a,b,c){var d=null;"table"==a?(d=
Model.tables.get(b),Model.selection.selectElement(d)):"table display"==a?(d=Model.tableDisplays.get(b),Display.selection.selectElement(d)):"reference"==a?(d=Model.references.get(b),Model.selection.selectElement(d)):"reference display"==a?(d=Model.referenceDisplays.get(b),Display.selection.selectElement(d)):"sequence"==a?(d=Model.sequences.get(b),Model.selection.selectElement(d),c=!1):"note"==a?(d=Model.notes.get(b),Model.selection.selectElement(d)):"view"==a?(d=Model.views.get(b),Model.selection.selectElement(d)):
"view display"==a?(d=Model.viewDisplays.get(b),Display.selection.selectElement(d)):"area"==a&&(d=Model.areas.get(b),Model.selection.selectElement(d));d&&c&&app.getDiagram().center(d.computeCenter());Model.selection.triggerSelectionChanged()},render:function(){var a=UI.template("search-template");this.$el.html(a({}));var b=this;this.$("input[name='query']").autocomplete({close:function(a,b){Model.clearSearchResults();app.getDiagram().draw()},source:function(a,d){var e=b.search(a.term);b.tellOther(e);
d(e)},select:function(a,d){d.item&&b.select(d.item.type,d.item.id,!0);Model.clearSearchResults();app.getDiagram().draw()},focus:function(a,d){d.item&&(b.select(d.item.type,d.item.id,!1),app.getDiagram().draw());return!1},position:{my:"right top",at:"right bottom"}}).data("autocomplete")._renderItem=function(a,b){return"separator"==b.type?$("<li>").append($("<b></b>").text(b.label)).appendTo(a):$("<li>").data("item.autocomplete",b).append($("<a></a>").text(b.label)).appendTo(a)};return this}});
UI.SequenceDetailsInternal={};
UI.SequenceDetailsInternal.AdditionalSql=Backbone.View.extend({initialize:function(){var a=this;this.model.on("change:additionalSqlBefore",this.update,this);this.model.on("change:additionalSqlAfter",this.update,this);this.$el.bind("section:show",function(){a.refresh()});this.render();this.update();this.refresh()},events:{"change textarea":"change"},change:function(a){var b=a.target.name;a=a.target.value;Commands.changeSequence(this.model.get("id"),b,a)},unbind:function(){this.sqlBeforeEditor.close();this.sqlAfterEditor.close();
this.model.off(null,null,this)},update:function(){this.sqlBeforeEditor.setValue(this.model.get("additionalSqlBefore"));this.sqlAfterEditor.setValue(this.model.get("additionalSqlAfter"))},refresh:function(){this.sqlBeforeEditor.refresh();this.sqlAfterEditor.refresh()},render:function(){var a=UI.template("sequence-details-additional-sql-template");this.$el.html(a({}));this.sqlBeforeEditor=new UI.SQLEditor(this.model.get("name")+" - Additional SQL Script - before sequence",this.$("textarea[name='additionalSqlBefore']").get(0));
this.sqlAfterEditor=new UI.SQLEditor(this.model.get("name")+" - Additional SQL Script - after sequence",this.$("textarea[name='additionalSqlAfter']").get(0));return this}});
UI.SequenceDetails=Backbone.View.extend({initialize:function(){var a=this;a.selected=null;this.sectionOpenStatus={"primary-data":!0};Model.selection.on("element_selected",function(b){b instanceof Model.Sequence&&(a.selected=b,a.render())});Model.selection.on("element_deselected",function(b){b instanceof Model.Sequence&&(a.$(":focus").blur(),a.selected=null,a.hide())});this.$el.hide()},events:{"change input[name='name']":"change","change textarea[name='description']":"change","change input[name='startWith']":"change",
"change input[name='incrementBy']":"change","change input[name='minValue']":"change","change input[name='maxValue']":"change","change input[name='cache']":"change","change input[name='hasMinValue']":"changeNoBoolean","change input[name='hasMaxValue']":"changeNoBoolean","change input[name='hasCache']":"changeNoBoolean","change input[name='cycle']":"changeCycle","click summary":"toggleDetails","click .preview-button":"showSqlPreview"},showSqlPreview:function(){SqlGenerator.Preview.preview("sequence",
this.selected.get("id"))},toggleDetails:function(a){a=$(a.currentTarget).closest(".details");var b=a.attr("section"),c=a.attr("open"),c=!(void 0==c?0:"open"==c);this.sectionOpenStatus[b]=c;$(a).find(".content > div").trigger(c?"section:show":"section:hide")},updateOpenedSection:function(){this.$(".details").removeAttr("open");for(var a in this.sectionOpenStatus)!0==this.sectionOpenStatus[a]?(this.$(".details[section="+a+"]").attr("open","open"),this.$(".details[section="+a+"]  .content > div").trigger("section:show")):
(this.$(".details[section="+a+"]").removeAttr("open"),this.$(".details[section="+a+"]  .content > div").trigger("section:hide"))},change:function(a){var b=a.target.name;a=a.target.value;Commands.changeSequence(this.selected.get("id"),b,a)},changeCycle:function(){Commands.changeSequence(this.selected.get("id"),"cycle",this.$("input[name=cycle][value=true]").is(":checked"))},changeNoBoolean:function(a){a=a.target.name;this.updateRelatedField(a);Commands.beginGroupCommands();var b=this.$('input[name="'+
a+'"]').is(":checked");Commands.changeSequence(this.selected.get("id"),a,!b);a=this.relatedFields[a];b=this.$("input[name='"+a+"']").val();Commands.changeSequence(this.selected.get("id"),a,b);Commands.endGroupCommands()},relatedFields:{hasMinValue:"minValue",hasMaxValue:"maxValue",hasCache:"cache"},enableRelatedField:function(a){this.$("input[name='"+this.relatedFields[a]+"']").prop("disabled",!1)},clearDisableRelatedField:function(a){a=this.relatedFields[a];this.$("input[name='"+a+"']").val("");
this.$("input[name='"+a+"']").prop("disabled",!0)},updateRelatedField:function(a){this.$('input[name="'+a+'"]').is(":checked")?this.clearDisableRelatedField(a):this.enableRelatedField(a)},updateEditableReadonly:function(){var a=[".preview-button"],b=!1;!1==app.isEditable()?(this.$("input[type=text]").attr("readonly",!0),this.$("textarea").attr("readonly",!0),this.$("select").attr("disabled",!0),this.$("input[type=checkbox]").attr("disabled",!0),this.$("input[type=radio]").attr("disabled",!0),b=!0):
(this.$("input[type=text]").attr("readonly",!1),this.$("textarea").attr("readonly",!1),this.$("select").attr("disabled",!1),this.$("input[type=checkbox]").attr("disabled",!1),this.$("input[type=radio]").attr("disabled",!1),b=!1);for(var c=0;c<a.length;c++)b?this.$(a[c]).hide():this.$(a[c]).show()},hide:function(){this.unbind();this.$el.html("")},unbind:function(){null!=this.problems&&(this.problems.unbind(),this.problems=null);null!=this.additionalSql&&(this.additionalSql.unbind(),this.additionalSql=
null)},render:function(){this.unbind();var a=UI.template("sequence-details-template");this.$el.html(a({}));this.$el.show();this.$("input[name='name']").val(this.selected.get("name"));this.$("textarea[name='description']").val(this.selected.get("description"));this.$("input[name='startWith']").val(this.selected.get("startWith"));this.$("input[name='incrementBy']").val(this.selected.get("incrementBy"));this.$("input[name='minValue']").val(this.selected.get("minValue"));this.$("input[name='maxValue']").val(this.selected.get("maxValue"));
this.$("input[name='cache']").val(this.selected.get("cache"));this.$('input[name="hasMinValue"]').attr("checked",!this.selected.get("hasMinValue"));this.$('input[name="hasMaxValue"]').attr("checked",!this.selected.get("hasMaxValue"));this.$('input[name="hasCache"]').attr("checked",!this.selected.get("hasCache"));this.$("input[name=cycle][value=true]").attr("checked",this.selected.get("cycle"));this.$("input[name=cycle][value=false]").attr("checked",!this.selected.get("cycle"));this.updateRelatedField("hasMinValue");
this.updateRelatedField("hasMaxValue");this.updateRelatedField("hasCache");this.additionalSql=new UI.SequenceDetailsInternal.AdditionalSql({el:this.$(".sequence-details-additional-sql"),model:this.selected});this.additionalProperties=new UI.AdditionalProperties({el:this.$(".additional-properties"),model:this.selected.get("properties"),propertiesType:"sequence",availableProperties:Model.availableSequenceProperties});this.problems=new UI.ProblemsOfObject({el:this.$("#sequence-details-problems .content"),
model:Model.problemReports,id:this.selected.get("id")});this.updateOpenedSection();this.updateEditableReadonly();return this}});UI.NoteDetailsInternal={};
UI.NoteDetailsInternal.Format=Backbone.View.extend({initialize:function(){this.model.on("change:fillColor",this.update,this);this.model.on("change:lineColor",this.update,this);this.render();this.update()},events:{"change input[name='lineColor']":"change","change input[name='fillColor']":"change","focus input[name='lineColor']":"handleFocus","focus input[name='fillColor']":"handleFocus","keydown input[name='lineColor']":"handleKeyDown","keydown input[name='fillColor']":"handleKeyDown"},handleFocus:function(a){!1!=
app.isEditable()&&($(a.target).parent(),a=this.$('input[name="'+a.target.name+'"]'),this.colorSelector=new UI.ColorPicker({el:$("#color-picker"),model:null,originField:a,type:a.val()}))},handleKeyDown:function(a){if(13==a.keyCode){var b=a.target.name,c=a.target.value;$(a.target).css({"background-color":a.target.value});Commands.changeNote(this.model.get("id"),b,c)}},change:function(a){var b=a.target.name,c=a.target.value;$(a.target).css({"background-color":a.target.value});Commands.changeNote(this.model.get("id"),
b,c)},unbind:function(){this.model.off(null,null,this)},update:function(){this.$("input[name=lineColor]").val(this.model.get("lineColor"));this.$("input[name=fillColor]").val(this.model.get("fillColor"));this.$("input[name=lineColor]").css({"background-color":this.model.get("lineColor")});this.$("input[name=fillColor]").css({"background-color":this.model.get("fillColor")})},set:function(a,b){Commands.changeNote(this.model.get("id"),a,b)},render:function(){var a=UI.template("note-details-format-template");
this.$el.html(a({}));return this}});
UI.NoteDetails=Backbone.View.extend({initialize:function(){var a=this;a.selected=null;this.sectionOpenStatus={"primary-data":!0};Model.selection.on("element_selected",function(b){b instanceof Model.Note&&(a.selected=b,a.render())});Model.selection.on("element_deselected",function(b){b instanceof Model.Note&&(a.$(":focus").blur(),a.selected=null,a.hide())});this.model.on("change",function(b,c){null!=a.selected&&!b.hasChanged("selected")&&!b.hasChanged("attached")&&b==a.selected&&a.update()});this.$el.hide()},
events:{"change input[name='name']":"change","change textarea[name='content']":"change","click summary":"toggleDetails"},toggleDetails:function(a){var b=$(a.currentTarget).closest(".details");a=b.attr("section");b=b.attr("open");b=!(void 0==b?0:"open"==b);this.sectionOpenStatus[a]=b},updateOpenedSection:function(){this.$(".details").removeAttr("open");for(var a in this.sectionOpenStatus)!0==this.sectionOpenStatus[a]&&this.$(".details[section="+a+"]").attr("open","open")},update:function(){this.$("input[name='name']").val(this.selected.get("name"));
this.$("textarea[name='content']").val(this.selected.get("content"))},updateEditableReadonly:function(){!1==app.isEditable()?(this.$("input[type=text]").attr("readonly",!0),this.$("textarea").attr("readonly",!0)):(this.$("input[type=text]").attr("readonly",!1),this.$("textarea").attr("readonly",!1))},change:function(a){var b=a.target.name;a=a.target.value;Commands.beginGroupCommands();Commands.changeNote(this.selected.get("id"),b,a);"content"===b&&Commands.eventuallyEnlargeNoteSize(this.selected.get("id"));
Commands.endGroupCommands()},hide:function(){this.unbind();this.$el.html("")},unbind:function(){null!=this.format&&(this.format.unbind(),this.format=null)},render:function(){this.unbind();var a=UI.template("note-details-template");this.$el.html(a({}));this.$el.show();this.$("input[name='name']").val(this.selected.get("name"));this.$("textarea[name='content']").val(this.selected.get("content"));this.format=new UI.NoteDetailsInternal.Format({el:this.$(".note-details-format"),model:this.selected});this.updateOpenedSection();
this.updateEditableReadonly();this.update();return this}});UI.ViewDetailsInternal={};UI.ViewDetailsInternal.typeSelector=null;
UI.ViewDetailsInternal.Basics=Backbone.View.extend({initialize:function(){var a=this;this.model.on("change:name",this.update,this);this.model.on("change:description",this.update,this);this.model.on("change:sqlQuery",this.update,this);Model.goTo.on("goto_view/name",function(b){a.$("input[name='name']").focus()});this.$el.bind("section:show",function(){a.refresh()});this.render();this.initSQLEditors();this.update();this.refresh()},initSQLEditors:function(){},events:{"change input[name='name']":"change",
"change textarea[name='description']":"change","change textarea[name='sqlQuery']":"change","click button[name='update-columns']":"updateColumns"},change:function(a){var b=a.target.name;a=a.target.value;Commands.changeView(this.model.get("id"),b,a)},updateColumns:function(a){this.updateColumnsLayer.show()},update:function(){this.$("input[name='name']").val(this.model.get("name"));this.$("textarea[name='description']").val(this.model.get("description"));this.sqlQueryEditor.setValue(this.model.get("sqlQuery"))},
unbind:function(){null!=this.updateColumnsLayer&&(this.updateColumnsLayer.unbind(),this.updateColumnsLayer=null);this.sqlQueryEditor.close();this.model.off(null,null,this);Model.goTo.off(null,null,this)},refresh:function(){this.sqlQueryEditor.refresh()},render:function(){var a=UI.template("view-details-basic-template");this.$el.html(a({}));this.sqlQueryEditor=new UI.SQLEditor(this.model.get("name")+" - SQL Query",this.$("textarea[name='sqlQuery']").get(0));this.updateColumnsLayer=new UI.ViewDetailsInternal.UpdateColumnsLayer({el:this.$(".view-update-columns-layer"),
model:this.model,sqlQueryEditor:this.sqlQueryEditor,openingButton:this.$("button[name='update-columns']")});return this}});
UI.ViewDetailsInternal.UpdateColumnsLayer=Backbone.View.extend({initialize:function(){this.openingButton=this.options.openingButton;this.sqlQueryEditor=this.options.sqlQueryEditor;this.render()},events:{"click #view_update_columns_layer_cancel":"hide","click #view_update_columns_layer_ok":"doUpdateColumns","click #view_update_columns_layer_failed_ok":"hide"},renderColumn:function(a){var b=a.get("name");a=a.get("type");b="<tr>"+('<td><div class="name">'+b+" </td>")+('<td><div class="type">'+a+" </td>");
return b+="</tr>"},renderColumns:function(a,b){a.html("");for(var c="",d=0;d<b.length;++d)c+=this.renderColumn(b[d]);c=UI.template("view-update-columns-layer-element")({elements:c});a.append(c)},renderColumnsSections:function(a,b){var c=this.$("#view-update-columns-layer-columns-before"),d=this.$("#view-update-columns-layer-columns-after");0!=a.length?(this.$("#view-update-columns-layer-columns-before-empty").hide(),this.renderColumns(c,a),c.show()):(this.$("#view-update-columns-layer-columns-before-empty").show(),
c.hide());this.renderColumns(d,b)},update:function(){var a=this.$(".parse_successful"),b=this.$(".parse_failed");a.hide();b.hide();var c=this.model.get("columns"),d=this.sqlQueryEditor.getValue(),e=new VertabeloSQLParser;try{e.parse(d)}catch(f){console.log("Parser failed: "+f);b.show();return}this.newViewColumns=e.getViewColumns();this.renderColumnsSections(c.toArray(),this.newViewColumns);a.show()},hide:function(){this.$el.hide();$(window).unbind("resize.view-update-columns-layer")},show:function(){function a(){b.$el.find(".content").height("").width("");
b.$el.show();var a=b.openingButton.offset(),d=app.calcHeight()-3,e=b.$el.outerHeight();b.$el.css({left:Math.max(0,a.left-320),top:Math.max(0,a.top+Math.min(0,d-(a.top+e)))});e>d&&(a=b.$el.find(".popup2-section:visible"),e=a.find(".content"),e.outerHeight(d-a.find(".header").outerHeight()-a.find(".buttons").outerHeight()),e.outerWidth(e.outerWidth()+20))}this.update();var b=this;a();$(window).bind("resize.view-update-columns-layer",a)},doUpdateColumns:function(){this.hide();Commands.beginGroupCommands();
Commands.resetViewColumns(this.model.get("id"),this.newViewColumns);Commands.eventuallyEnlargeViewSize(this.model.get("id"));Commands.endGroupCommands()},render:function(){var a=UI.template("view-update-columns-layer-template");this.$el.html(a({}));return this}});
UI.ViewDetailsInternal.Format=Backbone.View.extend({initialize:function(){this.model.on("change:fillColor",this.update,this);this.model.on("change:lineColor",this.update,this);this.model.on("change:fixedSize",this.update,this);this.render();this.update()},events:{"change input[name='lineColor']":"change","change input[name='fillColor']":"change","change input[name='fixedSize']":"changeFixedSize","focus input[name='lineColor']":"handleFocus","focus input[name='fillColor']":"handleFocus","keydown input[name='lineColor']":"handleKeyDown",
"keydown input[name='fillColor']":"handleKeyDown","keydown input[name='fixedSize']":"handleKeyDown"},handleFocus:function(a){!1!=app.isEditable()&&($(a.target).parent(),a=this.$('input[name="'+a.target.name+'"]'),this.colorSelector=new UI.ColorPicker({el:$("#color-picker"),model:null,originField:a,type:a.val()}))},handleKeyDown:function(a){if(13==a.keyCode){var b=a.target.name;if("fillColor"==b||"lineColor"==b){var c=a.target.value;$(a.target).css({"background-color":a.target.value})}Commands.changeViewDisplay(this.model.get("id"),
b,c)}},change:function(a){var b=a.target.name,c=a.target.value;$(a.target).css({"background-color":a.target.value});Commands.changeViewDisplay(this.model.get("id"),b,c)},changeFixedSize:function(a){Commands.changeViewDisplay(this.model.get("id"),"fixedSize",this.$("input[name=fixedSize][value=true]").is(":checked"))},unbind:function(){this.model.off(null,null,this)},update:function(){this.$("input[name=lineColor]").val(this.model.get("lineColor"));this.$("input[name=fillColor]").val(this.model.get("fillColor"));
this.$("input[name=fixedSize][value=true]").attr("checked",this.model.get("fixedSize"));this.$("input[name=fixedSize][value=false]").attr("checked",!this.model.get("fixedSize"));this.$("input[name=lineColor]").css({"background-color":this.model.get("lineColor")});this.$("input[name=fillColor]").css({"background-color":this.model.get("fillColor")})},set:function(a,b){Commands.changeView(this.model.get("id"),a,b)},render:function(){var a=UI.template("view-details-format-template");this.$el.html(a({}));
return this}});
UI.ViewDetailsInternal.Column=Backbone.View.extend({fieldsOrder:["name","type"],initialize:function(){var a=this;this.model.on("change",this.update,this);Model.goTo.on("goto_view_column/name",function(b){b==a.model.get("id")&&a.$('input[name="name"]').focus()});Model.goTo.on("goto_view_column/type",function(b){b==a.model.get("id")&&a.$('input[name="type"]').focus()});this.view=this.options.view;this.columns=this.options.columns;this.additionalProperties=null;this.render();this.update()},events:{'change input[name="name"]':"changeName",
'change input[name="type"]':"changeType",'change textarea[name="description"]':"changeDescription",'click  button[name="delete"]':"deleteColumn",'click  button[name="more"]':"toggleMore","keydown .table-details-navi-keys":"handleKeys","click .settings_button":"handleSettingsButton"},handleKeys:function(a){var b=a.target.name,c=$(a.target);if("type"==b&&13==a.keyCode)this.openDatabaseTypeSelector(c);else{var d=null;37==a.keyCode&&(d="left");39==a.keyCode&&(d="right");if(null!=d){if("name"==b||"type"==
b){var e=c.val().length,c=c.caret().start;if(c<e&&"right"==d||0<c&&"left"==d)return}a.stopPropagation();a.preventDefault();a=this.fieldsOrder.indexOf(b);"left"==d?a--:a++;0>a&&(a=0);a>=this.fieldsOrder.length&&(a=this.fieldsOrder.length-1);this.$('input[name="'+this.fieldsOrder[a]+'"]').focus()}}},handleSettingsButton:function(a){a=$(a.target).closest(".text_field_wrapper").find("input");this.openDatabaseTypeSelector(a)},openDatabaseTypeSelector:function(a){UI.ViewDetailsInternal.typeSelector.show(a,
$(a).val())},closeDatabaseTypeSelector:function(){UI.ViewDetailsInternal.typeSelector.hide()},toggleMore:function(){this.$el.toggleClass("more-expanded");this.$(".view-details-column-more-section").toggle()},deleteColumn:function(){Commands.deleteViewColumn(this.view.get("id"),this.model.get("id"))},changeName:function(){Commands.beginGroupCommands();Commands.changeViewColumn(this.view.get("id"),this.model.get("id"),"name",this.$('input[name="name"]').val());Commands.eventuallyEnlargeViewSize(this.view.get("id"));
Commands.endGroupCommands()},changeType:function(){Commands.beginGroupCommands();Commands.changeViewColumn(this.view.get("id"),this.model.get("id"),"type",this.$('input[name="type"]').val());Commands.eventuallyEnlargeViewSize(this.view.get("id"));Commands.endGroupCommands()},changeDescription:function(){Commands.changeViewColumn(this.view.get("id"),this.model.get("id"),"description",this.$('textarea[name="description"]').val())},unbind:function(){this.model.off(null,null,this);Model.goTo.unbind(null,
null,this)},update:function(){this.$('input[name="name"]').val(this.model.get("name"));this.$('input[name="type"]').val(this.model.get("type"));this.$('textarea[name="description"]').val(this.model.get("description"))},render:function(){var a=UI.template("view-details-columns-column-template");this.$el.html(a({id:this.model.get("id")}));this.additionalProperties=new UI.AdditionalProperties({el:this.$(".additional-properties"),model:this.model.get("properties"),propertiesType:"view_column",availableProperties:Model.availableViewColumnProperties});
return this}});
UI.ViewDetailsInternal.Columns=Backbone.View.extend({initialize:function(){this.columns=[];var a=this.model.get("columns");a.on("add",this.update,this);a.on("remove",this.update,this);this.model.on("change:columns",this.update,this);this.render()},events:{'click button[name="add-column"]':"addColumn","keydown .table-details-navi-keys":"handleKeys"},handleKeys:function(a){var b=$(a.target).closest("tbody"),c=a.target.name;this.$('input[name="'+c+'"]');var d=null;40==a.keyCode&&(d="down");38==a.keyCode&&
(d="up");null!=d&&(a.stopPropagation(),a.preventDefault(),"down"==d?(a=b.next(),0<a.length?a.find("input[name='"+c+"']").focus():this.addColumn()):"up"==d&&b.prev().find("input[name='"+c+"']").focus())},addColumn:function(){this.$(":focus").blur();Commands.beginGroupCommands();Commands.createViewColumn(this.model.get("id"));Commands.eventuallyEnlargeViewSize(this.model.get("id"));Commands.endGroupCommands();$(".view-details-columns-list").children().last().find('input[name="name"]').focus().select()},
unbind:function(){this.model.get("columns").off(null,null,this);this.model.off(null,null,this)},update:function(){this.renderColumns()},removeColumns:function(){for(var a=0;a<this.columns.length;a++){var b=this.columns[a];b.unbind();b.remove()}},renderColumns:function(){this.removeColumns();for(var a=this.model.get("columns"),b=this.$(".view-details-columns-list"),c=0;c<a.length;c++){var d=a.at(c),e="view-details-column-"+d.get("id"),f=$("<tbody></tbody>");b.append(f);f.attr("id",e);f.attr("columnid",
d.get("id"));d=new UI.ViewDetailsInternal.Column({el:f,model:d,view:this.model,columns:this.columns});this.columns.push(d)}b.find("thead").toggle(0<a.length);1<a.length?b.sortable("enable"):b.sortable("disable")},sortable:function(){var a=this;this.$(".view-details-columns-list").sortable({placeholder:"ui-state-highlight",update:function(b,c){var d=[];a.$(".view-details-columns-list").children().not("THEAD").each(function(a,b){d.push($(b).attr("columnid"))});Commands.setViewColumnsOrder(a.model.get("id"),
d)},items:"> TBODY"});$("#details_column_list").disableSelection()},render:function(){var a=UI.template("view-details-columns-template");this.$el.html(a({}));this.sortable();this.renderColumns();return this}});
UI.ViewDetailsInternal.AdditionalSql=Backbone.View.extend({initialize:function(){var a=this;this.model.on("change:additionalSqlBefore",this.update,this);this.model.on("change:additionalSqlAfter",this.update,this);this.$el.bind("section:show",function(){a.refresh()});this.render();this.update();this.refresh()},events:{"change textarea":"change"},change:function(a){var b=a.target.name;a=a.target.value;Commands.changeView(this.model.get("id"),b,a)},unbind:function(){this.sqlBeforeEditor.close();this.sqlAfterEditor.close();
this.model.off(null,null,this)},update:function(){this.sqlBeforeEditor.setValue(this.model.get("additionalSqlBefore"));this.sqlAfterEditor.setValue(this.model.get("additionalSqlAfter"))},refresh:function(){this.sqlBeforeEditor.refresh();this.sqlAfterEditor.refresh()},render:function(){var a=UI.template("view-details-additional-sql-template");this.$el.html(a({}));this.sqlBeforeEditor=new UI.SQLEditor(this.model.get("name")+" - Additional SQL Script - before view",this.$("textarea[name='additionalSqlBefore']").get(0));
this.sqlAfterEditor=new UI.SQLEditor(this.model.get("name")+" - Additional SQL Script - after view",this.$("textarea[name='additionalSqlAfter']").get(0));return this}});
UI.ViewDetailsInternal.Dependencies=Backbone.View.extend({initialize:function(){this.model.on("change:dependencies",this.update,this);this.render();this.update()},events:{"click button[name='add-view']":"addView","click button[name='remove-view']":"removeView"},addView:function(){for(var a=this.$('select[name="views"] option:selected').val(),b=this.model.get("dependencies"),c=[],d=0;d<b.length;d++)c.push(b[d]);0<=c.indexOf(a)||(c.push(a),Commands.changeViewDependencies(this.model.get("id"),c))},removeView:function(a){a=
$(a.target).attr("viewId");for(var b=this.model.get("dependencies"),c=[],d=0;d<b.length;d++)a!=b[d]&&c.push(b[d]);Commands.changeViewDependencies(this.model.get("id"),c)},unbind:function(){this.model.off(null,null,this)},update:function(){this.updateAvailableViews();this.updateSelectedViews()},updateAvailableViews:function(){var a=this.$('select[name="views"]');a.html("");for(var b=this.model.get("dependencies"),c=0,d=0;d<Model.views.size();d++){var e=Model.views.at(d);if(this.model.get("id")!==e.get("id")&&
!(0<=b.indexOf(e.get("id")))){var f=$("<option></option>");f.attr("value",e.get("id"));f.append(e.get("name"));a.append(f);c++}}0<c?this.$(".view-details-dependencies-add-dependency-view").show():this.$(".view-details-dependencies-add-dependency-view").hide()},updateSelectedViews:function(){var a=this.$(".view-details-dependencies-list");a.html("");for(var b=UI.template("view-details-dependencies-view-template"),c=this.model.get("dependencies"),d=0;d<c.length;d++){var e=c[d],f=Model.views.where({id:e});
if(1!=f.length)throw Error("View in dependencies does not exist: "+e);e=f[0];e=b({id:e.get("id"),name:e.get("name")});a.append(e)}},render:function(){var a=UI.template("view-details-dependencies-template");this.$el.html(a({}));return this}});
UI.ViewDetails=Backbone.View.extend({initialize:function(){var a=this;this.selectedDisplay=this.selected=this.columns=this.basics=null;this.sectionOpenStatus={"primary-data":!0,columns:!0};Model.selection.on("element_selected",function(b){b instanceof Model.View&&(a.selected=b,a.render())});Display.selection.on("element_selected",function(b){b instanceof Model.ViewDisplay&&(a.selectedDisplay=b,a.render())});Model.selection.on("element_deselected",function(b){b instanceof Model.View&&(a.$(":focus").blur(),
a.selected=null,a.hide(),UI.ViewDetailsInternal.typeSelector.hide())});Display.selection.on("element_deselected",function(b){b instanceof Model.ViewDisplay&&(a.$(":focus").blur(),a.selectedDisplay=null,a.hide(),UI.ViewDetailsInternal.typeSelector.hide())});Model.goTo.on("goto_view_column",function(b){a.sectionOpenStatus.columns=!0;a.updateOpenedSection()});this.model.on("change",function(b,c){null!=a.selected&&!b.hasChanged("selected")&&!b.hasChanged("attached")&&b==a.selected&&a.update()});this.$el.hide()},
events:{"click summary":"toggleDetails","click .preview-button":"showSqlPreview"},showSqlPreview:function(){SqlGenerator.Preview.preview("view",this.selected.get("id"))},toggleDetails:function(a){a=$(a.currentTarget).closest(".details");var b=a.attr("section"),c=a.attr("open"),c=!(void 0==c?0:"open"==c);this.sectionOpenStatus[b]=c;$(a).find(".content > div").trigger(c?"section:show":"section:hide")},updateOpenedSection:function(){this.$("#view-details-common > .details").removeAttr("open");for(var a in this.sectionOpenStatus)!0==
this.sectionOpenStatus[a]?(this.$(".details[section="+a+"]").attr("open","open"),this.$(".details[section="+a+"]  .content > div").trigger("section:show")):(this.$(".details[section="+a+"]").removeAttr("open"),this.$(".details[section="+a+"]  .content > div").trigger("section:hide"))},updateEditableReadonly:function(){var a="button[name=add-column] button[name=update-columns] button[name=add-view] button[name=delete] .settings_button .preview-button".split(" "),b=!1;!1==app.isEditable()?(this.$("input[type=text]").attr("readonly",
!0),this.$("textarea").attr("readonly",!0),this.$("select").attr("disabled",!0),this.$("input[type=checkbox]").attr("disabled",!0),this.$("input[type=radio]").attr("disabled",!0),b=!0):(this.$("input[type=text]").attr("readonly",!1),this.$("textarea").attr("readonly",!1),this.$("select").attr("disabled",!1),this.$("input[type=checkbox]").attr("disabled",!1),this.$("input[type=radio]").attr("disabled",!1),b=!1);for(var c=0;c<a.length;c++)b?this.$(a[c]).hide():this.$(a[c]).show()},update:function(){},
hide:function(){this.unbind();this.$el.html("")},unbind:function(){null!=this.basics&&(this.basics.unbind(),this.basics=null);null!=this.format&&(this.format.unbind(),this.format=null);null!=this.columns&&(this.columns.unbind(),this.columns=null);null!=this.additionalSql&&(this.additionalSql.unbind(),this.additionalSql=null);null!=this.additionalProperties&&(this.additionalProperties.unbind(),this.additionalProperties=null);null!=this.dependencies&&(this.dependencies.unbind(),this.dependencies=null);
null!=this.problems&&(this.problems.unbind(),this.problems=null)},render:function(){this.unbind();if(null!=this.selected){var a=UI.template("view-details-template");this.$el.html(a({}));this.$el.show();this.basics=new UI.ViewDetailsInternal.Basics({el:this.$(".view-details-basic"),model:this.selected});this.columns=new UI.ViewDetailsInternal.Columns({el:this.$(".view-details-columns"),model:this.selected});this.additionalSql=new UI.ViewDetailsInternal.AdditionalSql({el:this.$(".view-details-additional-sql"),
model:this.selected});this.additionalProperties=new UI.AdditionalProperties({el:this.$(".view-details-additional-properties"),model:this.selected.get("properties"),propertiesType:"view",availableProperties:Model.availableViewProperties});this.dependencies=new UI.ViewDetailsInternal.Dependencies({el:this.$(".view-details-dependencies"),model:this.selected});this.problems=new UI.ProblemsOfObject({el:this.$("#view-details-problems .content"),model:Model.problemReports,id:this.selected.get("id")})}null!=
this.selectedDisplay&&(this.format=new UI.ViewDetailsInternal.Format({el:this.$(".view-details-format"),model:this.selectedDisplay}));this.updateOpenedSection();this.updateEditableReadonly();this.update();return this}});
UI.AjaxFuseNotifier=Backbone.View.extend({initialize:function(){var a=this;this.message=this.options.message;this.label=this.options.label;this.model.on("change",function(b){a.render()});a.render()},events:{"click a":"reload"},reload:function(){document.location.href="/"},render:function(){if(this.model.ok())return this;var a=UI.template("fusebox-notifier-template");this.$el.html(a({id:this.model.get("id"),message:this.message,label:this.label}));this.$el.show();$("body").prepend($("#header_wrapper"));
$(".border_layout").remove();return this}});
UI.Toolbox=Backbone.View.extend({initialize:function(){var a=this;Model.metaInfo.on("change:mode",a.update,this);this.model.on("change:mode",a.update,this);Model.metaInfo.on("change:accountPlanFree",function(){a.render()},this);a.render();a.update()},events:{"click .select_mode_button":"select","click .select_rect_mode_button":"select","click .add_table_mode_button":"select","click .add_relationship_mode_button":"select","click .add_note_button":"select","click .add_view_button":"select","click .add_sequence_button":"addSequence",
"click .add_area_button":"select","mouseenter button":"tooltip_in","mouseleave button":"tooltip_out",mouseleave:"tooltipx"},tooltipTimeout:-1,tooltipx:function(a){clearTimeout(this.tooltipTimeout);this.hideTooltip()},tooltip_in:function(a){a.stopPropagation();var b=this;this.tooltipIsShowing?this.showTooltip(a):this.tooltipTimeout=setTimeout(function(){b.showTooltip(a)},1E3)},tooltip_out:function(a){clearTimeout(this.tooltipTimeout)},showTooltip:function(a){a=$(a.currentTarget);var b=a.offset();this.tooltipIsShowing=
!0;var c=a.attr("data-tooltip");c?$(".tooltip").css({left:b.left+0,top:b.top-a.outerHeight()-3}).find(".content").html(c).end().show():$(".tooltip").hide()},hideTooltip:function(a){this.tooltipIsShowing=!1;$(".tooltip").hide()},updateEditableReadonly:function(){app.isEditable()?this.$el.show():(this.$el.hide(),this.model.set("mode",this.model.SELECT_MODE))},select:function(a){this.model.set("mode",$(a.currentTarget).data("mode"));$("#diagram").focus()},addSequence:function(){Commands.createSequence.bind(Commands)()},
update:function(){this.updateEditableReadonly();var a=this.model.mode();this.$("button[type=button]").removeClass("active");!1==app.isEditable()&&(a!=this.model.SELECT_MODE||a!=this.model.SELECT_RECT_MODE)||this.$("button[type=button]").filter(function(){return $(this).data("mode")&&$(this).data("mode")==a}).addClass("active")},render:function(){var a=UI.template("toolbox-template");this.$el.html(a({}));this.$(".select_mode_button").data("mode",this.model.SELECT_MODE);this.$(".select_rect_mode_button").data("mode",
this.model.SELECT_RECT_MODE);this.$(".add_table_mode_button").data("mode",this.model.ADD_TABLE_MODE);this.$(".add_relationship_mode_button").data("mode",this.model.ADD_RELATIONSHIP_MODE);this.$(".add_note_button").data("mode",this.model.ADD_NOTE_MODE);this.$(".add_view_button").data("mode",this.model.ADD_VIEW_MODE);this.$(".add_area_button").data("mode",this.model.ADD_AREA_MODE);Model.metaInfo.get("accountPlanFree")&&this.$(".add_area_button").remove();this.$el.show();this.updateEditableReadonly();
return this}});
UI.CommonMenu=Backbone.View.extend({initialize:function(){var a=this;UI.CommonMenu.instances.push(this);$(document).click(function(b){(!a._isComponentDescendantElement(b.target)||$(a._getClosestMenuItemElement(b.target)).hasClass("toolbar-button"))&&a.closeOpenedDrawer()})},events:{"click .toolbar-button":"clickButton","click .toolbar-drawer":"clickDrawer","mouseenter .toolbar-drawer":"hoverMenu","mouseleave .toolbar-drawer":"leaveMenu","mouseenter .toolbar-button, .toolbar-drawer":"tooltip_in","mouseleave .toolbar-button, .toolbar-drawer":"tooltip_out",
mouseleave:"tooltipx"},setButtonActive:function(a,b){this.$(".toolbar-button-"+a).removeClass("toolbar-active-button toolbar-passive-button").addClass(b?"toolbar-active-button":"toolbar-passive-button")},setButtonPressed:function(a,b){this.$(".toolbar-button-"+a).toggleClass("toolbar-pressed-button",b)},isButtonActive:function(a){return this.$("[data-toolbar="+a+"]").add(this.$(".toolbar-button-"+a)).hasClass("toolbar-active-button")},isButtonPressed:function(a){return this.$(".toolbar-button-"+a).hasClass("toolbar-pressed-button")},
isButtonDisabled:function(a){return this.$("[data-toolbar="+a+"]").add(this.$(".toolbar-button-"+a)).hasClass("toolbar-disabled-button")},setDrawerOpen:function(a,b){var c=this.$(".toolbar-drawer-"+a);this.setButtonPressed(a,b);b?c.show():c.hide()},updateButtonDrawer:function(a){a=this.$(".toolbar-button-"+a).closest(".toolbar-drawer");a[0]&&this.updateDrawer(a.attr("data-toolbar"))},updateDrawer:function(a){var b=this.$(".toolbar-button-"+a);0<b.find("> .toolbar-drawer-content > UL > .toolbar-active-button").size()?
this.setButtonActive(a,!0):this.setButtonActive(a,!1);a=b.parent().closest(".toolbar-drawer");a[0]&&this.updateDrawer(a.attr("data-toolbar"))},closeOpenedDrawer:function(){var a=this.$(".toolbar-drawer.toolbar-pressed-button");a[0]&&(a=a.data("toolbar"),this.setButtonPressed(a,!1),this.setDrawerOpen(a,!1))},bindButtonPressed:function(a,b,c,d){function e(c){f.setButtonPressed(a,b(c.get(d)));f.updateButtonDrawer(a)}var f=this;this.setButtonActive(a,!0);c.on("change:"+d,function(a){e(a)});e(c)},bindButton:function(a,
b,c,d){function e(c){f.setButtonActive(a,b(c.get(d)));f.updateButtonDrawer(a)}var f=this;this.setButtonPressed(a,!1);c.on("change:"+d,function(a){e(a)});e(c)},bindButtonCustomEvent:function(a,b,c,d){var e=this;this.setButtonPressed(a,!1);var f=function(){e.setButtonActive(a,b());e.updateButtonDrawer(a)};c.on(d,f);f()},TOOLTIP_SHOW_DELAY:1E3,tooltipTimeout:-1,tooltipLastHoveredItem:null,tooltipx:function(a){clearTimeout(this.tooltipTimeout);this.hideTooltip()},tooltip_in:function(a){var b=this;this.tooltipLastHoveredItem=
this._getClosestMenuItemElement(a.target);this.tooltipIsShowing?this.showTooltip(this.tooltipLastHoveredItem):(clearTimeout(this.tooltipTimeout),this.tooltipTimeout=setTimeout(function(){b.showTooltip(b.tooltipLastHoveredItem)},this.TOOLTIP_SHOW_DELAY))},tooltip_out:function(a){clearTimeout(this.tooltipTimeout)},showTooltip:function(a){var b=$(a);a=b.offset();this.tooltipIsShowing=!0;var c=b.attr("data-tooltip");if(c){var d=b.closest(".menu, .hmenu").hasClass("menu"),b=d?b.width()-10:0,e=$(".tooltip");
e.find(".content").html(c).end().css({left:a.left+b,top:a.top-e.outerHeight()-3}).toggleClass("in-menu",d).show()}else $(".tooltip").hide()},hideTooltip:function(){this.tooltipIsShowing=!1;$(".tooltip").hide()},_getButtonName:function(a){return $(a.currentTarget).data("toolbar")},_getActionFunctionName:function(a){return"click_"+a.replace(/-/g,"_")},_isComponentDescendantElement:function(a){return!!$(a).closest(this.$el)[0]},_isChildElementOfVerticalMenuItem:function(a){return!!$(a).closest("UL.menu")[0]},
_getClosestElement:function(a,b){var c=$(a);return c.is(b)?a:c.closest(b)[0]},_getClosestMenuItemElement:function(a){return this._getClosestElement(a,"LI")},hoverMenu:function(a){a=$(a.currentTarget);var b=a.data("toolbar");this._isChildElementOfVerticalMenuItem(a)&&this.isButtonActive(b)&&a.find("> .toolbar-drawer-content").show()},leaveMenu:function(a){a=$(a.currentTarget);this._isChildElementOfVerticalMenuItem(a)&&a.find("> .toolbar-drawer-content").hide()},clickDrawer:function(a){if(a.currentTarget==
this._getClosestMenuItemElement(a.target)){a=$(a.currentTarget);var b=a.data("toolbar");!this.isButtonDisabled(b)&&(!1!=this.isButtonActive(b)&&!this._isChildElementOfVerticalMenuItem(a))&&(this.isButtonPressed(b)?(this.setButtonPressed(b,!1),this.setDrawerOpen(b,!1)):(this.closeOpenedDrawer(),this.setButtonPressed(b,!0),this.setDrawerOpen(b,!0)))}},clickButton:function(a){var b=this._getButtonName(a),c=this._getActionFunctionName(b);!this.isButtonDisabled(b)&&!1!=this.isButtonActive(b)&&(void 0!=
this[c]?(this.setButtonPressed(b,!0),!1==this[c].call(this,a)&&this.setButtonPressed(b,!1)):console.log("no such function: "+c))}});UI.CommonMenu.instances=[];
UI.Toolbar=UI.CommonMenu.extend({initialize:function(){UI.CommonMenu.prototype.initialize.apply(this,arguments);var a=function(a){return a},b=function(a){return!a},c=function(){return 0<Model.selection.getAttachedElements().length},d=function(){return 0<_.filter(Display.selection.getAttachedElements(),function(a){return a instanceof Model.Area}).length};Model.fuseBox.get("ajax").on("change",this.updateSaveButton,this);Model.fuseBox.get("table_limit").on("change",this.updateSaveButton,this);Model.applicationProperties.on("change:dirtyModel",
this.updateSaveButton,this);Model.applicationProperties.on("change:saveInProgress",this.updateSaveButton,this);Model.applicationProperties.on("change:saveStatus",this.updateSaveButton,this);this.bindButtonCustomEvent("copy",c,Model.selection,"selection-changed");this.bindButtonCustomEvent("cut",c,Model.selection,"selection-changed");this.bindButton("paste",b,Model.applicationProperties,"emptyClipboard");this.bindButton("paste-as-shortcut",b,Model.applicationProperties,"emptyClipboard");this.bindButtonCustomEvent("delete",
c,Display.selection,"selection-changed");this.bindButton("z-index-bring-to-front",d,Display.selection,"attached_elements");this.bindButton("z-index-send-to-back",d,Display.selection,"attached_elements");this.bindButton("z-index-bring-forward",d,Display.selection,"attached_elements");this.bindButton("z-index-send-backward",d,Display.selection,"attached_elements");var b=["copy","cut","show-references"],c="align-vertical-top align-vertical-bottom align-vertical-center align-horizontal-left align-horizontal-right align-horizontal-center size-same-height size-same-width".split(" "),
d="distribution-vertical-just distribution-vertical-top distribution-vertical-center distribution-vertical-bottom distribution-horizontal-just distribution-horizontal-left distribution-horizontal-center distribution-horizontal-right".split(" "),e=function(){var a=Display.selection.getAttachedElements();return 1<=_.filter(a,function(a){return a.has("width")}).length},f=function(){var a=Display.selection.getAttachedElements();return 2<=_.filter(a,function(a){return a.has("width")}).length},g=function(){var a=
Display.selection.getAttachedElements();return 3<=_.filter(a,function(a){return a.has("width")}).length},h;for(h in b)this.bindButtonCustomEvent(b[h],e,Display.selection,"selection-changed");for(h in c)this.bindButtonCustomEvent(c[h],f,Display.selection,"selection-changed");for(h in d)this.bindButtonCustomEvent(d[h],g,Display.selection,"selection-changed");this.bindButton("size-adjust-to-text",function(){return 0<Display.selection.getAttachedElements().length},Display.selection,"attached_elements");
this.bindButton("undo",a,Model.applicationProperties,"hasUndo");this.bindButton("redo",a,Model.applicationProperties,"hasRedo");this.bindButton("zoom-in",function(a){return 4>a},Model.diagramProperties,"zoom");this.bindButton("zoom-out",function(a){return 0.25<a},Model.diagramProperties,"zoom");this.setButtonActive("zoom-1-1",!0);this.bindButtonPressed("display-left-panel",a,Model.applicationProperties,"display-left-panel");this.bindButtonPressed("display-right-panel",a,Model.applicationProperties,
"display-right-panel");this.setButtonActive("sql",!0);this.setButtonActive("share",!0);this.setButtonActive("png",!0);this.setButtonActive("xml",!0);this.updateButtonDrawer("file");Model.diagramProperties.on("change:zoom",function(a,b){$("#current_zoom_widget").text(Math.floor(100*a.get("zoom"))+"%")});$("#custom_zoom_widget").click(function(){app.diagram.zoomCustom(parseFloat($(this).val()),!1)});Model.metaInfo.on("change:mode",this.updateEditableReadonly,this);Model.metaInfo.on("change:canShareModel",
this.updateShareButton,this);Model.metaInfo.on("change:updateTableLimitExceeded",this.updateTableLimitExceeded,this);Model.metaInfo.on("change:mode",this.updateTableLimitExceeded,this);Model.metaInfo.on("change:accountPlanFree",this.updateShowReferencesButton);this.render();this.updateShareButton();this.updateEditableReadonly();this.updateTableLimitExceeded();this.updateSaveButton()},updateShareButton:function(){var a=!1==Model.metaInfo.get("canShareModel");this.$(".toolbar-button-share").toggleClass("toolbar-disabled-button",
a)},updateTableLimitExceeded:function(){for(var a=["save","share","png","sql","xml"],b=Model.metaInfo.get("tableLimitExceeded"),c=0;c<a.length;c++)this.$(".toolbar-button-"+a[c]).toggleClass("toolbar-disabled-button",b)},updateEditableReadonly:function(){for(var a="copy cut paste paste-as-shortcut delete align-vertical-top align-vertical-bottom align-vertical-center align-horizontal-left align-horizontal-right align-horizontal-center distribution-vertical-just distribution-vertical-top distribution-vertical-center distribution-vertical-bottom distribution-horizontal-just distribution-horizontal-left distribution-horizontal-center distribution-horizontal-right size-adjust-to-text size-same-height size-same-width z-index-bring-to-front z-index-send-to-back z-index-bring-forward z-index-send-backward show-references".split(" "),
b=!1==app.isEditable(),c=0;c<a.length;c++)this.$(".toolbar-button-"+a[c]).toggleClass("toolbar-disabled-button",b)},updateSaveButton:function(){if(!1==app.isEditable())this.setButtonActive("save",!1);else{var a=this.$(".toolbar-button-save");!1==Model.fuseBox.get("ajax").ok()||!1==Model.fuseBox.get("table_limit").ok()?(this.setButtonActive("save",!1),a.removeClass("toolbar-processing-button"),a.addClass("toolbar-locked-button")):Model.applicationProperties.get("saveInProgress")?(this.setButtonActive("save",
!1),a.removeClass("toolbar-locked-button"),a.addClass("toolbar-processing-button")):(a.removeClass("toolbar-processing-button"),a.removeClass("toolbar-locked-button"),a=Model.applicationProperties.get("dirtyModel"),this.setButtonActive("save",a))}},updateShowReferencesButton:function(){Model.metaInfo.get("accountPlanFree")?$("li [data-toolbar=references]").hide():$("li [data-toolbar=references]").show()},click_save:function(){app.manualSave();return!1},click_share:function(){if(app.isAnonymous)return app.showOnlyForRegisteredUsersPopup(),
!1;if(!1==Model.metaInfo.get("canShareModel"))return!1;$("#share_model_button_wrapper A").click();return!1},click_sql:function(){app.showSqlGeneratorForm();return!1},click_png:function(){if(app.isAnonymous)return app.showOnlyForRegisteredUsersPopup(),!1;Diagram.Exporter.exportToImage();return!1},click_xml:function(){app.generateXML();return!1},click_copy:function(){Clipboard.copy();return!1},click_paste:function(){Clipboard.paste();return!1},click_paste_as_shortcut:function(){Clipboard.pasteAsShortcut();
return!1},click_cut:function(){Clipboard.cut();return!1},click_delete:function(){Clipboard.delete();return!1},click_undo:function(){Commands.undo();return!1},click_redo:function(){Commands.redo();return!1},click_zoom_out:function(){app.diagram.zoomOut(!1);return!1},click_zoom_in:function(){app.diagram.zoomIn(!1);return!1},click_zoom_1_1:function(){app.diagram.zoom11(!1);return!1},click_display_left_panel:function(){Model.applicationProperties.set("display-left-panel",!Model.applicationProperties.get("display-left-panel"));
return!0},click_display_right_panel:function(){Model.applicationProperties.set("display-right-panel",!Model.applicationProperties.get("display-right-panel"));return!0},click_display_diagram:function(){return!0},click_show_references:function(){Commands.showReferences();return!1},_resize_rectangle_elements:function(a,b){for(var c=Display.selection.getAttachedElements(),d=[],e=0;e<c.length;e++){var f=c[e];f.has("width")&&d.push(f)}if(!(2>d.length)){var g=a(d);Commands.beginGroupCommands();Model.groupOperation.doWithLock(function(){for(var a=
0;a<d.length;a++){var c=d[a],e=b(g,c);c instanceof Model.TableDisplay?Commands.resizeTableDisplay(c.get("id"),e.width,e.height):c instanceof Model.Note?Commands.resizeNote(c.get("id"),e.width,e.height):c instanceof Model.ViewDisplay&&Commands.resizeViewDisplay(c.get("id"),e.width,e.height)}});Commands.endGroupCommands()}},click_size_same_width:function(){this._resize_rectangle_elements(function(a){return a[0].get("width")},function(a,b){return{width:a,height:b.get("height")}});return!1},click_size_same_height:function(){this._resize_rectangle_elements(function(a){return a[0].get("height")},
function(a,b){return{width:b.get("width"),height:a}});return!1},click_size_adjust_to_text:function(){var a=Display.selection.getAttachedElements();Commands.beginGroupCommands();Model.groupOperation.doWithLock(function(){for(var b=0;b<a.length;b++){var c=a[b];c instanceof Model.TableDisplay?Commands.adjustTableDisplaySizeToText(c.get("id")):c instanceof Model.ViewDisplay?Commands.adjustViewDisplaySizeToText(c.get("id")):c instanceof Model.Note&&Commands.adjustNoteSizeToText(c.get("id"))}});Commands.endGroupCommands();
return!1},_alignElementsByFirstSelected:function(a){var b=Display.selection.getAttachedElements(),c=_.filter(b,function(a){return a.has("width")}),d=c[0];Commands.beginGroupCommands();Model.groupOperation.doWithLock(function(){for(var b=1;b<c.length;b++){var f=c[b],g=a(d,f);f instanceof Model.TableDisplay?Commands.moveTableDisplay(f.get("id"),g.x,g.y,!0):f instanceof Model.Note?Commands.moveNote(f.get("id"),g.x,g.y,!0):f instanceof Model.ViewDisplay&&Commands.moveViewDisplay(f.get("id"),g.x,g.y,!0)}});
Commands.endGroupCommands()},click_align_vertical_top:function(){this._alignElementsByFirstSelected(function(a,b){return{x:b.get("x"),y:a.get("y")}});return!1},click_align_vertical_center:function(){this._alignElementsByFirstSelected(function(a,b){var c=a.get("y")+a.get("height")/2-b.get("height")/2;return{x:b.get("x"),y:c}});return!1},click_align_vertical_bottom:function(){this._alignElementsByFirstSelected(function(a,b){var c=a.get("y")+a.get("height")-b.get("height");return{x:b.get("x"),y:c}});
return!1},click_align_horizontal_left:function(){this._alignElementsByFirstSelected(function(a,b){return{x:a.get("x"),y:b.get("y")}});return!1},click_align_horizontal_center:function(){this._alignElementsByFirstSelected(function(a,b){return{x:a.get("x")+a.get("width")/2-b.get("width")/2,y:b.get("y")}});return!1},click_align_horizontal_right:function(){this._alignElementsByFirstSelected(function(a,b){return{x:a.get("x")+a.get("width")-b.get("width"),y:b.get("y")}});return!1},_distributeJust:function(a,
b){var c=Display.selection.getAttachedElements(),c=_.filter(c,function(a){return a.has("width")}),d=_.sortBy(c,function(b){return b.get(a.axis)}),e=d[0],d=_.rest(d),f=_.max(d,function(b){return b.get(a.axis)+b.get(a.size)}),d=_.without(d,f),g=_.reduce(c,function(b,c){return b+c.get(a.size)},0),h=(f.get(a.axis)+f.get(a.size)-e.get(a.axis)-g)/(c.length-1);Commands.beginGroupCommands();Model.groupOperation.doWithLock(function(){for(var a=e,c=0;c<d.length;++c){var f=d[c],a=b(f,a,h);f instanceof Model.TableDisplay?
Commands.moveTableDisplay(f.get("id"),a.x,a.y,!0):f instanceof Model.Note?Commands.moveNote(f.get("id"),a.x,a.y,!0):f instanceof Model.ViewDisplay&&Commands.moveViewDisplay(f.get("id"),a.x,a.y,!0);a=f}});Commands.endGroupCommands()},click_distribution_vertical_just:function(){this._distributeJust({axis:"y",size:"height"},function(a,b,c){return{x:a.get("x"),y:b.get("y")+b.get("height")+c}});return!1},click_distribution_horizontal_just:function(){this._distributeJust({axis:"x",size:"width"},function(a,
b,c){return{x:b.get("x")+b.get("width")+c,y:a.get("y")}});return!1},_distributeTop:function(a,b){var c=Display.selection.getAttachedElements(),c=_.filter(c,function(a){return a.has("width")}),d=_.sortBy(c,function(b){return b.get(a.axis)}),e=d[0],d=_.rest(d),f=_.max(d,function(b){return b.get(a.axis)+b.get(a.size)}),d=_.without(d,f),g=(f.get(a.axis)-e.get(a.axis))/(c.length-1);Commands.beginGroupCommands();Model.groupOperation.doWithLock(function(){for(var a=e,c=0;c<d.length;++c){var f=d[c],a=b(f,
a,g);f instanceof Model.TableDisplay?Commands.moveTableDisplay(f.get("id"),a.x,a.y,!0):f instanceof Model.Note?Commands.moveNote(f.get("id"),a.x,a.y,!0):f instanceof Model.ViewDisplay&&Commands.moveViewDisplay(f.get("id"),a.x,a.y,!0);a=f}});Commands.endGroupCommands()},click_distribution_vertical_top:function(){this._distributeTop({axis:"y",size:"height"},function(a,b,c){return{x:a.get("x"),y:b.get("y")+c}});return!1},click_distribution_horizontal_left:function(){this._distributeTop({axis:"x",size:"width"},
function(a,b,c){return{x:b.get("x")+c,y:a.get("y")}});return!1},_distributeCenter:function(a,b){var c=Display.selection.getAttachedElements(),c=_.filter(c,function(a){return a.has("width")}),d=_.sortBy(c,function(b){return b.get(a.axis)+b.get(a.size)/2}),e=_.first(d),d=_.rest(d),f=_.last(d),d=_.without(d,f),g=e.get(a.axis)+e.get(a.size)/2,h=(f.get(a.axis)+f.get(a.size)/2-g)/(c.length-1);Commands.beginGroupCommands();Model.groupOperation.doWithLock(function(){for(var a=e,c=0;c<d.length;++c){var f=
d[c],a=b(f,a,h);f instanceof Model.TableDisplay?Commands.moveTableDisplay(f.get("id"),a.x,a.y,!0):f instanceof Model.Note?Commands.moveNote(f.get("id"),a.x,a.y,!0):f instanceof Model.ViewDisplay&&Commands.moveViewDisplay(f.get("id"),a.x,a.y,!0);a=f}});Commands.endGroupCommands()},click_distribution_vertical_center:function(){this._distributeCenter({axis:"y",size:"height"},function(a,b,c){return{x:a.get("x"),y:b.get("y")+b.get("height")/2+c-a.get("height")/2}});return!1},click_distribution_horizontal_center:function(){this._distributeCenter({axis:"x",
size:"width"},function(a,b,c){return{x:b.get("x")+b.get("width")/2+c-a.get("width")/2,y:a.get("y")}});return!1},_distributeBottom:function(a,b){var c=Display.selection.getAttachedElements(),c=_.filter(c,function(a){return a.has("width")}),d=_.sortBy(c,function(b){return 0-(b.get(a.axis)+b.get(a.size))}),e=d[0],d=_.rest(d),f=_.last(d),d=_.without(d,f),g=(f.get(a.axis)+f.get(a.size)-(e.get(a.axis)+e.get(a.size)))/(c.length-1);Commands.beginGroupCommands();Model.groupOperation.doWithLock(function(){for(var a=
e,c=0;c<d.length;++c){var f=d[c],a=b(f,a,g);f instanceof Model.TableDisplay?Commands.moveTableDisplay(f.get("id"),a.x,a.y,!0):f instanceof Model.Note?Commands.moveNote(f.get("id"),a.x,a.y,!0):f instanceof Model.ViewDisplay&&Commands.moveViewDisplay(f.get("id"),a.x,a.y,!0);a=f}});Commands.endGroupCommands()},click_distribution_vertical_bottom:function(){this._distributeBottom({axis:"y",size:"height"},function(a,b,c){return{x:a.get("x"),y:b.get("y")+b.get("height")+c-a.get("height")}});return!1},click_distribution_horizontal_right:function(){this._distributeBottom({axis:"x",
size:"width"},function(a,b,c){return{x:b.get("x")+b.get("width")+c-a.get("width"),y:a.get("y")}});return!1},click_z_index_bring_to_front:function(){for(var a=Display.selection.getAttachedElements(),a=_.filter(a,function(a){return a instanceof Model.Area}),a=_.sortBy(a,function(a){return-a.zIndex}),b=0;b<a.length;b++)Commands.bringAreaToTop(a[b].get("id"));return!1},click_z_index_send_to_back:function(){for(var a=Display.selection.getAttachedElements(),a=_.filter(a,function(a){return a instanceof Model.Area}),
a=_.sortBy(a,function(a){return a.zIndex}),b=0;b<a.length;b++)Commands.bringAreaToBottom(a[b].get("id"));return!1},click_z_index_bring_forward:function(){for(var a=Display.selection.getAttachedElements(),a=_.filter(a,function(a){return a instanceof Model.Area}),a=_.sortBy(a,function(a){return-a.zIndex}),b=0;b<a.length;b++)Commands.bringAreaUp(a[b].get("id"));return!1},click_z_index_send_backward:function(){for(var a=Display.selection.getAttachedElements(),a=_.filter(a,function(a){return a instanceof
Model.Area}),a=_.sortBy(a,function(a){return a.zIndex}),b=0;b<a.length;b++)Commands.bringAreaDown(a[b].get("id"));return!1},render:function(){var a="main-menu sql xml save share edit copy cut paste paste-as-shortcut delete undo redo shape size align distribution references align-vertical-top align-vertical-bottom align-vertical-center align-horizontal-left align-horizontal-right align-horizontal-center distribution-vertical-just distribution-vertical-top distribution-vertical-center distribution-vertical-bottom distribution-horizontal-just distribution-horizontal-left distribution-horizontal-center distribution-horizontal-right size-same-height size-same-width z-index-bring-to-front z-index-send-to-back z-index-bring-forward z-index-send-backward".split(" "),
b=["png","sql","xml"];switch(app.mode){case App.MODE.EDIT:this.updateShowReferencesButton();break;case App.MODE.PREVIEW_VERSION:case App.MODE.PREVIEW:_.each(a,function(a){this.$("li[data-toolbar="+a+"]").hide()});break;case App.MODE.INTERNAL_PREVIEW:_.each(a,function(a){this.$("li[data-toolbar="+a+"]").hide()});_.each(b,function(a){this.$("li[data-toolbar="+a+"]").hide()});this.$("li[data-toolbar=xml]").show();break;case App.MODE.PUBLIC_PREVIEW:_.each(a,function(a){this.$("li[data-toolbar="+a+"]").hide()});
_.each(b,function(a){this.$("li[data-toolbar="+a+"]").hide()});break;case App.MODE.EMBEDDED:throw Error("Impossible");default:throw Error("Unsupported mode: "+this.mode);}return this}});
UI.MainMenu=UI.CommonMenu.extend({initialize:function(){UI.CommonMenu.prototype.initialize.apply(this,arguments);this.TOOLTIP_SHOW_DELAY=0;var a=this;this.model.on("change",function(b){a.updateCurrentModel()});Model.metaInfo.on("reset",function(b){a.updateCurrentModel()});Model.metaInfo.on("change",function(b){a.updateCurrentModel()});this.model.on("reset",function(b){a.updateModels()});Model.metaInfo.on("change:mode",a.updateEditableReadonly,this);this.setButtonActive("details",!0);this.setButtonActive("set-tag",
!0);this.setButtonActive("export-to-xml",!1);this.setButtonActive("view-as-image",!1);this.updateDrawer("models");this.updateCurrentModel();this.updateModels();this.updateEditableReadonly();this.render()},click_details:function(a){app.switchToModelDetails();return!1},click_change_model:function(a){a=$(a.currentTarget).data("model-id");app.switchToModel(a)},click_set_tag:function(){app.setTag.show();return!1},updateCurrentModel:function(){this.$(".modeler-main-menu-name").html(Model.metaInfo.escape("name")||
"&nbsp;");var a=Model.metaInfo.escape("mode");app.mode==App.MODE.PUBLIC_PREVIEW?this.$(".modeler-main-menu-edit-mode").text("(Public preview)"):app.mode==App.MODE.PREVIEW?this.$(".modeler-main-menu-edit-mode").text("(Preview)"):app.mode==App.MODE.PREVIEW_VERSION?this.$(".modeler-main-menu-edit-mode").text("(Preview version)"):app.mode==App.MODE.EDIT&&("edit"==a?this.$(".modeler-main-menu-edit-mode").text("(Edit mode)"):this.$(".modeler-main-menu-edit-mode").text("(Read-only mode)"))},updateModels:function(){var a=
this.$(".toolbar-button-models").find("> .toolbar-drawer-content > UL.menu");a.html("");for(var b=0;b<this.model.size();b++){var c=$("<li></li>");a.append(c);c.append('<span class="icon"></span>');c.append($('<span class="label"></span>').text(this.model.at(b).get("name")));c.data("model-id",this.model.at(b).get("id"));c.data("toolbar","change-model");c.addClass("toolbar-button toolbar-button-change-model");Model.metaInfo.get("id")==this.model.at(b).get("id")?c.addClass("toolbar-passive-button modelerer-main-menu-selected"):
c.addClass("toolbar-active-button")}this.updateDrawer("models")},updateEditableReadonly:function(){for(var a=["set-tag","validation-setting"],b=!1==app.isEditable(),c=0;c<a.length;c++)this.$(".toolbar-button-"+a[c]).toggleClass("toolbar-disabled-button",b)},render:function(){var a="details set-tag export-to-xml view-as-image validation-setting models".split(" "),b=["main-menu"];switch(app.mode){case App.MODE.EDIT:break;case App.MODE.PREVIEW_VERSION:case App.MODE.PREVIEW:case App.MODE.INTERNAL_PREVIEW:_.each(a,
function(a){this.$("li[data-toolbar="+a+"]").hide()});break;case App.MODE.PUBLIC_PREVIEW:_.each(a,function(a){this.$("li[data-toolbar="+a+"]").hide()});_.each(b,function(a){this.$("li[data-toolbar="+a+"]").hide()});break;case App.MODE.EMBEDDED:throw Error("Impossible");default:throw Error("Unsupported mode: "+this.mode);}}});
UI.ValidationProperties=Backbone.View.extend({initialize:function(){this.sections="table table_column table_alternate_key table_checks table_index reference sequence view view_column".split(" ");this.sectionLabel={table:"Table",table_column:"Table column",table_alternate_key:"Table alternate key",table_checks:"Table check",table_index:"Table index",reference:"Reference",sequence:"Sequence",view:"View",view_column:"View column"};this.levels=["errors","warnings","hints"];this.model.on("change",this.update.bind(this));
this.render();this.update()},events:{"change .validation_property":"change"},change:function(a){var b=$(a.target);a=b.data("section");var c=b.data("level"),d=b.data("rule"),b=b.is(":checked");this.model.setEnabled(a,c,d,b);Model.Validation.Validator.touch()},update:function(){for(var a in this.sections){var b=this.sections[a],c;for(c in this.levels){var d=this.levels[c],e=Model.Validation.Rules[b][d],f;for(f in e)e="validation-properties-"+this.model.key(b,d,f),this.$("#"+e)[0].checked=this.model.isEnabled(b,
d,f)}}},render:function(){var a=UI.template("validation-properties-template")({});this.$el.html(a);for(var b in this.sections){var a=this.sections[b],c=this.sectionLabel[a],c=UI.template("validation-properties-section-template")({title:c});this.$el.find(".validation_properties_content").append(c);for(var d in this.levels){var c=this.levels[d],e=Model.Validation.Rules[a][c],f;for(f in e)e="validation-properties-"+this.model.key(a,c,f),e=UI.template("validation-properties-property-template")({name:f,
level:c,id:e,section:a,rule:f}),this.$el.find(".validation_properties_list").last().append(e)}}}});
UI.SetTag=Backbone.View.extend({initialize:function(){this.render()},elements:{ERROR_EMPTY_TAG_NAME:".error_empty_tag_name",ERROR_TAG_ALREADY_EXISTS:".error_tag_already_exists",FIELD:"input[name=name]"},events:{"click .set_tag_button":"setTag","click .hide_button":"hide"},setTag:function(){var a=this.$(this.elements.FIELD).val();this.hideError(this.elements.FIELD,this.elements.ERROR_EMPTY_TAG_NAME);this.hideError(this.elements.FIELD,this.elements.ERROR_TAG_ALREADY_EXISTS);if(""==a)this.showError(this.elements.FIELD,
this.elements.ERROR_EMPTY_TAG_NAME);else{var b=this,c=function(){Model.tagVersion(a,function(){b.taggingDone(a)},function(){b.showError(b.elements.FIELD,b.elements.ERROR_TAG_ALREADY_EXISTS)});Model.applicationProperties.off("after-save",c)};Model.applicationProperties.on("after-save",c);Model.save("Tag set")}},showError:function(a,b){this.$(a).addClass("field_error");this.$(b).show()},hideError:function(a,b){this.$(a).removeClass("field_error");this.$(b).hide()},show:function(){this.$(this.elements.FIELD).val("");
this.hideError(this.elements.FIELD,this.elements.ERROR_EMPTY_TAG_NAME);this.hideError(this.elements.FIELD,this.elements.ERROR_TAG_ALREADY_EXISTS);epoint.ow.popup.PopupManager.openPopup(this.$el[0].id);epoint.ow.popup.PopupManager.openPopupCover()},taggingDone:function(a){app.notification.show("You set "+a+" tag for your model");this.hide()},hide:function(){epoint.ow.popup.PopupManager.closePopup(this.$el[0].id);epoint.ow.popup.PopupManager.closePopupCover()},render:function(){var a=this,b=UI.template("set-tag-template")({});
this.$el.find(".popup_inner").html(b);this.$el.find(".close-popup-button").unbind("click").bind("click",function(){a.hide()})}});
UI.VersionNavigator=Backbone.View.extend({initialize:function(){this.model.on("reset",this.update,this);Model.metaInfo.on("change:versionId",this.update,this);this.render();this.update()},events:{"change select[name=version]":"selectVersion","click  button[name=prev]":"selectPrev","click  button[name=next]":"selectNext"},loadVersion:function(a,b){Model.load(a,b)},selectNext:function(){var a=this.versionIndexOf(),a=this.model.at(a-1);this.loadVersion(Model.metaInfo.get("id"),a.get("id"))},selectPrev:function(){var a=
this.versionIndexOf(),a=this.model.at(a+1);this.loadVersion(Model.metaInfo.get("id"),a.get("id"))},selectVersion:function(){var a=this.$("select[name=version]").val();this.loadVersion(Model.metaInfo.get("id"),a)},versionIndexOf:function(){return Model.modelVersions.indexOf(Model.modelVersions.get(Model.metaInfo.get("versionId")))},update:function(){this.$("select[name=version]").html("");var a=this.$("select[name=version]");this.model.each(function(b){var d=$("<option></option>");$(d).text(b.get("name"));
$(d).val(b.get("id"));a.append(d)});a.val(Model.metaInfo.get("versionId"));var b=this.versionIndexOf();0==b?this.$("button[name=next]").attr("disabled",!0):this.$("button[name=next]").attr("disabled",!1);b==Model.modelVersions.size()-1?this.$("button[name=prev]").attr("disabled",!0):this.$("button[name=prev]").attr("disabled",!1)},render:function(){var a=UI.template("version-navigator-template");this.$el.html(a({}));this.$el.show();return this}});
UI.PreviewInfoHeader=Backbone.View.extend({initialize:function(){this.model.on("change",this.render,this);this.render()},events:{},render:function(){var a=null;if(void 0!=this.model.get("name")){switch(app.mode){case App.MODE.INTERNAL_PREVIEW:a="preview-info-header-internal-template";break;case App.MODE.PREVIEW:a="preview-info-header-template";break;case App.MODE.PREVIEW_VERSION:a="preview-info-header-version-template";break;case App.MODE.PUBLIC_PREVIEW:a="preview-info-header-public-template"}null!=
a&&(a=UI.template(a)({version_name:_.escape(this.model.get("versionName")),name:_.escape(this.model.get("name")),author:_.escape(this.model.get("author"))}),this.$el.html(a),oneweb.DocumentReadyManager.runAllActions());this.$el.show();this.$el.closest(".border_layout_center")[0]&&app.updateBorderLayoutCenter();return this}}});UI.ModelDetailsInternal={};
UI.ModelDetailsInternal.AdditionalSQL=Backbone.View.extend({initialize:function(){this.model.on("add",this.update,this);this.model.on("remove",this.update,this);this.model.on("change",this.update,this);this.model.on("reset",this.update,this);var a=this;this.$el.bind("section:show",function(){a.refresh()});this.render();this.update();this.refresh()},events:{"change textarea[name='additionalSQLBeforeCreate']":"change","change textarea[name='additionalSQLAfterCreate']":"change","change textarea[name='additionalSQLBeforeDrop']":"change",
"change textarea[name='additionalSQLAfterDrop']":"change"},change:function(a){Commands.changeModelProperty(a.target.name,a.target.value)},update:function(){void 0!=this.model.get("additionalSQLBeforeCreate")&&this.createScriptBefore.setValue(this.model.get("additionalSQLBeforeCreate").get("value"));void 0!=this.model.get("additionalSQLAfterCreate")&&this.createScriptAfter.setValue(this.model.get("additionalSQLAfterCreate").get("value"));void 0!=this.model.get("additionalSQLBeforeDrop")&&this.dropScriptBefore.setValue(this.model.get("additionalSQLBeforeDrop").get("value"));
void 0!=this.model.get("additionalSQLAfterDrop")&&this.dropScriptAfter.setValue(this.model.get("additionalSQLAfterDrop").get("value"))},refresh:function(){this.createScriptBefore.refresh();this.createScriptAfter.refresh();this.dropScriptBefore.refresh();this.dropScriptAfter.refresh()},render:function(){var a=UI.template("model-details-additional-sql-template");this.$el.html(a({}));this.createScriptBefore=new UI.SQLEditor("Model Additional SQL Script - At the begining of create script",this.$("textarea[name='additionalSQLBeforeCreate']").get(0));
this.createScriptAfter=new UI.SQLEditor("Model Additional SQL Script - At the end of create script",this.$("textarea[name='additionalSQLAfterCreate']").get(0));this.dropScriptBefore=new UI.SQLEditor("Model Additional SQL Script - At the begining of drop script",this.$("textarea[name='additionalSQLBeforeDrop']").get(0));this.dropScriptAfter=new UI.SQLEditor("Model Additional SQL Script - At the end of drop script",this.$("textarea[name='additionalSQLAfterDrop']").get(0));return this}});
UI.ModelDetailsInternal.SqlGeneration=Backbone.View.extend({initialize:function(){this.model.on("add",this.update,this);this.model.on("remove",this.update,this);this.model.on("change",this.update,this);this.model.on("reset",this.update,this);this.render();this.update()},events:{"change input[id='sql-generation-quote-identifiers']":"change"},change:function(a){a=this.$("input[name='quote-identifiers']").is(":checked");Commands.changeSqlQuoteProperty(a)},update:function(){var a=this.model.get("sql_quote");
void 0!=a&&(a=a.get("value"),!0==a||"true"==a?this.$("#sql-generation-quote-identifiers").prop("checked",!0):this.$("#sql-generation-quote-identifiers").prop("checked",!1))},render:function(){var a=UI.template("model-details-sql-generation-template");this.$el.html(a({}));return this}});
UI.ModelDetails=Backbone.View.extend({initialize:function(){var a=this;this.selected=this.columns=this.basics=null;Model.selection.on("element_selected",function(b){a.hide()});Model.selection.on("element_deselected",function(b){a.show()});this.model.on("change",a.update,this);Model.tables.on("add",this.update,this);Model.tables.on("remove",this.update,this);Model.tables.on("reset",this.update,this);this.render();this.update();this.show()},events:{"click summary":"toggleDetails"},toggleDetails:function(a){a=
$(a.currentTarget).closest(".details");a.attr("section");var b=a.attr("open");$(a).find(".content > div").trigger(b?"section:hide":"section:show")},hide:function(){this.$el.hide()},show:function(){this.$el.show()},update:function(){if(void 0!=this.model.get("name"))switch(this.$(".model_details_model_name").text(this.model.escape("name")),this.$(".model_details_version_name").text(this.model.escape("versionName")),this.$(".model_details_database_definition").text(this.model.escape("databaseDefinition")),
this.model.get("hideTableLimitInfo")?this.$(".model_details_limit_info").hide():this.$(".model_details_limit_info").show(),this.model.get("tableLimitExceeded")?this.$(".model_details_tables").text(this.model.get("tables")):this.$(".model_details_tables").text(Model.tables.size()),this.$(".model_details_tables_max").text(this.model.get("tableLimit")),app.mode){case App.MODE.EDIT:case App.MODE.PREVIEW_VERSION:case App.MODE.PREVIEW:this.$(".modelDetailsTableLimitInfo").show();break;default:this.$(".modelDetailsTableLimitInfo").hide()}},
render:function(){var a=UI.template("model-details-template");this.$el.html(a({}));this.$(".modelDetailsTableLimitInfo").hide();this.additionalSql=new UI.ModelDetailsInternal.AdditionalSQL({el:this.$(".model-details-additional-properties"),model:Model.properties});this.validationProperties=new UI.ValidationProperties({el:$(".model-details-validation-properties"),model:Model.validationProperties});this.sqlGeneration=new UI.ModelDetailsInternal.SqlGeneration({el:$(".model-details-sql-generation-properties"),
model:Model.properties});this.update();return this}});
UI.Messages=Backbone.View.extend({initialize:function(){this.counter=1;this.render();this.update()},events:{"click .message-navigation .next":"showNext","click .message-navigation .prev":"showPrev","click .simple-message-close":"closeSimpleMessage"},closeSimpleMessage:function(a){a=$(a.target).attr("data-message-id");a=this.$("#message-"+a);this.removeMessage(a)},getVisibleId:function(){return $("#messages .message:visible").attr("data-message-id")},shift:function(a){var b=this.getMessageIds();if(0==
b.length)this.update();else{var c=this.getVisibleId();void 0==c&&(c=b[0]);c=b.indexOf(c);c=(b.length+c+a)%b.length;this.showById(b[c])}},showNext:function(){this.shift(1);this.update()},showPrev:function(){this.shift(-1);this.update()},getMessageIds:function(){return _.map($("#messages .message"),function(a){return $(a).attr("data-message-id")})},showById:function(a){this.$(".message").hide();this.$("#message-"+a).show()},update:function(){var a=this.getMessageIds();if(0==a.length)this.hide();else{this.show();
this.$(".message-navigation").toggle(1<a.length);this.$el.toggleClass("with-navigation",1<a.length);var b=this.getVisibleId(),c=0;void 0==b?(b=a[c],this.showById(b)):c=a.indexOf(b);0==c?this.$(".message-navigation .prev").attr("disabled","disabled"):this.$(".message-navigation .prev").removeAttr("disabled");c==a.length-1?this.$(".message-navigation .next").attr("disabled","disabled"):this.$(".message-navigation .next").removeAttr("disabled")}},nextId:function(){this.counter++;return this.counter},
addMessage:function(a){var b=this.newMessage(),c=$("<button>Hide</button>");c.addClass("simple-message-close");c.attr("data-message-id",this.counter);$(b).append(c);c=$("<span></span>");$(b).append(c);c.html(a);return b},newMessage:function(){var a=this.nextId(),b=$("<div></div>");b.attr("id","message-"+a);b.attr("data-message-id",a);b.addClass("message");this.$(".message-messages-container").append(b);var c=$("<div></div>").addClass("message-div");c.attr("data-message-id",a);b.append(c);this.showById(a);
this.update();return c},showOnTop:function(a){a=$(a).attr("data-message-id");this.showById(a);this.update()},removeMessage:function(a){a=$(a).attr("data-message-id");$("#message-"+a).remove();this.update()},hide:function(){this.$el.hide();app.updateBorderLayoutCenter()},show:function(){this.$el.show();app.updateBorderLayoutCenter()},render:function(){var a=UI.template("message-template");this.$el.html(a({}));return this}});
UI.TableLimitMessage=Backbone.View.extend({initialize:function(){var a=this;this.model.on("change",function(b){a.render()});Model.metaInfo.on("change:mode",function(){a.render()});this.render()},events:{"click .change_account_plan":"changeAccountPlan","click .signup":"signup"},signup:function(){app.redirect("/sign-up")},changeAccountPlan:function(){app.redirect("/redirect/change_account_plan")},render:function(){if(this.model.ok()||"edit"!=Model.metaInfo.get("mode"))return null!=this.el&&app.messages.removeMessage(this.el),
this.setElement(null),this;var a=app.messages.newMessage();this.setElement(a);var b=null,b=app.isAnonymous?UI.template("table-limit-anonymous-message-template"):UI.template("table-limit-message-template"),c=Model.metaInfo.get("tableLimit");this.$el.html(b({tables:c}));app.messages.showOnTop(a);return this}});
UI.TableLimitExceededMessage=Backbone.View.extend({initialize:function(){var a=this;this.model.on("change:tableLimitExceeded",function(){a.render()})},events:{"click .change_account_plan":"changeAccountPlan"},changeAccountPlan:function(){app.redirect("/redirect/change_account_plan")},render:function(){if(!1==this.model.get("tableLimitExceeded"))return null!=this.el&&app.messages.removeMessage(this.el),this.setElement(null),this;var a=app.messages.newMessage();this.setElement(a);var b=null,b=UI.template("table-limit-exceeded-message-template"),
c=Model.metaInfo.get("tableLimit");this.$el.html(b({tableLimit:c,accountPlan:Model.metaInfo.get("accountPlan")}));app.messages.showOnTop(a);return this}});UI.AnonymousModelMessage=Backbone.View.extend({initialize:function(){this.render()},events:{"click .signup":"signup"},signup:function(){app.redirect("/sign-up")},render:function(){var a=app.messages.newMessage();this.setElement(a);var b=UI.template("anonymous-model-message-template");this.$el.html(b({tables:20}));app.messages.showOnTop(a);return this}});
UI.AreaDetailsInternal={};
UI.AreaDetailsInternal.Format=Backbone.View.extend({initialize:function(){this.model.on("change:fillColor",this.update,this);this.model.on("change:lineColor",this.update,this);this.model.on("change:dashArray",this.update,this);this.model.on("change:nameColor",this.update,this);this.render();this.update()},events:{"change input[name='lineColor']":"change","change input[name='fillColor']":"change","change select[name='dashArray']":"change","change input[name='nameColor']":"change","focus input[name='lineColor']":"handleFocus",
"focus input[name='fillColor']":"handleFocus","focus input[name='nameColor']":"handleFocus","keydown input[name='lineColor']":"handleKeyDown","keydown input[name='fillColor']":"handleKeyDown","keydown select[name='dashArray']":"handleKeyDown","keydown input[name='nameColor']":"handleKeyDown"},handleFocus:function(a){$(a.target).parent();a=this.$('input[name="'+a.target.name+'"]');this.colorSelector=new UI.ColorPicker({el:$("#color-picker"),model:null,originField:a,type:a.val()})},handleKeyDown:function(a){if(13==
a.keyCode){var b=a.target.name,c;"lineColor"==b||"fillColor"==b||"nameColor"==b?(c=a.target.value,$(a.target).css({"background-color":a.target.value})):c=JSON.parse(a.target.value);Commands.changeArea(this.model.get("id"),b,c)}},change:function(a){var b=a.target.name,c;"lineColor"==b||"fillColor"==b||"nameColor"==b?(c=a.target.value,$(a.target).css({"background-color":a.target.value})):c=JSON.parse(a.target.value);Commands.changeArea(this.model.get("id"),b,c)},unbind:function(){this.model.off(null,
null,this)},update:function(){this.$("input[name=lineColor]").val(this.model.get("lineColor"));this.$("input[name=fillColor]").val(this.model.get("fillColor"));this.$("input[name=nameColor]").val(this.model.get("nameColor"));var a="["+this.model.get("dashArray").toString()+"]";this.$("select[name=dashArray]").val(a);this.$("input[name=lineColor]").css({"background-color":this.model.get("lineColor")});this.$("input[name=fillColor]").css({"background-color":this.model.get("fillColor")});this.$("input[name=nameColor]").css({"background-color":this.model.get("nameColor")})},
set:function(a,b){Commands.changeArea(this.model.get("id"),a,b)},render:function(){var a=UI.template("area-details-format-template");this.$el.html(a({}));return this}});
UI.AreaDetails=Backbone.View.extend({initialize:function(){var a=this;a.selected=null;this.sectionOpenStatus={"primary-data":!0,format:!0};Model.selection.on("element_selected",function(b){b instanceof Model.Area&&(a.selected=b,a.render())});Model.selection.on("element_deselected",function(b){b instanceof Model.Area&&(a.$(":focus").blur(),a.selected=null,a.hide())});this.model.on("change",function(b,c){null!=a.selected&&!b.hasChanged("selected")&&!b.hasChanged("attached")&&b==a.selected&&a.update()});
this.$el.hide()},events:{"change input[name='name']":"change","click summary":"toggleDetails"},toggleDetails:function(a){var b=$(a.currentTarget).closest(".details");a=b.attr("section");b=b.attr("open");b=!(void 0==b?0:"open"==b);this.sectionOpenStatus[a]=b},updateOpenedSection:function(){this.$(".details").removeAttr("open");for(var a in this.sectionOpenStatus)!0==this.sectionOpenStatus[a]&&this.$(".details[section="+a+"]").attr("open","open")},update:function(){this.$("input[name='name']").val(this.selected.get("name"))},
change:function(a){var b=a.target.name;a=a.target.value;Commands.changeArea(this.selected.get("id"),b,a)},hide:function(){this.unbind();this.$el.html("")},unbind:function(){null!=this.format&&(this.format.unbind(),this.format=null)},render:function(){this.unbind();var a=UI.template("area-details-template");this.$el.html(a({}));this.$el.show();this.$("input[name='name']").val(this.selected.get("name"));this.format=new UI.AreaDetailsInternal.Format({el:this.$(".area-details-format"),model:this.selected});
this.updateOpenedSection();this.update();return this}});UI.ProgressBarState=function(a,b,c){this.init(a,b,c)};_.extend(UI.ProgressBarState.prototype,{init:function(a,b,c){this.metaInfoEvent=a;this.progressBarStart=b;this.progressBarEnd=c},getMetaInfoEvent:function(){return this.metaInfoEvent},getProgressBarStart:function(){return this.progressBarStart},getProgressBarEnd:function(){return this.progressBarEnd}});
UI.ProgressBar=Backbone.View.extend({initialize:function(){this._percent=0;this._animationHandler=null;this._states=[];this._currentState=new UI.ProgressBarState(null,0,14);this._registerState(this._currentState);this._registerState(new UI.ProgressBarState("before-load",15,49));this._registerState(new UI.ProgressBarState("during-load-after-request",50,84));this._registerState(new UI.ProgressBarState("during-load-after-model-init",85,99));this._registerFinalState(new UI.ProgressBarState("after-initial-load",
100,100));this.render();this._startAnimation()},_registerState:function(a){this._states.push(a);if(null!=a.getMetaInfoEvent()){var b=this;Model.metaInfo.on(a.getMetaInfoEvent(),function(){b.isFirstLoad()&&b.changeState(a)})}},_registerFinalState:function(a){this._states.push(a);var b=this;Model.metaInfo.on(a.getMetaInfoEvent(),function(){b.changeState(a)})},events:{},isFirstLoad:function(){return 0===Model.applicationProperties.get("loadCounter")},changeState:function(a){this._stopAnimation();this._currentState=
a;this._percent=a.getProgressBarStart();100==this._percent?this.hide():(this.render(),this._startAnimation())},hide:function(){this.$el.hide()},resize:function(a,b){this.$el.css("width",a);this.$el.css("height",b)},_startAnimation:function(){this._debug("startAnimation");this._scheduleNextAnimationFrame()},_scheduleNextAnimationFrame:function(){if(this._percent!=this._currentState.getProgressBarEnd()){var a=this;this._animationHandler=setTimeout(function(){a._debug("animation frame invoked");++a._percent;
a.render();a._scheduleNextAnimationFrame()},150)}},_stopAnimation:function(){this._debug("stopAnimation");null!=this._animationHandler&&(clearTimeout(this._animationHandler),this._animationHandler=null)},render:function(){this._debug("render: percent="+this._percent);this.$el.find(".progress_bar").text(this._percent+"%");this.$el.find("progress").val(this._percent);return this},_debug:function(a){!1!=this._isDebugEnabled()&&console.log(a)},_isDebugEnabled:function(){return!1}});
UI.Notification=Backbone.View.extend({initialize:function(){this.$el.parent().hide()},events:{},timeout:-1,onTimeout:function(){this.$el.fadeOut("slow",function(){$(this).parent().hide()})},show:function(a){clearTimeout(this.timeout);this.$el.find(".content").text(a);this.$el.parent().show();this.$el.stop(!0,!0).show();this.timeout=setTimeout(this.onTimeout.bind(this),3E3)}});
var IntroGuide={render:function(a){return UI.template(a)({})},init:function(){this.introguide=introJs();this.introguide.setOptions({steps:[{element:"none",intro:this.render("intro-guide-welcome-template"),position:"left"},{element:"#help-menu",intro:this.render("intro-guide-start-tour-template"),position:"bottom"},{element:"#diagram",intro:this.render("intro-guide-diagram-template"),position:"left"},{element:".tree",intro:this.render("intro-guide-navigation-tree-template"),position:"right"},{element:".split-pane",
intro:this.render("intro-guide-properties-template"),position:"left"},{element:"#main-toolbar",intro:this.render("intro-guide-toolbar-template"),position:"bottom"},{element:"#toolbox-container",intro:this.render("intro-guide-toolbox-template"),position:"bottom"},{element:".add_table_mode_button",intro:this.render("intro-guide-table-template"),position:"bottom"},{element:".add_relationship_mode_button",intro:this.render("intro-guide-reference-template"),position:"bottom"},{element:"none",intro:this.render("intro-guide-end-template"),
position:"bottom"}].filter(function(a){return"none"===a.element?!0:$(a.element).is(":visible")})})},start:function(){this.init();$.cookie("introguide_run",1,{path:"/",expires:26500});this.introguide.start()}};
UI.SQLEditor=function(a,b){function c(a){!1===f.codeMirror.getOption("readOnly")&&(f.codeMirror.setOption("readOnly","nocursor"),f.editorWindow=new UI.EditorWindow({el:$("#editor-window"),title:f.title,origin:f.codeMirror,editorSaveFunction:d,editorCancelFunction:e}))}function d(a){g.setValue(a.getValue());g.setOption("readOnly",!1);a=a.getCursor();g.setCursor(a.line,a.ch);g.focus()}function e(a){g.setOption("readOnly",!1);g.focus()}var f=this;this.title=a;var g=this.codeMirror=CodeMirror.fromTextArea(b,
{mode:"text/x-plsql",extraKeys:{F11:c}}),h=$("<span>").addClass("key").text("F11"),h=$("<button>").addClass("setting_edit_button").text("Fullscreen edit").append(h).click(c);$(b).closest(".element").prevAll(".label").append(h);this.codeMirror.on("blur",function(){!1==f.codeMirror.isClean()&&($(b).val(f.getValue()),$(b).change())});this.refresh()};UI.SQLEditor.prototype.getValue=function(){return this.codeMirror.getValue()};
UI.SQLEditor.prototype.setValue=function(a){this.codeMirror.setValue(a);this.refresh();this.codeMirror.markClean()};UI.SQLEditor.prototype.close=function(){this.codeMirror.off("blur",null);this.editorWindow&&this.editorWindow.close()};UI.SQLEditor.prototype.refresh=function(){var a=this;a.codeMirror.refresh();setTimeout(function(){a.codeMirror.refresh()},100)};
SqlGenerator={Form:{el:"#sql_generator_form_container",popupPosition:function(a){0<$(".toolbar-button-sql").length&&(a=$(".toolbar-button-sql").offset().left,0==a&&(a=(a=$(".toolbar-button-sql").closest(".toolbar-drawer-content:visible").offset())&&a.left||0),0==a&&(a=$(".toolbar-button-tools").offset().left),$("#sql_generator_form_container").css("left",a-33));if($(".border_layout")[0]){a=$("#sql_generator_form_container");var b=app.calcCenterAvailHeight(),c=a.outerHeight(),d=a.closest(".block_dialog_container").offset().top;
app.calcCenterAvailHeight()<a.outerHeight()?a.addClass("v-shifted").css("top",Math.max(b-c,-d)):a.removeClass("v-shifted").css("top","auto")}},show:function(){this.reset();this.popupPosition();$("#sql_generator_form_button").hide();$("#sql_generator_form_despite_warnings_button").hide();$("#sql_generator_progress_checking").show();epoint.ow.popup.PopupManager.openPopup("sql_generator_form_container");epoint.ow.popup.PopupManager.openPopupCover();Model.problemReports.on("after_validation",this.afterValidation,
this);Model.Validation.Validator.touch();this.problems.enableRendering();this.problems.render()},hide:function(){epoint.ow.popup.PopupManager.closePopup("sql_generator_form_container");epoint.ow.popup.PopupManager.closePopupCover();this.problems.disableRendering();Model.problemReports.off("after_validation",this.afterValidation,this)},afterValidation:function(){$("#sql_generator_progress_checking").hide();0<Model.problemReports.filter(function(a){return 0<a.get("errors").size()||0<a.get("warnings").size()}).length?
($("#sql_generator_problems").show(),$("#sql_generator_problems_list").show(),$("#sql_generator_form_despite_warnings_button").show()):$("#sql_generator_form_button").show();this.popupPosition(!0)},correctModel:function(){this.hide()},updateEmptyScriptInfo:function(){0==$("#sql_generator_form input[name=scope]:checked").map(function(a,b){return b.value}).toArray().length?$("#sql_generator_empty_script").show():$("#sql_generator_empty_script").hide();this.popupPosition(!0)},generate:function(){var a=
this,b={};b.modelId=Model.metaInfo.get("id");b.type=$("#sql_generator_form input[name=type]:checked").val();b.scope=[];b.scope=$("#sql_generator_form input[name=scope]:checked").map(function(a,b){return b.value}).toArray();var c=JSON.stringify(b);$("#sql_generator_download").hide();$("#sql_generator_progress_generating").show();$.ajax({type:"POST",url:"/sql/generate",data:c,processData:!1,async:!0,contentType:"application/json",dataType:"json"}).done(function(c){$("#sql_generator_show_model_link").attr("href",
c.prettyPrintUrl);$("#sql_generator_show_model_link").text(c.filename);$("#sql_generator_download_model_button").attr("href",c.downloadUrl);$("#sql_generator_download").show();$("#sql_generator_progress_generating").hide();mixpanel.track("SQL Generation",{name:Model.metaInfo.get("name"),tables:Model.tables.size(),generation_scope:b.scope,generation_type:b.type,database_engine:Model.metaInfo.get("databaseDefinition")});a.popupPosition(!0)})},reset:function(){$("#sql_generator_download").hide();$("#sql_generator_progress_generating").hide();
$("#sql_generator_progress_checking").hide();$("#sql_generator_problems").hide();$("#sql_generator_empty_script").hide()},init:function(){this.problems=new UI.ProblemsList({el:$("#sql_generator_problems_list"),model:Model.problemReports,hideHints:!0,renderingEnabled:!1});$("#sql_generator_form_despite_warnings_button").click(this.generate.bind(this));$("#sql_generator_form_button").click(this.generate.bind(this));$("#sql_generator_form input[name=scope]").change(this.updateEmptyScriptInfo.bind(this))}},
Preview:{el:"#sql_preview_container",sqlCode:"#sql_preview_sql_code",preview:function(a,b){epoint.ow.popup.PopupManager.openPopup("sql_preview_container");epoint.ow.popup.PopupManager.openPopupCover();var c={};c.modelId=Model.metaInfo.get("id");c.versionId=Model.metaInfo.get("versionId");c.id=b;c.scope=a+"s";c.type="create";var c=JSON.stringify(c),d=this;$.ajax({type:"POST",url:"/sql/preview",data:c,processData:!1,async:!0,contentType:"application/json",dataType:"json"}).done(function(a){$(d.sqlCode).text(a.sql);
hljs.highlightBlock($(d.sqlCode)[0])})},show:function(){$(this.sqlCode).val("loading...")},hide:function(){$(this.sqlCode).val("")},init:function(){var a=this;$(this.el).bind("openPopup",function(){a.show()});$(this.el).bind("closePopup",function(){a.hide()})}},init:function(){SqlGenerator.Form.init();SqlGenerator.Preview.init()}};VertabeloSQLParserInternals={};
VertabeloSQLParserInternals.Column=Backbone.Model.extend({getName:function(){return this.get("name")},getAliasOrName:function(){return null!=this.get("alias")?this.get("alias"):this.get("name")},getRelationObjectName:function(){return this.get("relationObjectName")},setRelationObject:function(a){this.set("relationObject",a)},getRelationObject:function(){return this.get("relationObject")},setModelColumn:function(a){this.set("modelColumn",a)},getModelColumn:function(){return this.get("modelColumn")}});
VertabeloSQLParserInternals.Columns=Backbone.Collection.extend({model:VertabeloSQLParserInternals.Column});VertabeloSQLParserInternals.RelationObjectType={TABLE:"table",VIEW:"view"};
VertabeloSQLParserInternals.RelationObject=Backbone.Model.extend({getName:function(){return this.get("name")},getAliasOrName:function(){return null!=this.get("alias")?this.get("alias"):this.get("name")},_setRelationObjectType:function(a){this.set("relationObjectType",a)},getRelationObjectType:function(){return this.get("relationObjectType")},setModelTable:function(a){this.set("modelTable",a);this._setRelationObjectType(VertabeloSQLParserInternals.RelationObjectType.TABLE)},getModelTable:function(){if(this.getRelationObjectType()!==
VertabeloSQLParserInternals.RelationObjectType.TABLE)throw Error("This relation object is not a table");return this.get("modelTable")},setModelView:function(a){this.set("modelView",a);this._setRelationObjectType(VertabeloSQLParserInternals.RelationObjectType.VIEW)},getModelView:function(){if(this.getRelationObjectType()!==VertabeloSQLParserInternals.RelationObjectType.VIEW)throw Error("This relation object is not a view");return this.get("modelView")}});
VertabeloSQLParserInternals.RelationObjects=Backbone.Collection.extend({model:VertabeloSQLParserInternals.RelationObject});VertabeloSQLParser=function(){};
_.extend(VertabeloSQLParser.prototype,{_originalQuery:null,_parsedQuery:null,_columns:null,_relationObjects:null,_fieldToColumn:function(a){var b=null,c=null,d=null;void 0!==a.name&&null!==a.name&&(c=a.name.value);a=a.field;void 0!==a.nested&&null!==a.nested&&!0===a.nested?(b=a.value2,d=a.value.value):b=void 0!==a.value&&null!==a.value?a.value:a instanceof SQLParser.nodes.CaseExpression?"case":"";return new VertabeloSQLParserInternals.Column({name:b,alias:c,relationObjectName:d})},_starToColumn:function(a){var b=
null;a=a.table;null!=a&&(b=void 0!==a.nested&&null!==a.nested&&!0===a.nested?a.value2:a.value);return new VertabeloSQLParserInternals.Column({name:"*",alias:null,relationObjectName:b})},_createEmptyColumn:function(a){return new VertabeloSQLParserInternals.Column({name:"column_"+a,alias:null,relationObjectName:null})},_parseColumns:function(a){var b=new VertabeloSQLParserInternals.Columns,c=0,d;for(d in a.fields){var e=a.fields[d];++c;this._log(e);e=e.field instanceof SQLParser.nodes.LiteralValue?
this._fieldToColumn(e):e.field instanceof SQLParser.nodes.FunctionValue?this._createEmptyColumn(c):e.field instanceof SQLParser.nodes.CaseExpression?this._fieldToColumn(e):e instanceof SQLParser.nodes.Star?this._starToColumn(e):this._createEmptyColumn(c);b.add(e)}return b},_nodesTableToRelationObject:function(a){var b;void 0!==a.alias&&null!==a.alias&&(b=a.alias.value);return new VertabeloSQLParserInternals.RelationObject({name:a.name.value,alias:b})},_log:function(a){},_parseRelationObjects:function(a){var b=
new VertabeloSQLParserInternals.RelationObjects,c=a.source;c instanceof SQLParser.nodes.Table?(c=this._nodesTableToRelationObject(c),b.add(c)):this._log("Source is not a table, skipping");for(var d in a.joins)c=a.joins[d],c.right instanceof SQLParser.nodes.Table?(c=this._nodesTableToRelationObject(c.right),b.add(c)):this._log("Joined element is not a table, skipping");return b},_fillRelationObjectsReferencesToModel:function(a){for(var b=0;b<a.size();++b){var c=a.at(b);this._log("Searching for model relationObject with name: "+
c.getName());var d=Model.tables.where({name:c.getName()});if(0==d.length){this._log("  no table in model with name: "+c.getName()+", looking for a view...");viewSearchResults=Model.views.where({name:c.getName()});if(0==viewSearchResults.length)throw Error("  no table or view in model with name: "+c.getName());if(1<viewSearchResults.length)throw Error("  more than one view in model with name: "+c.getName());this._log("  found view with such name!");c.setModelView(viewSearchResults[0])}else{if(1<d.length)throw Error("  more than one table in model with name: "+
c.getName());this._log("  found table with such name!");c.setModelTable(d[0])}}},_getModelRelationObject:function(a){var b=null;if(VertabeloSQLParserInternals.RelationObjectType.TABLE===a.getRelationObjectType())b=a.getModelTable();else if(VertabeloSQLParserInternals.RelationObjectType.VIEW===a.getRelationObjectType())b=a.getModelView();else throw Error("Unsupported relation object type: "+a.getRelationObjectType());return b},_getRelationObjectModelColumn:function(a,b){var c=this._getModelRelationObject(a).get("columns").where({name:b.getName()});
return 1==c.length?c[0]:null},_getRelationObjectAllModelColumns:function(a){for(var b=this._getModelRelationObject(a).get("columns"),c=new VertabeloSQLParserInternals.Columns,d=0;d<b.size();++d){var e=b.at(d),e=new VertabeloSQLParserInternals.Column({name:e.get("name"),alias:null,relationObjectName:a.get("name"),relationObject:a,modelColumn:e});c.add(e)}return c},_findRelationObject:function(a,b){var c=a.where(b);if(0==c.length)return this._log("no results found"),null;if(1<c.length)return this._log("more than one result found"),
null;this._log("found exactly one relation object!");return c[0]},_fillColumnReferencesToModelColumnsAndRelationObjects:function(a,b){for(var c=0;c<a.size();++c){var d=a.at(c);this._log("Searching for relation object for column: "+d.getAliasOrName());if(void 0!==d.getRelationObjectName()&&null!==d.getRelationObjectName()){var e=d.getRelationObjectName();this._log("  relationObjectName is not null: "+e);var f=null;this._log("- searching by alias");f=this._findRelationObject(b,{alias:e});null===f&&
(this._log("- searching by name"),f=this._findRelationObject(b,{name:e}));null===f?this._log("Didn't find any relation object with alias or name: "+e):(e=this._getRelationObjectModelColumn(f,d),null===e?this._log("Relation object doesn't have such column"):(d.setRelationObject(f),d.setModelColumn(e)))}else{for(var e=[],g=0;g<b.size();++g)f=b.at(g),null!=this._getRelationObjectModelColumn(f,d)&&e.push(f);0==e.length?this._log("  no relationObjects with column name: "+d.getName()):1<e.length?this._log("  more than one relationObject with column name: "+
d.getName()):(this._log("  found relationObject with column name: "+d.getName()+", relationObject: "+e[0].getName()),f=e[0],e=this._getRelationObjectModelColumn(f,d),d.setRelationObject(f),d.setModelColumn(e))}}},_replaceStarColumnsWithRealColumns:function(a,b){for(var c=new VertabeloSQLParserInternals.Columns,d=0,e=0;e<a.size();++e){var f=a.at(e);if("*"!=f.getName())c.add(f),++d;else if(null==f.getRelationObjectName()){var g=this;b.each(function(a){a=g._getRelationObjectAllModelColumns(a);c.add(a.toArray());
d+=a.size()})}else{var h=null,h=this._findRelationObject(b,{alias:f.getRelationObjectName()});null===h&&(h=this._findRelationObject(b,{name:f.getRelationObjectName()}));null===h?(c.add(this._createEmptyColumn(d)),++d):(f=this._getRelationObjectAllModelColumns(h),c.add(f.toArray()),d+=f.size())}}return c},_convertToViewColumns:function(a){for(var b=[],c=0;c<a.size();++c){var d=a.at(c),e=Model.nextId("view_column"),f;f=void 0!==d.getModelColumn()&&null!==d.getModelColumn()?d.getModelColumn().get("type"):
Model.databaseTypes.getDefaultType();d=new Model.ViewColumn({id:e,name:d.getAliasOrName(),type:f,description:"",properties:[]});b.push(d)}return b},reset:function(){this._relationObjects=this._columns=this._parsedQuery=this._originalQuery=null},parse:function(a){this.reset();this._originalQuery=a;try{this._parsedQuery=SQLParser.parse(a),this._log(this._parsedQuery)}catch(b){throw Error("Unable to parse query: "+b);}try{this._columns=this._parseColumns(this._parsedQuery),this._relationObjects=this._parseRelationObjects(this._parsedQuery)}catch(c){throw Error("Unable to internally parse query: "+
c);}this._fillRelationObjectsReferencesToModel(this._relationObjects);this._fillColumnReferencesToModelColumnsAndRelationObjects(this._columns,this._relationObjects);this._columns=this._replaceStarColumnsWithRealColumns(this._columns,this._relationObjects)},getViewColumns:function(){return this._convertToViewColumns(this._columns)},getViewDependencies:function(){for(var a=[],b=0;b<this._relationObjects.size();++b){var c=this._relationObjects.at(b);VertabeloSQLParserInternals.RelationObjectType.VIEW===
c.getRelationObjectType()&&a.push(c.getModelView())}return a},getTableDependencies:function(){for(var a=[],b=0;b<this._relationObjects.size();++b){var c=this._relationObjects.at(b);VertabeloSQLParserInternals.RelationObjectType.TABLE===c.getRelationObjectType()&&a.push(c.getModelTable())}return a}});var App={},app=null;App.MODE={EDIT:1,PREVIEW:2,PREVIEW_VERSION:3,PUBLIC_PREVIEW:4,EMBEDDED:5,INTERNAL_PREVIEW:6,PUBLIC_PREVIEW_EMBEDDED:7};App.App=function(a){this.mode=a.mode};
App.App.prototype={init:function(){window.onerror=function(a,b,c,d,e){try{console.log("ERROR:",a,e);b=a+" url:"+b+" lineNumber:"+c;e&&(b+="\n\nStacktrace: "+e.stack);var f={appMode:app.mode,metaInfo:Model.metaInfo.toJSON(),ajaxFuse:Model.fuseBox.get("ajax").ok(),tableLimitFuse:Model.fuseBox.get("table_limit").ok(),appProperties:Model.applicationProperties.toJSON()},g=JSON.stringify(f,null,2);logger.error(b+("\n\nContext: "+g+"\n"));return!1}catch(q){return console.log("ERROR while logging error. "),
console.log("Error to log:",a),console.log("Error occured",q),!1}};this.hasUI=this.isAnonymous=!1;var a=this;switch(this.mode){case App.MODE.EDIT:Model.setup.loadDatabaseModels=!0;Model.setup.loadModelVersions=!1;Model.setup.startMetaInfoUpdater=!0;Model.setup.usePublicModelLink=!1;Model.setup.isSaveEnabled=!0;break;case App.MODE.PREVIEW_VERSION:Model.setup.loadDatabaseModels=!0;Model.setup.loadModelVersions=!0;Model.setup.startMetaInfoUpdater=!1;Model.setup.usePublicModelLink=!1;Model.setup.isSaveEnabled=
!1;break;case App.MODE.PREVIEW:Model.setup.loadDatabaseModels=!0;Model.setup.loadModelVersions=!0;Model.setup.startMetaInfoUpdater=!1;Model.setup.usePublicModelLink=!1;Model.setup.isSaveEnabled=!1;break;case App.MODE.PUBLIC_PREVIEW:Model.setup.loadDatabaseModels=!1;Model.setup.loadModelVersions=!1;Model.setup.startMetaInfoUpdater=!1;Model.setup.usePublicModelLink=!0;Model.setup.isSaveEnabled=!1;break;case App.MODE.PUBLIC_PREVIEW_EMBEDDED:Model.setup.loadDatabaseModels=!1;Model.setup.loadModelVersions=
!1;Model.setup.startMetaInfoUpdater=!1;Model.setup.usePublicModelLink=!0;Model.setup.isSaveEnabled=!1;break;case App.MODE.EMBEDDED:Model.setup.loadDatabaseModels=!1;Model.setup.loadModelVersions=!1;Model.setup.startMetaInfoUpdater=!1;Model.setup.usePublicModelLink=!1;Model.setup.isSaveEnabled=!1;break;case App.MODE.INTERNAL_PREVIEW:Model.setup.loadDatabaseModels=!1;Model.setup.loadModelVersions=!0;Model.setup.startMetaInfoUpdater=!1;Model.setup.usePublicModelLink=!1;Model.setup.useAdminModelLink=
!0;Model.setup.isSaveEnabled=!1;break;default:throw Error("Unsupported mode: "+this.mode);}switch(this.mode){case App.MODE.EDIT:if(!1==BrowserFeatures.isEditPossible()){this.notSupportedBrowser();return}break;case App.MODE.PREVIEW_VERSION:case App.MODE.PREVIEW:case App.MODE.PUBLIC_PREVIEW_EMBEDDED:case App.MODE.PUBLIC_PREVIEW:if(!1==BrowserFeatures.isPreviewPossible()){this.notSupportedBrowser();return}break;case App.MODE.EMBEDDED:case App.MODE.INTERNAL_PREVIEW:break;default:console.log("Not tested. Mode:"+
this.mode)}Model.init();Display.init();Commands.init();UI.init();Model.Validation.init();SqlGenerator.init();Clipboard.init();this.mode==App.MODE.EDIT&&IntroGuide.init();Model.Validation.startWorker();if(this.mode!=App.MODE.EMBEDDED){this.hasUI=!0;var b=document.createElement("a");b.href=document.location.href;b.protocol;b.hostname;b.port;b.pathname;b.search;b.hash;b.host;var c=b.pathname.split("/");""==c[0]&&(c=c.splice(1));var d=c[1],e=null;2<c.length&&(e=c[2]);"anonymous-model"==c[0]&&(this.isAnonymous=
!0);this.buildUI();this.bindModelEvents();this.bindUIEvents();Model.startAutosaver();Model.startMetaInfoUpdater();epoint.ow.JSErrorManager.handleAjaxError=function(a,b,c,d){epoint.ow.JSErrorManager.isSingleAccessViolated({event:a,jqXHR:b,ajaxSettings:c,thrownError:d})?epoint.ow.JSErrorManager.handleSingleAccessViolated({event:a,jqXHR:b,ajaxSettings:c,thrownError:d}):0==b.readyState&&0==b.status||(console.log("ajax-error",a,b,c,d),Model.fuseBox.get("ajax").blow())};app.mode==App.MODE.PUBLIC_PREVIEW_EMBEDDED&&
$("#logo-link").prop("href","/public-model-view/"+d).prop("target","_blank");if(b.search){for(var b=b.search.substring(1).split("&"),f={},c=0;c<b.length;c++){var g=b[c].split("=");"x"==g[0]&&(f["position-x"]=-parseInt(g[1]));"y"==g[0]&&(f["position-y"]=-parseInt(g[1]));"zoom"==g[0]&&(f.zoom=parseFloat(g[1]))}Model.metaInfo.on("after-initial-load",function(){Model.diagramProperties.set(f)})}Model.metaInfo.on("after-initial-load",function(){app.getDiagram().repositionDiagram()});Model.metaInfo.on("after-initial-load",
function(){app.loadPluginsFor(d);Model.Validation.Validator.touch()});if(void 0!=window.mixpanel)Model.metaInfo.on("after-initial-load",function(){!0==a.isAnonymous?mixpanel.track("Model (Anonymous)",{name:Model.metaInfo.get("name"),tables:Model.tables.size(),database_engine:Model.metaInfo.get("databaseDefinition")}):a.mode==App.MODE.EDIT?mixpanel.track("Model (Edit)",{name:Model.metaInfo.get("name"),tables:Model.tables.size(),database_engine:Model.metaInfo.get("databaseDefinition")}):mixpanel.track("Model (Preview)",
{name:Model.metaInfo.get("name"),database_engine:Model.metaInfo.get("databaseDefinition")});mixpanel.people.set({"Table Limit":Model.metaInfo.get("tableLimit")})});this.load(d,e);if(this.mode==App.MODE.EDIT)$(window).on("beforeunload",function(){!1!=Model.applicationProperties.get("dirtyModel")&&Model.internalSave(!0,"Window close")})}},loadPlugin:function(a){var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("src",a);document.getElementsByTagName("head")[0].appendChild(b);
Model.Validation.loadPlugin(a)},loadPluginsFor:function(a){var b={},b=JSON.stringify({modelId:a});a="/diagram-api/plugins";Model.setup.useAdminModelLink?a="/diagram-api/adminPlugins":Model.setup.usePublicModelLink&&(a="/diagram-api/publicPlugins");var c=this;$.ajax({type:"POST",url:a,data:b,processData:!1,async:!1,contentType:"application/json",dataType:"json"}).done(function(a){a=a.scripts;for(var b=0;b<a.length;b++)c.loadPlugin(a[b])})},load:function(a,b){Model.load(a,b)},isEditable:function(){return!1==
Model.metaInfo.isReadOnly()&&this.mode==App.MODE.EDIT?!0:!1},notSupportedBrowser:function(){$("body").addClass("not-supported");$("#header_wrapper").removeClass("header_wrapper__modeler");$("#left-panel").hide();$("#right-panel").hide();$("#diagram_container").hide();$("#toolbar_wrapper").hide();$("#not-supported-info").show();$("#not-supported-browser-info-header").show()},updateUI:function(){this.updatePanels();this.updateMetrics()},updateBorderLayoutCenter:function(){this.editingMode&&this.editingMode.$el.css("width",
this.calcCenterWidth());this.progressBar.resize(this.calcCenterWidth(),this.calcCenterHeight());var a=this.calcCenterWidth(),b=this.calcCenterAvailHeight();this.diagram.resize(a,b);Model.applicationProperties.set({width:a,height:b})},updateMetrics:function(){epoint.dbwm.ui.MenuUtil.collapseHeader();this.collapseToolbars();this.updateBorderLayoutCenter();this.resizeAccordion();this.resizeSplitPane();epoint.dbwm.ui.MenuUtil.resizeHeader();this.resizeToolbars()},updatePanels:function(){this.mode!=App.MODE.PUBLIC_PREVIEW_EMBEDDED&&
(Model.applicationProperties.get("display-left-panel")?$("TD.border_layout_west").show():$("TD.border_layout_west").hide(),Model.applicationProperties.get("display-right-panel")?$("TD.border_layout_east").show():$("TD.border_layout_east").hide())},resizeAccordion:function(){var a=this.calcCenterHeight();$("DIV.accordion > DIV.block").each(function(){a-=$(this).find("> DIV.header").outerHeight()}).each(function(){$(this).find("> DIV.content").outerHeight(a)})},splitPaneSizes:{},splitPaneSizesDefaults:{"model-details-common":function(a){return 1*
a/3},common:function(a){return 3*a/4}},setPanelsSize:function(a,b,c){var d=this.calcCenterHeight(),e=this.splitPaneSizes[a.prop("id")],f=a.find("> DIV.header").outerHeight(),g=Math.max(d-(b.find("> DIV.header").outerHeight()||0),f),e=Math.max(e+c,f),e=Math.min(e,g);a.find("> DIV.content").height(e-f);app.splitPaneSizes[a.prop("id")]=e;d-=e;b[0]&&(f=b.find("> DIV.header").outerHeight(),e=Math.max(d,f),b.find("> DIV.content").height(e-f),this.splitPaneSizes[b.prop("id")]=e)},updateSplitPane:function(){var a=
this,b=$("DIV.split-pane"),c=b.find("> DIV > DIV.block:visible"),d=this.calcCenterHeight();c.each(function(b){var e=$(this),f=a.splitPaneSizes[e.prop("id")];void 0===f&&(0==b&&1<c.size()?(b=a.splitPaneSizesDefaults[e.prop("id")]||a.splitPaneSizesDefaults.common,f=Math.round(b(d))):f=d,a.splitPaneSizes[e.prop("id")]=f);e.find("> DIV.content").height(f-e.find("> DIV.header").outerHeight());d-=f});b.find(".drag").remove();if(1<c.size()){var e,f;c.parent().prepend(e=$("<div></div>").addClass("drag"));
e.css({top:$(c[0]).height()});e.draggable({scroll:!1,axis:"y",containment:c.parent(),start:function(a){f=a.screenY},drag:function(b){var d=b.screenY-f;f=b.screenY;a.setPanelsSize($(c[0]),$(c[1]),d)},stop:function(a){e.css({top:$(c[0]).height()})}})}},resizeSplitPane:function(){var a=$("DIV.split-pane"),b=a.find("> DIV > DIV.block:visible"),c=this.calcCenterHeight(),d=0;b.each(function(){d+=$(this).height()});this.setPanelsSize($(b[0]),$(b[1]),c-d);a.find(".drag").css({top:$(b[0]).height()})},collapseToolbars:function(){$("#main-toolbar").find("li.expandable").each(function(){$(this).removeClass("expanded toolbar-pressed-button").find("> DIV.toolbar-drawer-content").hide().find("> UL.hmenu").removeClass("hmenu").addClass("menu")})},
resizeToolbars:function(a,b){a=a||$("#main-toolbar");b=b||{width:a.parent().width()-$("#modeler-main-menu").outerWidth()-$("#main-toolbar").outerWidth()};var c=this;epoint.dbwm.ui.MenuUtil._sortExpandablesByPriority(a.find("> ul > li.expandable")).each(function(){var a=$(this),e=a.is(":visible")&&a.outerWidth()||0;a.addClass("expanded").find("> DIV > UL.menu").removeClass("menu").addClass("hmenu");var f=a.outerWidth();if(0>b.width-(f-e))return a.removeClass("expanded").find("> DIV > UL.hmenu").removeClass("hmenu").addClass("menu"),
!1;b.width-=f-e;c.resizeToolbars(a.find("> .toolbar-drawer-content"),b)})},calcCenterWidth:function(){var a=$(window).width();$("DIV.border_layout_center").closest("tr").children().not(".border_layout_center").filter(":visible").each(function(){a-=$(this).outerWidth()});return a},calcHeight:function(){return $(window).height()},calcCenterHeight:function(){var a=this.calcHeight();return a-=$("DIV.border_layout_north").outerHeight()},calcCenterAvailHeight:function(){var a=this.calcCenterHeight();$("DIV.border_layout_center").children().not("#diagram_container").filter(":visible").each(function(){a-=
$(this).outerHeight()});return a},getDiagram:function(){return this.diagram},getDiagramPreview:function(){return this.preview},bindModelEvents:function(){var a=this;Model.diagramProperties.on("change:position-x change:position-y change:zoom",function(){Model.touch()});Model.metaInfo.on("change:mode",function(a,b){$("#top-menu button").attr("disabled",a.isReadOnly())});Model.diagramProperties.on("change:zoom",function(a,b){$("#current_zoom_widget").text(Math.floor(100*a.get("zoom"))+"%")});Model.metaInfo.on("change:modelLoad",
function(b,d){!0==d&&a.getDiagram().redrawDiagram()});Model.metaInfo.on("change:versionId",function(a,b){!a.get("modelLoad")&&a.isReadOnly()&&(Model.reload(),app.notification.show("New version of model has been loaded."))});a=this;Model.metaInfo.on("after-load",function(){Model.metaInfo.off("after-load",null,a);a.mode==App.MODE.EDIT&&(!1===Model.metaInfo.get("wasIntroguideAlreadyShown")&&1!=$.cookie("introguide_run"))&&(IntroGuide.start(),this.saveIntroguideShown());!1==Model.metaInfo.get("scrollToZoom")&&
$("#diagram").off("mousewheel",null,null)},this);Model.applicationProperties.on("change:display-left-panel",function(){app.updateUI()});Model.applicationProperties.on("change:display-right-panel",function(){app.updateUI()});Model.selection.on("element_selected",function(a){app.updateSplitPane()});Model.selection.on("element_deselected",function(a){app.updateSplitPane()});Model.goTo.on("goto_table",function(b){b=Model.tables.get(b);void 0!=b&&null!=b&&(b=Display.selection.selectDisplay(b,app.getDiagram()),
app.getDiagram().center(b.computeCenter()),a.getDiagram().redrawDiagram())});Model.goTo.on("goto_reference",function(b){b=Model.references.get(b);void 0!=b&&null!=b&&(b=Display.selection.selectDisplay(b,app.getDiagram()),app.getDiagram().center(b.computeCenter()),a.getDiagram().redrawDiagram())});Model.goTo.on("goto_sequence",function(b){b=Model.sequences.get(b);void 0!=b&&null!=b&&(Model.selection.selectElement(b),a.getDiagram().redrawDiagram())});Model.goTo.on("goto_view",function(b){b=Model.views.get(b);
void 0!=b&&null!=b&&(b=Display.selection.selectDisplay(b,app.getDiagram()),app.getDiagram().center(b.computeCenter()),a.getDiagram().redrawDiagram())});Model.tables.on("add",this.checkTableLimit,this);Model.tables.on("remove",this.checkTableLimit,this);Model.tables.on("reset",this.checkTableLimit,this);Model.metaInfo.on("change:tableLimitExceeded",function(){Model.metaInfo.get("tableLimitExceeded")?(a.navigationTree.$el.parent().hide(),a.problems.$el.hide()):(a.navigationTree.$el.parent().show(),
a.problems.$el.show())});var b=null;Model.metaInfo.on("change:applicationVersion",function(a,d,e){null==b?b=Model.metaInfo.get("applicationVersion"):document.location.href=document.location.href})},checkTableLimit:function(){if(Model.metaInfo.get("tableLimitEnabled")){var a=Model.metaInfo.get("tableLimit");Model.tables.size()>a?Model.fuseBox.get("table_limit").blow():Model.fuseBox.get("table_limit").fix()}},saveIntroguideShown:function(){var a=JSON.stringify({shown:!0});$.ajax({type:"POST",url:"/diagram-api/introguideShown",
dataType:"json",data:a,contentType:"application/json",async:!0}).done(function(a){})},buildUI:function(){var a=new UI.DatabaseTypeSelector({el:$("#database-type-selector"),model:Model.databaseTypes});UI.TableDetailsInternal.typeSelector=a;UI.ViewDetailsInternal.typeSelector=a;app.mode==App.MODE.EDIT&&(this.editingMode=new UI.EditingMode({el:$("#editing-mode"),model:Model.metaInfo}));this.updatePanels();var a=this.calcCenterWidth(),b=this.calcCenterAvailHeight();Model.applicationProperties.set({width:a,
height:b},{silent:!0});this.diagram=new Diagram.Diagram({model:Model,container:"diagram",width:a,height:b,diagramWidth:1E4,diagramHeight:1E4});this.preview=new Diagram.DiagramPreview({container:"preview",diagram:this.diagram,width:this.diagram.getHeight()/8*(4/3),height:this.diagram.getHeight()/8});this.progressBar=new UI.ProgressBar({el:$("#progress_bar_layer")});this.mode!=App.MODE.PUBLIC_PREVIEW_EMBEDDED&&(this.notification=new UI.Notification({el:$("#notification-container"),model:null}),this.messages=
new UI.Messages({el:$("#messages"),model:null}),this.navigationTree=new UI.NavigationTree({el:$(".tree"),model:Model}),this.tableDetails=new UI.TableDetails({el:$("#table-details"),model:Model.tables}),this.referenceDetails=new UI.ReferenceDetails({el:$("#reference-details"),model:Model.references,tables:Model.tables}),this.sequenceDetails=new UI.SequenceDetails({el:$("#sequence-details"),model:Model.sequences}),this.noteDetails=new UI.NoteDetails({el:$("#note-details"),model:Model.notes}),this.viewDetails=
new UI.ViewDetails({el:$("#view-details"),model:Model.views}),this.areaDetails=new UI.AreaDetails({el:$("#area-details"),model:Model.areas}),this.modelDetails=new UI.ModelDetails({el:$("#model-details"),model:Model.metaInfo}),this.search=new UI.Search({el:$("#search-box"),model:Model}),this.problems=new UI.ProblemsList({el:$("#problems-list"),model:Model.problemReports,renderingEnabled:!1}),this.handyMenu=new UI.HandyMenu({el:$("#handy-menu"),model:Model}),this.toolbox=new UI.Toolbox({el:$("#toolbox-container"),
model:Model.diagramMode}),this.toolbar=new UI.Toolbar({el:$("#main-toolbar"),model:Model}),this.mainMenu=new UI.MainMenu({el:$("#modeler-main-menu"),model:Model.databaseModels}),this.setTag=new UI.SetTag({el:$("#set-tag"),model:Model}),this.tableLimitMessage=new UI.TableLimitMessage({el:null,model:Model.fuseBox.get("table_limit")}),this.isAnonymous&&(this.anonymousModelMessage=new UI.AnonymousModelMessage({el:null,model:null})),this.tableLimitExceededMessage=new UI.TableLimitExceededMessage({el:null,
model:Model.metaInfo}),this.updateSplitPane());this.ajaxFuse=new UI.AjaxFuseNotifier({el:$("#fusebox_ajax_fuse"),model:Model.fuseBox.get("ajax"),message:"Oops we've got a problem. Something went wrong ...",label:"Reload page"});if(this.mode==App.MODE.PREVIEW_VERSION||this.mode==App.MODE.PREVIEW||this.mode==App.MODE.INTERNAL_PREVIEW)this.versionNavigator=new UI.VersionNavigator({el:$("#version-navigator"),model:Model.modelVersions});if(this.mode==App.MODE.PREVIEW||this.mode==App.MODE.PREVIEW_VERSION||
this.mode==App.MODE.PUBLIC_PREVIEW||this.mode==App.MODE.INTERNAL_PREVIEW)this.previewInfoHeader=new UI.PreviewInfoHeader({el:$("#preview-info-header"),model:Model.metaInfo});(this.mode==App.MODE.PREVIEW||this.mode==App.MODE.PREVIEW_VERSION)&&$("#logo-link").attr("href","/my-models");this.mode==App.MODE.PUBLIC_PREVIEW_EMBEDDED&&($("#left-panel").hide(),$("#right-panel").hide(),$("#toolbar_wrapper").hide(),this.updateBorderLayoutCenter());epoint.dbwm.ui.MenuUtil.collapseHeader();this.resizeAccordion();
epoint.dbwm.ui.MenuUtil.resizeHeader();this.resizeToolbars()},manualSave:function(){Model.save("Manual save")},switchToModelDetails:function(){if(app.isAnonymous)return app.showOnlyForRegisteredUsersPopup(),!1;var a="/redirect/model_details/"+Model.metaInfo.get("id");Model.applicationProperties.on("after-save",function(){document.location.href=a});Model.save("Model details")},setTagName:function(){app.setTag.show()},doSearch:function(){$("form[name=search] input[name=query]").focus()},selectAll:function(){Model.groupOperation.doWithLock(function(){Display.selection.clearAll();
for(var a=0;a<Model.tableDisplays.size();a++)Display.selection.attachElement(Model.tableDisplays.at(a));for(a=0;a<Model.referenceDisplays.size();a++)Display.selection.attachElement(Model.referenceDisplays.at(a));for(a=0;a<Model.notes.size();a++)Display.selection.attachElement(Model.notes.at(a));for(a=0;a<Model.viewDisplays.size();a++)Display.selection.attachElement(Model.viewDisplays.at(a));for(a=0;a<Model.areas.size();a++)Display.selection.attachElement(Model.areas.at(a))});Display.selection.triggerSelectionChanged();
this.getDiagram().redrawDiagram()},alignButtonClick:function(a){$(".toolbar-button-"+a).click()},bindUIEvents:function(){var a=this;$(window).keydown(function(a){var c=a.which,d=String.fromCharCode(c).toLowerCase(),e=a.ctrlKey,f=a.altKey,g={s:app.manualSave.bind(app),g:app.showSqlGeneratorForm.bind(app),m:app.switchToModelDetails.bind(app),f:app.doSearch.bind(app),n:app.setTagName.bind(app),i:app.toggleShortcutsHelper.bind(app),a:function(a){if($(a.target).is("INPUT, TEXTAREA"))return!0;app.selectAll()},
z:Commands.undo.bind(Commands),y:Commands.redo.bind(Commands)};if(f&&e){if("p"==d)return Model.applicationProperties.set("display-right-panel",!Model.applicationProperties.get("display-right-panel")),a.preventDefault(),!1;if("n"==d)return Model.applicationProperties.set("display-left-panel",!Model.applicationProperties.get("display-left-panel")),a.preventDefault(),!1}if(e){if(192==c)return app.showDebugConsole(),a.preventDefault(),!1;c=g[d];if(void 0!=c&&!0!==c(a))return a.preventDefault(),!1}return!0});
$("#diagram").keydown(function(a){var c=a.which,d=String.fromCharCode(a.which).toLowerCase(),e=a.ctrlKey,f=a.altKey;if(187==a.which&&!e)return app.diagram.zoomIn(!1),a.preventDefault(),!1;if(189==a.which&&!e)return app.diagram.zoomOut(!1),a.preventDefault(),!1;if("."==d)return Clipboard.delete(),a.preventDefault(),!1;if(37<=c&&40>=c)switch(c){case 37:app.diagram.getSelectionLayer().selectionGroupMove({x:-1,y:0});break;case 38:app.diagram.getSelectionLayer().selectionGroupMove({x:0,y:-1});break;case 39:app.diagram.getSelectionLayer().selectionGroupMove({x:1,
y:0});break;case 40:app.diagram.getSelectionLayer().selectionGroupMove({x:0,y:1})}if(48<=c&&58>c){switch(c){case 49:Model.diagramMode.set("mode",Model.diagramMode.SELECT_MODE);break;case 50:Model.diagramMode.set("mode",Model.diagramMode.SELECT_RECT_MODE);break;case 51:Model.diagramMode.set("mode",Model.diagramMode.ADD_TABLE_MODE);break;case 52:Model.diagramMode.set("mode",Model.diagramMode.ADD_RELATIONSHIP_MODE);break;case 53:Model.diagramMode.set("mode",Model.diagramMode.ADD_VIEW_MODE);break;case 54:Model.diagramMode.set("mode",
Model.diagramMode.ADD_NOTE_MODE);break;case 55:Model.diagramMode.set("mode",Model.diagramMode.ADD_AREA_MODE)}a.preventDefault();return!1}var g={c:Clipboard.copy.bind(Clipboard),x:Clipboard.cut.bind(Clipboard),v:Clipboard.paste.bind(Clipboard),k:Clipboard.pasteAsShortcut.bind(Clipboard),a:app.selectAll.bind(app)};if(f&&e){if(189==c)return app.alignButtonClick("align-vertical-bottom"),a.preventDefault(),!1;if(87==c)return app.alignButtonClick("size-same-width"),a.preventDefault(),!1;if(72==c)return app.alignButtonClick("size-same-height"),
a.preventDefault(),!1;if(84==c)return app.alignButtonClick("size-adjust-to-text"),a.preventDefault(),!1}if(e){d=g[d];if(void 0!=d)return d(),a.preventDefault(),!1;if(219==c)return app.alignButtonClick("align-horizontal-left"),a.preventDefault(),!1;if(220==c)return app.alignButtonClick("align-horizontal-center"),a.preventDefault(),!1;if(221==c)return app.alignButtonClick("align-horizontal-right"),a.preventDefault(),!1;if(189==c)return app.alignButtonClick("align-vertical-top"),a.preventDefault(),!1;
if(187==c)return app.alignButtonClick("align-vertical-center"),a.preventDefault(),!1}return!0});$("#diagram").blur(function(){Model.diagramMode.set("mode",Model.diagramMode.SELECT_MODE)});(function(){var a=$("DIV.accordion > DIV.block");a.find("> DIV.header").click(function(){a.addClass("collapsed");var c=$(this).closest("DIV.block");c.removeClass("collapsed");0!=c.find("#problems-list").length?(app.problems.enableRendering(),app.problems.render()):app.problems.disableRendering()})})();$("#shortcut-helper-menu-item").show();
this.mode==App.MODE.EDIT&&$("#take-application-tour-menu-item").show();$("#diagram").bind("mousewheel",function(a,c,d,e){a.stopPropagation();a.preventDefault();0<e?app.diagram.zoomIn(!0):app.diagram.zoomOut(!0)});$("#custom_zoom_widget").change(function(){app.diagram.zoomCustom(parseFloat($(this).val()),!1);$("#custom_zoom_widget")[0].selectedIndex=0});$(window).resize(function(){app.updateMetrics()});$("#popup_flow_share_model_div").bind("openPopup",function(){var a;a=$(".toolbar-button-share").offset().left;
0==a&&(a=(a=$(".toolbar-button-share").closest(".toolbar-drawer-content:visible").offset())&&a.left||0);0==a&&(a=$(".toolbar-button-tools").offset().left);$("#popup_flow_share_model_div").css("left",a-33)});$("#only_for_registered_container .close-popup-button").bind("click",function(){a.hideOnlyForRegisteredUsersPopup()});$("#debug-load-tests-button").click(app.loadTests.bind(app))},loadTestsFromUrl:function(a){a=a+"?_t="+(new Date).getTime();var b=document.createElement("script");b.setAttribute("type",
"text/javascript");b.setAttribute("src",a);document.getElementsByTagName("head")[0].appendChild(b)},_loadTests:function(){this.loadTestsFromUrl("/assets/js/modeler/tests.js")},loadTests:function(){window.QUnit?app._loadTests():$.getScript("/assets/js/modeler/lib/qunit-1.14.0.js",function(a,b,c){QUnit.config.autostart=!1;QUnit.config.altertitle=!1;QUnit.config.scrolltop=!1;QUnit.init();QUnit.start();app._loadTests()})},showDebugConsole:function(){epoint.ow.popup.PopupManager.openPopup("debug-console");var a={appMode:app.mode,
modelMode:Model.metaInfo.get("mode"),modelId:Model.metaInfo.get("id"),modelVersionId:Model.metaInfo.get("versionId"),loggerQueue:logger.queue,modelSetup:Model.setup,ajaxFuse:Model.fuseBox.get("ajax").ok(),tableLimitFuse:Model.fuseBox.get("table_limit").ok(),appProperties:Model.applicationProperties.toJSON()},a=JSON.stringify(a,null,4);$("#debug-console-content").text(a)},generateXML:function(){if(app.isAnonymous)return app.showOnlyForRegisteredUsersPopup(),!1;if(app.mode==App.MODE.INTERNAL_PREVIEW){var a=
"/admin_model_version_as_xml?gid="+Model.metaInfo.get("versionId")+"&id="+Model.metaInfo.get("id"),b=document.createElement("a");b.download="model.xml";b.href=a;b.click();return!1}if("edit"==Model.metaInfo.escape("mode")){var c=function(){Model.applicationProperties.off("after-save",c);var a="/model_version_as_xml?gid="+Model.metaInfo.get("versionId"),b=document.createElement("a");b.download="model.xml";b.href=a;b.click()};Model.applicationProperties.on("after-save",c);Model.save("XML Generation")}else b=
document.createElement("a"),b.download="model.xml",b.href=a,b.click();return!1},showSqlGeneratorForm:function(){if(app.isAnonymous)return app.showOnlyForRegisteredUsersPopup(),!1;if("edit"===Model.metaInfo.escape("mode")){var a=function(){Model.applicationProperties.off("after-save",a);SqlGenerator.Form.show()};Model.applicationProperties.on("after-save",a);Model.save("SQL generation")}else SqlGenerator.Form.show()},hideShortcutsHelper:function(){epoint.ow.popup.PopupManager.closePopup("shortcuts-helper");
epoint.ow.popup.PopupManager.closePopupCover()},showShortcutsHelper:function(){epoint.ow.popup.PopupManager.openPopup("shortcuts-helper");epoint.ow.popup.PopupManager.openPopupCover()},toggleShortcutsHelper:function(){$("#shortcuts-helper").is(":visible")?app.hideShortcutsHelper():app.showShortcutsHelper()},goTo:function(a,b){Model.goTo.goTo(a,b)},redirect:function(a){if(Model.metaInfo.isReadOnly())document.location.href=a;else{var b=function(){Model.applicationProperties.off("after-save",b);document.location.href=
a};Model.applicationProperties.on("after-save",b);Model.save("Window close")}},switchToModel:function(a){this.redirect("/model/"+a)},switchToModelVersionPreview:function(a,b){this.redirect("/model-version-view/"+a+"/"+b)},showOnlyForRegisteredUsersPopup:function(){epoint.ow.popup.PopupManager.openPopup("only_for_registered_container");epoint.ow.popup.PopupManager.openPopupCover()},hideOnlyForRegisteredUsersPopup:function(){epoint.ow.popup.PopupManager.closePopup("only_for_registered_container");epoint.ow.popup.PopupManager.closePopupCover()}};
App.buildApp=function(){app=new App.App({model:Model,mode:App.MODE.EDIT});app.init()};App.buildPreview=function(){app=new App.App({model:Model,mode:App.MODE.PREVIEW});app.init()};App.buildPreviewVersion=function(){app=new App.App({model:Model,mode:App.MODE.PREVIEW_VERSION});app.init()};App.buildPublicPreview=function(){app=new App.App({model:Model,mode:App.MODE.PUBLIC_PREVIEW});app.init()};
App.buildPublicPreviewEmbedded=function(){app=new App.App({model:Model,mode:App.MODE.PUBLIC_PREVIEW_EMBEDDED});app.init()};App.embedded=function(){app=new App.App({model:Model,mode:App.MODE.EMBEDDED});app.init()};App.internal=function(){app=new App.App({model:Model,mode:App.MODE.INTERNAL_PREVIEW});app.init()};
